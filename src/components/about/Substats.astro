---
import { socialLinks, type iconsType } from 'astro-pure/types'
import { Icon } from 'astro-pure/user'

interface SubstatsItem {
  platform: string
  icon: (typeof socialLinks)[number]
  color?: string
  link?: string
  text: string
  api?: string
  count?: number
}

type Props = {
  stats: SubstatsItem[]
}

const { stats } = Astro.props as Props

async function fetchCount(item: SubstatsItem) {
  if (!item.api) return

  const url = `https://api.swo.moe/stats/${encodeURIComponent(item.api)}`
  try {
    const response = await fetch(url, {
      headers: { accept: 'application/json' },
      redirect: 'follow'
    })

    // 先读成 text，避免 response.json() 在非 JSON 时直接抛异常
    const text = await response.text()
    const ct = response.headers.get('content-type') ?? ''

    // 非 2xx 或非 JSON：直接跳过（构建期/网络异常时很常见）
    if (!response.ok || !ct.includes('application/json')) {
      console.warn('[Substats] Non-JSON response', {
        url,
        status: response.status,
        contentType: ct,
        preview: text.slice(0, 120)
      })
      return
    }

    let data: any
    try {
      // 处理 BOM 等极少数脏前缀
      const cleaned = text.replace(/^\uFEFF/, '').trim()
      data = JSON.parse(cleaned)
    } catch (e) {
      console.warn('[Substats] JSON parse failed', { url, preview: text.slice(0, 120) })
      return
    }

    if (data?.failed) {
      throw new Error(data?.message || 'Substats API failed')
    }

    if (typeof data?.count === 'number') {
      item.count = data.count
    }
  } catch (error) {
    // 不要让构建失败：打个轻量日志就好
    console.warn('[Substats] Fetch error', { url, error: String(error) })
  }
}

await Promise.all(stats.map(fetchCount))
---

<div class='grid grid-cols-1 gap-3 rounded-xl border p-2 sm:grid-cols-2 sm:p-3'>
  {
    stats.map(({ link, platform, icon, color, count, text }) => (
      <a
        class='group text-muted-foreground no-underline'
        href={link}
        target='_blank'
        rel='noopener noreferrer'
      >
        <div class='flex items-center gap-3 rounded-lg border border-transparent px-3 py-2 transition-all hover:border-border hover:bg-muted'>
          {icon && <Icon name={icon as iconsType} color={color} />}
          <div class='flex-1 text-foreground transition-colors group-hover:text-primary'>
            {platform}
          </div>

          {typeof count === 'number' ? (
            <div class='flex items-center gap-1.5'>
              <samp>{count}</samp>
              <span class='text-sm font-normal'>{text}</span>
            </div>
          ) : (
            <span class="text-sm text-muted-foreground">—</span>
          )}
        </div>
      </a>
    ))
  }
</div>

<div class='mt-2 text-right text-sm'>
  Display real-time; powered by{' '}
  <a
    class='text-muted-foreground'
    href='http://github.com/spencerwooo/substats'
    target='_blank'
    rel='noopener noreferrer'
  >
    Substats
  </a>
</div>
