---
import type { MarkdownHeading } from 'astro'
import type { CollectionEntry } from 'astro:content'
import config from 'virtual:config'

// Plugin styles
import 'katex/dist/katex.min.css'

import { MediumZoom } from 'astro-pure/advanced'
import { ArticleBottom, Copyright, Hero, TOC } from 'astro-pure/components/pages'
import Signature from '../../packages/pure/components/user/Signature.astro'
import PageLayout from '@/layouts/ContentLayout.astro'
import { Comment, PageInfo } from '@/components/waline'
import RelatedArticles from '@/components/RelatedArticles.astro'
import { integ } from '@/site-config'

interface Props {
  post: CollectionEntry<'blog'>
  posts: CollectionEntry<'blog'>[]
  headings: MarkdownHeading[]
  remarkPluginFrontmatter: Record<string, unknown>
}

const {
  post,
  post: { id, data },
  posts,
  headings,
  remarkPluginFrontmatter
} = Astro.props

const {
  description,
  heroImage,
  publishDate,
  title,
  updatedDate,
  draft: isDraft,
  comment: enableComment
} = data

const socialImage = heroImage
  ? typeof heroImage.src === 'string'
    ? heroImage.src
    : heroImage.src.src
  : '/images/social-card.png'

// ✅ 给 meta 用的时间：优先 updated，其次 publish；都没有就 undefined（避免 TS 报错）
const articleDate =
  updatedDate?.toISOString() ??
  publishDate?.toISOString() ??
  undefined

const primaryColor = data.heroImage?.color ?? 'hsl(var(--primary) / var(--un-text-opacity))'

// ✅ 显示用：北京时间 + 时间（publish/updated 可能为空，所以要做判空）
const fmtBJ = new Intl.DateTimeFormat('zh-CN', {
  timeZone: 'Asia/Shanghai',
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  hour12: false
})

const publishDateBJ = publishDate ? fmtBJ.format(publishDate) : null
const updatedDateBJ = updatedDate ? fmtBJ.format(updatedDate) : null
---

<PageLayout
  meta={{ articleDate, description, ogImage: socialImage, title }}
  highlightColor={primaryColor}
  back='/blog'
>
  {!!headings.length && <TOC {headings} slot='sidebar' />}

  <Hero {data} {remarkPluginFrontmatter} slot='header'>
    <Fragment slot='description'>
      {/* ✅ 两个时间都显示：缺哪个就不显示哪个 */}
      {(publishDateBJ || updatedDateBJ) && (
        <div class="mt-1 text-xs text-muted-foreground space-y-1">
          {publishDate && publishDateBJ && (
            <div>
              Publish：
              <time datetime={publishDate.toISOString()}>{publishDateBJ}</time>
            </div>
          )}

          {updatedDate && updatedDateBJ && (
            <div>
              Update：
              <time datetime={updatedDate.toISOString()}>{updatedDateBJ}</time>
            </div>
          )}
        </div>
      )}

      {!isDraft && enableComment && <PageInfo comment class='mt-1' />}
    </Fragment>
  </Hero>

  <slot />

  {config.signature && <Signature />}

  <Fragment slot='bottom'>
    {/* Copyright */}
    <Copyright {data} />
    {/* Related Articles */}
    <RelatedArticles currentPost={post} allPosts={posts} />
    {/* Article recommend */}
    <ArticleBottom collections={posts} {id} class='mt-3 sm:mt-6' />
    {/* Comment */}
    {!isDraft && enableComment && <Comment class='mt-3 sm:mt-6' />}
  </Fragment>

  <slot name='bottom-sidebar' slot='bottom-sidebar' />
</PageLayout>

{integ.mediumZoom.enable && <MediumZoom />}
