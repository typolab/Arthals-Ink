---
title: eva title log
description: Deploying an EVA title generator
tags:
  - deploy
  - eva
language: ä¸­æ–‡
slug: eva_title
publishDate: '2025-12-06T12:45:38+08:00'
updatedDate: '2025-12-06T12:45:38+08:00'
---

###åŸ GitHub ç½‘ç«™ï¼š[eva-title](https://github.com/itorr/eva-title)
###åŸ Demo Server web: [Evangelion Title Card Generator](https://lab.magiconch.com/eva-title/)  
ç”±äºåŸ Github çš„é¡¹ç›® ç›´æ¥æ‹¿æ¥æ˜¯ä¸å¯ç”¨çš„
###æˆ‘ç»è¿‡æ”¹è‰¯åçš„ Github é¡¹ç›®ï¼š[eva-title](https://github.com/sotaify/eva-title)
###Demo Server web: [Evangelion Title Card Generator](https://yys.im/eva/)  


### ä»¥ä¸‹æ˜¯ä¿®æ”¹
## Q: 

eva-title-main.zip

è¿™ä¸ªé¡¹ç›®èƒ½ä¸èƒ½éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Š

## A: 

å¯ä»¥çš„ï¼Œè€Œä¸”è¿™ä¸ªé¡¹ç›®**å¾ˆé€‚åˆéƒ¨ç½²åˆ°æœåŠ¡å™¨**ï¼šä»ä½ ç»™çš„å‹ç¼©åŒ…ç»“æ„çœ‹ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**çº¯å‰ç«¯é™æ€é¡µé¢**ï¼ˆå…¥å£åœ¨ `eva-title-main/html/index.html`ï¼Œæ—è¾¹è¿˜æœ‰å­—ä½“ã€JSã€å›¾ç‰‡ç­‰èµ„æºï¼‰ï¼Œä¸éœ€è¦æ•°æ®åº“ä¹‹ç±»çš„åç«¯ã€‚

ä¸‹é¢ç»™ä½ ä¸¤ç§æœ€å¸¸è§çš„éƒ¨ç½²æ–¹å¼ï¼ˆä»»é€‰å…¶ä¸€ï¼‰ã€‚

* * *

## æ–¹å¼ Aï¼šå½“ä½œâ€œé™æ€ç½‘ç«™â€éƒ¨ç½²ï¼ˆæ¨èï¼šæœ€ç¨³ã€æœ€çœäº‹ï¼‰

### 1) è§£å‹å¹¶æŠŠ `html/` ç›®å½•å½“ç«™ç‚¹æ ¹ç›®å½•

```bash
unzip eva-title-main.zip
cd eva-title-main
# ä½ çš„ç«™ç‚¹æ–‡ä»¶éƒ½åœ¨ ./html é‡Œ
ls html
```

æŠŠ `html/` é‡Œçš„å†…å®¹å¤åˆ¶åˆ°ä½ çš„ Web æœåŠ¡å™¨ç«™ç‚¹ç›®å½•ï¼ˆä¾‹ï¼šNginx å¸¸ç”¨ç›®å½•ï¼‰ï¼š

```bash
sudo mkdir -p /var/www/eva-title
sudo cp -r html/* /var/www/eva-title/
```

### 2) Nginx é…ç½®ç¤ºä¾‹ï¼ˆé™æ€æ‰˜ç®¡ï¼‰

æ–°å»ºï¼š

```bash
sudo nano /etc/nginx/sites-available/eva-title
```

å¡«å…¥ï¼ˆæŠŠåŸŸåæ¢æˆä½ çš„ï¼‰ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;

    root /var/www/eva-title;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    # é™æ€èµ„æºç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public";
        try_files $uri =404;
    }
}
```

å¯ç”¨å¹¶é‡è½½ï¼š

```bash
sudo ln -s /etc/nginx/sites-available/eva-title /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

åš HTTPS çš„è¯ï¼Œç”¨ certbotï¼ˆå¦‚æœä½ å·²ç»åœ¨ç”¨å°±ç…§å¸¸ä¸Šè¯ä¹¦å³å¯ï¼‰ã€‚

* * *

## æ–¹å¼ Bï¼šç”¨ Node/Express è·‘ä¸€ä¸ªç®€å•æœåŠ¡ï¼ˆé€‚åˆä½ æ²¡æœ‰ Nginx çš„åœºæ™¯ï¼‰

è¿™ä¸ªé¡¹ç›®çš„ `package.json` é‡Œå¸¦äº† `express` ä¾èµ–ï¼Œä½†ä»“åº“é‡Œæ²¡æœ‰ç°æˆçš„ server æ–‡ä»¶ï¼›ä½ å¯ä»¥ç”¨ä¸€è¡Œå‘½ä»¤ç›´æ¥æŠŠ `html/` é™æ€æ‰˜ç®¡èµ·æ¥ï¼š

```bash
cd eva-title-main
npm i
node -e "const express=require('express'); const app=express(); app.use(express.static('html')); app.listen(3000, ()=>console.log('http://0.0.0.0:3000'));"
```

ç„¶åç”¨ Nginx/Caddy åä»£åˆ° 3000ï¼ˆæˆ–ç›´æ¥å¼€æ”¾ 3000 ç«¯å£ä¹Ÿè¡Œï¼Œä½†ç”Ÿäº§ä¸Šæ›´æ¨èåä»£ + HTTPSï¼‰ã€‚

* * *

## å¸¸è§å‘ä½ï¼ˆæå‰é¿é›·ï¼‰

*   **ç«™ç‚¹æ ¹ç›®å½•è¦æŒ‡å‘ `html/`**ï¼šä¸è¦æŒ‡åˆ° `eva-title-main/`ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ° `index.html` æˆ–èµ„æºè·¯å¾„ã€‚

*   å­—ä½“æ–‡ä»¶æ˜¯ `.woff/.woff2`ï¼Œé™æ€æœåŠ¡å™¨è¦èƒ½æ­£ç¡®è¿”å›ï¼ˆNginx é»˜è®¤æ²¡é—®é¢˜ï¼‰ã€‚

*   å¦‚æœä½ æ‰“ç®—æ”¾åˆ°å­è·¯å¾„ï¼ˆä¾‹å¦‚ `https://domain.com/eva/`ï¼‰ï¼Œéœ€è¦ç¡®è®¤ `index.html` é‡Œèµ„æºå¼•ç”¨æ˜¯ç›¸å¯¹è·¯å¾„è¿˜æ˜¯ä»¥ `/` å¼€å¤´ï¼›ä»¥ `/xxx` å¼€å¤´çš„è¯å°±å¾—æ”¹æˆç›¸å¯¹è·¯å¾„æˆ–æ”¹ Nginx `location` æ˜ å°„ã€‚

*   * *

å¦‚æœä½ å‘Šè¯‰æˆ‘ä½ æœåŠ¡å™¨ç¯å¢ƒæ˜¯ **Nginx / Apache / åªæœ‰ Node / ç”¨å®å¡”** é‡Œçš„å“ªä¸€ç§ï¼Œä»¥åŠåŸŸåæ˜¯å¦å·²æœ‰ã€æ˜¯å¦è¦ HTTPSï¼Œæˆ‘å¯ä»¥æŠŠå¯¹åº”çš„é…ç½®ç›´æ¥æŒ‰ä½ çš„åœºæ™¯ç»™åˆ°å¯å¤åˆ¶ç²˜è´´ç‰ˆæœ¬ã€‚

## Q: 

ç”¨å®å¡”é¢æ¿æ€ä¹ˆæ­å»º

## A: 

ç”¨å®å¡”æ­å»ºè¿™ä¸ªé¡¹ç›®å¾ˆç®€å•ï¼šæŠŠå®ƒå½“ä½œâ€œçº¯é™æ€ç½‘ç«™â€æ¥éƒ¨ç½²å°±è¡Œï¼ˆä¸éœ€è¦ Node/æ•°æ®åº“ï¼‰ã€‚

## 1ï¼‰å®å¡”é‡Œå…ˆå‡†å¤‡ç¯å¢ƒ

*   å·¦ä¾§ **è½¯ä»¶å•†åº—**ï¼š

    *   å®‰è£… **Nginx**ï¼ˆæ¨èï¼‰æˆ– Apacheï¼ˆäºŒé€‰ä¸€ï¼‰

    *   PHP / MySQL éƒ½ä¸éœ€è¦ï¼ˆè£…äº†ä¹Ÿæ— æ‰€è°“ï¼‰

## 2ï¼‰åˆ›å»ºç«™ç‚¹

*   å·¦ä¾§ **ç½‘ç«™** â†’ **æ·»åŠ ç«™ç‚¹**

    *   åŸŸåï¼šå¡«ä½ çš„åŸŸåï¼ˆæ²¡æœ‰åŸŸåä¹Ÿå¯ä»¥å…ˆç”¨ IP è®¿é—®ï¼‰

    *   æ ¹ç›®å½•ï¼šæ¯”å¦‚ `/www/wwwroot/eva-title`

    *   PHPç‰ˆæœ¬ï¼šé€‰æ‹© **çº¯é™æ€** / ä¸è®¾ç½®ï¼ˆå®å¡”ä¸€èˆ¬ä¼šè®©ä½ é€‰ï¼Œé€‰â€œä¸å¯ç”¨ PHPâ€å³å¯ï¼‰

*   ç‚¹æäº¤åˆ›å»º

## 3ï¼‰ä¸Šä¼ é¡¹ç›®æ–‡ä»¶ï¼ˆå…³é”®ï¼šä¸Šä¼  html é‡Œçš„å†…å®¹ï¼‰

ä½ çš„å‹ç¼©åŒ…é‡ŒçœŸå®ç½‘é¡µå…¥å£åœ¨ `html/index.html`ï¼Œæ‰€ä»¥è¦æŠŠ **html ç›®å½•å†…çš„æ–‡ä»¶**æ”¾åˆ°ç«™ç‚¹æ ¹ç›®å½•ã€‚

åšæ³•ä»»æ„ä¸€ç§ï¼š

### æ–¹æ³• Aï¼šå®å¡”æ–‡ä»¶ç®¡ç†ä¸Šä¼ 

*   å·¦ä¾§ **æ–‡ä»¶** â†’ è¿›å…¥ `/www/wwwroot/eva-title`

*   ä¸Šä¼  `eva-title-main.zip` å¹¶è§£å‹

*   è§£å‹åä¼šå‡ºç°ç±»ä¼¼ï¼š

    *   `/www/wwwroot/eva-title/eva-title-main/html/index.html`

*   ç„¶åæŠŠ `html` é‡Œé¢çš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼š

    *   ç«™ç‚¹æ ¹ç›®å½•æœ€ç»ˆåº”æ˜¯ï¼š

        *   `/www/wwwroot/eva-title/index.html`

        *   `/www/wwwroot/eva-title/js/...`ã€`/fonts/...` ç­‰

ï¼ˆä¸æƒ³ç§»åŠ¨ä¹Ÿè¡Œï¼šå°±æŠŠç«™ç‚¹æ ¹ç›®å½•æ”¹æˆè§£å‹åçš„ `.../html`ï¼Œçœ‹ä¸‹é¢â€œæ–¹æ³•Bâ€ã€‚ï¼‰

### æ–¹æ³• Bï¼šç›´æ¥æŠŠç«™ç‚¹æ ¹ç›®å½•æŒ‡å‘ html

*   ç½‘ç«™ â†’ ä½ çš„ç«™ç‚¹ â†’ **è®¾ç½®** â†’ **ç½‘ç«™ç›®å½•**

*   æŠŠæ ¹ç›®å½•æ”¹ä¸ºï¼š

    *   `/www/wwwroot/eva-title/eva-title-main/html`

*   ä¿å­˜å³å¯ï¼ˆçœå¾—ç§»åŠ¨æ–‡ä»¶ï¼‰

## 4ï¼‰è®¾ç½®é»˜è®¤é¦–é¡µ

*   ç½‘ç«™ â†’ ä½ çš„ç«™ç‚¹ â†’ **è®¾ç½®** â†’ **é»˜è®¤æ–‡æ¡£**

*   ç¡®ä¿ `index.html` åœ¨æœ€å‰é¢ï¼ˆæˆ–è‡³å°‘åŒ…å«ï¼‰

## 5ï¼‰é…ç½®ä¼ªé™æ€ / é˜²è·¨ç«™ï¼ˆä¸€èˆ¬ä¸ç”¨æ”¹ï¼‰

*   çº¯é™æ€é¡µé¢ä¸éœ€è¦ä¼ªé™æ€è§„åˆ™

*   å¦‚æœä½ å¼€äº†â€œé˜²è·¨ç«™æ”»å‡»â€ï¼Œä¸€èˆ¬ä¸å½±å“é™æ€ç«™ï¼›é‡åˆ°èµ„æºåŠ è½½å¤±è´¥å†å…³æ‰è¯•è¯•

## 6ï¼‰å¼€å¯ HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

*   ç½‘ç«™ â†’ ä½ çš„ç«™ç‚¹ â†’ **SSL**

*   é€‰ **Letâ€™s Encrypt** â†’ ç”³è¯·

*   æ‰“å¼€â€œå¼ºåˆ¶ HTTPSâ€

## 7ï¼‰éªŒè¯æ˜¯å¦æˆåŠŸ

*   ç›´æ¥è®¿é—®ï¼š`http://ä½ çš„åŸŸå/` æˆ– `http://æœåŠ¡å™¨IP/`

*   å¦‚æœå‡ºç° 404/ç©ºç™½é¡µï¼Œ90% æ˜¯**æ ¹ç›®å½•æ²¡æŒ‡åˆ° html æˆ–æ²¡æŠŠ html å†…å®¹ç§»åˆ°æ ¹ç›®å½•**

*   * *

### å¸¸è§é—®é¢˜é€ŸæŸ¥

*   **è®¿é—®åŸŸåèƒ½æ‰“å¼€ä½†å›¾ç‰‡/JS/CSS 404**ï¼šå¤šåŠæ˜¯ç›®å½•å±‚çº§ä¸å¯¹ï¼ˆæŠŠ `index.html` å’Œèµ„æºæ–‡ä»¶æ”¾åˆ°åŒä¸€çº§æ ¹ç›®å½•ï¼‰

*   **æ”¾åˆ°äºŒçº§ç›®å½•ï¼ˆå¦‚ /eva/ï¼‰èµ„æºå¤±æ•ˆ**ï¼šèµ„æºè·¯å¾„å¯èƒ½ç”¨çš„ `/xxx` ç»å¯¹è·¯å¾„ï¼Œéœ€è¦æ”¹æˆç›¸å¯¹è·¯å¾„æˆ–åœ¨ Nginx åšæ˜ å°„

å¦‚æœä½ æŠŠå®å¡”é‡Œç«™ç‚¹çš„**æ ¹ç›®å½•æˆªå›¾**ï¼ˆæˆ–å‘Šè¯‰æˆ‘ä½ ç°åœ¨æ ¹ç›®å½•æŒ‡å‘å“ªé‡Œã€è§£å‹åç›®å½•ç»“æ„é•¿å•¥æ ·ï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ ä¸€çœ¼ç¡®è®¤ä½ è¯¥ç”¨â€œç§»åŠ¨ html å†…å®¹â€è¿˜æ˜¯â€œæ”¹æ ¹ç›®å½•åˆ° htmlâ€ã€‚

## Q: 

é™æ€é¡µé¢æ˜¯ä¹±ç  ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µ

## A: 

ä½ è¿™å¼ æˆªå›¾é‡Œå…¶å®**ä¸æ˜¯â€œç¼–ç ä¹±ç â€**ï¼ˆæ–‡å­—éƒ½æ­£å¸¸æ˜¾ç¤ºï¼‰ï¼Œæ›´åƒæ˜¯ä¸¤ç±»å…¸å‹é—®é¢˜ä¹‹ä¸€ï¼š

1.  **JS æ²¡æœ‰è·‘èµ·æ¥** â†’ æ‰€ä»¥é¡µé¢é‡Œçš„æ¨¡æ¿å˜é‡ç›´æ¥åŸæ ·æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œæ¯”å¦‚ï¼š  
    `{{noMatchMojis.join('ï¼Œ')}}`ã€`{{input.placeholder}}`ã€`{{text}}`  
    è¿™ç±» `{{ }}` ä¸€èˆ¬æ˜¯ Vue/æ¨¡æ¿æ¸²æŸ“å ä½ç¬¦ï¼Œ**åªè¦ JS æ­£å¸¸åŠ è½½å¹¶æ‰§è¡Œï¼Œå°±ä¸ä¼šåŸæ ·éœ²å‡ºæ¥**ã€‚

2.  **å­—ä½“/èµ„æºæ²¡åŠ è½½æˆåŠŸ** â†’ ä½ è¿™ä¸ªé¡¹ç›®åˆåˆšå¥½æ˜¯å­—ä½“ç›¸å…³ï¼ˆEVA/Matisseï¼‰ï¼Œå¦‚æœå­—ä½“æ–‡ä»¶ 404/è¢«æ‹¦/ç±»å‹ä¸å¯¹ï¼Œå°±ä¼šå‡ºç°â€œç¼ºå­—/æ–¹å—/æ•ˆæœä¸å¯¹â€ï¼Œä½ ä¼šè§‰å¾—åƒâ€œä¹±ç â€ã€‚

ä¸‹é¢æŒ‰å®å¡”ç¯å¢ƒç»™ä½ æœ€å¿«æ’æŸ¥&ä¿®å¤æ–¹å¼ã€‚

* * *

## ä¸€ã€å…ˆç”¨æµè§ˆå™¨ 30 ç§’å®šä½åŸå› ï¼ˆæœ€å…³é”®ï¼‰

æ‰“å¼€ä½ éƒ¨ç½²åçš„é¡µé¢ï¼ŒæŒ‰ **F12 â†’ Networkï¼ˆç½‘ç»œï¼‰â†’ åˆ·æ–°**ï¼š

### ä½ é‡ç‚¹çœ‹ä¸‰ç§æ–‡ä»¶æœ‰æ²¡æœ‰ **404 / 403 / (blocked) / MIME type é”™è¯¯**ï¼š

*   `*.js`ï¼ˆè„šæœ¬ï¼‰

*   `*.css`ï¼ˆæ ·å¼ï¼‰

*   `*.woff` / `*.woff2` / `*.ttf`ï¼ˆå­—ä½“ï¼‰

å¦‚æœ **JS æ–‡ä»¶æ²¡åŠ è½½åˆ°**ï¼ˆ404/403ï¼‰ï¼Œå°±ä¼šå‡ºç°ä½ æˆªå›¾è¿™ç§ `{{xxx}}` ç›´æ¥æ˜¾ç¤ºçš„æƒ…å†µã€‚

* * *

## äºŒã€æœ€å¸¸è§åŸå› ï¼šç«™ç‚¹æ ¹ç›®å½•æ”¾é”™å±‚çº§ï¼ˆ90% æ˜¯è¿™ä¸ªï¼‰

ä½ çš„å‹ç¼©åŒ…é‡Œå…¥å£åœ¨ `.../html/index.html`ã€‚

ä½ éƒ¨ç½²æ—¶å¦‚æœå˜æˆï¼š

*   `/www/wwwroot/ç«™ç‚¹/index.html` å…¶å®ä¸æ˜¯é‚£ä¸ªçœŸæ­£çš„ `html/index.html`

*   æˆ–è€…ä½ æŠŠæ•´ä¸ª `eva-title-main` æ”¾æ ¹ç›®å½•ä¸‹ï¼Œå¯¼è‡´å¼•ç”¨è·¯å¾„ä¸å¯¹

**æ­£ç¡®åšæ³•äºŒé€‰ä¸€ï¼š**

### æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šæŠŠ `html/` é‡Œçš„å†…å®¹æŒªåˆ°ç½‘ç«™æ ¹ç›®å½•

æœ€ç»ˆç›®å½•åº”è¯¥é•¿è¿™æ ·ï¼š

*   `/www/wwwroot/ç«™ç‚¹/index.html`

*   `/www/wwwroot/ç«™ç‚¹/js/...`

*   `/www/wwwroot/ç«™ç‚¹/fonts/...`ï¼ˆæˆ–ç±»ä¼¼ï¼‰

*   `/www/wwwroot/ç«™ç‚¹/css/...`

### æ–¹æ¡ˆ Bï¼šç›´æ¥æŠŠâ€œç½‘ç«™æ ¹ç›®å½•â€æ”¹æˆè§£å‹åçš„ `html`

å®å¡” â†’ ç½‘ç«™ â†’ è®¾ç½® â†’ ç½‘ç«™ç›®å½•  
æŠŠæ ¹ç›®å½•æŒ‡å‘ï¼š

*   `/www/wwwroot/ç«™ç‚¹/xxx/html`

> åªè¦ä½ æ ¹ç›®å½•å¯¹äº†ï¼Œå†æ‰“å¼€ Networkï¼ŒJS/CSS/å­—ä½“åŸºæœ¬å°±ä¸ä¼š 404ã€‚

* * *

## ä¸‰ã€ç¬¬äºŒé«˜é¢‘ï¼šå®å¡”/Nginx æ²¡æœ‰æ­£ç¡®çš„å­—ä½“ MIME ç±»å‹ï¼ˆå¯¼è‡´å­—ä½“è¢«æ‹’ç»ï¼‰

æœ‰äº› Nginx é…ç½®é‡Œ `woff2` æ²¡é…å¥½ï¼Œä¼šå‡ºç°æ§åˆ¶å°æŠ¥é”™ç±»ä¼¼ï¼š

*   â€œRefused to apply styleâ€¦ MIME typeâ€¦â€

*   â€œFailed to decode downloaded fontâ€

### ä¿®å¤æ–¹æ³•ï¼ˆå®å¡”é‡Œæ“ä½œï¼‰

å®å¡” â†’ ç½‘ç«™ â†’ è®¾ç½® â†’ **é…ç½®æ–‡ä»¶**ï¼ˆNginxï¼‰é‡Œï¼Œç¡®ä¿æœ‰è¿™äº› `types`ï¼ˆé€šå¸¸åœ¨ http æ®µå…¨å±€ï¼Œä½†ç«™ç‚¹é‡ŒåŠ ä¹Ÿèƒ½æ•‘æ€¥ï¼‰ï¼š

```nginx
types {
  font/woff woff;
  font/woff2 woff2;
  application/octet-stream ttf;
  application/vnd.ms-fontobject eot;
  image/svg+xml svg;
}
```

ç„¶å **é‡è½½/é‡å¯ Nginx**ã€‚

* * *

## å››ã€å¦‚æœä½ è¯´çš„â€œä¹±ç â€æ˜¯ä¸­æ–‡å˜æˆ???/æ–¹å—ï¼šåŠ  UTF-8

å¦‚æœä½ é‡åˆ°çš„æ˜¯ä¸­æ–‡çœŸçš„å˜é—®å·/ä¹±ç ï¼ˆä½ æˆªå›¾ä¸åƒï¼Œä½†ä¹Ÿè¡¥ä¸Šï¼‰ï¼Œå¯ä»¥åœ¨ç«™ç‚¹é…ç½®é‡ŒåŠ ï¼š

```nginx
charset utf-8;
```

åŒæ—¶ç¡®ä¿ `index.html` é‡Œæœ‰ï¼š

```html
<meta charset="UTF-8">
```

* * *

## äº”ã€æˆ‘å»ºè®®ä½ ç›´æ¥ç»™æˆ‘ä¸¤æ ·ä¸œè¥¿ï¼Œæˆ‘å°±èƒ½ä¸€å£åˆ¤æ–­

1.  ä½ å®å¡”ç«™ç‚¹çš„ **ç½‘ç«™æ ¹ç›®å½•è·¯å¾„**ï¼ˆç½‘ç«™ â†’ è®¾ç½® â†’ ç½‘ç«™ç›®å½•é‚£é‡Œï¼‰

2.  F12 æ§åˆ¶å°/Network é‡Œ **æŠ¥é”™æˆªå›¾**ï¼ˆå°¤å…¶æ˜¯ 404 çš„ js/fontsï¼‰

é€šå¸¸æˆ‘çœ‹ä¸€çœ¼å°±èƒ½å‘Šè¯‰ä½ ï¼šæ˜¯â€œæ ¹ç›®å½•é”™å±‚çº§â€è¿˜æ˜¯â€œMIME/è·¨åŸŸ/è·¯å¾„å¼•ç”¨â€å¯¼è‡´çš„ã€‚

## Q: 

æˆ‘æŠŠhtmlé‡Œçš„å†…å®¹æ”¾åœ¨å’Œjsä¸€ä¸ªé¡µé¢è¿˜æ˜¯ä¹±ç 

## A: 

ä½ è¿™ä¸ªæƒ…å†µï¼ˆé¡µé¢é‡Œè¿˜åœ¨æ˜¾ç¤º `{{xxx}}` è¿™ç§æ¨¡æ¿å ä½ç¬¦ï¼‰**åŸºæœ¬å¯ä»¥ç¡®å®šä¸æ˜¯â€œæŠŠæ–‡ä»¶æ”¾åŒä¸€å±‚å°±èƒ½è§£å†³çš„ä¹±ç â€**ï¼Œè€Œæ˜¯ï¼š**JS æ²¡æœ‰æˆåŠŸåŠ è½½æˆ–æ²¡æœ‰æˆåŠŸæ‰§è¡Œ**ã€‚åªè¦ JS æ­£å¸¸è·‘èµ·æ¥ï¼Œè¿™äº› `{{ }}` ç»ä¸ä¼šåŸæ ·æ˜¾ç¤ºã€‚

ä¸‹é¢æŒ‰â€œæœ€å¸¸è§â†’æœ€å®¹æ˜“ä¿®â€çš„é¡ºåºç»™ä½ æ’ï¼š

* * *

## 1ï¼‰å…ˆç¡®è®¤ï¼šJS åˆ°åº•æœ‰æ²¡æœ‰åŠ è½½æˆåŠŸï¼ˆæœ€å…³é”®ï¼‰

åœ¨æµè§ˆå™¨æ‰“å¼€ä½ çš„ç½‘ç«™ â†’ æŒ‰ **F12**ï¼š

### A. çœ‹ Networkï¼ˆç½‘ç»œï¼‰â†’ åˆ·æ–°é¡µé¢

è¿‡æ»¤å…³é”®è¯ï¼š`js`  
ä½ è¦çœ‹åˆ°æ‰€æœ‰ `.js` éƒ½æ˜¯ **200**ï¼ˆä¸æ˜¯ 404/403/301/307/50xï¼‰ã€‚

> ä½ ä¹Ÿå¯ä»¥ç”¨æ›´â€œæš´åŠ›â€çš„åŠæ³•ï¼šæŠŠ `script src="..."` é‡ŒæŸä¸ª js åœ°å€å¤åˆ¶å‡ºæ¥ï¼Œå•ç‹¬åœ¨æµè§ˆå™¨æ‰“å¼€  
> èƒ½ç›´æ¥ä¸‹è½½/æ˜¾ç¤º JS å†…å®¹ï¼ˆè€Œä¸æ˜¯ 404/403/è·³è½¬åˆ°ç™»å½•é¡µï¼‰æ‰ç®—å¯¹ã€‚

### B. çœ‹ Consoleï¼ˆæ§åˆ¶å°ï¼‰

å¦‚æœæœ‰è¿™äº›æŠ¥é”™ï¼Œéƒ½ä¼šå¯¼è‡´â€œ`{{ }}` åŸæ ·éœ²å‡ºæ¥â€ï¼š

*   `Uncaught SyntaxError...`

*   `Failed to load module script...`ï¼ˆæ¨¡å—è„šæœ¬æ²¡åŠ è½½/ç±»å‹ä¸å¯¹ï¼‰

*   `Refused to execute script ... because its MIME type ...`ï¼ˆMIME ç±»å‹é”™è¯¯ï¼‰

*   `Mixed Content`ï¼ˆHTTPS é¡µé¢åŠ è½½ HTTP è„šæœ¬è¢«æ‹¦ï¼‰

*   `Cannot read properties of undefined`ï¼ˆè„šæœ¬æ‰§è¡Œä¸­é€”å´©äº†ï¼‰

*   * *

## 2ï¼‰ä½ è¯´â€œhtml å†…å®¹æ”¾åœ¨å’Œ js ä¸€ä¸ªé¡µé¢â€â€”â€”æœ€å®¹æ˜“è¸©çš„å‘æ˜¯ï¼š**è·¯å¾„å†™çš„æ˜¯ç»å¯¹è·¯å¾„**

å¾ˆå¤šé™æ€é¡¹ç›®åœ¨ `index.html` é‡Œè¿™æ ·å†™èµ„æºï¼š

```html
<script src="/js/xxx.js"></script>
```

è¿™ç§å†™æ³•çš„å«ä¹‰æ˜¯ï¼š**ä»åŸŸåæ ¹è·¯å¾„åŠ è½½** `https://ä½ çš„åŸŸå/js/xxx.js`

æ‰€ä»¥å¦‚æœä½ çš„ç«™ç‚¹å®é™…è®¿é—®è·¯å¾„æ˜¯ï¼š

*   `https://ä½ çš„åŸŸå/æŸä¸ªå­ç›®å½•/`ï¼ˆæ¯”å¦‚ `/eva/`ã€`/html/` è¿™ç§ï¼‰

é‚£ `/js/xxx.js` ä¼šå»åŸŸåæ ¹æ‰¾ï¼Œç»“æœå°± **404**ï¼Œé¡µé¢å°±å˜æˆä½ ç°åœ¨è¿™æ ·ã€‚

âœ… ä¿®æ³•ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š

*   **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šè®©ç«™ç‚¹â€œæ ¹ç›®å½•â€å°±æ˜¯åŒ…å« `index.html + js/ + css/ + fonts/` çš„é‚£ä¸€å±‚ï¼Œå¹¶ä¸”ç”¨ `https://åŸŸå/` è®¿é—®

*   **æ–¹æ¡ˆ B**ï¼šæŠŠ `index.html` é‡Œæ‰€æœ‰ `/js/...` `/css/...` æ”¹æˆ `./js/...` `./css/...`ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰

*   * *

## 3ï¼‰å®å¡”ä¸Šå¸¸è§çš„â€œJS è¢«å½“æˆæ–‡æœ¬/è¢«æ‹¦â€é—®é¢˜ï¼ˆMIME ç±»å‹ï¼‰

å¦‚æœæ§åˆ¶å°å‡ºç°â€œå› ä¸º MIME type ä¸æ˜¯ javascript è¢«æ‹’ç»æ‰§è¡Œâ€ï¼Œåœ¨å®å¡”ç«™ç‚¹çš„ **Nginx é…ç½®æ–‡ä»¶**é‡ŒåŠ ä¸€æ®µï¼ˆé€šå¸¸å…¨å±€éƒ½æœ‰ï¼Œå°‘æ•°ç¯å¢ƒç¼ºå¤±ï¼‰ï¼š

```nginx
types {
  application/javascript  js mjs;
  text/css                css;
  font/woff               woff;
  font/woff2              woff2;
}
```

ä¿å­˜å **é‡è½½ Nginx**ã€‚

* * *

## 4ï¼‰å¦‚æœä½ å¼€äº† HTTPSï¼šæ£€æŸ¥â€œæ··åˆå†…å®¹â€æ˜¯å¦æŠŠ JS æ‹¦äº†

å¦‚æœä½ é¡µé¢æ˜¯ `https://`ï¼Œä½† `index.html` é‡Œæœ‰è„šæœ¬/èµ„æºæ˜¯ `http://`ï¼Œæµè§ˆå™¨ä¼šç›´æ¥æ‹¦æ‰ï¼Œå¯¼è‡´å‰ç«¯ä¸æ‰§è¡Œã€‚

âœ… ä¿®æ³•ï¼š

*   ç»Ÿä¸€æ”¹æˆ `https://` æˆ–è€… `//` æˆ–ç›¸å¯¹è·¯å¾„ `./js/...`

*   * *

## 5ï¼‰ä¸€å¥è¯åˆ¤æ–­ä½ å½“å‰æ˜¯å“ªç§é—®é¢˜

ä½ ç°åœ¨è¿™ç§â€œæ¨¡æ¿å˜é‡ç›´æ¥æ˜¾ç¤ºâ€çš„ç°è±¡ï¼Œ**99% æ˜¯ä¸‹é¢ä¸¤ä»¶å…¶ä¸€**ï¼š

*   èµ„æºè·¯å¾„ä¸å¯¹ â†’ JS 404

*   JS è¢«æµè§ˆå™¨æ‹¦/æ‰§è¡ŒæŠ¥é”™ â†’ æ²¡æ¸²æŸ“

*   * *

å¦‚æœä½ æ„¿æ„è´´ä¸€ä¸‹ï¼ˆå¤åˆ¶æ–‡å­—å°±è¡Œï¼Œä¸ç”¨æˆªå›¾ï¼‰ï¼š

*   æ§åˆ¶å° Console çš„ç¬¬ä¸€æ¡çº¢è‰²æŠ¥é”™

*   æˆ– Network é‡Œä»»æ„ä¸€ä¸ª `.js` è¯·æ±‚çš„çŠ¶æ€ç ï¼ˆ200/404/â€¦ï¼‰å’Œ URL

æˆ‘å°±èƒ½ç›´æ¥å‘Šè¯‰ä½ æ˜¯ **è·¯å¾„é—®é¢˜ / MIME é—®é¢˜ / HTTPS æ··åˆå†…å®¹ / è„šæœ¬æœ¬èº«æŠ¥é”™**ï¼Œå¹¶ç»™ä½ å¯¹åº”çš„å®å¡”æ”¹æ³•ã€‚

## Q: 


## A: 

çœ‹åˆ°æŠ¥é”™å°±å¯¹ä¸Šäº†ï¼š**ä¸æ˜¯ä¹±ç **ï¼Œæ˜¯ä½ ç«™ç‚¹çš„ **CSPï¼ˆContent Security Policyï¼‰æŠŠ JS é‡Œçš„ `eval` ç¦æ‰äº†**ï¼Œå¯¼è‡´è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œæ‰€ä»¥é¡µé¢æ²¡æ¸²æŸ“ï¼Œæ¨¡æ¿ `{{ }}` å°±åŸæ ·éœ²å‡ºæ¥ã€‚

æˆªå›¾é‡Œä¸¤æ¡ä¿¡æ¯åˆ†åˆ«æ˜¯ï¼š

1.  `Content Security Policy ... blocks the use of 'eval' in JavaScript` âœ… æ ¹å› 

2.  `Verify stylesheet URLs` è¯´æ˜è¿˜æœ‰ CSS/å­—ä½“é“¾æ¥å¯èƒ½ä¹Ÿæœ‰é—®é¢˜ï¼ˆæ¬¡è¦ï¼‰

* * *

## è§£å†³æ–¹æ¡ˆï¼ˆå®å¡”é¢æ¿é‡Œæ”¹ï¼ŒäºŒé€‰ä¸€ï¼‰

### æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šå»æ‰/æ”¾å®½ CSP é‡Œå¯¹ eval çš„é™åˆ¶

ä½ éœ€è¦å…è®¸ `unsafe-eval`ï¼ˆä»¥åŠå¤šæ•°å‰ç«¯è¿˜éœ€è¦ `unsafe-inline`ï¼Œçœ‹ä½ é¡¹ç›®æƒ…å†µï¼‰ã€‚

åœ¨å®å¡”ï¼š

*   ç½‘ç«™ â†’ ä½ çš„ç«™ç‚¹ â†’ **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶ï¼ˆNginxï¼‰**

*   åœ¨ `server { ... }` é‡Œæ‰¾æœ‰æ²¡æœ‰ç±»ä¼¼ï¼š

    *   `add_header Content-Security-Policy "...";`

    *   æˆ–è€…åœ¨åä»£/å®‰å…¨æ’ä»¶é‡Œè®¾ç½®äº† CSP

æŠŠå®ƒæ”¹æˆï¼ˆç¤ºä¾‹ï¼‰ï¼š

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;" always;
```

ç„¶å **é‡è½½ Nginx**ã€‚

> å¦‚æœä½ åŸæ¥å·²ç»æœ‰ä¸€æ¡ CSPï¼Œå°±åœ¨åŸæ¥çš„ `script-src` é‡ŒåŠ ä¸Š `'unsafe-eval'` å³å¯ï¼Œä¸ç”¨æ•´æ¡æ›¿æ¢ã€‚

* * *

### æ–¹æ¡ˆ Bï¼šç›´æ¥å–æ¶ˆ CSP Headerï¼ˆæœ€çœäº‹ï¼Œä½†å®‰å…¨æ€§æœ€å¼±ï¼‰

å¦‚æœä½ åªæ˜¯ä¸´æ—¶å±•ç¤º/å†…ç½‘ç”¨ï¼Œç›´æ¥æŠŠé‚£æ¡ï¼š

```nginx
add_header Content-Security-Policy ...
```

æ³¨é‡Šæˆ–åˆ æ‰ï¼Œç„¶åé‡è½½ Nginxã€‚

* * *

## CSP æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿï¼ˆå®å¡”å¸¸è§æ¥æºï¼‰

*   ä½ æ‰‹åŠ¨åœ¨ Nginx é…ç½®é‡ŒåŠ è¿‡ `add_header Content-Security-Policy`

*   å®å¡”çš„â€œå®‰å…¨/é˜²è·¨ç«™/é˜²ç¯¡æ”¹/åŠ å›ºâ€ç±»æ’ä»¶å¯èƒ½è‡ªåŠ¨åŠ äº†

*   ä½ å‰é¢å¥—äº† CDN/WAFï¼ˆæ¯”å¦‚ Cloudflareï¼‰ä¹Ÿå¯èƒ½ä¸‹å‘ CSPï¼ˆè¿™æ—¶æ”¹å®å¡”ä¸ç”Ÿæ•ˆï¼‰

**éªŒè¯æ˜¯ä¸æ˜¯å®å¡”ä¸‹å‘çš„ï¼š**  
F12 â†’ Network â†’ ç‚¹å¼€ä½ çš„é¡µé¢è¯·æ±‚ï¼ˆDocï¼‰â†’ Response Headers  
çœ‹ `content-security-policy` æ˜¯ä¸æ˜¯åœ¨å“åº”å¤´é‡Œï¼Œä»¥åŠå…·ä½“å†…å®¹ã€‚

* * *

## é¡ºæ‰‹æŠŠç¬¬äºŒä¸ª â€œVerify stylesheet URLsâ€ ä¹Ÿå¤„ç†æ‰

æ”¹å®Œ CSP åï¼Œå¦‚æœè¿˜æœ‰æ ·å¼/å­—ä½“ 404ï¼Œä½ å†å» Network æ£€æŸ¥ï¼š

*   `.css` æ˜¯å¦ 200

*   `.woff2/.woff` æ˜¯å¦ 200

*   è‹¥æœ‰ 404ï¼šå°±æ˜¯è·¯å¾„/ç›®å½•é—®é¢˜ï¼ˆæ ¹ç›®å½•å±‚çº§ä¸å¯¹æˆ–ç”¨äº† `/css/...` ç»å¯¹è·¯å¾„ï¼‰

*   * *

ä½ æŠŠ **Response Headers é‡Œçš„ `content-security-policy` é‚£ä¸€æ•´è¡Œ** å¤åˆ¶ç»™æˆ‘ï¼ˆæˆ–å‘Šè¯‰æˆ‘ä½ æœ‰æ²¡æœ‰ CDN/WAFï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠ CSP ç²¾å‡†æ”¹åˆ°â€œåˆšå¥½èƒ½è·‘ã€åˆä¸é‚£ä¹ˆæ¾â€ã€‚

## Q: 

add_header Strict-Transport-Security "max-age=31536000";

## A: 

ä½ è´´çš„è¿™å¥ï¼š

```nginx
add_header Strict-Transport-Security "max-age=31536000";
```

è¿™æ˜¯ **HSTSï¼ˆå¼ºåˆ¶æµè§ˆå™¨ç”¨ HTTPSï¼‰**ï¼Œ**è·Ÿä½ æŠ¥çš„ CSP ç¦ `eval` æ²¡å…³ç³»**ï¼Œå®ƒä¸ä¼šå¯¼è‡´ `eval` è¢«æ‹¦ã€‚

ä½ ç°åœ¨çœŸæ­£éœ€è¦å¤„ç†çš„æ˜¯å“åº”å¤´é‡Œæœ‰æ²¡æœ‰ **Content-Security-Policy**ï¼Œä¸€èˆ¬é•¿è¿™æ ·ï¼š

```nginx
add_header Content-Security-Policy "...";
```

## ä½ åœ¨å®å¡”é‡Œè¿™æ ·æ”¹ï¼ˆç›´æ¥ç…§åšï¼‰

1.  å®å¡” â†’ **ç½‘ç«™** â†’ ä½ çš„ç«™ç‚¹ â†’ **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶ï¼ˆNginxï¼‰**

2.  åœ¨é…ç½®é‡Œæœç´¢ï¼š`Content-Security-Policy` æˆ– `CSP`

    *   å¦‚æœæ‰¾åˆ°äº†ï¼Œè¯´æ˜æ˜¯ç«™ç‚¹é…ç½®ä¸‹å‘çš„ CSP

### ä¿®å¤æ–¹å¼ï¼ˆæœ€ç›´æ¥èƒ½è·‘ï¼‰

æŠŠ CSP çš„ `script-src` å¢åŠ  `'unsafe-eval'`ï¼ˆå¿…è¦æ—¶ä¹ŸåŠ  `'unsafe-inline'`ï¼‰ï¼š

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;" always;
```

> å¦‚æœä½ å·²ç»æœ‰ä¸€æ¡ CSPï¼Œå°±ä¸è¦é‡å¤åŠ ä¸¤æ¡ï¼ˆä¼šæ‰“æ¶ï¼‰ï¼›åœ¨åŸæ¥çš„ `script-src` é‡Œé¢åŠ  `'unsafe-eval'` å°±è¡Œã€‚

3.  ä¿å­˜ â†’ **é‡è½½ Nginx**

* * *

## å¦‚æœä½ åœ¨ç«™ç‚¹é…ç½®é‡Œæœä¸åˆ° CSP

é‚£ CSP å¯èƒ½æ¥è‡ªï¼š

*   å®å¡”çš„å®‰å…¨/åŠ å›ºæ’ä»¶

*   CDN/WAFï¼ˆä¾‹å¦‚ Cloudflareï¼‰ä¸‹å‘çš„å“åº”å¤´

*   ä¸Šå±‚ Nginx ä¸»é…ç½®ï¼ˆä¸æ˜¯ç«™ç‚¹é…ç½®ï¼‰

### å¿«é€Ÿç¡®è®¤æ–¹æ³•ï¼ˆä¸ç”¨çŒœï¼‰

æµè§ˆå™¨ F12 â†’ **Network** â†’ ç‚¹å¼€ä¸»æ–‡æ¡£ï¼ˆDocï¼‰â†’ **Response Headers**  
æŠŠé‡Œé¢è¿™ä¸€è¡Œå¤åˆ¶å‡ºæ¥ç»™æˆ‘ï¼š

*   `content-security-policy: ...`

æˆ‘å°±èƒ½å‘Šè¯‰ä½ åº”è¯¥åœ¨å®å¡”å“ªä¸€å±‚æ”¹ã€è¯¥æ€ä¹ˆæ”¹ï¼ˆåªæ”¹åˆ°èƒ½ç”¨çš„æœ€å°æƒé™ï¼‰ã€‚

## Q: 

server { listen 80; listen 443 ssl; http2 on; listen 14001; server_name yys.im 74.48.175.131; index index.php index.html index.htm default.php default.htm default.html; root /www/wwwroot/yys.im; #CERT-APPLY-CHECK--START # ç”¨äºSSLè¯ä¹¦ç”³è¯·æ—¶çš„æ–‡ä»¶éªŒè¯ç›¸å…³é…ç½® -- è¯·å‹¿åˆ é™¤ include /www/server/panel/vhost/nginx/well-known/yys.im.conf; #CERT-APPLY-CHECK--END #SSL-START SSLç›¸å…³é…ç½®ï¼Œè¯·å‹¿åˆ é™¤æˆ–ä¿®æ”¹ä¸‹ä¸€è¡Œå¸¦æ³¨é‡Šçš„404è§„åˆ™ #error_page 404/404.html; #HTTP_TO_HTTPS_START if ($server_port !~ 443){ rewrite ^(/.\*)$ https://$host$1 permanent; } #HTTP_TO_HTTPS_END ssl_certificate /www/server/panel/vhost/cert/yys.im/fullchain.pem; ssl_certificate_key /www/server/panel/vhost/cert/yys.im/privkey.pem; ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3; ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5; ssl_prefer_server_ciphers on; ssl_session_tickets on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; add_header Strict-Transport-Security "max-age=31536000"; error_page 497 https://$host$request_uri; #SSL-END #ERROR-PAGE-START é”™è¯¯é¡µé…ç½®ï¼Œå¯ä»¥æ³¨é‡Šã€åˆ é™¤æˆ–ä¿®æ”¹ error_page 404 /404.html; #error_page 502 /502.html; #ERROR-PAGE-END #PHP-INFO-START PHPå¼•ç”¨é…ç½®ï¼Œå¯ä»¥æ³¨é‡Šæˆ–ä¿®æ”¹ include enable-php-80.conf; #PHP-INFO-END #REWRITE-START URLé‡å†™è§„åˆ™å¼•ç”¨,ä¿®æ”¹åå°†å¯¼è‡´é¢æ¿è®¾ç½®çš„ä¼ªé™æ€è§„åˆ™å¤±æ•ˆ include /www/server/panel/vhost/rewrite/yys.im.conf; #REWRITE-END #ç¦æ­¢è®¿é—®çš„æ–‡ä»¶æˆ–ç›®å½• location ~ ^/(\\.user.ini|\\.htaccess|\\.git|\\.env|\\.svn|\\.project|LICENSE|README.md) { return 404; } #ä¸€é”®ç”³è¯·SSLè¯ä¹¦éªŒè¯ç›®å½•ç›¸å…³è®¾ç½® location ~ \\.well-known{ allow all; } #ç¦æ­¢åœ¨è¯ä¹¦éªŒè¯ç›®å½•æ”¾å…¥æ•æ„Ÿæ–‡ä»¶ if ( $uri ~ "^/\\.well-known/.\*\\.(php|jsp|py|js|css|lua|ts|go|zip|tar\\.gz|rar|7z|sql|bak)$" ) { return 403; } location ~ .\*\\.(gif|jpg|jpeg|png|bmp|swf)$ { expires 30d; error_log /dev/null; access_log /dev/null; } location ~ .\*\\.(js|css)?$ { expires 12h; error_log /dev/null; access_log /dev/null; } access_log /www/wwwlogs/yys.im.log; error_log /www/wwwlogs/yys.im.error.log; }é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰

## A: 

ä½ è¿™ä»½ç«™ç‚¹é…ç½®é‡Œç¡®å®**æ²¡æœ‰** `Content-Security-Policy`ï¼Œæ‰€ä»¥ç°åœ¨åªæœ‰ä¸¤ç§å¯èƒ½ï¼š

## 1) CSP æ˜¯åœ¨â€œæ›´ä¸Šå±‚â€åŠ çš„ï¼ˆå®å¡”/Nginx å…¨å±€æˆ–å…¶å®ƒ includeï¼‰

ä½ è¿™ä»½é…ç½®é‡Œæœ‰ä¸¤å¤„ `include`ï¼ŒCSP å¾ˆå¯èƒ½è—åœ¨é‡Œé¢æˆ–ä¸»é…ç½®é‡Œï¼š

*   `/www/server/panel/vhost/rewrite/yys.im.conf`

*   `/www/server/panel/vhost/nginx/well-known/yys.im.conf`

*   ä»¥åŠä½ æœåŠ¡å™¨çš„å…¨å±€ Nginxï¼š`/www/server/nginx/conf/nginx.conf` æˆ– `/www/server/nginx/conf/enable-php-80.conf` ä¹Ÿå¯èƒ½åŠ  header

### ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šå…¨å±€æœä¸€ä¸‹ï¼ˆæœ€å¿«æœ€å‡†ï¼‰

SSH æ‰§è¡Œï¼š

```bash
grep -R "Content-Security-Policy" -n /www/server/nginx/conf /www/server/panel/vhost
```

å¦‚æœæœåˆ°äº†æ˜¯å“ªä¸€ä¸ªæ–‡ä»¶åŠ çš„ï¼Œå°±åœ¨é‚£ä¸€è¡ŒæŠŠ CSP æ”¹æ‰ï¼ˆåœ¨ `script-src` é‡ŒåŠ  `'unsafe-eval'`ï¼‰ï¼Œæˆ–è€…å…ˆæ³¨é‡Šæ‰éªŒè¯ã€‚

* * *

## 2) CSP ä¸æ˜¯ Nginx åŠ çš„ï¼Œè€Œæ˜¯â€œå‰ç«¯é¡µé¢è‡ªå·±åŠ çš„â€

æœ‰äº›é¡¹ç›®ä¼šåœ¨ `index.html` é‡Œå†™ï¼š

```html
<meta http-equiv="Content-Security-Policy" content="...">
```

è¿™ä¹Ÿä¼šè§¦å‘åŒæ ·çš„é”™è¯¯ã€‚

### æ£€æŸ¥æ–¹æ³•

æ‰“å¼€ä½ ç«™ç‚¹çš„ `index.html` æœï¼š

```bash
grep -n "Content-Security-Policy" -n /www/wwwroot/yys.im/index.html
```

å¦‚æœå­˜åœ¨ï¼Œå°±æ”¹ meta é‡Œçš„ `script-src` åŠ ä¸Š `'unsafe-eval'`ï¼Œæˆ–è€…åˆ æ‰è¿™ä¸ª metaï¼ˆå…ˆè·‘èµ·æ¥å†è¯´ï¼‰ã€‚

* * *

## ä½ ç°åœ¨å¯ä»¥ç›´æ¥è¿™æ ·ä¸´æ—¶â€œæ”¾è¡Œâ€è®©å®ƒå…ˆè·‘èµ·æ¥

æ— è®º CSP åœ¨å“ªï¼Œåªè¦ä½ æ‰¾åˆ°å®ƒï¼ŒæŠŠ script-src æ”¹æˆå…è®¸ evalï¼š

**ç¤ºä¾‹ï¼š**

```nginx
script-src 'self' 'unsafe-inline' 'unsafe-eval';
```

> æ³¨æ„ï¼š`unsafe-eval` ä¼šé™ä½å®‰å…¨æ€§ã€‚è¿™ä¸ªé¡¹ç›®å¦‚æœåªæ˜¯è‡ªå·±ç”¨/å±•ç¤ºï¼Œé—®é¢˜ä¸å¤§ï¼›å¦‚æœæ˜¯å¯¹å…¬ç½‘ã€è¿˜å¸¦ç”¨æˆ·è¾“å…¥ï¼Œå»ºè®®åç»­å†æ”¶ç´§ã€‚

* * *

## å¦å¤–ï¼šä½ è¿™ä¸ªç«™ç‚¹ç°åœ¨è¿˜åœ¨è·‘ PHPï¼ˆä¸å»ºè®®ï¼‰

ä½ æ˜¯çº¯é™æ€é¡¹ç›®ï¼Œå´ `include enable-php-80.conf;`ï¼Œè™½ç„¶ä¸ä¸€å®šå¯¼è‡´ CSPï¼Œä½†ä¼šå¼•å…¥é¢å¤–é…ç½®ã€ä¹Ÿå¯èƒ½å¸¦æ¥å®‰å…¨å¤´/è§„åˆ™ã€‚

âœ… å»ºè®®ï¼ˆéƒ¨ç½²ç¨³å®šåå†åšä¹Ÿè¡Œï¼‰ï¼š

*   å®å¡”ç«™ç‚¹è®¾ç½®é‡ŒæŠŠ PHP å…³æ‰ï¼ˆçº¯é™æ€ï¼‰

*   æˆ–æ³¨é‡Šæ‰ `include enable-php-80.conf;`

*   * *

æŠŠä½ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `grep -R "Content-Security-Policy"...` çš„è¾“å‡ºï¼ˆå‡ºç°çš„æ–‡ä»¶è·¯å¾„å’Œé‚£è¡Œå†…å®¹ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å°±èƒ½å‘Šè¯‰ä½ è¯¥æ”¹å“ªä¸€è¡Œã€æ€ä¹ˆæ”¹æœ€å°èŒƒå›´åœ°è§£å†³ `eval` è¢«æ‹¦çš„é—®é¢˜ã€‚

## Q: 

<meta http-equiv="X-UA-Compatible" content="IE=edge">


## A: 

è¿™è¡Œï¼š

```html
<meta http-equiv="X-UA-Compatible" content="IE=edge">
```

**ä¸æ˜¯ CSP**ï¼Œå®ƒåªæ˜¯å‘Šè¯‰æµè§ˆå™¨ç”¨æœ€æ–°ç‰ˆæ¸²æŸ“ï¼ˆä¸»è¦ç»™è€ IE ç”¨ï¼‰ï¼Œè·Ÿä½ æŠ¥çš„â€œCSP ç¦ evalâ€å®Œå…¨æ— å…³ã€‚

ä½ è¦æ‰¾çš„æ˜¯ä¸‹é¢è¿™ç§æ‰ä¼šå½±å“ `eval`ï¼š

```html
<meta http-equiv="Content-Security-Policy" content="...">
```

* * *

## ä½ ç°åœ¨åº”è¯¥æ€ä¹ˆåšï¼ˆç›´æ¥å®šä½ CSP åˆ°åº•ä»å“ªæ¥ï¼‰

### 1ï¼‰å…ˆåœ¨æµè§ˆå™¨ç¡®è®¤ CSP åˆ°åº•é•¿ä»€ä¹ˆæ ·ï¼ˆæœ€é è°±ï¼‰

F12 â†’ **Network** â†’ ç‚¹æœ€ä¸Šé¢çš„ **Docï¼ˆindex.htmlï¼‰** â†’ **Response Headers**  
æ‰¾åˆ°è¿™ä¸€è¡Œå¹¶å¤åˆ¶å‡ºæ¥ï¼ˆæœ€å…³é”®ï¼‰ï¼š

*   `content-security-policy: ...`

åªè¦æ‹¿åˆ°è¿™ä¸€è¡Œï¼Œæˆ‘ä»¬å°±èƒ½ç«‹åˆ»åˆ¤æ–­å®ƒæ˜¯ä» Nginx/CDN/é¢æ¿æ’ä»¶æ¥çš„ã€‚

* * *

## 2ï¼‰å¦‚æœä½ æ–¹ä¾¿ SSHï¼Œä¸ŠæœåŠ¡å™¨ä¸€æ¡å‘½ä»¤å…¨å±€æœ CSPï¼ˆæ¯”çŒœå¿«ï¼‰

```bash
grep -R "Content-Security-Policy" -n /www/server/nginx/conf /www/server/panel/vhost /www/wwwroot/yys.im
```

*   å¦‚æœæœåˆ°æŸä¸ªæ–‡ä»¶é‡Œæœ‰ `Content-Security-Policy` æˆ– `add_header ...`ï¼Œå°±æ˜¯å®ƒåœ¨ä¸‹å‘ã€‚

*   å¦‚æœå®Œå…¨æœä¸åˆ°ï¼Œä½†æµè§ˆå™¨ Response Headers é‡Œç¡®å®æœ‰ CSPï¼Œé‚£åŸºæœ¬å°±æ˜¯ **CDN/WAF** åœ¨åŠ ï¼ˆæ¯”å¦‚ Cloudflare ä¹‹ç±»ï¼‰ã€‚

*   * *

## 3ï¼‰ä¿®å¤åŸåˆ™ï¼ˆä½ è¿™ä¸ªé¡¹ç›®éœ€è¦å…è®¸ evalï¼‰

ä½ è¿™ä¸ªé¡¹ç›®çš„ JS ç”¨åˆ°äº† `eval`ï¼ˆæ‰€ä»¥æŠ¥é”™ï¼‰ï¼Œè¦è·‘èµ·æ¥å¿…é¡»æ»¡è¶³å…¶ä¸€ï¼š

*   CSP çš„ `script-src` åŠ ä¸Š `'unsafe-eval'`

*   æˆ–è€…æ¢/é‡æ„å‰ç«¯ä»£ç è®©å®ƒä¸ä¾èµ– evalï¼ˆä¸€èˆ¬ä¸ç°å®ï¼‰

*   * *

### ç«‹åˆ»èƒ½ç”¨çš„æœ€ç»ˆä¿®å¤ç¤ºä¾‹ï¼ˆå¦‚æœ CSP åœ¨ Nginxï¼‰

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;" always;
```

* * *

ä½ ç°åœ¨æŠŠ **Response Headers é‡Œé‚£æ¡ `content-security-policy:`** åŸæ ·è´´å‡ºæ¥å°±è¡Œï¼ˆä¸€æ•´è¡Œï¼‰ï¼Œæˆ‘å°±èƒ½ç›´æ¥å‘Šè¯‰ä½ ï¼šåº”è¯¥æ”¹å®å¡”å“ªä¸€å¤„/å“ªä¸€ä¸ªæ–‡ä»¶ï¼Œä»¥åŠåªéœ€è¦åŠ å“ªäº›å­—æ®µå°±èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚

## Q: 

åœ¨å“ª

## A: 

åœ¨ä½ è¿™å¼ å›¾é‡Œï¼Œé—®é¢˜**å·²ç»ä¸æ˜¯ CSP äº†**ï¼ˆCSP é‚£æ¡åº”è¯¥æ˜¯ä¹‹å‰çš„æŠ¥é”™/æˆ–å¦ä¸€ä¸ªé¡µé¢ï¼‰ï¼Œä½ ç°åœ¨çš„å…³é”®æ˜¯ **èµ„æº 404 å¯¼è‡´ Vue æ²¡åŠ è½½**ï¼Œæ‰€ä»¥æ‰å‡ºç°ï¼š

*   `GET .../document.css 404`

*   `GET https://yys.im/vue.2.6.11.min.js 404`

*   `Uncaught ReferenceError: Vue is not defined`

ä¹Ÿå°±æ˜¯è¯´ï¼š**é¡µé¢å¼•ç”¨çš„ Vue æ–‡ä»¶åœ°å€æ˜¯ `/vue.2.6.11.min.js`ï¼Œä½†ä½ æœåŠ¡å™¨æ ¹ç›®å½•ä¸‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶**ã€‚

* * *

## ä½ é—®â€œåœ¨å“ªâ€â€”â€”ç­”æ¡ˆï¼šåœ¨ Console é‡Œå·²ç»å‘Šè¯‰ä½ äº†

çœ‹ç¬¬äºŒæ¡çº¢å­—ï¼š

`GET https://yys.im/vue.2.6.11.min.js 404 (Not Found)`

è¿™è¯´æ˜ä½ çš„ `index.html` é‡Œå¤§æ¦‚ç‡æœ‰è¿™ä¸€è¡Œï¼ˆæˆ–ç±»ä¼¼ï¼‰ï¼š

```html
<script src="/vue.2.6.11.min.js"></script>
```

åŒç† CSS çš„ 404ï¼š

`GET https://yys.im/eva/eva-title-main/html/document.css 404`

è¯´æ˜ HTML é‡Œå¼•ç”¨äº†ï¼š

```html
<link rel="stylesheet" href="document.css">
```

ä½†ä½ å½“å‰è®¿é—®è·¯å¾„åœ¨ `/eva/eva-title-main/html/`ï¼ŒæœåŠ¡å™¨é‚£å±‚å¹¶æ²¡æœ‰ `document.css`ã€‚

* * *

## ç«‹åˆ»ä¿®å¤ï¼ˆæŒ‰ä½ å½“å‰è¿™ä¸ªè®¿é—®è·¯å¾„æ¥ï¼‰

ä½ ç°åœ¨è®¿é—®çš„æ˜¯ï¼š  
`https://yys.im/eva/eva-title-main/html/`

æ‰€ä»¥ä½ è¦ä¹ˆï¼š

### æ–¹æ¡ˆ Aï¼ˆæœ€æ¨èï¼‰ï¼šæŠŠç«™ç‚¹æ ¹ç›®å½•ç›´æ¥æŒ‡åˆ° `.../html`

å®å¡” â†’ ç½‘ç«™ â†’ è®¾ç½® â†’ ç½‘ç«™ç›®å½•  
æŠŠæ ¹ç›®å½•è®¾ä¸ºï¼ˆä¸¾ä¾‹ï¼‰ï¼š  
`/www/wwwroot/yys.im/eva/eva-title-main/html`

è¿™æ ·ä½ è®¿é—®ï¼š  
`https://yys.im/`  
å°±ä¼šæ­£ç¡®åŠ è½½ï¼š

*   `document.css`

*   `document.js`

*   å„ç§å­—ä½“/js

åŒæ—¶ `/vue.2.6.11.min.js` å¦‚æœé¡¹ç›®é‡Œå¸¦äº†ï¼Œå°±è¦æ”¾åœ¨è¿™ä¸ªæ ¹ç›®å½•åŒçº§ã€‚

### æ–¹æ¡ˆ Bï¼šä¸æ”¹æ ¹ç›®å½•ï¼Œæ”¹å¼•ç”¨è·¯å¾„ï¼ˆæ›´éº»çƒ¦ï¼‰

æŠŠ `index.html` é‡Œè¿™äº›è·¯å¾„æ”¹æˆâ€œæ­£ç¡®çš„ç›¸å¯¹/ç»å¯¹è·¯å¾„â€ï¼š

*   `src="/vue.2.6.11.min.js"` æ”¹æˆ `src="./js/vue.2.6.11.min.js"`ï¼ˆå‰ææ˜¯ä½ ç¡®å®æœ‰è¿™ä¸ªæ–‡ä»¶åœ¨ js ç›®å½•ï¼‰

*   `href="document.css"` æ”¹æˆ `href="./document.css"`ï¼ˆæˆ–æ­£ç¡®ä½ç½®ï¼‰

*   * *

## ä½ æ¥ä¸‹æ¥åªåšä¸€ä¸ªæ£€æŸ¥å°±èƒ½ç¡®å®šæ€ä¹ˆèµ°

åœ¨å®å¡”æ–‡ä»¶ç®¡ç†é‡Œï¼Œæ‰¾åˆ°ä½ ç°åœ¨è®¿é—®çš„ç›®å½•å¯¹åº”çš„ç‰©ç†è·¯å¾„ï¼Œç„¶åç¡®è®¤è¿™ä¸¤ä¸ªæ–‡ä»¶åˆ°åº•åœ¨å“ªé‡Œï¼š

*   `vue.2.6.11.min.js`

*   `document.css`

### å¿«é€Ÿæ‰¾æ–‡ä»¶ï¼ˆSSHï¼‰

```bash
cd /www/wwwroot/yys.im
find . -name "vue.2.6.11.min.js" -o -name "document.css"
```

*   å¦‚æœèƒ½æ‰¾åˆ°ï¼šæŠŠå®ƒä»¬æ”¾åˆ° `index.html` å¼•ç”¨çš„å¯¹åº”ä½ç½®ï¼ˆæˆ–æ”¹å¼•ç”¨ï¼‰

*   å¦‚æœæ‰¾ä¸åˆ° `vue.2.6.11.min.js`ï¼šè¯´æ˜ä½ æ¼ä¸Šä¼ äº†è¿™ä¸ªæ–‡ä»¶ï¼Œæˆ–é¡¹ç›®æœ¬æ¥ä¾èµ–å¤–éƒ¨ CDNï¼ˆä½†ä½ ç°åœ¨æŒ‡å‘äº†æœ¬åœ°æ ¹è·¯å¾„ï¼‰

*   * *

## é¡ºå¸¦è¯´ä¸€å¥ï¼šä½ ä¹‹å‰é—® CSP çš„ `eval`

å³ä½¿æŠŠ 404 ä¿®å¥½ï¼Œ**åé¢å¯èƒ½è¿˜ä¼šå†æ¬¡ç¢°åˆ° CSP/eval**ï¼ˆå› ä¸ºé¡¹ç›®åå°±å« eva-titleâ€¦å¸¸è§ç”¨ eval åšåŠ¨æ€å­—ä½“/æ¸²æŸ“ï¼‰ï¼Œä½†**ç°åœ¨ç¬¬ä¸€ä¼˜å…ˆæ˜¯æŠŠ Vue å’Œ CSS 404 è§£å†³**ï¼Œä¸ç„¶é¡µé¢æ ¹æœ¬è·‘ä¸èµ·æ¥ã€‚

å¦‚æœä½ æŠŠ `find` çš„è¾“å‡ºè´´å‡ºæ¥ï¼ˆæˆ–å‘Šè¯‰æˆ‘è¿™ä¸¤ä¸ªæ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šçš„å®é™…è·¯å¾„ï¼‰ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ ï¼šåº”è¯¥æ€ä¹ˆæ”¹æ ¹ç›®å½•/æ€ä¹ˆæ”¹ `index.html` çš„ä¸¤ä¸‰è¡Œå¼•ç”¨ï¼Œåšåˆ°ä¸€æ¬¡æå®šã€‚

## Q: 

githubä½œè€…ä¼¼ä¹æ²¡æœ‰ç»™å‡ºdocument.css

## A: 

å¯¹ï¼Œ**ä½ çš„å‹ç¼©åŒ…é‡Œç¡®å®æ²¡æœ‰ `document.css`**â€”â€”åªæœ‰ `document.less`ã€‚æ‰€ä»¥æµè§ˆå™¨å»è¯·æ±‚ `.../document.css` å°± 404 äº†ï¼›å¦å¤– `Vue` ä¹Ÿ 404 (`/vue.2.6.11.min.js` ä¸å­˜åœ¨)ï¼Œæ‰ä¼šå‡ºç° `Vue is not defined`ã€é¡µé¢æ¸²æŸ“å¤±è´¥ã€‚

ä½ ç°åœ¨è¦è¡¥é½ä¸¤æ ·ä¸œè¥¿ï¼š**document.css** å’Œ **vue.2.6.11.min.js**ã€‚

* * *

## 1ï¼‰ç”Ÿæˆ `document.css`ï¼ˆç”± `document.less` ç¼–è¯‘å‡ºæ¥ï¼‰

åœ¨æœåŠ¡å™¨ä¸Šè¿›åˆ°ä½ çš„ç›®å½•ï¼ˆæŒ‰ä½ æŠ¥é”™çš„è·¯å¾„ï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im/eva/eva-title-main/html
```

è£… less ç¼–è¯‘å™¨å¹¶ç”Ÿæˆ cssï¼š

```bash
npm i -g less
lessc document.less document.css
```

ç”Ÿæˆåç¡®è®¤æ–‡ä»¶å­˜åœ¨ï¼š

```bash
ls -la document.css
```

ç„¶ååˆ·æ–°é¡µé¢ï¼Œ`document.css` çš„ 404 å°±ä¼šæ¶ˆå¤±ã€‚

> å¦‚æœæœåŠ¡å™¨æ²¡è£… node/npmï¼šå®å¡”ã€Œè½¯ä»¶å•†åº—ã€è£…ä¸ª **Node.js ç‰ˆæœ¬ç®¡ç†å™¨**ï¼ˆæˆ–ç›´æ¥è£… Nodeï¼‰ï¼Œå†æ‰§è¡Œä¸Šé¢å‘½ä»¤ã€‚

* * *

## 2ï¼‰è§£å†³ Vue 404ï¼ˆä½ ç°åœ¨å¼•ç”¨çš„æ˜¯ `/vue.2.6.11.min.js`ï¼‰

ä½ é¡µé¢åœ¨è¯·æ±‚ï¼š  
`https://yys.im/vue.2.6.11.min.js`ï¼ˆæ³¨æ„æ˜¯åŸŸåæ ¹è·¯å¾„ï¼Œä¸æ˜¯ html ç›®å½•ï¼‰

### æ–¹æ¡ˆ Aï¼ˆæœ€å¿«ï¼‰ï¼šä¸‹è½½ Vue æ–‡ä»¶åˆ°ç½‘ç«™æ ¹ç›®å½•

æŠŠæ–‡ä»¶æ”¾åˆ°ï¼š  
`/www/wwwroot/yys.im/vue.2.6.11.min.js`

```bash
cd /www/wwwroot/yys.im
curl -L -o vue.2.6.11.min.js https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js
```

åˆ·æ–°é¡µé¢ï¼Œ`Vue is not defined` åº”è¯¥å°±æ²¡äº†ã€‚

### æ–¹æ¡ˆ Bï¼ˆæ›´ä¸å®¹æ˜“è¸©è·¯å¾„å‘ï¼‰ï¼šæ”¹æˆç›¸å¯¹è·¯å¾„å¹¶æ”¾åˆ° html ç›®å½•

ç¼–è¾‘ `/www/wwwroot/yys.im/eva/eva-title-main/html/index.html`ï¼š  
æŠŠ

```html
<script src="/vue.2.6.11.min.js"></script>
```

æ”¹æˆ

```html
<script src="./vue.2.6.11.min.js"></script>
```

ç„¶åæŠŠ Vue ä¸‹è½½åˆ° `html` ç›®å½•ï¼š

```bash
cd /www/wwwroot/yys.im/eva/eva-title-main/html
curl -L -o vue.2.6.11.min.js https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js
```

* * *

## 3ï¼‰ä½ ä¹‹å‰æåˆ°çš„ CSP ç¦ evalï¼šä¿®å®Œ 404 åå¯èƒ½è¿˜ä¼šå†å‡ºç°

è¿™ä¸ªé¡¹ç›®çš„ `ui-tabs.vue.js` è¿™ç§æ˜¯ `template: \`...\``ï¼ŒVue éœ€è¦ **ç¼–è¯‘æ¨¡æ¿**ï¼Œä¼šç”¨åˆ°` new Function\`ï¼ˆç­‰ä»·äº evalï¼‰ï¼Œå¦‚æœä½ æœ‰ CSPï¼Œä¼šå†æ¬¡æŠ¥ â€œblocks the use of 'eval'â€ã€‚

å¦‚æœä½ æŠŠ Vue/CSS 404 ä¿®å¥½ååˆå‡ºç° CSP æŠ¥é”™ï¼Œé‚£å°±éœ€è¦åœ¨ CSP é‡Œæ”¾è¡Œ `'unsafe-eval'`ï¼ˆæˆ–ç§»é™¤ CSPï¼‰ã€‚åˆ°æ—¶æŠŠé‚£æ¡ CSP å¤´è´´å‡ºæ¥æˆ‘ç»™ä½ ç²¾ç¡®æ”¹æ³•ã€‚

* * *

ä½ å…ˆåšå®Œ **(1) lessc ç”Ÿæˆ document.css** + **(2) ä¸‹è½½ vue.min.js**ï¼Œç„¶åå†æˆªå›¾ä¸€æ¬¡ Consoleï¼ˆçœ‹è¿˜æœ‰æ²¡æœ‰çº¢å­—ï¼‰ï¼Œæˆ‘å°±èƒ½ç»§ç»­å¸®ä½ æŠŠå‰©ä¸‹çš„ä¸€æ¬¡æ€§æ¸…å¹²å‡€ã€‚

## Q: 

root@racknerd-d898d1b:~# cd /www/wwwroot/yys.im/eva/eva-title-main/html -bash: cd: /www/wwwroot/yys.im/eva/eva-title-main/html: No such file or directory

## A: 

ä½ è¿™ä¸ªæŠ¥é”™è¯´æ˜ä¸€ä»¶äº‹ï¼š**ä½ æµè§ˆå™¨é‡Œçœ‹åˆ°çš„ URL è·¯å¾„** `https://yys.im/eva/eva-title-main/html/...` å¹¶ä¸ç­‰äºæœåŠ¡å™¨çš„çœŸå®æ–‡ä»¶è·¯å¾„ï¼ˆæˆ–è€…ä½ æ ¹æœ¬æ²¡æŠŠæ–‡ä»¶æ”¾åœ¨è¿™ä¸ªä½ç½®ï¼‰ã€‚æ‰€ä»¥å…ˆåˆ«æ€¥ç€ç¼–è¯‘ lessï¼Œæˆ‘ä»¬å…ˆæŠŠâ€œæ–‡ä»¶åˆ°åº•åœ¨å“ªâ€å®šä½å‡ºæ¥ã€‚

* * *

## 1ï¼‰å…ˆåœ¨æœåŠ¡å™¨ä¸ŠæŠŠé¡¹ç›®ç›®å½•æ‰¾å‡ºæ¥ï¼ˆç›´æ¥æœ index.html / document.lessï¼‰

åœ¨ SSH é‡Œæ‰§è¡Œï¼š

```bash
cd /www/wwwroot/yys.im
find . -maxdepth 6 -name "index.html" | head
```

å†æœä¸€ä¸‹ `document.less`ï¼ˆä½ è¯´ä½œè€…åªæœ‰ less æ²¡ cssï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im
find . -maxdepth 8 -name "document.less" -o -name "document.css"
```

è¿™ä¸¤æ¡ä¼šç›´æ¥å‘Šè¯‰ä½ ï¼šé¡¹ç›®çœŸå®æ”¾åœ¨ `/www/wwwroot/yys.im` ä¸‹çš„å“ªä¸ªå­ç›®å½•ã€‚

* * *

## 2ï¼‰ä½ ç°åœ¨é¡µé¢è¯·æ±‚çš„è·¯å¾„ä¸ºä»€ä¹ˆæ˜¯ `/eva/eva-title-main/html/...`ï¼Ÿ

è¿™é€šå¸¸æœ‰ä¸¤ç§åŸå› ï¼š

### æƒ…å†µ Aï¼šä½ ç½‘ç«™æ ¹ç›®å½•ä¸æ˜¯ `/www/wwwroot/yys.im`

å®å¡”é‡Œå¯èƒ½è®¾ç½®æˆåˆ«çš„æ ¹ç›®å½•äº†ã€‚  
åœ¨å®å¡”ï¼šç½‘ç«™ â†’ ç«™ç‚¹ â†’ è®¾ç½® â†’ ç½‘ç«™ç›®å½•ï¼Œç¡®è®¤æ ¹ç›®å½•ã€‚

### æƒ…å†µ Bï¼šä½ æ˜¯æŠŠ zip è§£å‹åˆ°åˆ«çš„åœ°æ–¹äº†

æ¯”å¦‚è§£å‹åˆ°äº†ï¼š

*   `/www/wwwroot/yys.im/eva-title-main/html`

*   `/www/wwwroot/yys.im/html`

*   `/www/wwwroot/yys.im/eva/xxx/...`

æ‰€ä»¥ä½  `cd` é‚£ä¸ªè·¯å¾„æ‰ä¸å­˜åœ¨ã€‚

* * *

## 3ï¼‰ç¡®è®¤çœŸå®ç›®å½•åï¼Œå†åšä¸¤ä»¶äº‹ï¼ˆä¿® 404ï¼‰

ä¸€æ—¦ä½ æ‰¾åˆ°äº†çœŸæ­£çš„ `html` ç›®å½•ï¼ˆé‡Œé¢æœ‰ `index.html` å’Œ `document.less`ï¼‰ï¼Œå°±è¿›å…¥é‚£ä¸ªç›®å½•ï¼š

```bash
cd /www/wwwroot/yys.im/ï¼ˆè¿™é‡Œæ¢æˆ find å‡ºæ¥çš„çœŸå®è·¯å¾„ï¼‰
ls
```

ç„¶åï¼š

### A. ç¼–è¯‘ `document.less` â†’ `document.css`

```bash
npm -v || node -v
```

å¦‚æœ node/npm å­˜åœ¨ï¼š

```bash
npm i -g less
lessc document.less document.css
```

### B. è§£å†³ Vue 404

ä½ ç°åœ¨é¡µé¢è¯·æ±‚çš„æ˜¯ `https://yys.im/vue.2.6.11.min.js`ï¼ˆåŸŸåæ ¹è·¯å¾„ï¼‰ï¼Œæ‰€ä»¥æœ€çœäº‹æ˜¯ç›´æ¥æ”¾åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼š

```bash
cd /www/wwwroot/yys.im
curl -L -o vue.2.6.11.min.js https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js
```

* * *

## 4ï¼‰åˆ«è¸©å‘ï¼šä½ çš„ URL è·¯å¾„å’Œæ–‡ä»¶è·¯å¾„è¦å¯¹åº”

ä½ ç°åœ¨ URL æ˜¯ï¼š`/eva/eva-title-main/html/xxx`  
åªæœ‰å½“æœåŠ¡å™¨ä¸ŠçœŸå®å­˜åœ¨ï¼š  
`/www/wwwroot/yys.im/eva/eva-title-main/html/xxx`  
å®ƒæ‰ä¼š 200ã€‚

æ‰€ä»¥å…ˆæŠŠ `find` çš„ç»“æœè´´å‡ºæ¥ï¼ˆä¸¤æ¡å‘½ä»¤çš„è¾“å‡ºï¼‰ï¼Œæˆ‘å°±èƒ½å‘Šè¯‰ä½ ï¼š

*   ä½ æ–‡ä»¶å®é™…åœ¨å“ªä¸ªç›®å½•

*   å®å¡”æ ¹ç›®å½•åº”è¯¥æ€ä¹ˆæŒ‡

*   è¯¥åœ¨å“ªä¸ªç›®å½•ç¼–è¯‘ `document.less`

*   ä»¥åŠ Vue æ–‡ä»¶æ”¾å“ªé‡Œæœ€åˆé€‚

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im# cd /www/wwwroot/yys.im/eva/html root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# npm i -g less lessc document.less document.css npm WARN EBADENGINE Unsupported engine { npm WARN EBADENGINE package: 'less@4.4.2', npm WARN EBADENGINE required: { node: '>=14' }, npm WARN EBADENGINE current: { node: 'v12.22.9', npm: '8.5.1' } npm WARN EBADENGINE } added 18 packages, and audited 19 packages in 3s 1 package is looking for funding run `npm fund` for details found 0 vulnerabilities

## A: 

å¾ˆå¥½ï¼Œä½ å·²ç»èµ°åˆ°æ­£ç¡®ç›®å½• `/www/wwwroot/yys.im/eva/html` äº†ï¼Œè€Œä¸” `less` ä¹Ÿè£…å¥½äº†ã€‚ç°åœ¨è¿™ä¸ªæç¤ºï¼š

`npm WARN EBADENGINE ... required node >=14, current node v12.22.9`

åªæ˜¯ **è­¦å‘Š**ï¼ˆå‘Šè¯‰ä½  Node ç‰ˆæœ¬åè€ï¼‰ï¼Œä¸ä¼šé˜»æ­¢å®‰è£…ï¼›æ¥ä¸‹æ¥å…³é”®æ˜¯ç¡®è®¤ `lessc` æœ‰æ²¡æœ‰æˆåŠŸæŠŠ `document.less` ç¼–è¯‘æˆ `document.css`ã€‚

## 1ï¼‰å…ˆç¡®è®¤æ˜¯å¦ç”Ÿæˆäº† document.cssï¼ˆç«‹åˆ»æ‰§è¡Œï¼‰

```bash
ls -la document.less document.css
```

å¦‚æœ `document.css` å­˜åœ¨ä¸”å¤§å°ä¸æ˜¯ 0ï¼Œå°±è¯´æ˜ CSS è¿™å— OK äº†ã€‚

å¦‚æœæ²¡æœ‰ç”Ÿæˆï¼ˆæ‰¾ä¸åˆ° document.less æˆ– lessc æŠ¥é”™ï¼‰ï¼Œå†æ‰§è¡Œï¼š

```bash
lessc --version
lessc document.less > document.css
```

* * *

## 2ï¼‰ä½ ç½‘é¡µé‡Œ CSS è¯·æ±‚è·¯å¾„è¦å¯¹ä¸Š

ä½ ä¹‹å‰æµè§ˆå™¨æŠ¥çš„æ˜¯ï¼š  
`https://yys.im/eva/eva-title-main/html/document.css` 404

ä½†ä½ çœŸå®ç›®å½•æ˜¯ï¼š  
`/www/wwwroot/yys.im/eva/html/document.css`

æ‰€ä»¥è¯´æ˜ä½ ç°åœ¨ç½‘é¡µè®¿é—®è·¯å¾„å…¶å®åº”è¯¥æ˜¯ç±»ä¼¼ï¼š  
`https://yys.im/eva/html/` è¿™ä¸€å¥—ï¼ˆè€Œä¸æ˜¯ eva-title-main/htmlï¼‰ã€‚

âœ… ä½ ç°åœ¨ç”¨æµè§ˆå™¨æ‰“å¼€ï¼š

*   `https://yys.im/eva/html/document.css`ï¼ˆçœ‹èƒ½ä¸èƒ½ç›´æ¥æ‰“å¼€/ä¸‹è½½ï¼‰

*   `https://yys.im/eva/html/`ï¼ˆçœ‹é¡µé¢ï¼‰

å¦‚æœèƒ½æ‰“å¼€ `document.css`ï¼ŒCSS 404 å°±è§£å†³äº†ã€‚

* * *

## 3ï¼‰ä¸‹ä¸€æ­¥ï¼šä¿® Vue 404ï¼ˆå¦åˆ™é¡µé¢è¿˜æ˜¯ä¼š â€œVue is not definedâ€ï¼‰

ä½ é¡µé¢ç°åœ¨è¯·æ±‚çš„æ˜¯ï¼š  
`https://yys.im/vue.2.6.11.min.js`ï¼ˆåŸŸåæ ¹ï¼‰

æ‰€ä»¥ç›´æ¥æ”¾åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼š

```bash
cd /www/wwwroot/yys.im
curl -L -o vue.2.6.11.min.js https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js
ls -la vue.2.6.11.min.js
```

ç„¶ååˆ·æ–°ç½‘é¡µï¼Œ`Vue is not defined` åº”è¯¥å°±æ²¡äº†ã€‚

* * *

## 4ï¼‰å…³äº Node 12ï¼ˆå»ºè®®ï¼Œä½†ä¸è€½è¯¯ä½ å…ˆè·‘èµ·æ¥ï¼‰

Node 12 å¤ªè€äº†ï¼Œå¾ˆå¤šå·¥å…·é“¾ä¼šå‡ºå„ç§å…¼å®¹é—®é¢˜ã€‚ä½ è¿™æ¬¡ less å®‰è£…æˆåŠŸäº†å°±å…ˆç”¨ç€ï¼›ä½†åç»­å¦‚æœä½ è¦æ„å»º/æ‰“åŒ…ï¼Œå»ºè®®å‡çº§åˆ° Node 16/18ã€‚

* * *

ä½ ç°åœ¨æŠŠè¿™æ¡å‘½ä»¤çš„è¾“å‡ºè´´ä¸€ä¸‹æˆ‘å°±èƒ½ç»§ç»­åˆ¤æ–­ä¸‹ä¸€æ­¥ï¼š

```bash
ls -la /www/wwwroot/yys.im/eva/html/document.css
```

ä»¥åŠä½ åˆ·æ–°åæ§åˆ¶å°è¿˜æœ‰å“ªäº›çº¢è‰²æŠ¥é”™ï¼ˆæˆªå›¾æˆ–æ–‡å­—éƒ½è¡Œï¼‰ã€‚

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# ls -la document.less document.css -rw-r--r-- 1 root root 6769 Dec 5 16:01 document.css -rwxr-xr-x 1 www www 8594 Aug 25 04:42 document.less

## A: 

OKï¼Œ`document.css` å·²ç»æˆåŠŸç”Ÿæˆäº†ï¼ˆ6769 å­—èŠ‚ï¼‰ï¼ŒCSS è¿™å—æå®š âœ…  
ç°åœ¨é¡µé¢è¿˜ä¸æ­£å¸¸çš„æ ¸å¿ƒåŸå› å¤§æ¦‚ç‡åªå‰© **Vue 404**ï¼ˆä½ ä¹‹å‰æ§åˆ¶å°æ˜ç¡®æŠ¥ `https://yys.im/vue.2.6.11.min.js 404`ï¼Œæ‰€ä»¥ Vue æ²¡å®šä¹‰ï¼‰ã€‚

## 1ï¼‰æŠŠ Vue æ”¾åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼ˆå¯¹åº”ä½ ç°åœ¨çš„å¼•ç”¨è·¯å¾„ï¼‰

ä½ çš„é¡µé¢åœ¨è¯·æ±‚çš„æ˜¯åŸŸåæ ¹ï¼š`/vue.2.6.11.min.js`  
æ‰€ä»¥ç›´æ¥åœ¨ `/www/wwwroot/yys.im/` æ”¾è¿™ä¸ªæ–‡ä»¶ï¼š

```bash
cd /www/wwwroot/yys.im
curl -L -o vue.2.6.11.min.js https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js
ls -la vue.2.6.11.min.js
```

ç„¶åæµè§ˆå™¨è®¿é—®æµ‹è¯•ä¸€ä¸‹ï¼š

*   `https://yys.im/vue.2.6.11.min.js` åº”è¯¥èƒ½æ‰“å¼€ï¼ˆä¸å† 404ï¼‰

åˆ·æ–°é¡µé¢åï¼Œ`Vue is not defined` åº”è¯¥æ¶ˆå¤±ã€‚

* * *

## 2ï¼‰é¡ºæ‰‹æŠŠä½ è®¿é—®è·¯å¾„ä¹Ÿç†é¡ºï¼ˆé¿å…åˆå‡ºç° 404ï¼‰

ä½ çœŸå®æ–‡ä»¶åœ¨ï¼š`/www/wwwroot/yys.im/eva/html/`  
é‚£ä½ æµè§ˆå™¨åº”è¯¥è®¿é—®ç±»ä¼¼ï¼š

*   `https://yys.im/eva/html/`ï¼ˆæˆ–å…·ä½“ `index.html` æ‰€åœ¨è·¯å¾„ï¼‰

å¦‚æœä½ ä»åœ¨è®¿é—® `.../eva/eva-title-main/html/`ï¼Œé‚£å°±æ˜¯ä½  URL è·¯å¾„å’ŒçœŸå®ç›®å½•ä¸ä¸€è‡´ï¼Œåé¢è¿˜ä¼šç»§ç»­ 404ã€‚

* * *

## 3ï¼‰å¦‚æœ Vue æå®šååˆå¼¹å‡º CSP eval æŠ¥é”™

é‚£æ—¶å†å¤„ç† CSPï¼ˆå…è®¸ `'unsafe-eval'`ï¼‰ï¼Œä½†**å…ˆæŠŠ Vue 404 è§£å†³**ï¼Œä¸ç„¶é¡µé¢ä»ç„¶æ¸²æŸ“ä¸äº†ã€‚

ä½ å…ˆæ‰§è¡Œä¸Šé¢ä¸‹è½½ Vue çš„å‘½ä»¤ï¼Œç„¶ååˆ·æ–°é¡µé¢ï¼ŒæŠŠæ–°çš„ Console çº¢å­—æˆªå›¾å‘æˆ‘ï¼Œæˆ‘å¸®ä½ æŠŠå‰©ä¸‹çš„ï¼ˆå¦‚æœè¿˜æœ‰ï¼‰ä¸€æ¬¡æ¸…å®Œã€‚

## Q: 

Vue æ”¾åˆ°ç«™ç‚¹æ ¹ç›®å½• ä¸èƒ½æ”¾åœ¨/www/wwwroot/yys.im/eva/html/ä¸‹å—

## A: 

å¯ä»¥æ”¾åœ¨ `/www/wwwroot/yys.im/eva/html/` ä¸‹ï¼Œ**ä½†å‰ææ˜¯ä½ è¦æŠŠ `index.html` é‡Œå¼•ç”¨ Vue çš„è·¯å¾„æ”¹æ‰**â€”â€”å› ä¸ºä½ ç°åœ¨é¡µé¢è¯·æ±‚çš„æ˜¯ï¼š

`https://yys.im/vue.2.6.11.min.js`ï¼ˆåŸŸåæ ¹è·¯å¾„ï¼‰

è¿™é€šå¸¸æ¥è‡ªè¿™è¡Œå†™æ³•ï¼š

```html
<script src="/vue.2.6.11.min.js"></script>
```

`/` å¼€å¤´å°±è¡¨ç¤ºâ€œä»ç½‘ç«™æ ¹ç›®å½•å–â€ï¼Œæ‰€ä»¥ä½ æ”¾åˆ° `eva/html` ä¸‹å®ƒä¹Ÿæ‰¾ä¸åˆ°ã€‚

* * *

## æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰ï¼šæ”¾åœ¨ eva/html ä¸‹ + æ”¹æˆç›¸å¯¹è·¯å¾„

1.  æŠŠ Vue ä¸‹è½½åˆ°é¡¹ç›®ç›®å½•ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
curl -L -o vue.2.6.11.min.js https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js
```

2.  ä¿®æ”¹ `index.html`ï¼ˆæŠŠå‰é¢çš„ `/` å»æ‰ï¼Œæ”¹æˆç›¸å¯¹ï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "vue\.2\.6\.11" index.html
```

æŠŠç±»ä¼¼è¿™è¡Œï¼š

```html
<script src="/vue.2.6.11.min.js"></script>
```

æ”¹æˆï¼š

```html
<script src="./vue.2.6.11.min.js"></script>
```

ï¼ˆç”¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨ç¼–è¾‘æˆ– `nano index.html` æ”¹éƒ½è¡Œï¼‰

è¿™æ ·æµè§ˆå™¨è®¿é—® `https://yys.im/eva/html/` æ—¶ï¼Œä¼šä»åŒç›®å½•åŠ è½½ Vueã€‚

* * *

## æ–¹æ¡ˆ 2ï¼ˆçœæ”¹ä»£ç ï¼‰ï¼šä¸æ”¹ HTMLï¼Œç›´æ¥æ”¾æ ¹ç›®å½•

å¦‚æœä½ ä¸æƒ³æ”¹ `index.html`ï¼Œé‚£å°±å¿…é¡»æ”¾åœ¨ï¼š  
`/www/wwwroot/yys.im/vue.2.6.11.min.js`

* * *

## ä¸€å¥è¯æ€»ç»“

*   **æƒ³æ”¾å“ªéƒ½è¡Œ**

*   **å…³é”®çœ‹ä½  `<script src="...">` å†™çš„æ˜¯ç»å¯¹è·¯å¾„ `/xxx` è¿˜æ˜¯ç›¸å¯¹è·¯å¾„ `./xxx`**

ä½ è¦æ˜¯æŠŠ `index.html` é‡Œæ‰€æœ‰ `src="/..."`ã€`href="/..."` çš„å‡ è¡Œè´´ä¸€ä¸‹ï¼ˆæˆ–è€…æˆ‘æ•™ä½ ç”¨ `grep` åˆ—å‡ºæ¥ï¼‰ï¼Œæˆ‘è¿˜èƒ½é¡ºæ‰‹å¸®ä½ æŠŠæ•´ä¸ªé¡¹ç›®çš„è·¯å¾„ä¸€æ¬¡æ€§æ”¹æˆâ€œæ”¾åœ¨å­ç›®å½•ä¹Ÿä¸ä¼š 404â€çš„ç‰ˆæœ¬ã€‚

## Q: 

éƒ¨åˆ†é¡µé¢è¿˜æ˜¯æ²¡å¥½ document.cssæ˜¯ä¸æ˜¯æœ‰é—®é¢˜

## A: 

`document.css` **æ–‡ä»¶æœ¬èº«æ²¡é—®é¢˜**ï¼ˆä½ å·²ç»ç”Ÿæˆå‡ºæ¥äº†ï¼‰ï¼Œä½ ç°åœ¨çš„é—®é¢˜æ˜¯ï¼š**æµè§ˆå™¨è¯·æ±‚çš„ URL è·ŸæœåŠ¡å™¨æ–‡ä»¶ä½ç½®å¯¹ä¸ä¸Šï¼Œæ‰€ä»¥è¿˜æ˜¯ 404**ã€‚

ä½ æˆªå›¾é‡Œæ§åˆ¶å°å†™å¾—éå¸¸æ¸…æ¥šï¼š

> `GET https://yys.im/eva/html/document.css ... 404 (Not Found)`

è¿™è¯´æ˜å¯¹å¤–è®¿é—®è·¯å¾„ `/eva/html/document.css` åœ¨æœåŠ¡å™¨ä¸Šæ²¡æ˜ å°„åˆ°é‚£ä¸ªçœŸå®æ–‡ä»¶ã€‚

è€Œä½ çœŸå®æ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šæ˜¯ï¼š  
`/www/wwwroot/yys.im/eva/html/document.css` âœ…ï¼ˆä½ å‰é¢ ls å·²ç»çœ‹åˆ°ï¼‰

ç†è®ºä¸Šåªè¦ç«™ç‚¹æ ¹ç›®å½•æ˜¯ `/www/wwwroot/yys.im`ï¼Œé‚£ä¹ˆ `/eva/html/document.css` å°±è¯¥èƒ½è®¿é—®åˆ°ã€‚ç°åœ¨ 404ï¼Œé€šå¸¸åªæœ‰ä¸‹é¢å‡ ç§åŸå› ï¼š

* * *

## 1ï¼‰å…ˆåšä¸€ä¸ªæœ€ç¡¬æ ¸çš„éªŒè¯ï¼šæœåŠ¡å™¨æœ¬æœº curl çœ‹çœ‹åˆ°åº•è¿”å›å•¥

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
curl -I https://yys.im/eva/html/document.css
curl -I http://127.0.0.1/eva/html/document.css
```

*   å¦‚æœ `127.0.0.1` æ˜¯ 200ï¼Œè€ŒåŸŸåæ˜¯ 404ï¼šè¯´æ˜ **CDN/åä»£/Cloudflare** åœ¨æè·¯å¾„æˆ–ç¼“å­˜

*   å¦‚æœä¸¤ä¸ªéƒ½æ˜¯ 404ï¼šè¯´æ˜ **Nginx ç«™ç‚¹æ ¹ç›®å½•ä¸æ˜¯ /www/wwwroot/yys.im** æˆ–è¢« location/é‡å†™è§„åˆ™å½±å“

*   * *

## 2ï¼‰å®å¡”é‡Œæœ€å¸¸è§ï¼šç«™ç‚¹æ ¹ç›®å½•å…¶å®ä¸æ˜¯ä½ ä»¥ä¸ºçš„é‚£ä¸ª

å»å®å¡”ï¼šç½‘ç«™ â†’ yys.im â†’ è®¾ç½® â†’ ç½‘ç«™ç›®å½•  
ç¡®è®¤æ˜¯ä¸æ˜¯ï¼š

*   **/www/wwwroot/yys.im**

å¦‚æœä¸æ˜¯ï¼Œæ”¹å›è¿™ä¸ªã€‚

* * *

## 3ï¼‰è¿˜æœ‰ä¸€ä¸ªä½ é…ç½®é‡Œå¾ˆå¯ç–‘çš„ç‚¹ï¼šä½ å¼€å¯äº† PHP å¹¶ include äº†é‡å†™è§„åˆ™

ä½ ç°åœ¨æ˜¯çº¯é™æ€ç«™ï¼Œä½†é…ç½®é‡Œæœ‰ï¼š

```nginx
include enable-php-80.conf;
include /www/server/panel/vhost/rewrite/yys.im.conf;
```

æŸäº›ä¼ªé™æ€/é‡å†™ä¼šæŠŠ `.css` ä¹‹ç±»çš„è¯·æ±‚æ”¹æ‰ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶ã€‚

### å¿«é€Ÿæ’é™¤æ³•ï¼ˆå»ºè®®ä½ ä¸´æ—¶åšä¸€æ¬¡ï¼‰

æŠŠä¼ªé™æ€æ¸…ç©ºï¼ˆå®å¡”ï¼šç½‘ç«™ â†’ è®¾ç½® â†’ ä¼ªé™æ€ â†’ é€‰ â€œçº¯é™æ€/ç©ºâ€ï¼‰ï¼Œæˆ–è€…ä¸´æ—¶æŠŠç«™ç‚¹é…ç½®é‡Œè¿™è¡Œæ³¨é‡Šæ‰ï¼š

```nginx
include /www/server/panel/vhost/rewrite/yys.im.conf;
```

ä¿å­˜åé‡è½½ Nginxï¼Œå†è®¿é—® `https://yys.im/eva/html/document.css` è¯•è¯•ã€‚

* * *

## 4ï¼‰ä¸è¦çŒœï¼šç›´æ¥çœ‹ Nginx è®¿é—®æ—¥å¿—é‡Œå®ƒåˆ°åº•è®¿é—®åˆ°å“ªäº†

ä½ é…ç½®é‡Œæœ‰æ—¥å¿—ï¼š

*   access: `/www/wwwlogs/yys.im.log`

*   error: `/www/wwwlogs/yys.im.error.log`

æ‰§è¡Œï¼š

```bash
tail -n 50 /www/wwwlogs/yys.im.error.log
tail -n 50 /www/wwwlogs/yys.im.log
```

ç„¶åä½ åœ¨æµè§ˆå™¨åˆ·æ–°ä¸€ä¸‹é¡µé¢ï¼Œå† tail ä¸€æ¬¡ï¼Œçœ‹å®ƒå¯¹ `/eva/html/document.css` åˆ°åº•æŠ¥äº†ä»€ä¹ˆè·¯å¾„çš„ `open() failed`ã€‚

* * *

## 5ï¼‰ä½ æˆªå›¾é‡Œè¿˜æœ‰ä¸ªè¿·æƒ‘ç‚¹ï¼šä½ åœ¨ç¼–è¾‘å™¨æ‰“å¼€çš„ document.css é¡¶éƒ¨æœ‰çº¢å‰

é‚£ç§çº¢å‰å¤šåŠæ˜¯**ç¼–è¾‘å™¨è¯­æ³•æ£€æŸ¥**ï¼ˆæ¯”å¦‚å¯¹ `--color-red` ä¹‹ç±»çš„ CSS å˜é‡æç¤ºï¼‰ï¼Œä¸å½±å“æµè§ˆå™¨ä½¿ç”¨ï¼›çœŸæ­£è‡´å‘½çš„æ˜¯ä½ æ§åˆ¶å°é‡Œçš„ **404**ã€‚

* * *

### æœ€å¿«ç›´æ¥ä¿®å¥½çš„â€œä¿åº•æ–¹æ¡ˆâ€ï¼ˆä¸ç®¡ä½ æ ¹ç›®å½•å’‹æ ·éƒ½èƒ½ç”¨ï¼‰

æ—¢ç„¶æµè§ˆå™¨åœ¨æ‰¾ `/eva/html/document.css`ï¼Œé‚£å°±ä¿è¯å®ƒèƒ½æ‰¾åˆ°ï¼š

```bash
ls -la /www/wwwroot/yys.im/eva/html/document.css
```

å¦‚æœå­˜åœ¨ï¼Œå†ç¡®ä¿ Nginx root æŒ‡å‘ `/www/wwwroot/yys.im`ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å†™æ‹¦æˆªå®ƒã€‚

* * *

ä½ ç°åœ¨æŠŠä¸‹é¢ä¸¤æ¡å‘½ä»¤çš„è¾“å‡ºè´´å‡ºæ¥ï¼ˆä¸ç”¨æˆªå›¾ï¼Œå¤åˆ¶æ–‡æœ¬å³å¯ï¼‰ï¼Œæˆ‘å°±èƒ½ä¸€é”¤å®šéŸ³æ˜¯å“ªä¸€ç§æƒ…å†µï¼š

```bash
nginx -T | grep -n "root /www/wwwroot/yys.im" -n
curl -I http://127.0.0.1/eva/html/document.css
```

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# curl -I https://yys.im/eva/html/document.css curl -I http://127.0.0.1/eva/html/document.css HTTP/2 200 date: Fri, 05 Dec 2025 16:07:13 GMT content-type: text/css server: cloudflare last-modified: Fri, 05 Dec 2025 16:01:22 GMT vary: Accept-Encoding etag: W/"693301d2-1a71" expires: Sat, 06 Dec 2025 04:07:13 GMT cache-control: max-age=43200 strict-transport-security: max-age=31536000 report-to: {"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=%2BQ181YY7eGBCR8BirDHzHUyi9rm7Dhq4aCEAyrvCRWGAxVZhbc%2FjOG8MFh9lSOqCWo2e9xz7LVN2Gt2iV9NgMZXohaEVpQ%3D%3D"}]} cf-cache-status: EXPIRED nel: {"report_to":"cf-nel","success_fraction":0.0,"max_age":604800} cf-ray: 9a94cb971f806387-LAX alt-svc: h3=":443"; ma=86400 HTTP/1.1 404 Not Found Server: nginx Date: Fri, 05 Dec 2025 16:07:13 GMT Content-Type: text/html Content-Length: 146 Connection: keep-alive

## A: 

è¿™è¾“å‡ºå¤ªå…³é”®äº†ï¼š**é—®é¢˜å·²ç»å®Œå…¨å®šä½**â€”â€”

*   èµ°åŸŸå `https://yys.im/eva/html/document.css` â†’ **200ï¼Œä¸” server: cloudflare**

*   æœ¬æœºç›´è¿ `http://127.0.0.1/eva/html/document.css` â†’ **404ï¼Œserver: nginx**

ç»“è®ºï¼š**Cloudflare æ²¡æœ‰å›æºåˆ°ä½ è¿™å° Nginx**ï¼ˆæˆ–è€…å›æºè·¯å¾„/ä¸»æœºä¸å¯¹ï¼‰ï¼Œä½ æµè§ˆå™¨çœ‹åˆ°çš„é¡µé¢/èµ„æºæœ‰ä¸€éƒ¨åˆ†æ¥è‡ª Cloudflare çš„ç¼“å­˜/åˆ«çš„æºï¼Œæ‰€ä»¥å°±å‡ºç°â€œæœ‰çš„å¥½ã€æœ‰çš„åâ€çš„å‰²è£‚ç°è±¡ã€‚

* * *

## ä½ ç°åœ¨è¯¥æ€ä¹ˆä¿®ï¼ˆæŒ‰æœ€å¿«åˆ°æœ€ç¨³ï¼‰

### æ–¹æ¡ˆ 1ï¼ˆæœ€å¿«éªŒè¯ï¼‰ï¼šCloudflare å…ˆæš‚åœ/ç°äº‘

åœ¨ Cloudflare é¢æ¿ï¼š

*   DNS â†’ æŠŠ `yys.im` å’Œç›¸å…³è®°å½•ï¼ˆA/AAAA/CNAMEï¼‰ä» **æ©™äº‘ä»£ç†** æ”¹æˆ **ç°äº‘ä»…DNS**

*   ç­‰å‡ åˆ†é’Ÿåå†è®¿é—®

å¦‚æœè¿™æ—¶å€™é¡µé¢å…¨éƒ¨ç»Ÿä¸€ï¼ˆè€Œä¸”èƒ½å¤ç° 404/200 çš„ä¸€è‡´æ€§ï¼‰ï¼Œå°±è¯æ˜é—®é¢˜åœ¨ Cloudflare å›æº/è§„åˆ™/ç¼“å­˜ã€‚

* * *

## æ–¹æ¡ˆ 2ï¼ˆæ¨èé•¿æœŸï¼‰ï¼šä¿® Cloudflare å›æºåˆ°æ­£ç¡®çš„æºç«™

ä½ ç°åœ¨ Nginx æœ¬æœº 404ï¼Œè¯´æ˜**æºç«™çš„ç«™ç‚¹ç›®å½•/URL æ˜ å°„ä¸å¯¹**ï¼Œæˆ–ä½ è¯·æ±‚çš„å¹¶ä¸æ˜¯æœ¬æœºæ­£ç¡®ç«™ç‚¹ã€‚

### A. å…ˆç¡®è®¤ Nginx çœŸå®ç«™ç‚¹æ ¹ç›®å½•æ˜¯å¦åŒ…å«æ–‡ä»¶

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
ls -la /www/wwwroot/yys.im/eva/html/document.css
```

ä½ è¿™ä¸ªæ˜¯å­˜åœ¨çš„ï¼ˆä¹‹å‰å·²ç¡®è®¤ï¼‰ï¼Œé‚£ Nginx ä»è¿”å› 404ï¼Œä¸€èˆ¬æ˜¯ä¸¤ç§æƒ…å†µï¼š

#### æƒ…å†µ A1ï¼šNginx è¿™ä¸ª server å¹¶æ²¡æœ‰ç”¨åˆ° `root /www/wwwroot/yys.im`

å¯èƒ½å‘½ä¸­äº†å¦ä¸€ä¸ª server å—/é»˜è®¤ç«™ç‚¹ã€‚

ğŸ‘‰ ç”¨æœ¬æœºç›´æ¥å¸¦ Host å¤´è®¿é—®ï¼ˆéå¸¸å…³é”®ï¼‰ï¼š

```bash
curl -I -H "Host: yys.im" http://127.0.0.1/eva/html/document.css
```

*   å¦‚æœè¿™æ¡å˜æˆ **200**ï¼šè¯´æ˜ Nginx ç«™ç‚¹æ²¡é—®é¢˜ï¼Œæ˜¯ä½ ä¹‹å‰æ²¡å¸¦ Host å‘½ä¸­äº†é»˜è®¤ç«™ç‚¹ã€‚

*   å¦‚æœä»ç„¶ **404**ï¼šè¯´æ˜è¿™ä¸ª server å—è™½ç„¶åŒ¹é…äº†ï¼Œä½†è§£æè·¯å¾„/é‡å†™æŠŠå®ƒææ²¡äº†ã€‚

æˆ‘çŒœä½ å¤§æ¦‚ç‡æ˜¯ **æ²¡å¸¦ Host å‘½ä¸­é»˜è®¤ç«™ç‚¹**ï¼ˆå› ä¸ºä½ ç«™ç‚¹é‡Œæœ‰ `server_name yys.im 74.48.175.131;`ï¼Œè€Œä½  curl ç”¨çš„æ˜¯ 127.0.0.1ï¼‰ã€‚

* * *

## æ–¹æ¡ˆ 3ï¼šè®© Cloudflare å›æºæ—¶ç¡®ä¿ Host æ­£ç¡®

Cloudflare å›æºä¼šå¸¦ Host=åŸŸåï¼Œæ­£å¸¸ä¸ä¼šåƒ 127.0.0.1 é‚£æ ·å¤±é…ï¼›ä½†ä½ ç°åœ¨å‡ºç°åŸŸå 200ã€æœ¬åœ° 404ï¼Œè¯´æ˜ Cloudflare å¾ˆå¯èƒ½**æ ¹æœ¬æ²¡å›ä½ è¿™å°**ï¼Œæˆ–è€…å›çš„æ˜¯å¦ä¸€ä¸ª IP/ç«¯å£ã€‚

è¯·æ£€æŸ¥ Cloudflareï¼š

1.  DNS é‡Œ `yys.im` çš„ A è®°å½• IP æ˜¯ä¸æ˜¯ä½ è¿™å°æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆ74.48.175.131ï¼Ÿï¼‰

2.  æ˜¯å¦è¿˜æœ‰åˆ«çš„è®°å½•ï¼ˆwwwã€@ã€eva å­åŸŸï¼‰æŒ‡å‘ä¸åŒçš„æº

3.  æ˜¯å¦ç”¨äº† Cloudflare çš„ **Cache Rules / Page Rules** æŠŠæŸäº›è·¯å¾„ç¼“å­˜æˆæ—§ç‰ˆæœ¬

4.  å¦‚æœä½ ç”¨çš„æ˜¯ â€œOrigin Rules / Host Header æ”¹å†™/ç«¯å£â€ ä¹‹ç±»ï¼Œç¡®è®¤æ²¡æ”¹é”™

* * *

## ä½ ç°åœ¨é©¬ä¸Šåšè¿™ä¸€æ­¥ï¼Œæˆ‘å°±èƒ½ç»™ä½ ä¸‹ç»“è®º

è¯·åœ¨æœåŠ¡å™¨æ‰§è¡Œå¹¶æŠŠè¾“å‡ºè´´å›æ¥ï¼š

```bash
curl -I -H "Host: yys.im" http://127.0.0.1/eva/html/document.css
```

å¦‚æœè¿™æ¡æ˜¯ 200ï¼Œé‚£ä½ æºç«™å…¶å®æ²¡é—®é¢˜ï¼Œä½ ä¹‹å‰çš„ 404 åªæ˜¯å› ä¸º curl æ²¡å¸¦ Hostï¼›æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸“æ³¨ä¿®å‰ç«¯çš„å…¶å®ƒ 404ï¼ˆVue è·¯å¾„ç­‰ï¼‰ã€‚  
å¦‚æœè¿˜æ˜¯ 404ï¼Œæˆ‘å†å¸¦ä½ æ£€æŸ¥ Nginx é‡å†™/ç›®å½•/try_filesï¼Œç›´æ¥æŠŠ `/eva/html/*` è¿™ç±»é™æ€èµ„æºå½»åº•æ”¾é€šã€‚\*_

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# ls -la /www/wwwroot/yys.im/eva/html/document.css -rw-r--r-- 1 root root 6769 Dec 5 16:01 /www/wwwroot/yys.im/eva/html/document.css

## A: 

æ–‡ä»¶åœ¨ç£ç›˜ä¸Šæ²¡é—®é¢˜ âœ…ï¼Œä½†ä½ ä¹‹å‰ `curl http://127.0.0.1/eva/html/document.css` ä»ç„¶ 404ï¼Œè¯´æ˜ **Nginx æ²¡æœ‰ç”¨è¿™ä¸ªç«™ç‚¹é…ç½®æ¥å¤„ç†ä½ è¿™ä¸ªè¯·æ±‚**ï¼ˆå¾ˆå¯èƒ½å‘½ä¸­äº†é»˜è®¤ç«™ç‚¹/åˆ«çš„ server å—ï¼‰ï¼Œè€Œ Cloudflare è®¿é—®åŸŸåæ—¶å´æ˜¯ 200ï¼ˆè¯´æ˜å®ƒå‘½ä¸­äº†å¦ä¸€ä¸ªæ­£ç¡®ç«™ç‚¹æˆ–ç¼“å­˜ï¼‰ã€‚

ä¸‹ä¸€æ­¥ä¸ç”¨çŒœï¼Œç›´æ¥ç”¨ **Host å¤´**æ¨¡æ‹Ÿâ€œé€šè¿‡åŸŸåè®¿é—®æºç«™â€çš„æ–¹å¼ï¼š

## ç°åœ¨è¯·ä½ æ‰§è¡Œè¿™æ¡ï¼ˆæœ€å…³é”®çš„ä¸€é”¤å®šéŸ³ï¼‰

```bash
curl -I -H "Host: yys.im" http://127.0.0.1/eva/html/document.css
```

### ç»“æœæ€ä¹ˆè§£è¯»

*   **å¦‚æœè¿”å› 200**ï¼šè¯´æ˜ Nginx ç«™ç‚¹å…¶å®å¯¹ï¼Œåˆšæ‰ 404 åªæ˜¯å› ä¸ºä½ ç”¨ 127.0.0.1 æ²¡å¸¦ Host å‘½ä¸­äº†é»˜è®¤ç«™ç‚¹ã€‚  
    è¿™æ—¶ä½ ç½‘é¡µâ€œéƒ¨åˆ†ä¸å¥½çš„â€åŸå› å°±ä¸æ˜¯ Nginx è·¯ç”±ï¼Œè€Œæ˜¯å‰ç«¯è¿˜æœ‰èµ„æºè·¯å¾„ 404ï¼ˆæ¯”å¦‚ Vue é‚£ä¸ªï¼‰ã€‚

*   **å¦‚æœä»ç„¶ 404**ï¼šé‚£å°±æ˜¯è¿™ä¸ªç«™ç‚¹é‡Œæœ‰ rewite/try_files/alias ç­‰å¯¼è‡´ `/eva/html/document.css` æ²¡è¢«å½“é™æ€æ–‡ä»¶æ­£ç¡®æ˜ å°„ã€‚æˆ‘ä¼šè®©ä½ è´´ä¸€ä¸‹ `rewrite/yys.im.conf` å†…å®¹æˆ–ç›´æ¥ç»™ä½ ä¸€ä¸ª `location ^~ /eva/ { ... }` çš„æ”¾é€šè§„åˆ™ã€‚

*   * *

## é¡ºæ‰‹ä¸€ä¸ªæ£€æŸ¥ï¼šCloudflare å¯èƒ½åœ¨ç¼“å­˜æ—§é¡µé¢

ä½ æˆªå›¾é‡Œæµè§ˆå™¨ä»æŠ¥ `document.css 404`ï¼Œä½†ä½  `curl -I https://yys.im/eva/html/document.css` æ˜¯ 200ï¼Œè¿™è¯´æ˜æµè§ˆå™¨å¾ˆå¯èƒ½ç¼“å­˜/æˆ–é¡µé¢å¼•ç”¨äº†é”™è¯¯è·¯å¾„ï¼ˆæ¯”å¦‚è¿˜æ˜¯å¼•ç”¨äº†æ—§ç›®å½• `/eva/eva-title-main/html/document.css`ï¼‰ã€‚

ä½ å¯ä»¥åœ¨æµè§ˆå™¨ï¼š

*   æ‰“å¼€ `https://yys.im/eva/html/index.html`

*   `Ctrl+F5` å¼ºåˆ·ï¼ˆæˆ– DevTools å‹¾é€‰ Disable cacheï¼‰

ä½†åœ¨æˆ‘ä»¬ç¡®è®¤æºç«™è·¯ç”±ä¹‹å‰ï¼Œå…ˆæŠŠä¸Šé¢é‚£æ¡ `curl -H "Host: yys.im"` è·‘äº†å†è¯´ã€‚

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# curl -I -H "Host: yys.im" http://127.0.0.1/eva/html/document.css HTTP/1.1 301 Moved Permanently Server: nginx Date: Fri, 05 Dec 2025 16:08:26 GMT Content-Type: text/html Content-Length: 162 Connection: keep-alive Location: https://yys.im/eva/html/document.css Strict-Transport-Security: max-age=31536000

## A: 

å®Œç¾ï¼Œè¿™å°±è¯´æ˜ï¼š**æºç«™ Nginx å®é™…ä¸Šæ˜¯æ­£å¸¸çš„**ï¼Œåªæ˜¯ä½ ç«™ç‚¹é…ç½®é‡ŒæŠŠé 443 çš„è¯·æ±‚éƒ½ 301 è·³åˆ° HTTPSï¼ˆä½ é…ç½®é‡Œé‚£æ®µ `if ($server_port !~ 443) rewrite ... https ...`ï¼‰ã€‚æ‰€ä»¥ï¼š

*   ä½ ä¹‹å‰ç›´æ¥ `http://127.0.0.1/...` çœ‹è§ 404ï¼Œæ˜¯å› ä¸ºå‘½ä¸­äº†åˆ«çš„ server/æˆ–è·³è½¬é“¾è·¯å¯¼è‡´ä½ è¯¯åˆ¤ï¼›

*   ç°åœ¨å¸¦ Host å¤´åè¿”å› 301 åˆ° `https://yys.im/...`ï¼Œè¯´æ˜è¿™æ¡é™æ€èµ„æºåœ¨æºç«™è·¯å¾„æ˜¯é€šçš„ã€‚

è€Œä½ æµè§ˆå™¨æ§åˆ¶å°è¿˜åœ¨æŠ¥ `document.css 404`ï¼ŒåŸºæœ¬å°±æ˜¯ä¸‹é¢ä¸¤ç§ä¹‹ä¸€ï¼š

## 1ï¼‰é¡µé¢å¼•ç”¨çš„ CSS è·¯å¾„è¿˜æ˜¯â€œè€çš„/é”™è¯¯çš„â€

ä½ ä¹‹å‰æŠ¥è¿‡ `.../eva/eva-title-main/html/document.css 404`ï¼Œç°åœ¨åˆæ˜¯ `/eva/html/document.css`ã€‚å»ºè®®ç›´æ¥åœ¨æœåŠ¡å™¨æŸ¥ `index.html` é‡Œåˆ°åº•å¼•ç”¨äº†å•¥ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "document.css" -n index.html
grep -n "document.less" -n index.html
```

å¦‚æœ HTML é‡Œå†™çš„æ˜¯ `href="document.css"`ï¼Œé‚£åœ¨è®¿é—® `https://yys.im/eva/html/` æ—¶æ²¡é—®é¢˜ï¼›  
ä½†å¦‚æœä½ å®é™…è®¿é—®çš„æ˜¯ `https://yys.im/eva/html/index.html` ä»¥å¤–çš„è·¯å¾„ï¼ˆæ¯”å¦‚å°‘äº†ç»“å°¾ `/`ï¼Œæˆ–è®¿é—®äº†åˆ«çš„ç›®å½•ï¼‰ï¼Œç›¸å¯¹è·¯å¾„å°±å¯èƒ½é”™ã€‚

âœ… æœ€ç¨³çš„å†™æ³•æ˜¯æ”¹æˆï¼š

```html
<link rel="stylesheet" href="./document.css">
```

**æ³¨æ„æ˜¯ `./`**ã€‚

* * *

## 2ï¼‰Cloudflare/æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ HTMLï¼ˆè¿˜åœ¨æŒ‡å‘ä¸å­˜åœ¨çš„ css è·¯å¾„ï¼‰

ä½  `curl -I https://yys.im/eva/html/document.css` æ˜¯ 200ï¼Œä½†æµè§ˆå™¨ä» 404ï¼Œå¼ºçƒˆåƒç¼“å­˜å¯¼è‡´ã€‚

### æ¸…ç¼“å­˜çš„æœ€å¿«åšæ³•

*   æµè§ˆå™¨ DevTools â†’ Network å‹¾é€‰ **Disable cache** â†’ å¼ºåˆ·ï¼ˆCtrl+F5ï¼‰

*   Cloudflare æ§åˆ¶å°ï¼š**Purge Cache â†’ Purge Everything**

    *   æˆ–åª Purge `/eva/*`

*   * *

## é¡ºæ‰‹æŠŠå¦å¤–ä¸¤ä¸ªâ€œçœ‹ä¼¼æŠ¥é”™ä½†å…¶å®ä¸å½±å“â€çš„è§£é‡Šä¸‹

*   `static.cloudflareinsights.com ... ERR_BLOCKED_BY_CLIENT`ï¼šè¿™æ˜¯ä½ æµè§ˆå™¨è£…äº†å¹¿å‘Šæ‹¦æˆª/éšç§æ’ä»¶æ‹¦æ‰äº† Cloudflare beaconï¼Œ**ä¸å½±å“é¡µé¢åŠŸèƒ½**ã€‚

*   `Canvas2D ... willReadFrequently`ï¼šæ€§èƒ½æç¤ºï¼Œ**ä¸å½±å“æ˜¾ç¤º**ã€‚

*   * *

## æˆ‘å»ºè®®ä½ æŒ‰è¿™ä¸ªé¡ºåºåšï¼ˆæœ€å¿«è§æ•ˆï¼‰

1. æŠŠ `index.html` é‡Œ CSS å¼•ç”¨æ”¹æˆå¸¦ `./` çš„ç›¸å¯¹è·¯å¾„

   ```bash
   sed -i 's/href="document.css"/href=".\/document.css"/' index.html
   ```

2. åˆ·æ–°é¡µé¢å‰ï¼ŒCloudflare **Purge** `/eva/*`

3. æµè§ˆå™¨å‹¾ Disable cache å¼ºåˆ·

* * *

å¦‚æœä½ æ„¿æ„ï¼ŒæŠŠä¸‹é¢å‘½ä»¤è¾“å‡ºè´´ä¸€ä¸‹ï¼ˆæˆ‘å°±èƒ½ç²¾å‡†å‘Šè¯‰ä½ ç°åœ¨ HTML å¼•ç”¨çš„åˆ°åº•æ˜¯å“ªæ¡è·¯å¾„ï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "stylesheet" index.html
```

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# cd /www/wwwroot/yys.im/eva/html grep -n "document.css" -n index.html grep -n "document.less" -n index.html 10:<link rel="stylesheet" href="document.css">

## A: 

å¥½ï¼Œé‚£å°±å¾ˆæ¸…æ¥šäº†ï¼š`index.html` é‡Œå¼•ç”¨çš„æ˜¯ç›¸å¯¹è·¯å¾„

```html
<link rel="stylesheet" href="document.css">
```

è¿™ä¸ªå†™æ³•**åªæœ‰åœ¨ä½ ç”¨â€œç›®å½•å½¢å¼â€è®¿é—®æ—¶æ‰ä¸€å®šç¨³å®š**ï¼Œæ¯”å¦‚ï¼š

*   âœ… `https://yys.im/eva/html/` ï¼ˆä¼šæ‹¼æˆ `/eva/html/document.css`ï¼‰

*   âœ… `https://yys.im/eva/html/index.html`ï¼ˆä¹Ÿä¼šæ‹¼æˆ `/eva/html/document.css`ï¼‰

ä½†ä½ æµè§ˆå™¨ä»ç„¶æŠ¥ 404ï¼Œè€Œä½  `curl -I https://yys.im/eva/html/document.css` æ˜¯ 200ï¼Œè¿™ç§â€œçŸ›ç›¾â€å‡ ä¹å°±æ˜¯ **ç¼“å­˜/æ—§é¡µé¢** æˆ– **ä½ å®é™…æ‰“å¼€çš„ä¸æ˜¯è¿™ä¸ª index.html**ã€‚

æˆ‘ä»¬ç›´æ¥åšä¸¤æ­¥â€œç¡¬ä¿®å¤â€ï¼Œè®©å®ƒä¸å†å—è·¯å¾„/ç¼“å­˜å½±å“ï¼š

* * *

## 1ï¼‰æŠŠå¼•ç”¨æ”¹æˆæ›´ç¨³çš„ `./document.css`

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
sed -i 's/href="document.css"/href=".\/document.css"/' index.html
```

éªŒè¯ä¸€ä¸‹ï¼š

```bash
grep -n "document.css" index.html
```

åº”å˜æˆï¼š

```html
<link rel="stylesheet" href="./document.css">
```

* * *

## 2ï¼‰æ¸… Cloudflare ç¼“å­˜ + æµè§ˆå™¨å¼ºåˆ·

å› ä¸ºä½ åŸŸåèµ° Cloudflareï¼ˆä½  `curl` è¿”å› `server: cloudflare`ï¼‰ï¼Œæ—§çš„ `index.html` å¾ˆå¯èƒ½è¿˜è¢«ç¼“å­˜ç€ã€‚

*   Cloudflare åå°ï¼š**Caching â†’ Purge Cache â†’ Purge Everything**

    *   æˆ–è€…åªæ¸… `/eva/*`

*   æµè§ˆå™¨ï¼šDevTools â†’ Network å‹¾ **Disable cache** â†’ **Ctrl+F5**

*   * *

## 3ï¼‰å†åšä¸€ä¸ªéªŒè¯ï¼šç›´æ¥æ‰“å¼€ CSS çœ‹æ˜¯ä¸æ˜¯ 200

åœ¨æµè§ˆå™¨æ–°å¼€ä¸€ä¸ªæ ‡ç­¾è®¿é—®ï¼š

*   `https://yys.im/eva/html/document.css`

å¦‚æœèƒ½ç›´æ¥çœ‹åˆ° CSS å†…å®¹ï¼ˆä¸æ˜¯ 404ï¼‰ï¼Œé‚£ CSS ç»å¯¹æ²¡é—®é¢˜ï¼›é¡µé¢ä»å¼‚å¸¸å°±è¦çœ‹ JS/Vue çš„ 404 å’Œåç»­æŠ¥é”™ã€‚

* * *

### é¢å¤–æé†’ï¼ˆä½ å‰é¢è¿˜ç¼º Vueï¼‰

ä½ ä¹‹å‰æ§åˆ¶å°è¿˜æœ‰ `Vue is not defined`ï¼ˆå› ä¸º `/vue.2.6.11.min.js` 404ï¼‰ã€‚CSS ä¿®å¥½åªæ˜¯æ ·å¼ï¼Œé¡µé¢åŠŸèƒ½è¿˜æ˜¯è¦æŠŠ Vue è·¯å¾„ä¹Ÿä¿®æ‰ï¼ˆæ”¾æ ¹ç›®å½•ï¼Œæˆ–æ”¹æˆ `./vue.2.6.11.min.js` å¹¶æ”¾åˆ° `eva/html`ï¼‰ã€‚

ä½ å…ˆæŒ‰ä¸Šé¢æŠŠ CSS å¼•ç”¨æ”¹æˆ `./` å¹¶æ¸…ç¼“å­˜åˆ·æ–°ï¼Œç„¶åæŠŠåˆ·æ–°åçš„ Console çº¢å­—å†å‘ä¸€å¼ ï¼Œæˆ‘ç»§ç»­å¸®ä½ æŠŠ Vue é‚£å—ä¸€æ¬¡æå®šã€‚

## Q: 

åœ¨htmlé¡µé¢æ€ä¹ˆæ”¹

## A: 

åœ¨ `html` é¡µé¢é‡Œæ”¹å°±æ˜¯æ”¹ **index.html** è¿™ä¸€è¡Œå¼•ç”¨è·¯å¾„ã€‚ä½ æœ‰ä¸¤ç§æœ€æ–¹ä¾¿çš„æ–¹æ³•ï¼š

## æ–¹æ³• 1ï¼šç”¨å®å¡”é¢æ¿æ”¹ï¼ˆæœ€ç›´è§‚ï¼‰

1.  å®å¡” â†’ **æ–‡ä»¶**

2.  æ‰“å¼€ç›®å½•ï¼š`/www/wwwroot/yys.im/eva/html/`

3.  æ‰¾åˆ°å¹¶ç‚¹å‡» **index.html**

4.  ç‚¹ **ç¼–è¾‘**

5.  æŠŠè¿™ä¸€è¡Œï¼š

```html
<link rel="stylesheet" href="document.css">
```

æ”¹æˆï¼š

```html
<link rel="stylesheet" href="./document.css">
```

6.  ä¿å­˜

7.  æµè§ˆå™¨ **Ctrl+F5 å¼ºåˆ·**ï¼ˆå¦‚æœèµ° Cloudflareï¼Œå†å» Cloudflare Purge ä¸€ä¸‹ `/eva/*` æˆ–å…¨ç«™ï¼‰

* * *

## æ–¹æ³• 2ï¼šSSH ä¸€æ¡å‘½ä»¤æ”¹ï¼ˆæœ€å¿«ï¼‰

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
sed -i 's/href="document.css"/href=".\/document.css"/' index.html
grep -n "document.css" index.html
```

çœ‹åˆ°è¾“å‡ºå˜æˆ `./document.css` å°±æˆåŠŸã€‚

* * *

### é¡ºä¾¿æŠŠ Vue ä¹Ÿæ”¹äº†ï¼ˆæ¨èä¸€èµ·åšï¼Œé¿å…å†æŠ¥ Vue 404ï¼‰

å¦‚æœä½ çš„ index.html é‡Œæœ‰ï¼š

```html
<script src="/vue.2.6.11.min.js"></script>
```

ä¹Ÿå»ºè®®æ”¹æˆï¼š

```html
<script src="./vue.2.6.11.min.js"></script>
```

ç„¶åæŠŠ `vue.2.6.11.min.js` æ”¾è¿›åŒç›®å½• `/www/wwwroot/yys.im/eva/html/`ã€‚

ä½ è¦æ˜¯æŠŠ `index.html` é‡Œæ‰€æœ‰ `<script src=...>` é‚£å‡ è¡Œè´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ æ¯ä¸€è¡Œè¯¥æ€ä¹ˆæ”¹æˆæœ€ç¨³çš„ç›¸å¯¹è·¯å¾„ç‰ˆæœ¬ã€‚

## Q: 

æˆåŠŸäº† ç»™æˆ‘å†è®²è®²ç›¸å¯¹è·¯å¾„ å¹¶ä¸¾å¤šä¸ªä¾‹å­ è®©æˆ‘æ›´æ˜ç™½äº›

## A: 

å¤ªå¥½äº†ï¼ç›¸å¯¹è·¯å¾„è¿™ä¸œè¥¿ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼š**â€œä»å½“å‰ç½‘é¡µæ‰€åœ¨çš„ä½ç½®å‡ºå‘ï¼Œå»æ‰¾èµ„æºã€‚â€**ï¼ˆè€Œç»å¯¹è·¯å¾„æ˜¯â€œä»ç½‘ç«™æ ¹ç›®å½• / å‡ºå‘â€ï¼‰ã€‚

ä¸‹é¢æˆ‘ç”¨ä½ è¿™ä¸ªé¡¹ç›®çš„ç»“æ„æ¥è®²ï¼Œé…å¾ˆå¤šä¾‹å­ã€‚

* * *

## å…ˆå‡è®¾ä½ çš„ç›®å½•é•¿è¿™æ ·

ç«™ç‚¹æ ¹ç›®å½•ï¼š`/www/wwwroot/yys.im/`

ä½ é¡¹ç›®åœ¨ï¼š`/www/wwwroot/yys.im/eva/html/`

é‡Œé¢æœ‰ï¼š

*   `index.html`

*   `document.css`

*   `vue.2.6.11.min.js`

*   `js/app.js`

*   `fonts/matisse.woff2`

*   `img/logo.png`

é‚£ä¹ˆå¯¹åº”çš„ URL å¤§æ¦‚æ˜¯ï¼š

*   `https://yys.im/eva/html/index.html`

*   `https://yys.im/eva/html/document.css`

*   `https://yys.im/eva/html/js/app.js`

*   â€¦

*   * *

## 1ï¼‰ç›¸å¯¹è·¯å¾„çš„ä¸‰ç§â€œèµ·ç‚¹å†™æ³•â€

### A. `document.css`ï¼ˆä¸å†™å‰ç¼€ï¼‰

```html
<link rel="stylesheet" href="document.css">
```

å«ä¹‰ï¼š**åœ¨å½“å‰é¡µé¢æ‰€åœ¨ç›®å½•**æ‰¾  
å¦‚æœä½ å½“å‰é¡µé¢æ˜¯ï¼š`https://yys.im/eva/html/index.html`  
å®ƒä¼šå»æ‰¾ï¼š`https://yys.im/eva/html/document.css`

### B. `./document.css`ï¼ˆæ˜¾å¼è¯´â€œå½“å‰ç›®å½•â€ï¼‰

```html
<link rel="stylesheet" href="./document.css">
```

å«ä¹‰è·Ÿä¸Šé¢å‡ ä¹ä¸€æ ·ï¼š**ä»ç„¶æ˜¯å½“å‰ç›®å½•**ã€‚  
å®ƒçš„ä¼˜ç‚¹æ˜¯æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“åœ¨ä¸€äº›â€œè·¯å¾„è¢«é‡å†™/æ‹¼æ¥â€çš„æƒ…å†µä¸‹å‡ºé”™ã€‚

### C. `../document.css`ï¼ˆä¸Šä¸€çº§ç›®å½•ï¼‰

```html
<link rel="stylesheet" href="../document.css">
```

å«ä¹‰ï¼šä» `eva/html/` é€€å›åˆ° `eva/` å†æ‰¾  
å¦‚æœå½“å‰é¡µæ˜¯ï¼š`https://yys.im/eva/html/index.html`  
å®ƒä¼šå»æ‰¾ï¼š`https://yys.im/eva/document.css`

* * *

## 2ï¼‰æœ€é‡è¦çš„å‘ï¼šä»¥ `/` å¼€å¤´çš„ä¸æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ˜¯â€œç«™ç‚¹ç»å¯¹è·¯å¾„â€

```html
<script src="/vue.2.6.11.min.js"></script>
```

è¿™ä¸ª `/` è¡¨ç¤ºï¼š**ä»åŸŸåæ ¹ç›®å½•å¼€å§‹**  
ä¸ç®¡ä½ é¡µé¢åœ¨å“ªï¼Œå®ƒéƒ½ä¼šå»ï¼š

*   `https://yys.im/vue.2.6.11.min.js`

æ‰€ä»¥ä½ å½“æ—¶æŠŠ Vue æ”¾åœ¨ `eva/html/` ä¸‹å°±ä¼š 404ï¼Œå› ä¸ºå®ƒæ ¹æœ¬ä¸å»é‚£é‡Œæ‰¾ã€‚

å¯¹æ¯”ä¸€ä¸‹ï¼š

*   âœ… `./vue.2.6.11.min.js` â†’ `https://yys.im/eva/html/vue.2.6.11.min.js`

*   âŒ `/vue.2.6.11.min.js` â†’ `https://yys.im/vue.2.6.11.min.js`

*   * *

## 3ï¼‰å¤šä¸ªå®æˆ˜ä¾‹å­ï¼ˆä»ä½ å½“å‰é¡µé¢å‡ºå‘ï¼‰

å‡è®¾å½“å‰é¡µé¢æ˜¯ï¼š

`https://yys.im/eva/html/index.html`

### âœ… å¼•ç”¨åŒç›®å½•æ–‡ä»¶

```html
<link rel="stylesheet" href="./document.css">
<script src="./vue.2.6.11.min.js"></script>
```

è¯·æ±‚ä¼šå˜æˆï¼š

*   `/eva/html/document.css`

*   `/eva/html/vue.2.6.11.min.js`

### âœ… å¼•ç”¨å­ç›®å½•æ–‡ä»¶

```html
<script src="./js/app.js"></script>
<img src="./img/logo.png">
<link rel="preload" href="./fonts/matisse.woff2" as="font" type="font/woff2" crossorigin>
```

è¯·æ±‚ä¼šå˜æˆï¼š

*   `/eva/html/js/app.js`

*   `/eva/html/img/logo.png`

*   `/eva/html/fonts/matisse.woff2`

### âœ… å¼•ç”¨ä¸Šä¸€çº§ç›®å½•èµ„æº

å¦‚æœä½ æŠŠå›¾ç‰‡æ”¾åœ¨ `eva/` ä¸‹ï¼š`/eva/banner.png`  
é‚£åœ¨ `eva/html/index.html` é‡Œï¼š

```html
<img src="../banner.png">
```

ä¼šè¯·æ±‚ï¼š

*   `/eva/banner.png`

*   * *

## 4ï¼‰ç›¸å¯¹è·¯å¾„â€œåˆ°åº•ç›¸å¯¹è°â€ï¼Ÿâ€”â€”ç›¸å¯¹å½“å‰ URL çš„ç›®å½•

è¿˜æ˜¯ä»¥è¿™ä¸ª URL ä¸ºä¾‹ï¼š

`https://yys.im/eva/html/index.html`

*   `a.js` æˆ– `./a.js` â†’ `/eva/html/a.js`

*   `../a.js` â†’ `/eva/a.js`

*   `../../a.js` â†’ `/a.js`

*   `/a.js` â†’ `/a.js`ï¼ˆæ°¸è¿œä»æ ¹å¼€å§‹ï¼‰

*   * *

## 5ï¼‰ä¸€ä¸ªå®¹æ˜“è¿·ç³Šçš„ç‚¹ï¼šå¦‚æœ URL æœ«å°¾ä¸å¸¦ `/`ï¼Œå¾ˆå¤šäººä¼šè¸©

ä¾‹å¦‚ä½ è®¿é—®ï¼š

*   `https://yys.im/eva/html`ï¼ˆæ²¡å†™ `/`ï¼‰

æœ‰çš„æœåŠ¡å™¨ä¼š 301 è·³è½¬åˆ°ï¼š

*   `https://yys.im/eva/html/`

æœ‰çš„é…ç½®ä¸è§„èŒƒæ—¶ï¼Œä¼šå¯¼è‡´æµè§ˆå™¨æŠŠ `html` å½“æˆâ€œæ–‡ä»¶åâ€ï¼Œç›¸å¯¹è·¯å¾„è®¡ç®—å°±å¯èƒ½æ€ªæ€ªçš„ã€‚

æ‰€ä»¥æˆ‘ä¸€èˆ¬å»ºè®®ï¼š

*   ç«™ç‚¹ç›®å½•è®¿é—®å°½é‡ä¿è¯ **æœ«å°¾æœ‰ `/`**

*   æˆ–è€…åœ¨ HTML é‡Œç»Ÿä¸€ç”¨ `./xxx` è¿™ç§æ˜¾å¼å†™æ³•

*   * *

## 6ï¼‰ä»€ä¹ˆæ—¶å€™ç”¨ç›¸å¯¹è·¯å¾„ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ `/` ç»å¯¹è·¯å¾„ï¼Ÿ

### ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆæ¨èç»™ä½ è¿™ç§é¡¹ç›®ï¼‰

*   é¡¹ç›®å¯èƒ½æ”¾åœ¨å­ç›®å½•ï¼ˆ`/eva/html/`ï¼‰

*   æœªæ¥å¯èƒ½æ¢åŸŸåã€æ¢è·¯å¾„

*   æƒ³â€œæ‹·è´åˆ°å“ªéƒ½èƒ½è·‘â€

### ç”¨ `/` ç»å¯¹è·¯å¾„

*   ä½ ç¡®å®šæ°¸è¿œéƒ¨ç½²åœ¨åŸŸåæ ¹ï¼ˆ`https://yys.im/`ï¼‰

*   æƒ³ç»Ÿä¸€å¼•ç”¨æ ¹ç›®å½•çš„å…¬å…±èµ„æºï¼ˆæ¯”å¦‚ `/assets/...`ï¼‰

*   * *

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ æŠŠ `index.html` é‡Œæ‰€æœ‰ `src="/..."`ã€`href="/..."` ä¸€æ¬¡æ€§æ”¹æˆæ›´ç¨³çš„ç›¸å¯¹è·¯å¾„é£æ ¼ï¼ˆè¿™æ ·ä»¥åä½ æŠŠé¡¹ç›®æŒªåˆ°ä»»ä½•å­ç›®å½•éƒ½ä¸ä¼š 404ï¼‰ã€‚ä½ æŠŠ `index.html` é‡Œç›¸å…³å‡ è¡Œè´´å‡ºæ¥å°±è¡Œã€‚

## Q: 

../../a.jsæ˜¯ä¸Šä¸€å±‚çš„ä¸Šä¸€å±‚å—

## A: 

å¯¹ï¼Œ`../../a.js` å°±æ˜¯â€œä¸Šä¸€çº§çš„ä¸Šä¸€çº§â€ï¼ˆå¾€ä¸Šé€€ä¸¤å±‚ï¼‰å†æ‰¾ `a.js`ã€‚

ä¸¾ä¸ªå…·ä½“ä¾‹å­ä½ ä¸€çœ¼å°±æ‡‚ï¼š

å‡è®¾å½“å‰é¡µé¢åœ¨ï¼š  
`https://yys.im/eva/html/pages/index.html`

ä¹Ÿå°±æ˜¯ç›®å½•æ˜¯ï¼š  
`/eva/html/pages/`

é‚£å„ä¸ªè·¯å¾„è§£æç»“æœæ˜¯ï¼š

*   `./a.js` æˆ– `a.js` â†’ `https://yys.im/eva/html/pages/a.js`ï¼ˆåŒä¸€å±‚ï¼‰

*   `../a.js` â†’ `https://yys.im/eva/html/a.js`ï¼ˆä¸Šä¸€å±‚ï¼‰

*   `../../a.js` â†’ `https://yys.im/eva/a.js`ï¼ˆä¸Šä¸¤å±‚ï¼‰

*   `../../../a.js` â†’ `https://yys.im/a.js`ï¼ˆå†ä¸Šä¸‰å±‚åˆ°æ ¹ï¼‰

*   `/a.js` â†’ `https://yys.im/a.js`ï¼ˆç›´æ¥ä»æ ¹å¼€å§‹ï¼Œè·Ÿå½“å‰åœ¨å“ªæ— å…³ï¼‰

è®°å¿†è¯€çªï¼š

*   `../` = â€œå›åˆ°çˆ¶ç›®å½•â€ä¸€æ¬¡

*   `../../` = â€œå›åˆ°çˆ¶ç›®å½•â€ä¸¤æ¬¡  
    æƒ³å›å‡ å±‚å°±å†™å‡ ä¸ª `../`ã€‚

## Q: 

ä¸ºä»€ä¹ˆè¿™ä¸ªé¡¹ç›®ä¸­ ./a.js æˆ– a.js ä¼šå‡ºç°é”™è¯¯

## A: 

å› ä¸º `./a.js` å’Œ `a.js` éƒ½æ˜¯**ç›¸å¯¹å½“å‰é¡µé¢ URL çš„ç›®å½•**æ¥ç®—çš„ï¼Œè€Œåœ¨ä½ è¿™ä¸ªé¡¹ç›®é‡Œï¼Œâ€œå½“å‰é¡µé¢çš„ç›®å½•â€ç»å¸¸ä¼šå› ä¸ºä¸‹é¢è¿™äº›åŸå› å˜æ‰ï¼Œæ‰€ä»¥å°±ä¼šæŒ‡åˆ°é”™è¯¯çš„ä½ç½®ï¼Œå¯¼è‡´ 404ã€‚

## 1ï¼‰ä½ è®¿é—®çš„ URL ä¸æ˜¯ä½ ä»¥ä¸ºçš„é‚£ä¸ªç›®å½•ï¼ˆæœ€å¸¸è§ï¼‰

ç›¸å¯¹è·¯å¾„æ˜¯æŒ‰**åœ°å€æ é‡Œçš„è·¯å¾„**ç®—çš„ï¼Œä¸æŒ‰æœåŠ¡å™¨çœŸå®æ–‡ä»¶è·¯å¾„ç®—ã€‚

æ¯”å¦‚ä½ ä»¥ä¸ºä½ åœ¨ï¼š

*   `https://yys.im/eva/html/`ï¼ˆç›®å½•ï¼‰

ä½†ä½ å®é™…æ‰“å¼€çš„æ˜¯ï¼š

*   `https://yys.im/eva/` æˆ– `https://yys.im/eva/html`ï¼ˆå°‘äº†ç»“å°¾ `/`ï¼‰æˆ– `https://yys.im/eva/html/some-route`

é‚£ä¹ˆï¼š

*   `a.js` ä¼šå»æ‰¾ `https://yys.im/eva/a.js` æˆ– `https://yys.im/eva/html/a.js`ï¼ˆè·Ÿä½ é¢„æœŸä¸åŒï¼‰

*   äºæ˜¯å°± 404

\*\*ç»éªŒï¼š\*\*åªè¦é¡¹ç›®å¯èƒ½æ”¾åœ¨å­ç›®å½•ï¼Œèµ„æºå»ºè®®ç»Ÿä¸€å†™æˆ `./xxx` + ç¡®ä¿ç”¨ `.../` å½¢å¼è®¿é—®ç›®å½•ã€‚

* * *

## 2ï¼‰é¡µé¢é‡Œæœ‰ `<base href="...">`ï¼ˆå¾ˆéšè”½ï¼Œä½†æ€ä¼¤åŠ›å¤§ï¼‰

å¦‚æœ HTML é‡Œæœ‰ï¼š

```html
<base href="/eva/">
```

é‚£æ‰€æœ‰ç›¸å¯¹è·¯å¾„ï¼ˆ`a.js`ã€`./a.js`ã€`css/main.css`ï¼‰éƒ½ä¼šå˜æˆç›¸å¯¹è¿™ä¸ª base è®¡ç®—ï¼Œè€Œä¸æ˜¯ç›¸å¯¹å½“å‰é¡µé¢ç›®å½•ã€‚

ç»“æœå°±æ˜¯ä½ å†™ `./a.js` ä¹Ÿå¯èƒ½è·‘å» `/eva/a.js`ï¼Œä»è€ŒæŠ¥é”™ã€‚

ä½ å¯ä»¥åœ¨ `index.html` é‡Œæœï¼š

```html
<base
```

* * *

## 3ï¼‰ä½ æŠŠ `index.html` æ”¾åˆ°äº†æŸå±‚ï¼Œä½† `a.js` å®é™…ä¸åœ¨åŒå±‚

`a.js`/`./a.js` çš„å«ä¹‰å°±æ˜¯ â€œåŒç›®å½•ä¸‹çš„ a.jsâ€ã€‚

æ‰€ä»¥å¦‚æœçœŸå®ç»“æ„æ˜¯ï¼š

```css
/eva/html/index.html
/eva/html/js/a.js
```

é‚£ä½ å†™ï¼š

```html
<script src="a.js"></script>
```

å½“ç„¶æ‰¾ä¸åˆ°ã€‚

å¿…é¡»å†™æˆï¼š

```html
<script src="./js/a.js"></script>
```

* * *

## 4ï¼‰å‰ç«¯è·¯ç”±/é‡å†™è®©â€œå½“å‰è·¯å¾„â€å˜æ·±äº†

æ¯”å¦‚ä½ æ‰“å¼€ï¼š

*   `https://yys.im/eva/html/#/about`ï¼ˆhash è·¯ç”±ï¼‰ä¸€èˆ¬ä¸å½±å“ç›¸å¯¹è·¯å¾„  
    ä½†å¦‚æœæ˜¯ï¼š

*   `https://yys.im/eva/html/about`ï¼ˆhistory è·¯ç”±/é‡å†™ï¼‰  
    é‚£ä¹ˆ `a.js` å¯èƒ½ä¼šè¢«è§£ææˆï¼š

*   `/eva/html/a.js` æˆ– `/eva/html/about/a.js`ï¼ˆå–å†³äºé¡µé¢å®é™…æ˜¯å“ªä¸ª URLï¼‰

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤š SPA é™æ€é¡¹ç›®æ›´å–œæ¬¢ç”¨ `/assets/...` æˆ–è®¾ç½® `base`/æ‰“åŒ…æ—¶é…ç½® publicPathã€‚

* * *

## 5ï¼‰Cloudflare/ç¼“å­˜å¯¼è‡´ä½ åŠ è½½çš„æ˜¯â€œæ—§çš„ HTMLâ€ï¼Œè·¯å¾„å·²ç»å˜äº†

ä½ ä¹‹å‰å°±é‡åˆ°è¿‡ Cloudflareï¼šåŒä¸€ä¸ªèµ„æº curl æ˜¯ 200ï¼Œä½†æµè§ˆå™¨è¿˜ 404ã€‚  
è¿™æ˜¯ç¼“å­˜å¯¼è‡´ä½ æµè§ˆå™¨æ‹¿åˆ°çš„ HTML ä»åœ¨å¼•ç”¨æ—§è·¯å¾„ï¼Œå½“ç„¶ä¼šè§‰å¾—â€œæˆ‘å†™ a.js æ€ä¹ˆé”™äº†â€ã€‚

* * *

### æœ€ç¨³çš„åšæ³•ï¼ˆé€‚åˆä½ è¿™ä¸ªé¡¹ç›®ï¼‰

*   èµ„æºå†™æˆ**ç›¸å¯¹äºå½“å‰ç›®å½•**ï¼š`./document.css`ã€`./vue.2.6.11.min.js`ã€`./js/xxx.js`

*   ç¡®ä¿è®¿é—®è·¯å¾„æ˜¯å¸¦ `/` çš„ç›®å½•å½¢å¼ï¼š`https://yys.im/eva/html/`

*   æ£€æŸ¥æœ‰æ²¡æœ‰ `<base href=...>`ï¼Œæœ‰çš„è¯è¦ä¹ˆåˆ æ‰ï¼Œè¦ä¹ˆæ”¹æ­£ç¡®

å¦‚æœä½ æŠŠä½ é¡¹ç›®é‡Œé‚£å‡ è¡Œ `<script src=...>` å’Œä½ å½“å‰å®é™…æ‰“å¼€çš„é¡µé¢ URLï¼ˆåœ°å€æ é‚£ä¸€æ•´æ¡ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥æŒ‡å‡ºæ˜¯å“ªä¸€ç§æƒ…å†µåœ¨å‘ä½ ã€‚

## Q: 

é‡åˆ°ä¸åŒ¹é…å­—å‹å¯å…ˆå˜—è©¦è½‰ç¹é«”ï¼Œé‚„ä¸åŒ¹é…çš„æƒ…å†µè«‹å˜—è©¦æ›¿æ›å…¶ä»–æ–‡å­— å®åœ¨æ‰¾ä¸åˆ°æ›¿æ¢æ–‡å­—å¯ä»¥å·æ‡’å®‰è£…ä¸€ä»½ æ€æºå®‹ä½“ Heavy å­—å‹ä½œä¸º Fallbacks

## A: 

æ˜ç™½ï¼Œä½ è¿™æ®µè¯æ˜¯åœ¨ç»™ç”¨æˆ·å†™â€œä½¿ç”¨è¯´æ˜/æ’é”™å»ºè®®â€ã€‚æˆ‘ç»™ä½ æ¶¦è‰²æˆæ›´æ¸…æ™°çš„ä¸€ç‰ˆï¼ˆä¿ç•™ä½ åŸæ„ï¼‰ï¼Œå†ç»™ä½ ä¸€ä¸ªæ›´æ­£å¼å’Œä¸€ä¸ªæ›´å£è¯­çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥æŒ‰åœºæ™¯é€‰ã€‚

## ç‰ˆæœ¬ Aï¼ˆæ¸…æ™°é€šç”¨ï¼Œæ¨èæ”¾ READMEï¼‰

é‡åˆ°å­—å½¢ä¸åŒ¹é…æ—¶ï¼Œå¯å…ˆå°è¯•å°†æ–‡å­—è½¬æ¢ä¸ºç¹ä½“ï¼›å¦‚æœä»ä¸åŒ¹é…ï¼Œè¯·æ›´æ¢ä¸ºå…¶ä»–æ–‡å­—ã€‚  
è‹¥å®åœ¨æ‰¾ä¸åˆ°åˆé€‚çš„æ›¿æ¢æ–¹æ¡ˆï¼Œå¯å·æ‡’å®‰è£… **æ€æºå®‹ä½“ï¼ˆSource Han Serifï¼‰Heavy** ä½œä¸ºåå¤‡å­—ä½“ï¼ˆfallbackï¼‰ã€‚

## ç‰ˆæœ¬ Bï¼ˆæ›´æ­£å¼ä¸€ç‚¹ï¼‰

å¦‚å‡ºç°å­—å½¢ä¸åŒ¹é…çš„æƒ…å†µï¼Œå»ºè®®ä¼˜å…ˆå°è¯•å°†æ–‡æœ¬è½¬æ¢ä¸ºç¹ä½“ï¼›è‹¥ä»æ— æ³•åŒ¹é…ï¼Œè¯·æ›¿æ¢ä¸ºå…¶ä»–æ–‡å­—ã€‚  
è‹¥ç¡®å®æ— æ³•æ‰¾åˆ°æ›¿ä»£å­—ç¬¦ï¼Œå¯å®‰è£… **æ€æºå®‹ä½“ï¼ˆSource Han Serifï¼‰Heavy** ä½œä¸º fallback å­—ä½“ï¼Œä»¥æå‡å…¼å®¹æ€§ã€‚

## ç‰ˆæœ¬ Cï¼ˆæ›´å£è¯­ä¸€ç‚¹ï¼‰

å¦‚æœæœ‰å­—ä¸åŒ¹é…ï¼Œå…ˆè¯•è¯•è½¬æˆç¹ä½“ï¼›è¿˜ä¸è¡Œå°±æ¢ä¸ªå­—/æ¢ä¸ªè¯´æ³•ã€‚  
å®åœ¨æƒ³ä¸åˆ°æ›¿æ¢çš„è¯ï¼Œç›´æ¥è£…ä¸ª **æ€æºå®‹ä½“ Heavy** å½“å¤‡ç”¨å­—ä½“ï¼ˆfallbackï¼‰å°±çœäº‹äº†ã€‚

å¦‚æœä½ æƒ³æ›´è´´å¿ƒä¸€ç‚¹ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ è¿½åŠ ä¸€å¥â€œå“ªé‡Œä¸‹è½½/å®‰è£…ï¼ˆWindows/macOS/Linuxï¼‰â€çš„è¯´æ˜ã€‚

## Q: 

å¦‚ä½•åœ¨è¿™ä¸ªé¡¹ç›®ä¸­å¼•ç”¨æ–°å­—ä½“ä½œä¸ºåå¤‡å­—ä½“

## A: 

åœ¨è¿™ä¸ªé¡¹ç›®é‡ŒåŠ â€œåå¤‡å­—ä½“ï¼ˆfallbackï¼‰â€ï¼Œæ ¸å¿ƒå°±ä¸¤æ­¥ï¼š

1.  **æŠŠæ–°å­—ä½“â€œå¯ç”¨â€èµ·æ¥**ï¼ˆæœ¬åœ°å·²å®‰è£… or é¡¹ç›®å†…ç”¨ `@font-face` å¼•å…¥ï¼‰

2.  **åœ¨ `font-family` é‡ŒæŠŠå®ƒæ’åœ¨ä¸»å­—ä½“åé¢**ï¼ˆä¸»å­—ä½“æ‰¾ä¸åˆ°æŸä¸ªå­—å½¢æ—¶ï¼Œå°±ä¼šå¾€åæ‰¾ï¼‰

ä¸‹é¢ç»™ä½ å‡ ç§æœ€å®ç”¨çš„åšæ³•ï¼ˆç›´æ¥å¤åˆ¶æ”¹ï¼‰ã€‚

* * *

## åšæ³• 1ï¼ˆæ¨èï¼‰ï¼šæŠŠå­—ä½“æ–‡ä»¶æ”¾è¿›é¡¹ç›®ï¼Œç”¨ `@font-face` å¼•å…¥ï¼ˆè·¨è®¾å¤‡ç¨³å®šï¼‰

å‡è®¾ä½ å‡†å¤‡ç”¨ **æ€æºå®‹ä½“ Heavy** å½“åå¤‡å­—ä½“ï¼Œå¹¶ä¸”ä½ æ‹¿åˆ°äº† `SourceHanSerifSC-Heavy.woff2`ã€‚

### 1) æ”¾æ–‡ä»¶

æŠŠå­—ä½“æ”¾åˆ°ä¾‹å¦‚ï¼š

```swift
/www/wwwroot/yys.im/eva/html/fonts/SourceHanSerifSC-Heavy.woff2
```

### 2) åœ¨ `document.css`ï¼ˆæˆ–ä½ é¡¹ç›®çš„ä¸» CSSï¼‰é‡ŒåŠ å…¥ï¼š

```css
@font-face {
  font-family: "SHSerifFallback";
  src: url("./fonts/SourceHanSerifSC-Heavy.woff2") format("woff2");
  font-weight: 900; /* Heavy å¸¸ç”¨ 800/900ï¼ŒæŒ‰ä½ å­—ä½“å®é™…æƒ…å†µ */
  font-style: normal;
  font-display: swap;
}
```

### 3) æŠŠåå¤‡å­—ä½“åŠ è¿› font-family é“¾

ä¾‹å¦‚ä½ å…¨ç«™ç”¨ï¼š

```css
body {
  font-family: "EVA", "SHSerifFallback", "Source Han Serif SC", "Noto Serif CJK SC", serif;
}
```

è§£é‡Šä¸€ä¸‹é¡ºåºï¼š

*   `"EVA"`ï¼šä½ çš„ä¸»å­—ä½“ï¼ˆé¡¹ç›®é‡Œé‚£å¥—ï¼‰

*   `"SHSerifFallback"`ï¼šä½ å¼•å…¥çš„åå¤‡ï¼ˆä¿è¯æœ‰ï¼‰

*   `"Source Han Serif SC"` / `"Noto Serif CJK SC"`ï¼šç”¨æˆ·ç³»ç»Ÿå¯èƒ½è‡ªå¸¦çš„å®‹ä½“ç³»

*   `serif`ï¼šæœ€åå…œåº•

> åªè¦ä¸»å­—ä½“ç¼ºæŸä¸ªå­—çš„å­—å½¢ï¼Œæµè§ˆå™¨å°±ä¼šå¾€åæ‰¾èƒ½æ˜¾ç¤ºçš„é‚£ä¸ªå­—å½¢ã€‚

* * *

## åšæ³• 2ï¼šåªä¾èµ–â€œç³»ç»Ÿå·²å®‰è£…å­—ä½“â€ï¼ˆæœ€çœäº‹ï¼Œä½†ç”¨æˆ·æ²¡è£…å°±æ²¡ç”¨ï¼‰

å¦‚æœä½ æ˜¯è®©ç”¨æˆ·è‡ªå·±â€œå®‰è£…æ€æºå®‹ä½“ Heavyâ€ï¼Œé‚£é¡¹ç›®é‡Œä¸ç”¨æ”¾å­—ä½“æ–‡ä»¶ï¼Œåªè¦åœ¨ CSS é‡ŒåŠ  fallback åç§°ï¼š

```css
body {
  font-family: "EVA", "Source Han Serif SC", "Source Han Serif", "Noto Serif CJK SC", serif;
}
```

æ³¨æ„ï¼š**å­—ä½“åç§°è¦å†™å¯¹**ï¼Œä¸åŒç³»ç»Ÿæ˜¾ç¤ºåå¯èƒ½ç•¥ä¸åŒï¼›å†™å¤šä¸ªåˆ«åæ›´ç¨³ã€‚

* * *

## åšæ³• 3ï¼šåªå¯¹æŸä¸ªå…ƒç´ /ç»„ä»¶åŠ  fallbackï¼ˆä¸å½±å“å…¶ä»–éƒ¨åˆ†ï¼‰

æ¯”å¦‚åªå¯¹è¾“å…¥æ¡†/é¢„è§ˆæ–‡å­—åŠ ï¼š

```css
.preview-text, .result-text, input, textarea {
  font-family: "EVA", "SHSerifFallback", serif;
}
```

* * *

## å¸¸è§å‘ï¼ˆä½ ä¸€çœ‹å°±èƒ½é¿ï¼‰

*   **è·¯å¾„**ï¼šä½ ç°åœ¨é¡¹ç›®åœ¨ `/eva/html/`ï¼Œæ‰€ä»¥ CSS é‡Œç”¨ `./fonts/...` æœ€ç¨³ï¼ˆç›¸å¯¹ `document.css` æ‰€åœ¨ç›®å½•ï¼‰ã€‚

*   **woff2 ä¼˜å…ˆ**ï¼šæµè§ˆå™¨æ›´å‹å¥½ã€‚èƒ½ç”¨ woff2 å°±åˆ«ç”¨ ttf/otfï¼ˆä½“ç§¯å¤§ï¼‰ã€‚

*   **ä¸è¦æŒ‡æœ›â€œä¸€ä¸ª font-family åªæœ‰ä¸€ç§å­—ä½“â€**ï¼šæŒ‰å­—ç¬¦é€ä¸ª fallback æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œæ‰€ä»¥æœ‰äº›å­—ä¼šâ€œçœ‹èµ·æ¥ä¸ä¸€æ ·â€ï¼Œè¿™æ˜¯é¢„æœŸç»“æœã€‚

*   **å¦‚æœä½ ç”¨çš„æ˜¯ Vue æ¨¡æ¿/JS åŠ¨æ€å†™ style**ï¼šä¹Ÿè¦æŠŠé‚£é‡Œçš„ `fontFamily` æ”¹æˆå¸¦ fallback çš„é“¾ã€‚

*   * *

## ä½ å¯ä»¥ç›´æ¥è´´ä¸€æ®µæˆ‘å¸®ä½ æ”¹

ä½ æŠŠ `document.css` é‡Œç°åœ¨è®¾ç½®å­—ä½“çš„é‚£å‡ è¡Œï¼ˆä¾‹å¦‚ `body` æˆ–æŸä¸ª class çš„ `font-family`ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å°±èƒ½æŒ‰ä½ é¡¹ç›®ç°çŠ¶æŠŠâ€œåå¤‡å­—ä½“é“¾â€ç²¾å‡†æ’è¿›å»ï¼Œä¿è¯ä¸ç ´åç°æœ‰æ ·å¼ã€‚

## Q: 

å¸®æˆ‘çœ‹ä½œè€…æœ‰æ²¡æœ‰åœ¨æˆ‘å‘çš„æ–‡ä»¶ä¸­åšè¿™ä¸€ä»¶äº‹

## A: 

çœ‹äº†ä½ å‘çš„è¿™ä¸ª `eva-title-main.zip`ï¼Œä½œè€…\*\*â€œæœ‰æåˆ°/åšäº†ä¸€éƒ¨åˆ†å‡†å¤‡â€ï¼Œä½†æ²¡æœ‰åœ¨æ ·å¼é‡ŒçœŸæ­£æŠŠæ–°å­—ä½“åŠ å…¥ fallback é“¾\*\*ã€‚

## ä»–åšäº†ä»€ä¹ˆï¼ˆåœ¨ä½ çš„æ–‡ä»¶é‡Œç¡®å®å­˜åœ¨ï¼‰

### 1) `document.less` é‡Œæœ‰ä¸€æ®µ **@font-face çš„ç¤ºä¾‹**ï¼Œä½†å…¨éƒ½è¢«æ³¨é‡Šæ‰äº†

åœ¨ `eva-title-main/html/document.less` å¼€å¤´èƒ½çœ‹åˆ°ï¼ˆæ³¨æ„å‰é¢éƒ½æ˜¯ `//`ï¼Œæ‰€ä»¥ä¸ä¼šç”Ÿæ•ˆï¼‰ï¼š

```less
// @font-face {
//     font-family: EVAMatisseClassic;
//     src: url(../fonts/EVA-Matisse_Classic.woff2);
// }
// @font-face {
//     font-family: MatisseProEB;
//     src: url(FOT-MatissePro-EB.woff2);
// }
//
// @font-face {
//     font-family: NotoSerifSCBlack;
//     src: url(NotoSerifSC-Black.woff2);
// }
//
// @font-face {
//     font-family: baseSplit;
//     src: url(base-split.woff);
// }
```

ä¹Ÿå°±æ˜¯è¯´ï¼šä½œè€…**é¢„ç•™äº†æ€è·¯**ï¼ˆåŒ…æ‹¬ Noto Serifã€baseSplitï¼‰ï¼Œä½†**æ²¡æœ‰å¯ç”¨**ï¼Œæ›´æ²¡æœ‰æŠŠâ€œæ€æºå®‹ä½“ Heavyâ€æ”¾è¿› `font-family: ... , ...` é‡Œä½œä¸ºåå¤‡ã€‚

### 2) `document.js` é‡Œä¼šæ£€æµ‹ä½ ç³»ç»Ÿæœ‰æ²¡æœ‰è£…æŸäº›å­—ä½“ï¼ˆåŒ…æ‹¬ â€œSourceHanSerifCN-Heavyâ€ï¼‰

åœ¨ `eva-title-main/html/document.js` é‡Œæœ‰ï¼š

```js
let haveMatisse = checkFont('EVA_Matisse_Classic-EB,MatissePro-EB') > 120;
let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150;
```

è¿™è¯´æ˜ä½œè€…**ç¡®å®è€ƒè™‘è¿‡**â€œå¦‚æœç”¨æˆ·è£…äº†æ€æºå®‹ä½“ Heavyï¼ˆSourceHanSerifCN-Heavyï¼‰å°±å¯ä»¥ç”¨â€çš„åœºæ™¯â€”â€”ä½†è¿™é‡Œç›®å‰åªæ˜¯â€œæ£€æµ‹â€ï¼Œå¹¶æ²¡æœ‰åœ¨ CSS/JS é‡ŒæŠŠå®ƒæ¥åˆ°æ˜¾ç¤ºç”¨çš„ fallback å­—ä½“é“¾ä¸Šã€‚

* * *

## ç»“è®º

*   **æ²¡æœ‰**ï¼šåœ¨ä½ è¿™ä»½æ–‡ä»¶é‡Œï¼Œä½œè€…å¹¶æ²¡æœ‰å®Œæˆâ€œå¼•ç”¨æ–°å­—ä½“ä½œä¸ºåå¤‡å­—ä½“ï¼ˆfallbackï¼‰â€è¿™ä»¶äº‹ï¼ˆè‡³å°‘æ²¡æœ‰è®©é¡µé¢åœ¨ç¼ºå­—æ—¶è‡ªåŠ¨ fallback åˆ°æ€æºå®‹ä½“ Heavyï¼‰ã€‚

*   **æœ‰**ï¼šä»–ç•™äº†æ³¨é‡Šç¤ºä¾‹ + ç”¨ JS æ£€æµ‹ç³»ç»Ÿæ˜¯å¦å­˜åœ¨ `SourceHanSerifCN-Heavy`ï¼Œç®—æ˜¯â€œåŠæˆå“/é¢„å¤‡å·¥ä½œâ€ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç›´æ¥åŸºäºä½ ç°åœ¨çš„ç›®å½•ç»“æ„ï¼ˆä½ ç°åœ¨æ˜¯ `/www/wwwroot/yys.im/eva/html/`ï¼‰ç»™ä½ ä¸€å¥—**æœ€å°æ”¹åŠ¨**çš„ fallback å®ç°ï¼šæ—¢æ”¯æŒâ€œç”¨æˆ·ç³»ç»Ÿè£…äº†æ€æºå®‹ä½“â€ï¼Œä¹Ÿæ”¯æŒâ€œä½ æŠŠ woff2 æ”¾è¿› fonts ç›®å½•æ—¶è‡ªåŠ¨ç”Ÿæ•ˆâ€ã€‚

## Q: 

æˆ‘ç°åœ¨ä¸‹è½½äº†SourceHanSerifCN-Heav.otf å¹¶æ”¾åˆ°äº†æ–‡ä»¶ä¸­ æˆ‘è¯¥æ€ä¹ˆå¼•ç”¨ä»–

## A: 

å¯ä»¥å¼•ç”¨ï¼Œè€Œä¸”ä½ ç°åœ¨æ”¾çš„æ˜¯ **.otf**ï¼Œåšæ³•å°±æ˜¯ï¼šç”¨ `@font-face` æŠŠå®ƒæ³¨å†Œæˆä¸€ä¸ª font-family åå­—ï¼Œç„¶åæŠŠè¿™ä¸ªåå­—åŠ åˆ°ä½ åŸæ¥çš„ `font-family` åé¢å½“åå¤‡å­—ä½“ã€‚

ä¸‹é¢æŒ‰ä½ ç°åœ¨é¡¹ç›®ç›®å½•ï¼ˆä½ ä¹‹å‰æ˜¯åœ¨ `/www/wwwroot/yys.im/eva/html/`ï¼‰ç»™ä½ ä¸€å¥—æœ€å°æ”¹åŠ¨çš„æ­¥éª¤ã€‚

* * *

## 1ï¼‰æŠŠå­—ä½“æ”¾åˆ°åˆé€‚ä½ç½®ï¼ˆæ¨è fonts ç›®å½•ï¼‰

æŠŠæ–‡ä»¶æ”¾åˆ°ï¼ˆä¸¾ä¾‹ï¼‰ï¼š

```swift
/www/wwwroot/yys.im/eva/html/fonts/SourceHanSerifCN-Heavy.otf
```

ç¡®è®¤å­˜åœ¨ï¼š

```bash
ls -la /www/wwwroot/yys.im/eva/html/fonts/SourceHanSerifCN-Heavy.otf
```

* * *

## 2ï¼‰åœ¨ `document.css` é¡¶éƒ¨åŠ å…¥ `@font-face`

ç¼–è¾‘ï¼š  
`/www/wwwroot/yys.im/eva/html/document.css`

åœ¨æœ€ä¸Šé¢åŠ ï¼š

```css
@font-face {
  font-family: "SourceHanSerifCNHeavyLocal";
  src: url("./fonts/SourceHanSerifCN-Heavy.otf") format("opentype");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
```

> `format("opentype")` å¯¹ .otf æ˜¯å¯¹çš„ã€‚`font-weight` ä¸ä¸€å®šå¿…é¡»ç²¾ç¡®ï¼Œä½†å»ºè®®ç»™ Heavy ç”¨ 900ã€‚

* * *

## 3ï¼‰æŠŠå®ƒåŠ åˆ°ä½ é¡µé¢å®é™…åœ¨ç”¨çš„å­—ä½“é“¾é‡Œï¼ˆå…³é”®ï¼‰

ä½ è¦æ‰¾åˆ°é¡¹ç›®é‡ŒçœŸæ­£æ§åˆ¶æ–‡å­—çš„é‚£æ¡ `font-family`ï¼ˆé€šå¸¸åœ¨ `body`ã€`.container`ã€`.preview` ä¹‹ç±»çš„é€‰æ‹©å™¨ï¼‰ã€‚

å¦‚æœä½ ä¸ç¡®å®šåœ¨å“ªï¼Œå…ˆæœï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "font-family" document.css | head -n 30
```

æŠŠé‚£æ¡ä¸»å­—ä½“æ”¹æˆç±»ä¼¼è¿™ç§ï¼ˆæŠŠä½ çš„ä¸»å­—ä½“æ”¾å‰é¢ï¼Œæ–°å­—ä½“æ”¾åé¢ï¼‰ï¼š

```css
body {
  font-family: "EVA_Matisse_Classic-EB", "MatissePro-EB", "SourceHanSerifCNHeavyLocal",
               "Source Han Serif SC", "Noto Serif CJK SC", serif;
}
```

è¦ç‚¹ï¼š

*   **ä¸»å­—ä½“åœ¨å‰**ï¼ˆä½ é¡¹ç›®çš„ EVA/Matisseï¼‰

*   **ä½ çš„ Heavy ä½œä¸ºåå¤‡**ï¼ˆ`SourceHanSerifCNHeavyLocal`ï¼‰

*   å†å¾€åæ”¾ä¸€äº›ç³»ç»Ÿå¯èƒ½æœ‰çš„å®‹ä½“ç³»åˆ— + `serif` å…œåº•

*   * *

## 4ï¼‰å¦‚æœä½ å¸Œæœ›â€œä»…å½“ç¼ºå­—æ—¶æ‰æ›¿è¡¥â€ï¼Œè¿™æ ·å†™å°±æ˜¯å¯¹çš„

æµè§ˆå™¨ä¼šæŒ‰â€œå­—ç¬¦â€é€ä¸ª fallbackï¼šä¸»å­—ä½“æ²¡æœ‰è¿™ä¸ªå­—å½¢ â†’ å»åå¤‡å­—ä½“æ‰¾ â†’ ç›´åˆ°æ‰¾åˆ°èƒ½æ˜¾ç¤ºçš„å­—å½¢ã€‚

* * *

## 5ï¼‰.otf åœ¨æœåŠ¡å™¨ä¸Šå¸¸è§å‘ï¼šMIME ç±»å‹ä¸å¯¹å¯¼è‡´å­—ä½“åŠ è½½å¤±è´¥

å¦‚æœä½ æ‰“å¼€ F12 â†’ Network å‘ç° `.otf` 404 æˆ–è¢«æ‹’ç»ï¼Œå¯èƒ½éœ€è¦åœ¨ Nginx å¢åŠ  otf ç±»å‹ã€‚

åœ¨å®å¡”ç«™ç‚¹ Nginx é…ç½®ï¼ˆæˆ–å…¨å±€ï¼‰åŠ ï¼š

```nginx
types {
  font/otf  otf;
}
```

é‡è½½ Nginxã€‚

ï¼ˆå¦‚æœä½ æ²¡çœ‹åˆ°ä»»ä½•å­—ä½“åŠ è½½æŠ¥é”™ï¼Œä¸€èˆ¬ä¸éœ€è¦è¿™æ­¥ã€‚ï¼‰

* * *

## 6ï¼‰å¿«é€ŸéªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

1.  æµè§ˆå™¨æ‰“å¼€é¡µé¢ï¼ŒF12 â†’ Network è¿‡æ»¤ `otf`  
    çœ‹ `SourceHanSerifCN-Heavy.otf` æ˜¯å¦ **200**

2.  F12 â†’ Elements â†’ é€‰ä¸­é‚£æ®µâ€œæ˜¾ç¤ºå¼‚å¸¸çš„å­—â€  
    çœ‹ computed é‡Œçš„ **Rendered Fonts / font-family**ï¼Œæ˜¯å¦å‡ºç°ä½ çš„å­—ä½“å

* * *

### æ›´æ¨èçš„å‡çº§ï¼ˆå¯é€‰ï¼‰ï¼šæŠŠ otf è½¬æˆ woff2

`.otf` å¾€å¾€ä½“ç§¯å¤§ã€åŠ è½½æ…¢ã€‚é•¿æœŸå»ºè®®è½¬ `woff2` å†å¼•ç”¨ï¼ˆæ›´çœæµé‡æ›´å¿«ï¼‰ã€‚ä½ è¦æ˜¯æƒ³æˆ‘ç»™ä½ ä¸€æ¡å¯ç”¨çš„è½¬æ¢å‘½ä»¤ï¼ˆæ ¹æ®ä½ æœåŠ¡å™¨ç¯å¢ƒï¼‰ï¼Œæˆ‘ä¹Ÿèƒ½ç›´æ¥å†™å¥½ã€‚

å¦‚æœä½ æŠŠ `document.css` é‡Œç›®å‰é‚£æ®µæ§åˆ¶å­—ä½“çš„é€‰æ‹©å™¨ï¼ˆä¾‹å¦‚ `body{...}` æˆ–å¯¹åº” class é‚£å‡ è¡Œï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠ fallback é“¾å‡†ç¡®æ’è¿›å»ï¼Œé¿å…ä½ æ”¹é”™ä½ç½®å¯¼è‡´â€œåŠ äº†ä½†æ²¡ç”Ÿæ•ˆâ€ã€‚

## Q: 

woff2å’Œotfæœ‰ä»€ä¹ˆåŒºåˆ« åœ¨ä½¿ç”¨æ—¶æœ‰ä»€ä¹ˆä¸ä¸€æ ·çš„

## A: 

`OTF` å’Œ `WOFF2` éƒ½èƒ½è£…å­—ï¼Œä½†å®ƒä»¬æ›´åƒâ€œ**åŒä¸€æœ¬å­—ä½“çš„ä¸åŒåŒ…è£…**â€ã€‚åŒºåˆ«ä¸»è¦åœ¨ **ç”¨é€”ã€ä½“ç§¯ã€åŠ è½½æ€§èƒ½ã€æµè§ˆå™¨æ”¯æŒå’ŒæœåŠ¡ç«¯é…ç½®**ã€‚

## æ ¸å¿ƒåŒºåˆ«

### OTFï¼ˆOpenType Fontï¼‰

*   **å®šä½**ï¼šåŸå§‹å­—ä½“æ–‡ä»¶æ ¼å¼ï¼ˆæ¡Œé¢å®‰è£…ã€æ’ç‰ˆè½¯ä»¶å¸¸ç”¨ï¼‰

*   **ä½“ç§¯**ï¼šé€šå¸¸æ›´å¤§ï¼ˆæ²¡æ€ä¹ˆå‹ç¼©ï¼‰

*   **Web ä½¿ç”¨**ï¼šå¯ä»¥ç”¨ `@font-face` ç›´æ¥å¼•ç”¨ï¼Œä½†ä¸å¤Ÿâ€œç½‘é¡µå‹å¥½â€

*   **ä¼˜ç‚¹**ï¼šåŸæ±åŸå‘³ã€é€šç”¨ï¼Œæ‹¿åˆ°å°±èƒ½è£…åˆ°ç³»ç»Ÿé‡Œ

*   **ç¼ºç‚¹**ï¼šç½‘é¡µåŠ è½½æ›´æ…¢ï¼›æœ‰æ—¶éœ€è¦é¢å¤–é…ç½® MIMEï¼›CDN/ç¼“å­˜æˆæœ¬æ›´é«˜

### WOFF2ï¼ˆWeb Open Font Format 2ï¼‰

*   **å®šä½**ï¼šä¸“é—¨ä¸ºç½‘é¡µåŠ è½½è®¾è®¡çš„å­—ä½“å°è£…

*   **ä½“ç§¯**ï¼šé€šå¸¸æ¯” OTF/TTF **å°å¾ˆå¤š**ï¼ˆå‹ç¼©æ›´å¼ºï¼ŒåŠ è½½æ›´å¿«ï¼‰

*   **Web ä½¿ç”¨**ï¼šç½‘é¡µç«¯æœ€ä½³å®è·µï¼ˆç°ä»£æµè§ˆå™¨å‡ ä¹éƒ½æ”¯æŒï¼‰

*   **ä¼˜ç‚¹**ï¼šå¿«ã€çœæµé‡ã€ç¼“å­˜å‹å¥½ï¼›æµè§ˆå™¨åŠ è½½ä½“éªŒæ›´ç¨³å®š

*   **ç¼ºç‚¹**ï¼šä¸é€‚åˆä½œä¸ºâ€œç³»ç»Ÿå®‰è£…å­—ä½“â€ï¼ˆå®ƒä¸»è¦å°±æ˜¯ç»™ web ç”¨çš„ï¼‰

*   * *

## ä½¿ç”¨æ—¶æœ‰ä»€ä¹ˆä¸ä¸€æ ·ï¼ˆä»£ç å±‚é¢ï¼‰

ä¸¤è€…éƒ½ç”¨ `@font-face`ï¼Œä¸»è¦å·®åˆ«åœ¨ `src` çš„æ ¼å¼å£°æ˜å’Œä½ æ›´æ¨èçš„å†™æ³•ï¼š

### ç”¨ OTFï¼ˆä½ ç°åœ¨çš„æƒ…å†µï¼‰

```css
@font-face {
  font-family: "SHSerifHeavy";
  src: url("./fonts/SourceHanSerifCN-Heavy.otf") format("opentype");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
```

### ç”¨ WOFF2ï¼ˆæ¨èï¼‰

```css
@font-face {
  font-family: "SHSerifHeavy";
  src: url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
```

> `format("woff2")` / `format("opentype")` å†™å¯¹æ›´åˆ©äºæµè§ˆå™¨åˆ¤æ–­ä¸ä¼˜åŒ–ã€‚

* * *

## å®é™…éƒ¨ç½²/ä½“éªŒçš„ä¸åŒç‚¹ï¼ˆä½ è¿™ç§é¡¹ç›®æœ€ç›¸å…³ï¼‰

### 1) åŠ è½½é€Ÿåº¦

*   **WOFF2**ï¼šæ›´å° â†’ æ›´å¿« â†’ é¦–å±æ›´ç¨³

*   **OTF**ï¼šæ›´å¤§ â†’ æ›´æ…¢ â†’ æ›´å®¹æ˜“å‡ºç°â€œå…ˆæ˜¾ç¤ºåæ›¿æ¢/é—ªçƒ(FOUT/FOIT)â€

### 2) æœåŠ¡å™¨é…ç½®ï¼ˆMIME / ç¼“å­˜ï¼‰

*   **WOFF2** ä¸€èˆ¬æœåŠ¡å™¨é»˜è®¤å°±æ”¯æŒå¾—æ›´å¥½ï¼ˆ`font/woff2`ï¼‰

*   **OTF** æœ‰æ—¶ä¼šè¢«å½“æˆ `application/octet-stream`ï¼Œé€šå¸¸ä¹Ÿèƒ½ç”¨ï¼Œä½†å¶å°”ä¼šé‡åˆ°å­—ä½“è§£ç /è·¨åŸŸç­–ç•¥æ›´æŒ‘å‰”çš„æƒ…å†µ  
    ï¼ˆå°¤å…¶ä½ ç”¨äº† Cloudflareï¼Œæ›´æ¨è WOFF2ï¼‰

### 3) æµè§ˆå™¨å…¼å®¹

*   ç°ä»£æµè§ˆå™¨ï¼šWOFF2 åŸºæœ¬æ²¡é—®é¢˜

*   æè€æµè§ˆå™¨ï¼šå¯èƒ½åªæ”¯æŒ WOFF/TTFï¼Œä½†ä½ è¿™ä¸ªé¡¹ç›®ä¹Ÿä¸å¤ªåƒè¦å…¼å®¹ IE æ—¶ä»£

### 4) æˆæƒ/ç‰ˆæƒ

è¿™ä¸ªè·Ÿæ ¼å¼æ— å…³ï¼Œä½†æé†’ä¸€å¥ï¼šå¾ˆå¤šå­—ä½“æˆæƒå¯¹â€œç½‘é¡µåµŒå…¥â€æœ‰é¢å¤–æ¡æ¬¾ã€‚æ€æºç³»åˆ—ä¸€èˆ¬æ¯”è¾ƒå‹å¥½ï¼Œä½†ä»å»ºè®®ç¡®è®¤ä½ ç”¨çš„å­—ä½“ç‰ˆæœ¬/æˆæƒè¯´æ˜ã€‚

* * *

## æœ€ä½³å®è·µï¼ˆä½ ç°åœ¨è¯¥æ€ä¹ˆé€‰ï¼‰

*   åªåšç½‘é¡µå±•ç¤ºï¼š**ä¼˜å…ˆ WOFF2**ï¼ˆæ¨èæŠŠ OTF è½¬æˆ WOFF2 å†å¼•ç”¨ï¼‰

*   è®©ç”¨æˆ·æœ¬æœºå®‰è£…å½“ fallbackï¼šé‚£å°±ç»™ç”¨æˆ· **OTF/TTF å®‰è£…åŒ…**ï¼ˆè¿™æ˜¯ç³»ç»Ÿå®‰è£…ç”¨çš„ï¼‰

å¾ˆå¤šé¡¹ç›®ä¼šåŒæ—¶æä¾›ä¸¤ç§ï¼Œåƒè¿™æ ·å†™æœ€ç¨³ï¼š

```css
@font-face{
  font-family:"SHSerifHeavy";
  src:
    url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2"),
    url("./fonts/SourceHanSerifCN-Heavy.otf") format("opentype");
  font-weight:900;
  font-style:normal;
  font-display:swap;
}
```

æµè§ˆå™¨ä¼šä¼˜å…ˆç”¨ woff2ï¼›æ²¡æœ‰æ”¯æŒæ—¶æ‰å›é€€åˆ° otfã€‚

* * *

å¦‚æœä½ æƒ³æŠŠä½ ç°åœ¨é‚£ä»½ `SourceHanSerifCN-Heavy.otf` è½¬æˆ `.woff2`ï¼Œå‘Šè¯‰æˆ‘ä½ æœåŠ¡å™¨ä¸Šæœ‰æ²¡æœ‰ `fonttools` æˆ– `node`ï¼ˆä½ æœ‰ npmï¼‰ï¼Œæˆ‘å¯ä»¥ç»™ä½ ä¸€ä¸ªåœ¨ Linux ä¸Šå¯ç›´æ¥è·‘çš„è½¬æ¢æ–¹æ¡ˆã€‚

## Q: 

otfæ€ä¹ˆå˜æˆwoff2

## A: 

ä½ ç°åœ¨åœ¨ Linux æœåŠ¡å™¨ä¸Šï¼ˆè€Œä¸”å·²ç»æœ‰ `node/npm`ï¼‰ï¼ŒæŠŠ `.otf` è½¬æˆ `.woff2` æœ€ç¨³çš„åŠæ³•æœ‰ä¸¤ç§ï¼š**fonttoolsï¼ˆæ¨èï¼‰** æˆ– **woff2 å·¥å…·é“¾**ã€‚æˆ‘ç»™ä½ ç›´æ¥å¯å¤åˆ¶çš„å‘½ä»¤ã€‚

* * *

## æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šç”¨ Python fonttools è½¬ï¼ˆæœ€ç®€å•ã€æˆåŠŸç‡é«˜ï¼‰

### 1) å®‰è£…ä¾èµ–

Ubuntu/Debianï¼š

```bash
sudo apt update
sudo apt install -y python3-pip
pip3 install --user fonttools brotli
```

> `brotli` æ˜¯ç”Ÿæˆ woff2 éœ€è¦çš„ã€‚

### 2) è½¬æ¢

å‡è®¾ä½ çš„å­—ä½“åœ¨ï¼š  
`/www/wwwroot/yys.im/eva/html/fonts/SourceHanSerifCN-Heavy.otf`

æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/yys.im/eva/html/fonts
python3 -m fontTools.ttLib.woff2 compress SourceHanSerifCN-Heavy.otf
```

æˆåŠŸåä¼šç”Ÿæˆï¼š  
`SourceHanSerifCN-Heavy.woff2`

æ£€æŸ¥ï¼š

```bash
ls -la SourceHanSerifCN-Heavy.*
```

* * *

## æ–¹æ¡ˆ Bï¼šç”¨ç³»ç»Ÿ woff2 å·¥å…·ï¼ˆä¹Ÿå¾ˆå¥½ä½†æœ‰æ—¶è¦è£…åŒ…ï¼‰

```bash
sudo apt update
sudo apt install -y woff2
cd /www/wwwroot/yys.im/eva/html/fonts
woff2_compress SourceHanSerifCN-Heavy.otf
```

* * *

## è½¬å®Œä»¥åæ€ä¹ˆç”¨ï¼ˆCSSï¼‰

æŠŠä½  CSS æ”¹æˆä¼˜å…ˆ woff2ï¼š

```css
@font-face{
  font-family: "SHSerifHeavy";
  src: url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
```

æˆ–è€…åŒä¿é™©ï¼ˆwoff2 ä¼˜å…ˆï¼Œotf å…œåº•ï¼‰ï¼š

```css
@font-face{
  font-family:"SHSerifHeavy";
  src:
    url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2"),
    url("./fonts/SourceHanSerifCN-Heavy.otf") format("opentype");
  font-weight:900;
  font-style:normal;
  font-display:swap;
}
```

* * *

## å¸¸è§å‘ï¼ˆå¦‚æœä½ é‡åˆ°é”™è¯¯ï¼‰

*   `No module named fontTools`ï¼šè¯´æ˜ pip å®‰è£…æ²¡è¿› PATHï¼Œç”¨ `python3 -m pip install --user ...`

*   æƒé™é—®é¢˜ï¼šæŠŠå­—ä½“ç›®å½•æƒé™ç»™å¯å†™ï¼Œæˆ–ç”¨ `sudo`ï¼ˆä¸æ¨èé•¿æœŸç”¨ sudo pipï¼‰

å¦‚æœä½ æŠŠ `fonts` ç›®å½•é‡Œå­—ä½“æ–‡ä»¶å `ls` çš„è¾“å‡ºè´´ä¸€ä¸‹ï¼Œæˆ‘ä¹Ÿå¯ä»¥æŠŠå‘½ä»¤æŒ‰ä½ çš„çœŸå®æ–‡ä»¶åç²¾ç¡®å†™ä¸€éï¼Œé¿å…æ‹¼é”™ã€‚

## Q: 

ç„¶åéœ€è¦å“ªäº›æ“ä½œ

## A: 

ä½ ç°åœ¨å·²ç»æŠŠå­—ä½“æ–‡ä»¶æ”¾è¿›å»äº†ï¼Œå¹¶ä¸”åœ¨ `document.css` é‡Œå†™äº† `@font-face`ï¼Œæ¥ä¸‹æ¥è¿˜å·® **æœ€å…³é”®çš„ä¸€æ­¥**ï¼š**åœ¨å®é™…ä½¿ç”¨æ–‡å­—çš„åœ°æ–¹æŠŠè¿™äº›å­—ä½“åŠ å…¥ `font-family`ï¼ˆä½œä¸º fallback é“¾ï¼‰**ã€‚å¦åˆ™â€œæ³¨å†Œäº†å­—ä½“â€ä¹Ÿä¸ä¼šè¢«ç”¨åˆ°ã€‚

å¦å¤–ä½ è¿™æ®µ `@font-face` æœ‰ä¸¤ä¸ªå°é—®é¢˜ä¹Ÿè¦é¡ºæ‰‹ä¿®ä¸€ä¸‹ï¼šè·¯å¾„å’Œæ ¼å¼å£°æ˜ã€‚

* * *

## 1ï¼‰å…ˆæŠŠ `@font-face` å†™è§„èŒƒï¼ˆå»ºè®®ç…§ä¸‹é¢æ”¹ï¼‰

ä½ æˆªå›¾é‡Œåƒè¿™æ ·ï¼š

```css
@font-face {
  font-family: EVAMatisseClassic;
  src: url(..fonts/EVA-Matisse_Classic.woff2);
}
```

è¿™é‡Œ `..fonts` å°‘äº†ä¸€ä¸ª `/`ï¼Œåº”è¯¥æ˜¯ `../fonts/...`ï¼ˆé™¤éä½ çš„ fonts å°±åœ¨åŒç›®å½•ï¼Œä¸ç„¶ä¼š 404ï¼‰ã€‚

âœ… æ¨èä½ æ”¹æˆï¼ˆæ›´ç¨³ï¼šå¸¦å¼•å· + formatï¼‰ï¼š

```css
@font-face{
  font-family: "EVAMatisseClassic";
  src: url("../fonts/EVA-Matisse_Classic.woff2") format("woff2");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}

@font-face{
  font-family: "NotoSerifSCBlack";
  src: url("./NotoSerifSC-Black.woff2") format("woff2");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
```

> è¯´æ˜ï¼š
>
> *   `../fonts/...`ï¼šè¡¨ç¤ºä» `document.css` æ‰€åœ¨ç›®å½•å¾€ä¸Šä¸€çº§å†è¿› `fonts`
>
> *   `./NotoSerifSC-Black.woff2`ï¼šè¡¨ç¤ºæ–‡ä»¶å’Œ `document.css` åŒç›®å½•ï¼ˆçœ‹ä½ æˆªå›¾åƒæ˜¯è¿™æ ·ï¼‰
>
> *   `font-display: swap`ï¼šé¿å…ç™½å±ç­‰å­—ä½“åŠ è½½ä½“éªŒé—®é¢˜

* * *

## 2ï¼‰æœ€é‡è¦ï¼šæŠŠåå¤‡å­—ä½“åŠ åˆ° `font-family`ï¼ˆè®©å®ƒçœŸçš„ç”Ÿæ•ˆï¼‰

ä½ è¦åœ¨æ§åˆ¶æ–‡æœ¬æ˜¾ç¤ºçš„é€‰æ‹©å™¨é‡ŒåŠ ä¸€æ¡ç±»ä¼¼ï¼š

```css
body{
  font-family:
    "EVAMatisseClassic",
    "MatisseProEB",
    "NotoSerifSCBlack",
    "SourceHanSerifCN-Heavy",
    serif;
}
```

### æ€ä¹ˆæ‰¾åˆ°åº”è¯¥åŠ åœ¨å“ªï¼Ÿ

åœ¨ä½  `document.css` é‡Œæœï¼š

*   `font-family:`

*   æˆ–è€…çœ‹ `body`ã€`.text`ã€`.preview`ã€`.output` è¿™äº›é€‰æ‹©å™¨

ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "font-family" document.css | head -n 50
```

æŠŠä½ æ‰¾åˆ°çš„â€œè´Ÿè´£æ¸²æŸ“æ–‡å­—çš„é‚£ä¸€æ¡â€æ”¹æˆå¸¦ fallback çš„é“¾å³å¯ã€‚

> fallback çš„é¡ºåºåŸåˆ™ï¼š**ä¸»å­—ä½“åœ¨å‰**ï¼Œç¼ºå­—æ‰è½®åˆ°åé¢çš„å­—ä½“ã€‚

* * *

## 3ï¼‰ç¡®ä¿æ–‡ä»¶èƒ½è¢«æµè§ˆå™¨è®¿é—®åˆ°ï¼ˆç”¨ Network éªŒè¯ 200ï¼‰

æ”¹å®Œåï¼Œæµè§ˆå™¨ F12 â†’ Networkï¼Œè¿‡æ»¤ `woff2`ï¼Œåˆ·æ–°é¡µé¢ï¼Œç¡®è®¤ï¼š

*   `EVA-Matisse_Classic.woff2` æ˜¯ 200

*   `NotoSerifSC-Black.woff2` æ˜¯ 200

*   ä½ æ–°å¢çš„å­—ä½“ï¼ˆå¦‚æœæœ‰ï¼‰ä¹Ÿæ˜¯ 200

å¦‚æœæœ‰ 404ï¼Œå°±æ˜¯è·¯å¾„è¿˜ä¸å¯¹ï¼ˆæœ€å®¹æ˜“é”™çš„å°±æ˜¯ `../fonts/` å’Œ `./fonts/`ï¼‰ã€‚

* * *

## 4ï¼‰å¯é€‰ï¼šè®© JS è¯†åˆ«åˆ°ä½ è£…çš„ fallback å­—ä½“ï¼ˆå¦‚æœé¡¹ç›®æœ‰æ£€æµ‹é€»è¾‘ï¼‰

ä½œè€…çš„ `document.js` é‡Œä¼š `checkFont('SourceHanSerifCN-Heavy', 800)` ä¹‹ç±»ã€‚  
å¦‚æœä½ åœ¨ CSS é‡ŒæŠŠå­—ä½“ `font-family` åå­—å†™æˆåˆ«çš„ï¼ˆæ¯”å¦‚ `"SourceHanSerifCNHeavyLocal"`ï¼‰ï¼Œé‚£ JS æ£€æµ‹ä¸åˆ°ã€‚

âœ… å»ºè®®ï¼šä½  `@font-face` çš„ `font-family` åå­—æœ€å¥½å°±ç”¨ï¼š

```css
font-family: "SourceHanSerifCN-Heavy";
```

è·Ÿä½œè€…æ£€æµ‹å­—ç¬¦ä¸²ä¸€è‡´ï¼ˆæ›´çœäº‹ï¼‰ã€‚

* * *

### ä½ ç°åœ¨åªè¦åšä¸¤ä»¶äº‹å°±èƒ½çœ‹åˆ°æ•ˆæœ

1.  ä¿®æ­£ `@font-face` çš„è·¯å¾„ï¼ˆ`../fonts/...`ï¼‰

2.  åœ¨å®é™…æ–‡å­—æ ·å¼é‡ŒåŠ  `font-family` fallback é“¾

å¦‚æœä½ æŠŠ `document.css` é‡Œé‚£æ®µâ€œçœŸæ­£æ§åˆ¶æ–‡å­—å­—ä½“çš„é€‰æ‹©å™¨ï¼ˆåŒ…å« font-family çš„é‚£å‡ è¡Œï¼‰â€è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ åº”è¯¥æŠŠ fallback é“¾æ’åˆ°å“ªä¸€æ®µã€æ€ä¹ˆå†™æœ€åˆé€‚ã€‚

## Q: 

font-familyåªæœ‰è¿™ä¸¤æ¡

## A: 

å¯¹ï¼Œè¿™å°±è¯´æ˜ä½œè€…å‡ ä¹æ²¡å…¨å±€è®¾ç½®å­—ä½“ï¼šé¡µé¢é‡Œåªæœ‰ `header h1` å’Œ `header h2` å•ç‹¬æŒ‡å®šäº†å­—ä½“ï¼Œæ‰€ä»¥ä½ åŠ çš„ `@font-face` **ä¸ä¼šè‡ªåŠ¨ç”¨åˆ°å…¶ä»–æ–‡å­—**ã€‚ä½ éœ€è¦åŠ ä¸€æ¡â€œå…¨å±€å­—ä½“é“¾â€ï¼ˆæ¨èæ”¾åœ¨ `html` æˆ– `body` ä¸Šï¼‰ï¼Œå†æŠŠ `h1/h2` é‚£ä¸¤æ¡ä¹Ÿæ”¹æˆä½¿ç”¨ä½ çš„å­—ä½“é“¾ã€‚

ä¸‹é¢ç»™ä½ ç›´æ¥å¯æŠ„çš„æ”¹æ³•ã€‚

* * *

## 1ï¼‰åŠ ä¸€æ¡å…¨å±€ fallbackï¼ˆæœ€å…³é”®ï¼‰

åœ¨ `document.css` é‡Œæ‰¾ `html { ... }` æˆ– `body { ... }`ï¼ˆä½ æ–‡ä»¶é‡Œåº”è¯¥æœ‰ `html { font: 24px/1.4 sans-serif; }` é‚£æ®µï¼‰ã€‚

æŠŠå®ƒæ”¹æˆè¿™æ ·ï¼ˆåŠ ä¸Š `font-family`ï¼‰ï¼š

```css
html{
  font: 24px/1.4 sans-serif;
  font-family:
    "EVAMatisseClassic",
    "MatisseProEB",
    "SourceHanSerifCN-Heavy",
    "NotoSerifSCBlack",
    "Noto Serif CJK SC",
    serif;
}
```

> é¡ºåºå«ä¹‰ï¼šå…ˆç”¨ EVA/Matisseï¼›ç¼ºå­—å°±ç”¨æ€æºå®‹ä½“ Heavyï¼›å†ä¸è¡Œç”¨ Notoï¼›æœ€åå…œåº• serifã€‚

* * *

## 2ï¼‰æŠŠ header çš„ä¸¤æ¡ä¹Ÿæ”¹æˆèµ°åŒä¸€å¥—å­—ä½“é“¾

ä½ æˆªå›¾é‡Œï¼š

```css
header h1 { font-family: serif; }
header h2 { font-family: 'Times New Roman', Times, serif; }
```

æ”¹æˆï¼š

```css
header h1{
  font-family:
    "EVAMatisseClassic",
    "MatisseProEB",
    "SourceHanSerifCN-Heavy",
    "NotoSerifSCBlack",
    serif;
}

header h2{
  font-family:
    "Times New Roman", Times,
    "SourceHanSerifCN-Heavy",
    "NotoSerifSCBlack",
    serif;
}
```

> è¿™æ · h2 ä»ä¼˜å…ˆ Times é£æ ¼ï¼Œä½†ç¼ºå­—ä¼šå›é€€åˆ°ä½ çš„ä¸­æ–‡åå¤‡å­—ä½“ã€‚

* * *

## 3ï¼‰ç¡®è®¤ä½ çš„ `@font-face` åå­—å’Œè·¯å¾„åŒ¹é…

ä½  `font-family` é‡Œå†™äº† `"SourceHanSerifCN-Heavy"`ï¼Œé‚£ä½  `@font-face` é‡Œä¹Ÿè¦å«è¿™ä¸ªåå­—ï¼Œä¾‹å¦‚ï¼š

```css
@font-face{
  font-family: "SourceHanSerifCN-Heavy";
  src: url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2");
  font-weight: 900;
  font-style: normal;
  font-display: swap;
}
```

ï¼ˆå¦‚æœä½ æ–‡ä»¶è¿˜æ˜¯ `.otf`ï¼ŒæŠŠ src æ”¹æˆ otf é‚£æ¡å³å¯ã€‚ï¼‰

* * *

## 4ï¼‰éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

*   F12 â†’ Network è¿‡æ»¤ `woff2/otf` çœ‹å­—ä½“æ˜¯å¦ 200

*   F12 â†’ Elements é€‰ä¸­æ–‡å­— â†’ çœ‹ computed é‡Œçš„ **Rendered fonts** æ˜¯å¦å‡ºç°ä½ åŠ çš„å­—ä½“å

*   * *

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ åšä¸€ä¸ªæ›´â€œå¹²å‡€â€çš„å†™æ³•ï¼šç”¨ CSS å˜é‡ç»Ÿä¸€ç®¡ç†å­—ä½“é“¾ï¼Œæ¯”å¦‚ `--font-main`ã€`--font-fallback`ï¼Œä»¥åä½ æ¢å­—ä½“åªæ”¹ä¸€å¤„ã€‚

## Q: 

html { font: 24px/1.4 sans-serif; text-rendering: optimizeLegibility; -webkit-font-smoothing: grayscale; background: var(--color-background); color: var(--color-font); background-position: top left; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23222222' viewBox='0 0 200 339'%3E%3Cpath d='M100,69.6l87,50v100l-87,50l-87-50v-100L100,69.6zM87-18v68L0,100L-18,0M380,0l-180,100L113,50V-18M0,239l87,50V400H-198M400,400H113v-111l87-50'/%3E%3C/svg%3E"); background-size: 16px; } html[data-output="true"] { overflow: hidden; } body { margin: 0; padding: 20px 0 100px; }

## A: 

å¾ˆå¥½ï¼Œå°±åœ¨è¿™æ®µé‡ŒåŠ å°±è¡Œï¼š**æœ€æ¨èåŠ åœ¨ `html { ... }` é‡Œ**ï¼Œå› ä¸ºä½ å·²ç»ç”¨ `font:` ç»Ÿä¸€è®¾ç½®äº†å­—å·/è¡Œé«˜ã€‚

æ³¨æ„ä¸€ä¸ªå…³é”®ç‚¹ï¼šä½ ç°åœ¨å†™çš„æ˜¯

```css
font: 24px/1.4 sans-serif;
```

è¿™ä¸ª shorthand ä¼šæŠŠ `font-family` ä¹Ÿä¸€èµ·è®¾ç½®æ‰ï¼Œæ‰€ä»¥ä½ è¦ä¹ˆï¼š

*   **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šä¿ç•™è¿™å¥ï¼Œç„¶ååœ¨å®ƒä¸‹é¢å†åŠ ä¸€è¡Œ `font-family: ...;` è¦†ç›–å³å¯

*   **æ–¹æ¡ˆ B**ï¼šæŠŠ `sans-serif` æ¢æˆä½ çš„å­—ä½“é“¾ï¼ˆä¹Ÿè¡Œï¼Œä½†ä¸å¦‚ A æ¸…æ™°ï¼‰

æˆ‘ç»™ä½ æŒ‰æ–¹æ¡ˆ A å†™å®Œæ•´å¯ç²˜è´´ç‰ˆæœ¬ï¼š

```css
html {
  font: 24px/1.4 sans-serif;
  font-family:
    "EVAMatisseClassic",
    "MatisseProEB",
    "SourceHanSerifCN-Heavy",
    "NotoSerifSCBlack",
    "Noto Serif CJK SC",
    serif;

  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: grayscale;
  background: var(--color-background);
  color: var(--color-font);
  background-position: top left;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23222222' viewBox='0 0 200 339'%3E%3Cpath d='M100,69.6l87,50v100l-87,50l-87-50v-100L100,69.6zM87-18v68L0,100L-18,0M380,0l-180,100L113,50V-18M0,239l87,50V400H-198M400,400H113v-111l87-50'/%3E%3C/svg%3E");
  background-size: 16px;
}
```

### é‡è¦æé†’ï¼ˆé¿å…ä¸ç”Ÿæ•ˆï¼‰

1.  ä½  `@font-face` é‡Œå£°æ˜çš„ `font-family` åå­—å¿…é¡»è·Ÿè¿™é‡Œçš„ä¸€è‡´

    *   ä¾‹å¦‚ä½ å†™äº† `"NotoSerifSCBlack"`ï¼Œé‚£ `@font-face` ä¹Ÿè¦ `font-family: "NotoSerifSCBlack";`

2.  è·¯å¾„è¦èƒ½ 200ï¼ˆF12 Network è¿‡æ»¤ woff2/otf çœ‹åŠ è½½æ˜¯å¦æˆåŠŸï¼‰

* * *

## è®© h1/h2 ä¹Ÿåƒåˆ°è¿™æ¡å…¨å±€å­—ä½“ï¼ˆå¯é€‰ï¼Œä½†å»ºè®®ï¼‰

ä½ ä¹‹å‰ `header h1 { font-family: serif; }` ä¼šè¦†ç›–å…¨å±€ï¼Œå»ºè®®ä½ æŠŠå®ƒåˆ æ‰æˆ–æ”¹æˆç»§æ‰¿ï¼š

```css
header h1 { font-family: inherit; }
header h2 { font-family: inherit; } /* æˆ–è€…ä¿ç•™ Times å†åŠ ä¸­æ–‡ fallback */
```

* * *

å¦‚æœä½ æŠŠä½ ç°åœ¨ `@font-face` é‚£å‡ æ®µï¼ˆå°¤å…¶æ˜¯ SourceHanSerifCN-Heavy çš„é‚£æ®µï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠå­—ä½“å/è·¯å¾„ä¸€æ¬¡å¯¹é½ï¼Œä¿è¯ä¸€å®šèƒ½ fallbackã€‚

## Q: 


## A: 

ä»ä½ è¿™å¼ å›¾çœ‹ï¼Œç°åœ¨å·²ç»**æ²¡æœ‰è‡´å‘½é”™è¯¯äº†**ï¼Œé¡µé¢èƒ½æ­£å¸¸è·‘èµ·æ¥äº† âœ…

ä½ çœ‹åˆ°çš„ä¸¤æ¡éƒ½ä¸å½±å“åŠŸèƒ½ï¼š

1.  `static.cloudflareinsights.com ... ERR_BLOCKED_BY_CLIENT`  
    è¿™æ˜¯è¢«æµè§ˆå™¨çš„å¹¿å‘Šæ‹¦æˆª/éšç§æ’ä»¶æ‹¦äº† Cloudflare çš„ç»Ÿè®¡è„šæœ¬ï¼ˆbeaconï¼‰ã€‚**ä¸ç”¨ç®¡**ã€‚æƒ³æ¶ˆå¤±å°±å…³æ‰æ’ä»¶æˆ–æŠŠè¿™ä¸ªåŸŸååŠ ç™½åå•ã€‚

2.  `Canvas2D ... willReadFrequently`  
    è¿™æ˜¯æµè§ˆå™¨çš„**æ€§èƒ½æç¤º**ï¼šä½ ä»£ç é‡Œé¢‘ç¹ `getImageData`ï¼Œå»ºè®®åœ¨åˆ›å»º canvas context æ—¶åŠ  `willReadFrequently: true`ï¼Œä¼šæ›´å¿«ã€‚**ä¸ä¿®ä¹Ÿèƒ½ç”¨**ã€‚

* * *

## å¦‚æœä½ æƒ³æŠŠ Canvas çš„æç¤ºä¹Ÿæ¶ˆæ‰ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

åœ¨ä½ æŠ¥çš„ä½ç½® `makebmp.js:33` é™„è¿‘ï¼Œåº”è¯¥æœ‰ç±»ä¼¼ï¼š

```js
const ctx = canvas.getContext('2d');
```

æŠŠå®ƒæ”¹æˆï¼š

```js
const ctx = canvas.getContext('2d', { willReadFrequently: true });
```

ä¿å­˜ååˆ·æ–°ï¼Œæç¤ºä¸€èˆ¬å°±æ²¡äº†ï¼ˆæˆ–ä¼šå‡å°‘ï¼‰ã€‚

* * *

## å¦å¤–ï¼šä½  Network é‡Œåªçœ‹åˆ° `NotDefault.woff2`ã€`base-split.woff`

è¿™è¯´æ˜å½“å‰é¡µé¢ç¡®å®åœ¨åŠ è½½å­—ä½“äº†ã€‚  
å¦‚æœä½ è¿˜æƒ³ç¡®è®¤â€œä½ çš„åå¤‡å­—ä½“é“¾æ˜¯å¦çœŸçš„ç”Ÿæ•ˆâ€ï¼Œå¯ä»¥è¿™æ ·éªŒï¼š

### éªŒè¯æ–¹æ³•

*   F12 â†’ **Elements** â†’ ç‚¹ä¸€æ®µæ–‡å­—

*   å³ä¾§ **Computed** é‡Œæ‰¾ _Rendered fonts / font-family_

*   çœ‹æ˜¯å¦å‡ºç°ä½ è®¾ç½®çš„ `"SourceHanSerifCN-Heavy"` / `"NotoSerifSCBlack"` ç­‰åå­—

*   * *

å¦‚æœä½ ç°åœ¨çš„ç›®æ ‡æ˜¯â€œé‡åˆ°ç¼ºå­—å°±ä¼˜é›… fallbackâ€ï¼Œä½ å·²ç»èµ°åœ¨æ­£ç¡®è·¯ä¸Šäº†ã€‚ä½ æƒ³è®©æˆ‘å¸®ä½ å†æ£€æŸ¥ä¸€ä¸‹ï¼šä½ é‚£å‡ ä¸ª `@font-face` è·¯å¾„æ˜¯å¦éƒ½èƒ½ 200ã€ä»¥åŠ `font-family` é“¾çš„é¡ºåºæ˜¯å¦æœ€åˆç†å—ï¼Ÿåªè¦æŠŠä½ å½“å‰çš„ `@font-face` + `html{font-family:...}` ä¸¤æ®µè´´å‡ºæ¥å°±è¡Œã€‚

## Q: 

åœ¨å“ª

## A: 

åœ¨ **Chrome å¼€å‘è€…å·¥å…·**é‡Œï¼Œä½ç½®æ˜¯è¿™æ ·çš„ï¼ˆæŒ‰æ­¥éª¤ç‚¹å°±èƒ½æ‰¾åˆ°ï¼‰ï¼š

1.  æ‰“å¼€é¡µé¢ï¼ŒæŒ‰ **F12**

2.  ç‚¹ä¸Šæ–¹çš„ **Elementsï¼ˆå…ƒç´ ï¼‰**

3.  ç”¨é¼ æ ‡ç‚¹ä¸€ä¸‹é¡µé¢é‡Œé‚£æ®µæ–‡å­—ï¼ˆç¡®ä¿é€‰ä¸­å¯¹åº”çš„ DOMï¼‰

4.  å³ä¾§ä¼šæœ‰ä¸€åˆ—é¢æ¿ï¼ˆå¦‚æœä½ çœ‹åˆ°çš„æ˜¯ Styles/Computed/â€¦ é‚£ä¸€æ’æ ‡ç­¾ï¼‰

5.  ç‚¹ **Computedï¼ˆè®¡ç®—åæ ·å¼ï¼‰**

6.  åœ¨ Computed é‡Œï¼š

    *   å¾€ä¸‹æ»šåŠ¨ï¼Œæ‰¾åˆ° **Rendered Fonts**ï¼ˆæœ‰æ—¶å« _Rendered fonts_ï¼‰

    *   æˆ–è€…åœ¨ Computed é¡¶éƒ¨çš„æœç´¢æ¡†é‡Œè¾“å…¥ï¼š`font-family`

å¦‚æœä½ å³ä¾§æ²¡çœ‹åˆ° Computedï¼ˆé¢æ¿å¤ªçª„å¸¸è§ï¼‰ï¼Œæœ‰ä¸¤ä¸ªåŠæ³•ï¼š

*   æŠŠ DevTools æ¨ªå‘æ‹‰å®½ä¸€ç‚¹ï¼›æˆ–

*   ç‚¹å³ä¾§é¢æ¿æ ‡ç­¾æ æœ«å°¾çš„ `>>`ï¼Œåœ¨é‡Œé¢é€‰ **Computed**ã€‚

æ‰¾åˆ°åä½ ä¼šçœ‹åˆ°æµè§ˆå™¨å®é™…ç”¨åˆ°çš„å­—ä½“åˆ—è¡¨ï¼ˆè¿™å°±èƒ½éªŒè¯ fallback æ˜¯å¦ç”Ÿæ•ˆï¼‰ã€‚

## Q: 

Rendered Fonts Family name: Noto Sans SC PostScript name: Noto-Sans-SC Font origin: Local file(6 glyphs)Rendered Fonts Family name: Noto Sans SC PostScript name: Noto-Sans-SC Font origin: Local file(6 glyphs)

## A: 

è¿™è¯´æ˜ **fallback å·²ç»åœ¨å·¥ä½œäº†**ï¼šä½ å½“å‰é€‰ä¸­çš„è¿™æ®µæ–‡å­—é‡Œï¼Œæœ‰ **6 ä¸ªå­—å½¢(glyphs)** æœ€ç»ˆæ˜¯ç”¨ä½ ç”µè„‘æœ¬åœ°å®‰è£…çš„ **Noto Sans SC** æ¸²æŸ“å‡ºæ¥çš„ï¼ˆä¹Ÿå°±æ˜¯ä¸»å­—ä½“é‡Œç¼ºè¿™äº›å­—ï¼Œæµè§ˆå™¨å¾€åæ‰¾åˆ°äº†èƒ½æ˜¾ç¤ºçš„å­—ä½“ï¼‰ã€‚

ä½†å®ƒä¹Ÿè¯´æ˜ä¸€ä»¶äº‹ï¼šåœ¨ä½ çš„ `font-family` é“¾é‡Œï¼Œ**Noto Sans SC çš„ä¼˜å…ˆçº§æ¯”ä½ æƒ³è¦çš„â€œæ€æºå®‹ä½“ Heavy / NotoSerifSCBlackâ€ç­‰æ›´é«˜**ï¼Œæˆ–è€…ä½ å½“å‰è¿™æ®µæ–‡å­—çš„ CSS ä»ç„¶è¢« `sans-serif`/åˆ«çš„è§„åˆ™è¦†ç›–äº†ã€‚

ä¸‹é¢æ˜¯ä½ æƒ³è¦â€œä¼˜å…ˆç”¨æŸä¸ªåå¤‡å­—ä½“â€çš„è°ƒæ•´åŠæ³•ã€‚

* * *

## ä¸ºä»€ä¹ˆä¼šç”¨åˆ° Noto Sans SCï¼Ÿ

å¸¸è§åŸå›  3 ä¸ªï¼š

1.  **ä½ è®¾ç½®çš„åå¤‡å­—ä½“æ²¡åŠ è½½/æ²¡åŒ¹é…åˆ°åå­—**  
    æ¯”å¦‚ `@font-face` çš„ `font-family` åå­—å’Œä½ å†™è¿› `font-family:` é“¾é‡Œçš„åå­—ä¸ä¸€è‡´ï¼›æˆ–å­—ä½“æ–‡ä»¶è·¯å¾„ 404ã€‚

2.  **ä½ å†™çš„åå¤‡å­—ä½“æ˜¯è¡¬çº¿(Serif)ï¼Œä½†å½“å‰è¿™æ®µæ–‡å­—è¢«å¼ºåˆ¶ç”¨ sans-serif**  
    ä¾‹å¦‚æŸä¸ªé€‰æ‹©å™¨å†™äº† `font: ... sans-serif;` æˆ– `font-family: sans-serif;`ï¼Œå¯¼è‡´æµè§ˆå™¨æ›´å€¾å‘å»æ‰¾ç³»ç»Ÿ sans-serifï¼ˆNoto Sans SCï¼‰ã€‚

3.  **ä½ çš„åå¤‡å­—ä½“é“¾é¡ºåºé‡Œï¼ŒNoto Sans SC æ›´é å‰**  
    æ¯”å¦‚ä½ å†™äº† `..., sans-serif`ï¼Œç³»ç»Ÿå°±ä¼šé€‰å®ƒçš„ä¸­æ–‡ sans-serifï¼ˆNoto Sans SC / PingFang ç­‰ï¼‰ã€‚

* * *

## ä½ æƒ³è¦â€œç¼ºå­—æ—¶ä¼˜å…ˆç”¨ SourceHanSerifCN-Heavyï¼ˆæˆ– NotoSerifSCBlackï¼‰â€æ€ä¹ˆåšï¼Ÿ

### 1ï¼‰ç¡®ä¿ä½ çš„å­—ä½“ç¡®å®è¢«åŠ è½½ï¼ˆNetwork é‡Œè¦çœ‹åˆ° 200ï¼‰

F12 â†’ Network è¿‡æ»¤ï¼š`woff2` / `otf`  
ä½ åº”è¯¥èƒ½çœ‹åˆ°æ¯”å¦‚ï¼š

*   `SourceHanSerifCN-Heavy.woff2`ï¼ˆæˆ– .otfï¼‰ 200

*   `NotoSerifSC-Black.woff2` 200

å¦‚æœçœ‹ä¸åˆ°å®ƒä»¬ï¼Œè¯´æ˜ä½ åªæ˜¯å†™äº† `font-family`ï¼Œä½†å­—ä½“æ ¹æœ¬æ²¡è¢«å¼•ç”¨æˆåŠŸã€‚

* * *

### 2ï¼‰æŠŠå…¨å±€å­—ä½“é“¾æ˜ç¡®å†™æˆâ€œå…ˆ serif å† fallback serifâ€

ä½ å¯ä»¥æŠŠ html çš„ `font` shorthand æ”¹æˆä¸æŒ‡å®š familyï¼Œæˆ–è€…ç›´æ¥è¦†ç›– `font-family`ï¼ˆä½ ä¹‹å‰æˆ‘ä»¬å°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰ã€‚

æ¨èè¿™æ ·å†™ï¼ˆé‡ç‚¹ï¼šä¸è¦åœ¨æœ€åç”¨ `sans-serif` å…œåº•ï¼Œè€Œæ˜¯ `serif`ï¼‰ï¼š

```css
html{
  font: 24px/1.4 sans-serif; /* è¿™è¡Œä¿ç•™ä¹Ÿè¡Œ */
  font-family:
    "EVAMatisseClassic",
    "MatisseProEB",
    "SourceHanSerifCN-Heavy",
    "NotoSerifSCBlack",
    "Noto Serif CJK SC",
    serif;
}
```

å¹¶ä¸”ç¡®ä¿æ²¡æœ‰åˆ«çš„åœ°æ–¹æŠŠ `body` æˆ–æŸä¸ªå®¹å™¨æ”¹æˆ `sans-serif`ã€‚

* * *

### 3ï¼‰å¦‚æœä½ å¸Œæœ›â€œå³ä½¿ä¸»å­—ä½“å­˜åœ¨ä¹Ÿæ›´å€¾å‘å®‹ä½“é£æ ¼â€ï¼ŒæŠŠ sans ç³»åˆ—ä»é“¾é‡Œæ‹¿æ‰

å¦‚æœä½ åœ¨æŸå¤„å†™äº†ç±»ä¼¼ï¼š

```css
font-family: ..., "Noto Sans SC", sans-serif;
```

é‚£å®ƒå°±ä¼šå¾ˆå®¹æ˜“ç”¨åˆ° Noto Sans SCã€‚

* * *

## å¿«é€Ÿç¡®è®¤åˆ°åº•æ˜¯å“ªæ¡ CSS åœ¨æ§åˆ¶å®ƒ

åœ¨ Elements é‡Œé€‰ä¸­é‚£æ®µæ–‡å­—åï¼š

*   çœ‹ **Styles** é¢æ¿é‡Œï¼Œå“ªä¸€æ¡è§„åˆ™æœ€ç»ˆç»™äº†å®ƒ `font-family`ï¼ˆä¼šæ˜¾ç¤ºæ¥æºæ–‡ä»¶å’Œè¡Œå·ï¼‰

*   æŠŠé‚£æ¡ `font-family` è´´å‡ºæ¥ï¼Œæˆ‘å°±èƒ½å‘Šè¯‰ä½ åº”è¯¥æ”¹å“ªä¸€å¤„ã€æ€ä¹ˆæ’é¡ºåºã€‚

*   * *

å¦‚æœä½ æƒ³æˆ‘ç›´æ¥ç»™ä½ â€œæœ€ç¨³ä¸”ç¬¦åˆä½œè€…å»ºè®®â€çš„å­—ä½“é“¾ï¼š  
ä½ æŠŠä½ å½“å‰ `html { ... }` é‡Œ `font-family` é‚£æ®µå’Œ `@font-face` é‡Œä¸‰ä¸ªå­—ä½“çš„ `font-family` åå­—è´´å‡ºæ¥ï¼ˆå‡ è¡Œå°±è¡Œï¼‰ï¼Œæˆ‘å°±èƒ½ç²¾å‡†æŒ‡å‡ºä¸ºä»€ä¹ˆè½åˆ° Noto Sans SCï¼Œä»¥åŠæ€ä¹ˆè®©å®ƒä¼˜å…ˆè½åˆ° SourceHanSerifCN-Heavyã€‚

## Q: 


## A: 

è¿™å¼ å›¾é‡Œçš„é—®é¢˜ä¹Ÿå¾ˆæ˜ç¡®ï¼šé¡µé¢åœ¨è¯·æ±‚ä¸€ä¸ª **åç«¯æ¥å£**ï¼Œä½†ä½ ç°åœ¨æ˜¯çº¯é™æ€éƒ¨ç½²ï¼Œæ‰€ä»¥ **`/api/fontmin` è¿™ä¸ªæ¥å£ä¸å­˜åœ¨**ï¼Œäºæ˜¯ 404ï¼š

*   `GET https://yys.im/api/fontmin?name=EVAMatisseClassic&unicode=... 404`

è¿™ä¸æ˜¯å­—ä½“æ–‡ä»¶æ²¡æ”¾å¥½ï¼Œè€Œæ˜¯ï¼šä½œè€…çš„é€»è¾‘æƒ³â€œæŒ‰éœ€ç”Ÿæˆ/å­é›†åŒ–å­—ä½“ï¼ˆfontminï¼‰â€ï¼Œéœ€è¦æœåŠ¡ç«¯æ¥å¤„ç†ã€‚

* * *

## ä½ æœ‰ä¸‰ç§å¤„ç†æ–¹å¼ï¼ˆä»çœäº‹åˆ°å®Œæ•´ï¼‰

### æ–¹æ¡ˆ Aï¼ˆæœ€çœäº‹ï¼Œæ¨èï¼‰ï¼šåœ¨å‰ç«¯ç¦ç”¨è¿™æ¡ /api/fontmin è°ƒç”¨

ç›®æ ‡ï¼šä¸è¦å†è¯·æ±‚ `/api/fontmin`ï¼Œæ”¹ä¸ºç›´æ¥ä½¿ç”¨ä½ å·²ç»æ”¾å¥½çš„æœ¬åœ°å­—ä½“ï¼ˆwoff2/otfï¼‰åš fallbackã€‚

åšæ³•ï¼š

1.  æ‰“å¼€æŠ¥é”™æŒ‡å‘çš„æ–‡ä»¶ï¼ˆä½ å›¾é‡Œæ˜¯ `make.js:680`ï¼Œä»¥åŠè§¦å‘å¤„ `html/?layout=...`ï¼‰

2.  åœ¨ä»£ç é‡Œæœç´¢ `"/api/fontmin"` æˆ– `fontmin`ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -R "api/fontmin" -n .
# æˆ–
grep -R "fontmin" -n .
```

æ‰¾åˆ°åé€šå¸¸æ˜¯ç±»ä¼¼ï¼š

```js
fetch(`/api/fontmin?name=${name}&unicode=${...}`)
```

**ä¸´æ—¶ç²—æš´ç‰ˆ**ï¼šç›´æ¥ return / è·³è¿‡è¿™æ®µé€»è¾‘ï¼Œè®©å®ƒä¸è¦å‘è¯·æ±‚ã€‚ï¼ˆæ¯”å¦‚åœ¨è°ƒç”¨å‰åŠ ä¸€è¡Œ `return;` æˆ–è€…æŠŠè¿™æ®µç”Ÿæˆå­—ä½“çš„åŠŸèƒ½æŒ‰é’®ç¦ç”¨ã€‚ï¼‰

> é€‚åˆä½ åªæ˜¯â€œç”Ÿæˆæ ‡é¢˜æ•ˆæœ/é¢„è§ˆâ€ï¼Œä¸éœ€è¦åœ¨çº¿è£å‰ªå­—ä½“çš„åœºæ™¯ã€‚

* * *

### æ–¹æ¡ˆ Bï¼ˆæ¨èé•¿æœŸï¼‰ï¼šæŠŠ /api/fontmin åšæˆä¸€ä¸ªçœŸæ­£çš„åç«¯æ¥å£ï¼ˆNode/Expressï¼‰

ä½œè€…é¡¹ç›®é‡Œæœ¬æ¥å°±å¸¦äº† `express` ä¾èµ–å€¾å‘ï¼ˆä½ åŒ…é‡Œæœ‰ `package.json`ï¼‰ï¼Œå¾ˆå¯èƒ½åŸä½œè€…æœ¬åœ°æ˜¯è·‘äº†ä¸€ä¸ª Node æœåŠ¡æ¥æä¾› `/api/fontmin`ã€‚

æ€è·¯ï¼š

*   ç”¨ Node/Express èµ·ä¸€ä¸ªæœåŠ¡

*   å®ç° `/api/fontmin`ï¼šæ¥æ”¶ `name` å’Œ `unicode`ï¼Œç”¨ fontminï¼ˆæˆ– fonttoolsï¼‰ç”Ÿæˆå­é›† woff2ï¼Œè¿”å›ç»™å‰ç«¯

*   ç”¨ Nginx åä»£ `/api/` åˆ° Node ç«¯å£

è¿™æ–¹æ¡ˆæœ€â€œè¿˜åŸä½œè€…è®¾è®¡â€ï¼Œä½†éœ€è¦ä½ åœ¨æœåŠ¡å™¨è·‘ Node æœåŠ¡ã€‚

* * *

### æ–¹æ¡ˆ Cï¼ˆæŠ˜ä¸­ï¼‰ï¼šæŠŠéœ€è¦çš„å­—ä½“å­é›†é¢„å…ˆç”Ÿæˆï¼ˆä¸éœ€è¦æ¥å£ï¼‰

å¦‚æœä½ ç”Ÿæˆçš„å­—ç¬¦é›†æ˜¯å›ºå®šçš„ï¼Œä½ å¯ä»¥ç¦»çº¿åšå¥½å­é›†å­—ä½“æ–‡ä»¶ï¼Œå‰ç«¯ç›´æ¥å¼•ç”¨ï¼Œä¸èµ° apiã€‚

ä½†ä½ è¿™ä¸ªå·¥å…·çœ‹èµ·æ¥æ˜¯ç”¨æˆ·è¾“å…¥ä»»æ„æ–‡å­—ï¼Œå­—ç¬¦é›†ä¼šå˜ï¼Œæ‰€ä»¥é¢„ç”Ÿæˆä¸ä¸€å®šåˆé€‚ã€‚

* * *

## ä½ ç°åœ¨åº”è¯¥åšå“ªä¸€ä¸ªï¼Ÿ

å¦‚æœä½ åªæ˜¯æƒ³ç½‘é¡µèƒ½ç¨³å®šç”¨ã€ç¼ºå­—å°± fallbackï¼š**é€‰æ–¹æ¡ˆ A**ï¼ˆç¦ç”¨ `/api/fontmin` é€»è¾‘ï¼‰ï¼Œæœ€å¿«ã€‚

* * *

## æˆ‘ç›´æ¥å‘Šè¯‰ä½ ä¸‹ä¸€æ­¥æ€ä¹ˆåšï¼ˆå®šä½å…·ä½“æ–‡ä»¶ï¼‰

å…ˆè·‘è¿™æ¡ï¼ŒæŠŠè§¦å‘æ–‡ä»¶æ‰¾å‡ºæ¥ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -R "api/fontmin" -n .
```

æŠŠè¾“å‡ºè´´ç»™æˆ‘ï¼ˆä¼šæ˜¾ç¤ºæ–‡ä»¶å:è¡Œå·ï¼‰ï¼Œæˆ‘å°±èƒ½å‘Šè¯‰ä½ **æ”¹å“ªä¸€è¡Œ**ï¼Œç”¨æœ€å°æ”¹åŠ¨è®©å®ƒä¸å† 404ï¼ˆåŒæ—¶ä¸å½±å“é¡µé¢å…¶å®ƒåŠŸèƒ½ï¼‰ã€‚

## Q: 


## A: 

ä½ è¿™å¼ å›¾é‡Œæœ‰ 3 ç±»ä¿¡æ¯ï¼Œå…¶ä¸­**çœŸæ­£å½±å“åŠŸèƒ½çš„åªæœ‰ `/api/fontmin` 404**ï¼Œå¦å¤–ä¸¤ç±»åŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚

* * *

## 1) å…³é”®é—®é¢˜ï¼š`/api/fontmin` 404ï¼ˆå¿…é¡»å¤„ç†ï¼‰

ä½ ç°åœ¨æ˜¯çº¯é™æ€éƒ¨ç½²ï¼Œæ‰€ä»¥æµè§ˆå™¨è¯·æ±‚ï¼š

`GET https://yys.im/api/fontmin?... 404`

è¿™è¯´æ˜é¡¹ç›®é‡Œæœ‰åŠŸèƒ½ä¾èµ–â€œåç«¯åŠ¨æ€å­é›†åŒ–å­—ä½“â€ï¼ˆfontminï¼‰ã€‚æ²¡æœ‰åç«¯å°±ä¼šä¸€ç›´æŠ¥é”™ï¼Œå¹¶ä¸”æŸäº›ç”Ÿæˆ/å¯¼å‡ºåŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚

### ä½ æœ‰ä¸¤æ¡è·¯ï¼š

#### è·¯çº¿ Aï¼ˆæ¨èï¼Œæœ€å¿«ç¨³å®šï¼‰ï¼šç¦ç”¨ fontmin æ¥å£è°ƒç”¨ï¼Œæ”¹æˆç›´æ¥ç”¨æœ¬åœ°å­—ä½“

ä¹Ÿå°±æ˜¯ï¼šä¸å†è¯·æ±‚ `/api/fontmin`ï¼Œåªç”¨ä½ å·²ç»æ”¾å¥½çš„å­—ä½“ï¼ˆEVA/Matisse/æ€æº/Notoï¼‰åšæ¸²æŸ“ã€‚

ä½ ç°åœ¨å…ˆåœ¨æœåŠ¡å™¨æ‰¾åˆ°æ˜¯è°åœ¨è°ƒç”¨å®ƒï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -R "api/fontmin" -n .
# æˆ–
grep -R "fontmin" -n .
```

æŠŠè¾“å‡ºè´´ç»™æˆ‘ï¼ˆæ–‡ä»¶å:è¡Œå·ï¼‰ï¼Œæˆ‘å°±èƒ½å‘Šè¯‰ä½ æ”¹å“ªä¸€å°æ®µï¼š

*   è¦ä¹ˆç›´æ¥ return è·³è¿‡

*   è¦ä¹ˆåŠ ä¸ªå¼€å…³ï¼Œæ¯”å¦‚ `USE_FONTMIN = false`

*   è¦ä¹ˆå¤±è´¥æ—¶ fallback åˆ°æœ¬åœ°å­—ä½“ï¼ˆæœ€ä¼˜é›…ï¼‰

#### è·¯çº¿ Bï¼ˆå®Œæ•´è¿˜åŸä½œè€…è®¾è®¡ï¼‰ï¼šåœ¨æœåŠ¡å™¨å®ç° `/api/fontmin`

éœ€è¦èµ·ä¸€ä¸ª Node/Express æœåŠ¡å®ç°è¿™ä¸ªæ¥å£ï¼Œç„¶å Nginx åä»£ `/api/` åˆ° Nodeã€‚  
ï¼ˆè¿™æ¡è·¯å·¥ä½œé‡æ›´å¤§ï¼Œä½†åŠŸèƒ½æœ€å®Œæ•´ï¼‰

* * *

## 2) `net::ERR_BLOCKED_BY_CLIENT`ï¼ˆä¸ç”¨ç®¡ï¼‰

è¿™æ˜¯å¹¿å‘Šæ‹¦æˆª/éšç§æ’ä»¶æ‹¦äº†æŸäº›è„šæœ¬ï¼ˆä¾‹å¦‚ cloudflare insightsï¼‰ã€‚ä¸å½±å“é¡µé¢æ ¸å¿ƒåŠŸèƒ½ã€‚

* * *

## 3) çº¢è‰²çš„ â€œUnchecked runtime.lastError â€¦ message channel closed â€¦â€

è¿™å‡ æ¡ **99% æ˜¯æµè§ˆå™¨æ’ä»¶**ï¼ˆæ¯”å¦‚ç¿»è¯‘ã€å¹¿å‘Šæ‹¦æˆªã€è„šæœ¬ç®¡ç†å™¨ï¼‰å¯¼è‡´çš„æ§åˆ¶å°å™ªéŸ³ï¼Œè·Ÿä½ ç«™ç‚¹ä»£ç å…³ç³»ä¸å¤§ã€‚

éªŒè¯æ–¹æ³•å¾ˆç®€å•ï¼š

*   ç”¨ **æ— ç—•çª—å£**ï¼ˆé»˜è®¤ç¦ç”¨å¤§éƒ¨åˆ†æ’ä»¶ï¼‰æ‰“å¼€é¡µé¢  
    æˆ–

*   ä¸´æ—¶ç¦ç”¨æ’ä»¶å†æ‰“å¼€

å®ƒä»¬é€šå¸¸å°±æ²¡äº†ã€‚

* * *

### ä½ ç°åœ¨æœ€è¯¥åšçš„ä¸€æ­¥

è¯·ä½ ç›´æ¥æŠŠä¸‹é¢å‘½ä»¤çš„è¾“å‡ºè´´å‡ºæ¥ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -R "api/fontmin" -n .
```

æˆ‘ä¼šæ ¹æ®è¾“å‡ºç»™ä½ ä¸€ä¸ªâ€œæœ€å°ä¿®æ”¹è¡¥ä¸â€ï¼Œè®© `/api/fontmin` ä¸å†æŠ¥é”™ï¼Œå¹¶ä¸”é¡µé¢åŠŸèƒ½å°½å¯èƒ½ä¸å—å½±å“ã€‚

## Q: 

ä¸ºä»€ä¹ˆ æ²¡æœ‰åå¤‡æ–‡å­—æ•ˆæœ

## A: 

ä½ ç°åœ¨â€œæ²¡æœ‰åå¤‡æ–‡å­—æ•ˆæœâ€çš„æ ¹æœ¬åŸå› é€šå¸¸ä¸æ˜¯ CSS æ²¡å†™å¯¹ï¼Œè€Œæ˜¯**è¿™ä¸ªé¡¹ç›®æ¸²æŸ“æ–‡å­—çš„æ–¹å¼**å†³å®šçš„ï¼šå®ƒå¾ˆå¯èƒ½æ˜¯ç”¨ **Canvas ç”»å­— / ç”Ÿæˆä½å›¾**ï¼Œå¹¶ä¸”ç”¨ JS **ä¸»åŠ¨æ£€æµ‹â€œä¸»å­—ä½“æœ‰æ²¡æœ‰è¿™ä¸ªå­—å½¢â€**ã€‚ä¸€æ—¦æ£€æµ‹åˆ°â€œç¼ºå­—â€ï¼Œå®ƒå°±æŠŠè¿™äº›å­—å½“æˆâ€œä¸åŒ¹é…æ–‡å­—â€å¤„ç†ï¼Œè€Œä¸æ˜¯äº¤ç»™æµè§ˆå™¨å»è‡ªåŠ¨ fallbackã€‚

å†åŠ ä¸Šä½ ç°åœ¨è¿˜å­˜åœ¨ `/api/fontmin` 404ï¼ˆæ²¡æœ‰åç«¯ï¼‰ï¼Œå¾ˆå¤šâ€œä¸ºæŸæ®µæ–‡å­—ç”Ÿæˆå¯¹åº”å­—ä½“å­é›†â€çš„æµç¨‹ä¼šå¤±è´¥ï¼Œå¯¼è‡´å®ƒæ›´å®¹æ˜“åˆ¤å®šâ€œç¼ºå­—â€ï¼Œä»è€Œçœ‹èµ·æ¥â€œfallback ä¸ç”Ÿæ•ˆâ€ã€‚

ä¸‹é¢æŠŠåŸå› å’Œæ€ä¹ˆæ”¹è®²æ¸…æ¥šï¼š

* * *

## ä¸ºä»€ä¹ˆæµè§ˆå™¨çš„ fallback æ²¡ä½“ç°å‡ºæ¥ï¼Ÿ

### 1) CSS fallback åªå¯¹â€œæ­£å¸¸é¡µé¢æ–‡å­—æ¸²æŸ“â€æœ‰æ•ˆ

å¦‚æœé¡µé¢æ˜¯ `<div>ä½ å¥½</div>` è¿™ç§ç”±æµè§ˆå™¨æ’ç‰ˆæ˜¾ç¤ºçš„æ–‡å­—ï¼Œ`font-family: A, B, C;` æ‰ä¼šé€å­— fallbackã€‚

ä½†è¿™ä¸ªé¡¹ç›®å¾ˆå¯èƒ½æ˜¯ï¼š

*   è¯»å–ç”¨æˆ·è¾“å…¥ â†’ ç”¨ Canvas `ctx.fillText()` æˆ–ç”Ÿæˆä½å›¾ â†’ å¯¼å‡ºå›¾ç‰‡  
    è¿™ç§æƒ…å†µä¸‹ **font-family ä¸åœ¨ CSS ä¸Šå†³å®š**ï¼Œè€Œåœ¨ JS é‡Œç±»ä¼¼è¿™æ ·å†³å®šï¼š

```js
ctx.font = "48px EVAMatisseClassic";
```

å¦‚æœå®ƒåªå†™äº†ä¸€ä¸ªå­—ä½“åï¼Œé‚£å°±ç®—ä½  CSS é‡Œå†™äº† fallbackï¼ŒCanvas ä¹Ÿä¸ä¼šç”¨ã€‚

âœ… ä½ è¦è®© Canvas ä¹Ÿæœ‰ fallbackï¼Œå¿…é¡»æ”¹æˆå­—ä½“æ ˆï¼š

```js
ctx.font = '48px "EVAMatisseClassic","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif';
```

* * *

### 2) é¡¹ç›®å¯èƒ½â€œä¸»åŠ¨åˆ¤ç¼ºå­—â€ï¼ŒæŠŠ fallback æœºä¼šææ‰

ä½ ä¹‹å‰é¡µé¢é‡Œå‡ºç°è¿‡ `{{noMatchMojis...}}` è¿™ç§é€»è¾‘ï¼Œè¯´æ˜å®ƒä¼šç»Ÿè®¡â€œä¸åŒ¹é…å­—â€ã€‚

å¾ˆå¤šå­—ä½“å·¥å…·ä¼šç”¨ç±»ä¼¼ä¸‹é¢çš„æ–¹å¼æ£€æµ‹ç¼ºå­—ï¼š

*   `document.fonts.check("48px EVAMatisseClassic", "æŸå­—")`

*   æˆ–ç”¨æµ‹å®½ã€æµ‹åƒç´ æ¥åˆ¤æ–­å­—å½¢æ˜¯å¦å­˜åœ¨

å¦‚æœå®ƒåªæ£€æµ‹ä¸»å­—ä½“ `EVAMatisseClassic`ï¼Œé‚£å³ä½¿åå¤‡å­—ä½“é‡Œæœ‰å­—ï¼Œå®ƒä¹Ÿä¼šä¾ç„¶æç¤ºâ€œä¸åŒ¹é…â€ï¼Œå¹¶ä¸”å¯èƒ½ä¸å»ç”»ã€‚

âœ… è§£å†³æ€è·¯ï¼š

*   æ£€æµ‹æ—¶ç”¨å­—ä½“æ ˆï¼ˆåŒ…å« fallbackï¼‰ï¼Œæˆ–è€…

*   åˆ¤æ–­ç¼ºå­—æ—¶ï¼šåªè¦ä»»æ„ä¸€ä¸ª fallback èƒ½æ¸²æŸ“ï¼Œå°±åˆ«ç®—â€œä¸åŒ¹é…â€ã€‚

*   * *

### 3) `/api/fontmin` 404 ä¼šè®©â€œæŒ‰éœ€å­—ä½“ç”Ÿæˆ/å­é›†åŒ–â€å¤±è´¥

ä½ æ§åˆ¶å°ä¸€ç›´åœ¨è¯·æ±‚ï¼š  
`/api/fontmin?name=EVAMatisseClassic&unicode=...`

è¿™é€šå¸¸ç”¨äºï¼š**æŠŠä½ è¾“å…¥çš„å­—ç¬¦åšæˆä¸€ä¸ªåªåŒ…å«è¿™äº›å­—çš„å­—ä½“æ–‡ä»¶**ï¼ˆå°ã€å¿«ã€å¯å¯¼å‡ºä¸€è‡´ï¼‰ã€‚æ²¡æœ‰åç«¯ï¼Œè¿™æ¡è·¯å°±æ–­äº†ï¼Œäºæ˜¯å®ƒå¯èƒ½ï¼š

*   æ‹¿ä¸åˆ°å¯¹åº”å­—å½¢ â†’ ç›´æ¥ç®—â€œä¸åŒ¹é…â€

*   æˆ–ä¸ç»§ç»­æ¸²æŸ“ â†’ çœ‹èµ·æ¥ fallback æ²¡æ•ˆæœ

âœ… ä¸¤æ¡è·¯ï¼š

*   **å®ç°åç«¯ `/api/fontmin`**ï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰

*   **åœ¨å‰ç«¯ç¦ç”¨è¿™æ®µè°ƒç”¨ï¼Œæ”¹ä¸ºç›´æ¥ç”¨ä½ æœ¬åœ°/é¡¹ç›®å†…å­—ä½“æ¸²æŸ“**ï¼ˆæœ€å¿«ï¼‰

*   * *

## ä½ è¦æ€ä¹ˆåšæ‰èƒ½â€œçœŸçš„æœ‰åå¤‡æ–‡å­—æ•ˆæœâ€ï¼Ÿ

### A. å…ˆç¡®è®¤ï¼šä½ æƒ³è¦çš„æ˜¯å“ªç§â€œåå¤‡æ•ˆæœâ€ï¼Ÿ

1.  **é¡µé¢ä¸Šæ˜¾ç¤ºæ–‡å­—æ—¶è‡ªåŠ¨ fallback**ï¼ˆæµè§ˆå™¨æ’ç‰ˆï¼‰  
    â†’ ä½ å·²ç»åšåˆ°ä¸€éƒ¨åˆ†äº†ï¼ˆä½ çœ‹åˆ° Rendered Fonts ç”¨äº† Noto Sans SCï¼Œè¯´æ˜ fallback åœ¨å‘ç”Ÿï¼‰ã€‚

2.  **å¯¼å‡ºå›¾ç‰‡/Canvas ç”Ÿæˆæ—¶ä¹Ÿèƒ½ fallback**  
    â†’ å¿…é¡»æ”¹ JS é‡Œçš„ `ctx.font` å­—ä½“æ ˆ + ç¼ºå­—æ£€æµ‹é€»è¾‘ï¼ˆè¿™æ˜¯ä½ ç°åœ¨ç¼ºçš„ï¼‰ã€‚

* * *

## æœ€å¿«ä¸‹ä¸€æ­¥ï¼ˆä¸é—®ä½ ä¸€å †é—®é¢˜ï¼Œç›´æ¥æ¨è¿›ï¼‰

è¯·ä½ åœ¨æœåŠ¡å™¨è·‘è¿™æ¡ï¼Œæ‰¾å‡ºåˆ°åº•æ˜¯è°è®¾ç½®äº† Canvas å­—ä½“å’Œè°ƒç”¨ fontminï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -R "ctx\.font" -n .
grep -R "api/fontmin" -n .
```

æŠŠè¾“å‡ºï¼ˆæ–‡ä»¶å:è¡Œå·ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å°±èƒ½ç›´æ¥å‘Šè¯‰ä½ **æ”¹å“ªå‡ è¡Œ**ï¼ŒæŠŠå­—ä½“æ ˆåŠ ä¸Š `"SourceHanSerifCN-Heavy"` / `"NotoSerifSCBlack"`ï¼Œå¹¶è®©â€œç¼ºå­—åˆ¤æ–­â€æŠŠ fallback ç®—è¿›å»ï¼Œè¿™æ ·æ‰ä¼šå‡ºç°ä½ æœŸå¾…çš„â€œåå¤‡æ–‡å­—æ•ˆæœâ€ã€‚

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva/html# cd /www/wwwroot/yys.im/eva grep -R "ctx\\.font" -n . grep -R "api/fontmin" -n . ./html/document.js:28: ctx.font = `${weight} ${w}px ${fontName},sans-serif`; ./html/make.js:243: ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`; ./document.js:28: ctx.font = `${weight} ${w}px ${fontName},sans-serif`; ./make.js:243: ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`; ./html/document.js:9:// let fontAPI = 'http://192.168.31.7:8003/api/fontmin'; ./html/document.js:10:let fontAPI = `https://${location.hostname}/api/fontmin`; ./html/document.js:12:// fontAPI = 'https://s6.magiconch.com/api/fontmin'; ./html/document.js:13:// fontAPI = 'http://localhost:60912/api/fontmin'; ./html/document.js:15:// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; ./html/document.js:61: fontAPI = 'http://localhost:60912/api/fontmin'; ./document.js:9:// let fontAPI = 'http://192.168.31.7:8003/api/fontmin'; ./document.js:10:let fontAPI = `https://${location.hostname}/api/fontmin`; ./document.js:12:// fontAPI = 'https://s6.magiconch.com/api/fontmin'; ./document.js:13:// fontAPI = 'http://localhost:60912/api/fontmin'; ./document.js:15:// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; ./document.js:61: fontAPI = 'http://localhost:60912/api/fontmin';

## A: 

å¤ªå¥½äº†ï¼Œç­”æ¡ˆå·²ç»â€œæŠ“åˆ°ç°è¡Œâ€äº†ï¼š**ä½ è¿™ä¸ªé¡¹ç›®çš„æ–‡å­—ä¸æ˜¯é  CSS æ¸²æŸ“çš„ï¼Œè€Œæ˜¯é  Canvas çš„ `ctx.font` æ¸²æŸ“çš„**ã€‚æ‰€ä»¥ä½ åœ¨ CSS é‡ŒåŠ  fallback ä¸ä¼šä½“ç°åœ¨â€œç”Ÿæˆ/å¯¼å‡ºæ–‡å­—æ•ˆæœâ€ä¸Šâ€”â€”å¿…é¡»æ”¹ JS é‡Œè¿™ä¸¤å¤„ `ctx.font` çš„å­—ä½“æ ˆã€‚

ä½ æŸ¥åˆ°çš„ä¸¤è¡Œå°±æ˜¯å…³é”®ï¼š

* `./html/document.js:28`

  ```js
  ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
  ```

  è¿™é‡Œ fallback åªæœ‰ `sans-serif`ï¼Œæ‰€ä»¥ä¸­æ–‡ç¼ºå­—æ—¶ä¼šæ‰åˆ°ç³»ç»Ÿçš„ Noto Sans SCï¼ˆä½ çœ‹åˆ°çš„ Rendered Fonts å°±æ˜¯å®ƒï¼‰ã€‚

* `./html/make.js:243`

  ```js
  ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`;
  ```

  è¿™é‡Œæ˜¯å¦æœ‰ fallbackï¼Œå–å†³äº `baseFontFamilyName` æ˜¯å•¥ï¼ˆä¸€èˆ¬ä¹Ÿæ²¡æ”¾ä½ è¦çš„ Heavyï¼‰ã€‚

åŒæ—¶ä½ è¿˜çœ‹åˆ°ï¼š

```js
let fontAPI = `https://${location.hostname}/api/fontmin`;
```

æ‰€ä»¥å®ƒä¼šè°ƒç”¨ä½ ç«™ç‚¹è‡ªå·±çš„ `/api/fontmin`ï¼Œä½ æ²¡åç«¯å°± 404ï¼Œå­é›†å­—ä½“ç”Ÿæˆå¤±è´¥ï¼Œä¹Ÿä¼šå½±å“â€œç¼ºå­—å¤„ç†â€çš„é‚£éƒ¨åˆ†ä½“éªŒã€‚

* * *

## âœ… ç›®æ ‡ï¼šè®© Canvas ä¹Ÿå…·å¤‡â€œåå¤‡å­—ä½“æ•ˆæœâ€

ä½ è¦åšä¸¤ä»¶äº‹ï¼š

### 1ï¼‰æŠŠ Canvas çš„å­—ä½“æ ˆè¡¥é½ï¼ˆè®©ç¼ºå­—æ—¶èƒ½è½åˆ°ä½ æŒ‡å®šçš„å­—ä½“ï¼‰

ç¼–è¾‘ `./html/document.js`ï¼ˆå’Œæ ¹ç›®å½•çš„ `./document.js` å¦‚æœä¸¤ä»½éƒ½åœ¨ç”¨ï¼Œä¹Ÿä¸€èµ·æ”¹åŒæ ·å†…å®¹ï¼‰ï¼ŒæŠŠç¬¬ 28 è¡Œæ”¹æˆï¼š

```js
ctx.font = `${weight} ${w}px "${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack","Noto Serif CJK SC",serif`;
```

> è§£é‡Šï¼š
>
> *   `"${fontName}"` ä»æ˜¯ä¸»å­—ä½“
>
> *   åé¢ä¾æ¬¡æ˜¯ä½ å¸Œæœ›ä¼˜å…ˆ fallback çš„å­—ä½“ï¼ˆæ€æºå®‹ä½“ Heavyã€Noto Serif é»‘ç­‰ï¼‰
>
> *   æœ€å `serif` å…œåº•  
>     **è¿™æ · Canvas åœ¨ç”»æ¯ä¸ªå­—ç¬¦æ—¶ä¹Ÿä¼šæŒ‰è¿™æ¡é“¾å»æ‰¾å­—å½¢ã€‚**

ç„¶ååŒç†æ”¹ `./html/make.js`ï¼ˆä»¥åŠæ ¹ç›®å½• `./make.js`ï¼‰çš„ 243 è¡Œï¼Œæ”¹æˆæ›´ç¨³çš„â€œæ— è®º baseFontFamilyName æ˜¯ä»€ä¹ˆï¼Œéƒ½å¸¦ä¸Š serif fallbackâ€ï¼š

```js
const fallbackStack = `"SourceHanSerifCN-Heavy","NotoSerifSCBlack","Noto Serif CJK SC",serif`;
ctx.font = `${fontWeight} ${fontSize}px "${_fontFamilyName}",${baseFontFamilyName || ""}${baseFontFamilyName ? "," : ""}${fallbackStack}`;
```

> è¿™æ®µå†™æ³•å¯ä»¥é¿å… `baseFontFamilyName` ä¸ºç©ºæ—¶å‡ºç°å¤šä½™é€—å·ã€‚

* * *

## âœ… 2ï¼‰å¤„ç† `/api/fontmin` 404ï¼ˆä¸ç„¶æ§åˆ¶å°ä¸€ç›´çº¢ã€ä¸”éƒ¨åˆ†åŠŸèƒ½ä¼šå¤±è´¥ï¼‰

ä½  `document.js` é‡Œå·²ç»ç»™äº†å¯ç”¨çš„å…¬å…±æœåŠ¡åœ°å€ï¼ˆæ³¨é‡Šç€ï¼‰ï¼š

```js
// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin';
```

å¦‚æœä½ åªæ˜¯æƒ³åŠŸèƒ½æ­£å¸¸ã€æ‡’å¾—è‡ªå»ºåç«¯ï¼Œ**ç›´æ¥ç”¨è¿™ä¸ª**å°±è¡Œï¼š

æŠŠ `./html/document.js`ï¼ˆä»¥åŠ `./document.js`ï¼‰é‡Œè¿™è¡Œå–æ¶ˆæ³¨é‡Šå¹¶è¦†ç›–é»˜è®¤å€¼ï¼Œä¾‹å¦‚ï¼š

```js
let fontAPI = 'https://eva-title-server.vercel.app/api/fontmin';
```

å¹¶æŠŠåŸæ¥çš„è¿™è¡Œæ³¨é‡Šæ‰ï¼š

```js
// let fontAPI = `https://${location.hostname}/api/fontmin`;
```

> è¿™æ ·å°±ä¸ä¼šå†è¯·æ±‚ä½ è‡ªå·±ç«™ç‚¹çš„ `/api/fontmin` äº†ã€‚

* * *

## æœ€åéªŒè¯

æ”¹å®Œåï¼š

1.  æµè§ˆå™¨å¼ºåˆ·ï¼ˆCtrl+F5ï¼‰ï¼Œçœ‹ Console é‡Œ `/api/fontmin` æ˜¯å¦è¿˜ 404

2.  å†é€‰ä¸€æ®µ previously â€œç¼ºå­—â€çš„å†…å®¹ï¼Œçœ‹ Canvas ç”Ÿæˆçš„ç»“æœæ˜¯ä¸æ˜¯å·²ç»èƒ½ç”¨ä½ æŒ‡å®šçš„åå¤‡å­—ä½“æ˜¾ç¤ºå‡ºæ¥

3.  Network é‡Œç¡®è®¤ä½ çš„å­—ä½“æ–‡ä»¶ï¼ˆwoff2/otfï¼‰éƒ½ 200ï¼ˆå¦‚æœä½ æ˜¯é€šè¿‡ `@font-face` å¼•å…¥çš„ï¼‰

* * *

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ æ›´è¿›ä¸€æ­¥ï¼šè®©â€œç¼ºå­—æç¤ºâ€ï¼ˆnoMatchMojisï¼‰ä¹ŸåŸºäºâ€œæ•´æ¡ fallback æ ˆâ€åˆ¤æ–­ï¼Œè€Œä¸æ˜¯åªçœ‹ä¸»å­—ä½“ï¼Œè¿™æ · UI ä¸Šå°±ä¸ä¼šå†åŠ¨ä¸åŠ¨æç¤ºâ€œä¸åŒ¹é…æ–‡å­—â€ã€‚åªè¦ä½ æŠŠ `checkFont` é‚£æ®µç›¸å…³å‡½æ•°è´´å‡ºæ¥/æˆ–æˆ‘æ ¹æ®æ–‡ä»¶å†å®šä½è¡Œå·å°±è¡Œã€‚

## Q: 

${fontName} é‡ŒåŒ…å«å“ªäº›å­—ä½“

## A: 

`fontName` é‡Œæ”¾çš„æ˜¯**å½“å‰é€‰æ‹©/è¦æ¸²æŸ“çš„â€œä¸»å­—ä½“åâ€**ï¼ˆä¸€ä¸ª font-family åç§°ï¼‰ï¼Œä¸æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚

ä»ä½ è´´å‡ºæ¥çš„ä»£ç ä½ç½®çœ‹ï¼ˆ`document.js:28`ï¼‰ï¼š

```js
ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
```

è¿™é‡Œçš„ `${fontName}` é€šå¸¸ä¼šæ˜¯ä¸‹é¢è¿™äº›ä¹‹ä¸€ï¼ˆå–å†³äºä½ åœ¨é¡µé¢é‡Œé€‰äº†å“ªç§å­—ä½“/æ¨¡å¼ï¼‰ï¼š

*   ä½ åœ¨ `@font-face` é‡Œæ³¨å†Œçš„åå­—ï¼Œæ¯”å¦‚ï¼š

    *   `EVAMatisseClassic`

    *   `MatisseProEB`

    *   `NotoSerifSCBlack`

    *   ä»¥åŠé¡¹ç›®é‡Œå¯èƒ½è¿˜æœ‰çš„ `baseSplit`ã€`NotDefault` ç­‰ï¼ˆçœ‹ä½ æ–‡ä»¶é‡Œç¡®å®æœ‰ `base-split.woff`ã€`NotDefault.woff2`ï¼‰

å®ƒ**ä¸ä¼šè‡ªåŠ¨åŒ…å«**åå¤‡å­—ä½“ï¼›åå¤‡å­—ä½“æ˜¯åœ¨ä½ æ‹¼çš„è¿™ä¸€æ®µé‡Œç”¨é€—å·è¿½åŠ çš„ï¼ˆä¾‹å¦‚ `..., "SourceHanSerifCN-Heavy", serif`ï¼‰ã€‚

* * *

## ä½ æ€ä¹ˆâ€œç¡®å®šâ€fontName å…·ä½“ä¼šæ˜¯ä»€ä¹ˆï¼Ÿ

æœ€ç›´æ¥çš„ 3 ç§æ–¹æ³•ï¼š

### æ–¹æ³• 1ï¼šåœ¨ä»£ç é‡Œæ‰“å°

åœ¨è®¾ç½® `ctx.font` å‰åŠ ä¸€è¡Œï¼š

```js
console.log("fontName =", fontName);
```

åˆ·æ–°é¡µé¢ï¼Œçœ‹æ§åˆ¶å°è¾“å‡ºã€‚

### æ–¹æ³• 2ï¼šå…¨å±€æœç´¢å“ªé‡Œç»™ fontName èµ‹å€¼

åœ¨æœåŠ¡å™¨ä¸Šè·‘ï¼š

```bash
cd /www/wwwroot/yys.im/eva
grep -R "fontName" -n ./html/document.js ./html/make.js ./html -n | head -n 60
```

çœ‹å®ƒä»å“ªé‡Œæ¥ï¼ˆé€šå¸¸æ˜¯æŸä¸ªä¸‹æ‹‰é€‰æ‹©ã€é…ç½®å¯¹è±¡ã€æˆ–å­—ä½“åˆ—è¡¨ï¼‰ã€‚

### æ–¹æ³• 3ï¼šçœ‹é¡µé¢ UI çš„å­—ä½“é€‰é¡¹

ä¸€èˆ¬ UI é‡Œä½ é€‰çš„â€œå­—ä½“åç§°â€å°±æ˜¯ä¼ è¿›æ¥çš„ `fontName`ï¼ˆå¯èƒ½ä¼šåšä¸€æ¬¡æ˜ å°„ï¼‰ã€‚

* * *

## ä½ å¯ä»¥æŠŠ fontName å˜æˆâ€œå­—ä½“æ ˆâ€å—ï¼Ÿ

å¯ä»¥ï¼Œä½†è¦å°å¿ƒï¼šå¦‚æœ `fontName` æœ¬èº«åŒ…å«é€—å·ï¼ˆæ¯”å¦‚ä½ æŠŠå®ƒå˜æˆ `"A","B"`ï¼‰ï¼Œé‚£ä½ æ‹¼æ¥æ—¶è¦ç¡®ä¿åŠ å¼•å·ï¼Œå¦åˆ™å®¹æ˜“å‡ºé”™ã€‚æ›´æ¨èçš„åšæ³•æ˜¯ï¼š

*   `fontName` ä¿æŒä¸ºä¸»å­—ä½“å•ä¸ªåå­—

*   å¦å¤–æ‹¼ä¸€ä¸ª `fallbackStack` è¿½åŠ åœ¨åé¢ï¼ˆæˆ‘ä»¬å‰é¢ç»™çš„åšæ³•ï¼‰

*   * *

å¦‚æœä½ æŠŠ `document.js` é‡Œ `fontName` æ˜¯æ€ä¹ˆæ¥çš„é‚£å‡ è¡Œï¼ˆå¤§æ¦‚ 10 è¡Œä¸Šä¸‹æ–‡ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ ï¼šå®ƒæœ‰å“ªäº›å¯èƒ½å–å€¼ã€å¯¹åº”é¡µé¢é‡Œå“ªä¸ªé€‰é¡¹ã€ä»¥åŠä½ åº”è¯¥æŠŠ fallback æ ˆæ’åœ¨ä»€ä¹ˆåœ°æ–¹æœ€å¹²å‡€ã€‚

## Q: 

@font-face é‡Œæ³¨å†Œçš„åå­— ä½†æ˜¯è¿˜æ˜¯åœ¨é¡µé¢æ˜¾ç¤ºä¸å…¨ æœ¬çº¿è¿™è¿™å‡ ä¸ªä¾æ¬¡ å¦‚æœEVAMatisseClassicä¸å­˜åœ¨è¿™ä¸ªå­— é‚£ä¹ˆå°†æœ‰åç»­çš„å­—ä½“è¡¥å…¨ ä½†æ˜¯ç°åœ¨è¿™ä¸ªå­—ä½“ä¸å­˜åœ¨è¿˜æ˜¯æ˜¾ç¤ºä¸å‡ºæ¥

## A: 

ä½ è¿™ä¸ªæè¿°éå¸¸å…¸å‹ï¼š**ä½ ä»¥ä¸ºè‡ªå·±åšäº†â€œå­—ä½“æ ˆ fallbackâ€ï¼Œä½† Canvas æœ€ç»ˆè¿˜æ˜¯â€œç¼ºå­—æ˜¾ç¤ºä¸å‡ºæ¥â€**ã€‚è¿™é€šå¸¸ä¸æ˜¯â€œfont-family è¯­æ³•â€é—®é¢˜ï¼Œè€Œæ˜¯ä¸‹é¢ 3 ä¸ªåŸå› åœ¨ä½œæ€ªï¼ˆä½ è¿™é¡¹ç›®å¾ˆå¯èƒ½æ˜¯ 1+2 åŒæ—¶å­˜åœ¨ï¼‰ï¼š

* * *

## 1ï¼‰Canvas ç”»å­—æ—¶ï¼Œå­—ä½“è¿˜æ²¡åŠ è½½å®Œæˆï¼ˆæœ€å¸¸è§ï¼‰

Canvas çš„ `ctx.fillText()` ä¸ä¼šåƒæ™®é€š DOM æ–‡æœ¬é‚£æ ·â€œç­‰å­—ä½“åŠ è½½å®Œå†é‡æ’â€ã€‚å¦‚æœä½ åœ¨å­—ä½“æ–‡ä»¶è¿˜æ²¡ ready çš„æ—¶å€™å°±ç”»äº†ï¼Œå®ƒå°±ä¼šç”¨ä¸´æ—¶å­—ä½“/ç¼ºå­—ç»“æœç›´æ¥ç”»åœ¨ç”»å¸ƒä¸Šï¼Œ**åé¢å­—ä½“åŠ è½½å¥½äº†ä¹Ÿä¸ä¼šè‡ªåŠ¨è¡¥ç”»**ï¼Œä½ çœ‹åˆ°çš„å°±ä¸€ç›´æ˜¯â€œä¸å…¨â€ã€‚

âœ… è§£å†³ï¼šåœ¨ç»˜åˆ¶å‰å¼ºåˆ¶ç­‰å¾…å­—ä½“åŠ è½½ï¼Œç„¶åå†ç»˜åˆ¶ï¼ˆæˆ–é‡ç»˜ä¸€æ¬¡ï¼‰ã€‚

åœ¨ `document.js` / `make.js` é‡Œï¼Œåœ¨ä½ çœŸæ­£å¼€å§‹ç»˜åˆ¶å‰åŠ ï¼š

```js
async function ensureFontsReady(fontStack, sampleText = "æµ‹è¯•å­—ABC") {
  try {
    // è®©æµè§ˆå™¨å¼€å§‹åŠ è½½è¿™äº›å­—ä½“
    await document.fonts.load(`48px ${fontStack}`, sampleText);
    // ç­‰å…¨éƒ¨å­—ä½“å°±ç»ª
    await document.fonts.ready;
  } catch (e) {
    console.warn("font load failed", e);
  }
}
```

ç„¶åä½ è®¾ç½® `ctx.font` ä¹‹å‰ï¼š

```js
const fontStack = `"EVAMatisseClassic","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`;
await ensureFontsReady(fontStack, text);
ctx.font = `${weight} ${w}px ${fontStack}`;
```

> è¿™æ ·å³ä½¿ EVAMatisseClassic ç¼ºå­—ï¼Œä¹Ÿèƒ½ç­‰åˆ°åå¤‡å­—ä½“ ready åå†ç”»å‡ºæ¥ã€‚

* * *

## 2ï¼‰ä½ çš„ `font-weight` åŒ¹é…ä¸ä¸Šï¼Œå¯¼è‡´æ ¹æœ¬æ²¡ç”¨åˆ°ä½ æ³¨å†Œçš„å­—ä½“

ä½ é¡¹ç›®é‡Œè®¾ç½® Canvas å­—ä½“æ˜¯è¿™æ ·çš„ï¼ˆä½ è´´çš„ï¼‰ï¼š

```js
ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
```

æ³¨æ„ `${weight}` å¾ˆå¯èƒ½æ˜¯ **800**ï¼ˆä½ æˆªå›¾é‡Œ h1 å°±æ˜¯ 800ï¼‰ï¼Œä½†ä½  `@font-face` å¯èƒ½å†™çš„æ˜¯ `font-weight: 900;` æˆ–æ²¡å†™ï¼Œæµè§ˆå™¨å°±å¯èƒ½è®¤ä¸ºâ€œè¿™ä¸ªå®¶æ—åœ¨ 800 è¿™ä¸ªæƒé‡æ²¡æœ‰å¯¹åº”å­—ä½“â€ï¼Œäºæ˜¯ fallback è¡Œä¸ºä¼šå˜å¾—å¾ˆæ€ªï¼Œç”šè‡³ç›´æ¥è·³åˆ°ç³»ç»Ÿå­—ä½“ã€‚

âœ… è§£å†³ï¼šè®© `@font-face` çš„ weight è¦†ç›–ä½ ç”¨åˆ°çš„æƒé‡èŒƒå›´ï¼ˆæœ€çœäº‹ï¼‰ï¼š

```css
@font-face{
  font-family: "SourceHanSerifCN-Heavy";
  src: url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2");
  font-weight: 100 900; /* å…³é”®ï¼šè¦†ç›–èŒƒå›´ï¼Œé¿å… 800/900 åŒ¹é…ä¸ä¸Š */
  font-style: normal;
  font-display: swap;
}
```

å¯¹ä½ æ³¨å†Œçš„å…¶ä»–å­—ä½“ä¹Ÿå»ºè®®è¿™ä¹ˆå†™ï¼ˆè‡³å°‘æŠŠ 400/800/900 è¦†ç›–æ‰ï¼‰ã€‚

* * *

## 3ï¼‰é¡¹ç›®è‡ªèº«çš„â€œç¼ºå­—åˆ¤å®š/æ›¿æ¢â€æŠŠ fallback æœºä¼šææ‰äº†

è¿™ä¸ªé¡¹ç›®æœ‰ `noMatchMojis`ã€ä»¥åŠ `checkFont(...)` è¿™ç§é€»è¾‘ï¼ˆä½ ä¹‹å‰é¡µé¢å°±æ˜¾ç¤ºè¿‡â€œä¸åŒ¹é…æ–‡å­—â€ï¼‰ï¼Œå®ƒå¾ˆå¯èƒ½åšäº†ï¼š

*   åªç”¨ä¸»å­—ä½“ `EVAMatisseClassic` å»æ£€æµ‹æŸå­—æœ‰æ²¡æœ‰

*   å¦‚æœæ²¡æœ‰ï¼Œå°±æŠŠè¿™ä¸ªå­—åˆ—åˆ° â€œä¸åŒ¹é…â€ï¼Œç”šè‡³ç›´æ¥ä¸ç”»/æ›¿æ¢æˆç©ºç™½

è¿™æ ·å°±ç®—ä½ å­—ä½“æ ˆé‡Œåé¢æœ‰ `"SourceHanSerifCN-Heavy"` èƒ½ç”»ï¼Œå®ƒä¹Ÿ**ä¸ä¼šç»™ä½ æœºä¼š**ã€‚

âœ… è§£å†³æœ‰ä¸¤ç§ï¼š

*   **è¦ä¹ˆ**æ”¹é€»è¾‘ï¼šç¼ºå­—æ£€æµ‹æ—¶ç”¨â€œæ•´ä¸ªå­—ä½“æ ˆâ€åˆ¤æ–­ï¼Œè€Œä¸æ˜¯åªæµ‹ä¸»å­—ä½“

*   **è¦ä¹ˆ**æœ€ç®€å•ï¼šå…ˆæŠŠâ€œç¼ºå­—è¿‡æ»¤/æ›¿æ¢â€é‚£æ®µé€»è¾‘æ³¨é‡Šæ‰ï¼Œè®© Canvas æŒ‰è‡ªç„¶ fallback ç”»

å¦‚æœä½ æŠŠ `checkFont` å‡½æ•°å’Œç”Ÿæˆ `noMatchMojis` çš„é‚£æ®µä»£ç ï¼ˆå‡ åè¡Œé™„è¿‘ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ æœ€å°æ”¹åŠ¨è¯¥æ€ä¹ˆæ”¹æˆâ€œåªè¦åå¤‡å­—ä½“èƒ½æ˜¾ç¤ºå°±ä¸ç®—ç¼ºå­—â€ã€‚

* * *

## ä½ ç°åœ¨å¯ä»¥ç«‹åˆ»åšçš„ 3 ä¸ªå¿«é€Ÿè‡ªæ£€ï¼ˆä¸æ”¹å¤§é€»è¾‘ä¹Ÿèƒ½å®šä½ï¼‰

1. **Network é‡Œç¡®è®¤ä½ çš„åå¤‡å­—ä½“æ–‡ä»¶ç¡®å® 200**ï¼ˆç‰¹åˆ«æ˜¯ SourceHanSerifCN-Heavy / NotoSerifSCBlackï¼‰

2. **æŠŠ Canvas çš„å­—ä½“æ ˆä¸´æ—¶å†™æ­»æµ‹è¯•**ï¼ˆæ’é™¤ fontName ä¼ é”™ï¼‰ï¼š

   ```js
   ctx.font = `800 48px "EVAMatisseClassic","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`;
   ```

3. åœ¨ç»˜åˆ¶å‰åŠ ä¸€å¥ï¼š

   ```js
   console.log(document.fonts.check('48px "SourceHanSerifCN-Heavy"', 'æ±‰'));
   ```

   *   `true` æ‰è¡¨ç¤ºæµè§ˆå™¨è®¤ä¸ºè¿™å­—ä½“ ready ä¸”å¯ç”¨

* * *

### æœ€å¯èƒ½çš„ç»“è®ºï¼ˆç»“åˆä½ é¡¹ç›®æƒ…å†µï¼‰

ä½ ç°åœ¨â€œå­—ä½“ä¸å­˜åœ¨è¿˜æ˜¯æ˜¾ç¤ºä¸å‡ºæ¥â€ï¼Œæœ€å¸¸è§å°±æ˜¯ **Canvas åœ¨å­—ä½“æœªåŠ è½½å®Œæˆå°±å·²ç»ç”»å®Œäº†ï¼ˆåŸå›  1ï¼‰**ï¼Œå†å åŠ  **weight ä¸åŒ¹é…ï¼ˆåŸå›  2ï¼‰** æˆ– **ç¼ºå­—é€»è¾‘æ‹¦æˆªï¼ˆåŸå›  3ï¼‰**ã€‚

æŠŠä½  `document.js` é‡Œ `ctx.font = ...` å¾€ä¸‹åˆ°çœŸæ­£ `fillText`/ç”Ÿæˆå›¾ç‰‡é‚£ä¸€æ®µï¼ˆå¤§æ¦‚ 30~60 è¡Œï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ ä¸€ä»½â€œå¯ç”¨çš„ patchâ€ï¼Œä¿è¯ï¼š

*   EVAMatisseClassic ç¼ºå­—æ—¶ â†’ è‡ªåŠ¨ç”¨ SourceHanSerifCN-Heavy è¡¥é½

*   å¹¶ä¸”ä¸ä¼šå†è¢«é¡¹ç›®çš„ç¼ºå­—æç¤ºè¯¯ä¼¤

## Q: 

document.css @font-face { font-family: EVAMatisseClassic; src: url(../fonts/EVA-Matisse_Classic.woff2); } @font-face { font-family: MatisseProEB; src: url(FOT-MatissePro-EB.woff2); } @font-face { font-family: NotoSerifSCBlack; src: url(NotoSerifSC-Black.woff2); } html { font: 24px/1.4 sans-serif; font-family: MatisseProEB,serif; font-family: EVAMatisseClassic,serif; font-family: EVAMatisseClassic,MatisseProEB,serif; font-family: NotoSerifSCBlack,serif; font-family: MatisseProEB,NotoSerifSCBlack,serif; font-weight: 200; font-display: swap; text-rendering: optimizeLegibility; -webkit-font-smoothing: grayscale; background: var(--color-background); color: var(--color-font); background-position: top left; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23222222' viewBox='0 0 200 339'%3E%3Cpath d='M100,69.6l87,50v100l-87,50l-87-50v-100L100,69.6zM87-18v68L0,100L-18,0M380,0l-180,100L113,50V-18M0,239l87,50V400H-198M400,400H113v-111l87-50'/%3E%3C/svg%3E"); background-size: 16px; }

## A: 

é—®é¢˜æ‰¾åˆ°äº†ï¼šä½ è¿™æ®µ CSS é‡Œ **`font-family` å†™äº†å¾ˆå¤šè¡Œï¼Œä½†åªæœ‰æœ€åä¸€è¡Œä¼šç”Ÿæ•ˆ**ã€‚CSS è§„åˆ™æ˜¯â€œåŒä¸€ä¸ªé€‰æ‹©å™¨é‡ŒåŒåå±æ€§ï¼Œåå†™çš„è¦†ç›–å…ˆå†™çš„â€ã€‚æ‰€ä»¥ä½ ç°åœ¨å®é™…ç”Ÿæ•ˆçš„æ˜¯ï¼š

```css
font-family: MatisseProEB,NotoSerifSCBlack,serif;
```

è€Œä¸”ä½ **å¹¶æ²¡æœ‰æŠŠ `SourceHanSerifCN-Heavy` åŠ è¿›æ¥**ï¼Œæ‰€ä»¥ç¼ºå­—æ—¶æ ¹æœ¬ä¸ä¼šç”¨å®ƒè¡¥ã€‚

å¦å¤–è¿˜æœ‰ 2 ä¸ªå‘ä¹Ÿè¦ä¿®ï¼š

1.  `font-display` å†™åœ¨ `html {}` é‡Œæ˜¯æ— æ•ˆçš„ï¼ˆå®ƒåªå¯¹ `@font-face` æœ‰æ•ˆï¼‰

2.  `@font-face` é‡Œæ²¡å†™ `format()`ã€æ²¡å†™ `font-weight` èŒƒå›´ï¼ŒCanvas ç”¨ `800` æ—¶å¯èƒ½åŒ¹é…ä¸åˆ°ä½ åŠ è½½çš„é‚£ä»½å­—é‡ã€‚

* * *

## âœ… ä½ åº”è¯¥æ”¹æˆè¿™æ ·ï¼ˆç›´æ¥æ›¿æ¢ä½ çš„ html { ... } é‡Œçš„ font-family éƒ¨åˆ†ï¼‰

æŠŠ `html {}` é‡Œé‚£ä¸€å † `font-family:` åªä¿ç•™ **ä¸€æ¡**ï¼Œæ¯”å¦‚ï¼š

```css
html {
  font: 24px/1.4 sans-serif;

  font-family:
    EVAMatisseClassic,
    MatisseProEB,
    SourceHanSerifCN-Heavy,
    NotoSerifSCBlack,
    serif;

  font-weight: 200;

  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: grayscale;
  background: var(--color-background);
  color: var(--color-font);
  background-position: top left;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23222222' viewBox='0 0 200 339'%3E%3Cpath d='M100,69.6l87,50v100l-87,50l-87-50v-100L100,69.6zM87-18v68L0,100L-18,0M380,0l-180,100L113,50V-18M0,239l87,50V400H-198M400,400H113v-111l87-50'/%3E%3C/svg%3E");
  background-size: 16px;
}
```

> æ³¨æ„ï¼š`SourceHanSerifCN-Heavy` åªæœ‰åœ¨ä½ ä¹Ÿç”¨ `@font-face` æ³¨å†Œäº†å®ƒï¼ˆæˆ–ç³»ç»Ÿå®‰è£…äº†åŒåå­—ä½“ï¼‰æ‰ä¼šç”Ÿæ•ˆã€‚

* * *

## âœ… æŠŠ `@font-face` ä¹Ÿè¡¥å…¨ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

æŠŠä½ ç°æœ‰çš„ 3 æ®µæ”¹æˆæ›´æ ‡å‡†ï¼ˆè·¯å¾„æŒ‰ä½ å®é™…ä½ç½®è°ƒæ•´ï¼‰ï¼š

```css
@font-face{
  font-family: "EVAMatisseClassic";
  src: url("../fonts/EVA-Matisse_Classic.woff2") format("woff2");
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}

@font-face{
  font-family: "MatisseProEB";
  src: url("./FOT-MatissePro-EB.woff2") format("woff2");
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}

@font-face{
  font-family: "NotoSerifSCBlack";
  src: url("./NotoSerifSC-Black.woff2") format("woff2");
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}
```

ç„¶å**å†åŠ ä¸€æ®µ**ä½ çš„ Heavyï¼ˆå¦‚æœä½ æ”¾çš„æ˜¯ woff2/otfï¼Œè·¯å¾„å’Œ format å¯¹ä¸Šï¼‰ï¼š

```css
@font-face{
  font-family: "SourceHanSerifCN-Heavy";
  src: url("./fonts/SourceHanSerifCN-Heavy.woff2") format("woff2");
  /* å¦‚æœä½ è¿˜æ˜¯ otfï¼Œå°±ç”¨ï¼š
     src: url("./fonts/SourceHanSerifCN-Heavy.otf") format("opentype");
  */
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}
```

> `font-weight: 100 900;` è¿™å¥å¾ˆå…³é”®ï¼šä½ çš„ Canvas ä»£ç ä¼šç”¨ 800/900ï¼Œä¸ç»™èŒƒå›´æœ‰æ—¶ä¼šåŒ¹é…ä¸åˆ°ã€‚

* * *

## ä½†æˆ‘è¦æé†’ä¸€å¥ï¼šä½ è¿™ä¸ªé¡¹ç›®çš„â€œç”Ÿæˆæ•ˆæœâ€ä¸»è¦åƒçš„æ˜¯ Canvas çš„ `ctx.font`

å³ä½¿ CSS ä¿®å¥½äº†ï¼Œ**Canvas é‡Œå¦‚æœè¿˜æ˜¯ `${fontName},sans-serif`**ï¼Œå®ƒä¾æ—§å¯èƒ½ä¸èµ°ä½ æƒ³è¦çš„ Heavy è¡¥å­—ï¼ˆæˆ–è€…è¡¥å¾—ä¸ç¨³å®šï¼‰ã€‚

ä½ åº”è¯¥æŠŠ `document.js` é‚£è¡Œä¹Ÿæ”¹æˆå¸¦å®Œæ•´æ ˆï¼š

```js
ctx.font = `${weight} ${w}px ${fontName},"SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`;
```

* * *

å¦‚æœä½ æŠŠ `SourceHanSerifCN-Heavy` å­—ä½“æ–‡ä»¶ç°åœ¨æ”¾çš„å…·ä½“è·¯å¾„ï¼ˆæ¯”å¦‚ `./fonts/...` è¿˜æ˜¯åŒç›®å½•ï¼‰å‘Šè¯‰æˆ‘/è´´ä¸ª `ls`ï¼Œæˆ‘å¯ä»¥æŠŠé‚£æ¡ `src: url(...)` ç²¾å‡†å†™åˆ°ä¸ä¼š 404 çš„ç‰ˆæœ¬ã€‚

## Q: 


## A: 

ä½ ç°åœ¨é¡µé¢â€œè¡¥å­—è¿˜ä¸å‡ºæ¥â€çš„æ ¸å¿ƒåŸå› å·²ç»ä¸æ˜¯ CSS äº†ï¼Œè€Œæ˜¯**å®ƒè¿˜åœ¨è¯·æ±‚ `/api/fontmin`ï¼Œè€Œä½ è¿™è¾¹æ²¡æœ‰è¿™ä¸ªæ¥å£**ï¼Œæ‰€ä»¥ä¸€ç›´ 404ï¼ˆä½ æˆªå›¾é‡Œä¸¤æ¡çº¢é”™å°±æ˜¯å®ƒï¼‰ï¼š

`GET https://yys.im/api/fontmin?... 404`

è¿™ä¼šå¯¼è‡´ï¼šé¡¹ç›®æƒ³â€œæŒ‰è¾“å…¥æ–‡å­—åŠ¨æ€ç”Ÿæˆ/è£å‰ªå­—ä½“ï¼ˆå­é›†å­—ä½“ï¼‰â€ï¼Œä½†æ‹¿ä¸åˆ°ç»“æœï¼ŒCanvas æ¸²æŸ“é“¾è·¯å°±ç¼ºä¸€ç¯ï¼Œäºæ˜¯ä½ çœ‹åˆ°â€œè¿˜æ˜¯æ˜¾ç¤ºä¸å…¨/ä¸ç”Ÿæ•ˆâ€ã€‚

* * *

## ä½ è¯¥æ€ä¹ˆåšï¼ˆä¸¤ç§é€‰ä¸€ä¸ªï¼‰

### æ–¹æ¡ˆ Aï¼ˆæœ€å¿«ï¼Œæ¨èï¼‰ï¼šæ”¹ç”¨ä½œè€…æä¾›çš„åœ¨çº¿ fontmin æœåŠ¡

ä½  grep ç»“æœé‡Œå·²ç»æœ‰ï¼š  
`// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin';`

ç›´æ¥æŠŠ `./eva/html/document.js`ï¼ˆä»¥åŠ `./eva/document.js` å¦‚æœé¡µé¢å¼•ç”¨çš„æ˜¯å®ƒï¼‰é‡Œçš„ fontAPI æ”¹æˆè¿™ä¸€æ¡å³å¯ã€‚

æŠŠè¿™ä¸€è¡Œï¼š

```js
let fontAPI = `https://${location.hostname}/api/fontmin`;
```

æ”¹æˆï¼š

```js
let fontAPI = 'https://eva-title-server.vercel.app/api/fontmin';
```

ç„¶åä¿å­˜ã€å¼ºåˆ·ï¼ˆCtrl+F5ï¼‰ï¼Œä½ ä¼šçœ‹åˆ° `/api/fontmin` 404 æ¶ˆå¤±ï¼ˆå› ä¸ºä¸è¯·æ±‚ä½ åŸŸåäº†ï¼‰ã€‚

> å¦‚æœä½ è¿˜æƒ³èµ°åˆ«çš„å…¬å…±æ¥å£ï¼Œæ–‡ä»¶é‡Œä¹Ÿæœ‰æ³¨é‡Šï¼š`s6.magiconch.com` ç­‰ã€‚

* * *

### æ–¹æ¡ˆ Bï¼ˆå®Œæ•´è‡ªå»ºï¼‰ï¼šä½ è‡ªå·±å®ç° `/api/fontmin`

éœ€è¦ Node/Express åœ¨æœåŠ¡å™¨è·‘ä¸€ä¸ªæ¥å£ï¼Œå†ç”¨ Nginx åä»£ `/api/` åˆ° Nodeã€‚å·¥ä½œé‡æ›´å¤§ï¼Œä½†æœ€å¯æ§ã€‚

* * *

## ä½ ç°åœ¨åº”è¯¥æ”¹å“ªä¸ªæ–‡ä»¶ï¼Ÿï¼ˆé‡è¦ï¼‰

ä½ ç›®å½•é‡Œæœ‰ä¸¤ä»½ï¼š`./eva/html/document.js` å’Œ `./eva/document.js`ã€‚å®é™…ç”Ÿæ•ˆçš„æ˜¯å“ªä»½ï¼Œå–å†³äº `index.html` å¼•ç”¨äº†è°ã€‚

ä½ ç”¨è¿™æ¡ç¡®è®¤ä¸€ä¸‹ï¼ˆåœ¨æœåŠ¡å™¨æ‰§è¡Œï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "document.js" index.html
```

*   å¦‚æœå¼•ç”¨çš„æ˜¯ `document.js`ï¼ˆåŒç›®å½•ï¼‰ï¼Œæ”¹ `eva/html/document.js`

*   å¦‚æœå¼•ç”¨çš„æ˜¯ `../document.js` æˆ– `/eva/document.js`ï¼Œé‚£ä¸¤ä»½éƒ½æ”¹æœ€çœäº‹

*   * *

## ä½ æ”¹å®Œåæ€ä¹ˆéªŒè¯æˆåŠŸ

æ‰“å¼€æ§åˆ¶å°çœ‹è¯·æ±‚ï¼š

*   ä¸åº”è¯¥å†å‡ºç° `https://yys.im/api/fontmin... 404`

*   ä¼šå˜æˆè®¿é—® `https://eva-title-server.vercel.app/api/fontmin?...`ï¼ˆåº”è¯¥æ˜¯ 200ï¼‰

*   * *

å¦å¤–ä¸¤æ¡æç¤ºï¼š

*   `ERR_BLOCKED_BY_CLIENT`ï¼šæ’ä»¶æ‹¦ç»Ÿè®¡è„šæœ¬ï¼Œæ— è§†

*   Canvas2D æ€§èƒ½æç¤ºï¼Œæ— è§†æˆ–æŒ‰ä¹‹å‰æ–¹å¼åŠ  `willReadFrequently`

ä½ å…ˆæŠŠ `fontAPI` æŒ‰æ–¹æ¡ˆ A æ”¹æ‰ï¼Œå¼ºåˆ·åå¦‚æœè¿˜æœ‰â€œä¸åŒ¹é…æ–‡å­—ä¸è¡¥å…¨â€ï¼Œæˆ‘å†å¸¦ä½ æŠŠâ€œç¼ºå­—åˆ¤å®šåªçœ‹ä¸»å­—ä½“â€çš„é‚£æ®µé€»è¾‘æ”¹æˆâ€œç”¨å­—ä½“æ ˆåˆ¤å®šâ€ï¼Œè¿™æ ·å°±æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ fallback è¡¥å­—äº†ã€‚

## Q: 

è¿™ä¸ªapiç”¨ä¸äº†

## A: 

æ‡‚äº†ï¼šæ—¢ç„¶å¤–éƒ¨ `fontmin` API ç”¨ä¸äº†ï¼Œé‚£è¿™ä¸ªé¡¹ç›®é‡Œ**æ‰€æœ‰ä¾èµ– `/api/fontmin` çš„â€œæŒ‰å­—ç”Ÿæˆå­—ä½“å­é›†â€åŠŸèƒ½éƒ½ä¼šå¤±è´¥**ï¼Œæ§åˆ¶å°å°±ä¸€ç›´ 404ï¼Œä¹Ÿå°±å¾ˆéš¾å‡ºç°ä½ æœŸå¾…çš„â€œè‡ªåŠ¨è¡¥å…¨ç¼ºå­—â€æ•ˆæœã€‚

ä½ ç°åœ¨æœ‰ä¸¤æ¡å¯èµ°çš„è·¯ï¼š**å…³æ‰ fontminï¼ˆæœ€å¿«ï¼‰** æˆ– **è‡ªå·±åœ¨æœåŠ¡å™¨æ­ä¸€ä¸ª `/api/fontmin`ï¼ˆæœ€å®Œæ•´ï¼‰**ã€‚æˆ‘æŠŠä¸¤æ¡éƒ½ç»™ä½ ï¼ŒæŒ‰ä½ éœ€æ±‚é€‰ã€‚

* * *

## è·¯çº¿ 1ï¼ˆæ¨èï¼Œæœ€å¿«èƒ½ç”¨ï¼‰ï¼šå½»åº•ç¦ç”¨ `/api/fontmin`ï¼Œåªç”¨â€œå­—ä½“æ ˆ fallbackâ€æ¥è¡¥å­—

é€‚åˆï¼šä½ ä¸»è¦æƒ³é¡µé¢/å¯¼å‡ºèƒ½æ­£å¸¸æ˜¾ç¤ºï¼Œä¸è¿½æ±‚â€œåŠ¨æ€å­é›†åŒ–å­—ä½“â€ï¼ˆæ–‡ä»¶å˜å°ã€æŒ‰å­—ä¸‹è½½é‚£ç§ï¼‰ã€‚

### A. æ”¹ JSï¼šåˆ«å†è¯·æ±‚ fontmin

ä½  grep å‡ºæ¥ `fontAPI` åœ¨ `eva/html/document.js`ï¼ˆä»¥åŠå¯èƒ½è¿˜æœ‰ä¸€ä»½ `eva/document.js`ï¼‰ã€‚

æŠŠè¿™è¡Œï¼ˆä½ ç°åœ¨çš„ï¼‰ï¼š

```js
let fontAPI = `https://${location.hostname}/api/fontmin`;
```

æ”¹æˆè®©å®ƒâ€œä¸å¯ç”¨â€ï¼Œå¹¶åœ¨è°ƒç”¨å¤„ç›´æ¥è·³è¿‡è¯·æ±‚ã€‚æœ€çœäº‹çš„æ–¹æ³•æ˜¯ï¼šåœ¨è°ƒç”¨ fontAPI çš„å‡½æ•°å¼€å¤´åŠ ä¸€ä¸ªå¼€å…³ï¼š

1ï¼‰åœ¨ `document.js` é¡¶éƒ¨åŠ ï¼š

```js
const DISABLE_FONTMIN = true;
```

2ï¼‰æ‰¾åˆ°å®é™…è¯·æ±‚ fontmin çš„å‡½æ•°ï¼ˆä¸€èˆ¬åå­—åƒ `fontmin()` / `getFont()` / `fetchFont()`ï¼Œä½ æœç´¢ä¸€ä¸‹ï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im/eva/html
grep -n "fontAPI" document.js
grep -n "fetch(" document.js | head
```

åœ¨é‚£ä¸ªå‡½æ•°æœ€å‰é¢åŠ ï¼š

```js
if (DISABLE_FONTMIN) return null;
```

è¿™æ ·å®ƒå°±ä¸ä¼šå†æ‰“ `/api/fontmin` äº†ã€‚

### B. å…³é”®ï¼šè®© Canvas ç”¨â€œå­—ä½“æ ˆâ€è€Œä¸æ˜¯å•å­—ä½“

ä½ å·²ç»æ‰¾åˆ°è¿™è¡Œï¼š

`./html/document.js:28`

```js
ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
```

æŠŠå®ƒæ”¹æˆï¼ˆåŠ å…¥ä½ è¦çš„åå¤‡å­—ä½“ï¼‰ï¼š

```js
ctx.font = `${weight} ${w}px "${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack","Noto Serif CJK SC",serif`;
```

åŒç†æŠŠ `make.js:243` ä¹ŸåŠ ä¸Š fallback æ ˆï¼ˆæœ€ç®€å•å†™æ­»ï¼‰ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px "${_fontFamilyName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`;
```

> è¿™æ ·å³ä½¿ä¸»å­—ä½“æ²¡æœ‰æŸäº›å­—ï¼ŒCanvas ä¼šè‡ªåŠ¨ç”¨ä½ åé¢çš„å­—ä½“æŠŠé‚£äº›å­—ç”»å‡ºæ¥ã€‚

### C. åˆ·æ–°éªŒè¯

å¼ºåˆ·åæ§åˆ¶å°é‡Œåº”è¯¥**ä¸å†å‡ºç°**ï¼š

*   `GET https://yys.im/api/fontmin ... 404`

å¹¶ä¸”ç¼ºå­—ä¼šç”¨åå¤‡å­—ä½“æ˜¾ç¤ºï¼ˆä½ ä¹‹å‰çœ‹åˆ°çš„ Noto Sans SC é‚£ç§ç°è±¡ä¼šæ›´å¯æ§ï¼‰ã€‚

* * *

## è·¯çº¿ 2ï¼ˆæœ€å®Œæ•´ï¼‰ï¼šä½ è‡ªå·±åœ¨æœåŠ¡å™¨å®ç° `/api/fontmin`

é€‚åˆï¼šä½ æƒ³ä¿ç•™ä½œè€…åŠŸèƒ½â€”â€”æŒ‰è¾“å…¥æ–‡å­—åŠ¨æ€ç”Ÿæˆå­é›†å­—ä½“ï¼ˆæ›´å°ã€æ›´â€œåŸä½œâ€ï¼‰ã€‚

> è¿™ä¸ªæ¯”è·¯çº¿ 1 å¤æ‚ï¼Œä½†å¯è¡Œã€‚

### A. Node æœåŠ¡ï¼ˆæœ€å° demoï¼‰

åœ¨æœåŠ¡å™¨æ–°å»ºç›®å½•ï¼š

```bash
mkdir -p /www/wwwroot/yys.im/fontmin-server
cd /www/wwwroot/yys.im/fontmin-server
npm init -y
npm i express cors
```

åˆ›å»º `server.js`ï¼š

```js
const express = require("express");
const cors = require("cors");

const app = express();
app.use(cors());

app.get("/api/fontmin", async (req, res) => {
  const { name, unicode } = req.query;
  // å…ˆåšå ä½ï¼šå‘Šè¯‰å‰ç«¯â€œæˆ‘ä¸æ”¯æŒåŠ¨æ€å­é›†â€ï¼Œé¿å… 404
  // å®Œæ•´å®ç°éœ€è¦ï¼šè¯»å–å¯¹åº”å­—ä½“æ–‡ä»¶ + æŒ‰ unicode å­é›†åŒ– + è¾“å‡º woff2
  res.status(501).json({ error: "fontmin not implemented", name, unicode });
});

app.listen(60912, () => console.log("fontmin server :60912"));
```

å¯åŠ¨ï¼š

```bash
node server.js
```

ç„¶å Nginx åä»£ `/api/` åˆ° 60912 ç«¯å£ï¼ˆå®å¡”ç«™ç‚¹é…ç½® `server{}` é‡ŒåŠ ï¼‰ï¼š

```nginx
location ^~ /api/ {
  proxy_pass http://127.0.0.1:60912;
  proxy_set_header Host $host;
}
```

> æ³¨æ„ï¼šè¿™åªæ˜¯å…ˆæŠŠ 404 å˜æˆ 501ï¼›çœŸæ­£çš„å­é›†åŒ–è¿˜éœ€è¦é¢å¤–åº“ï¼ˆfontmin/fonttools ç­‰ï¼‰å’Œå­—ä½“æ–‡ä»¶é‡‡é›†é€»è¾‘ã€‚å®ç°èµ·æ¥ä¸éš¾ï¼Œä½†ä»£ç ä¼šé•¿å¾ˆå¤šã€‚

* * *

## æˆ‘å»ºè®®ä½ æ€ä¹ˆé€‰

*   **ä½ ä¸»è¦ç›®æ ‡æ˜¯â€œèƒ½æ˜¾ç¤ºå…¨ã€èƒ½å¯¼å‡ºã€ä¸æŠ¥é”™â€**ï¼šé€‰ **è·¯çº¿ 1**ï¼ˆç¦ç”¨ fontmin + Canvas å­—ä½“æ ˆ fallbackï¼‰æœ€çœäº‹ã€æœ€ç¨³å®šã€‚

*   **ä½ è¦å®Œå…¨å¤åˆ»ä½œè€…çš„â€œæŒ‰å­—ç”Ÿæˆå°å­—ä½“æ–‡ä»¶â€**ï¼šé€‰è·¯çº¿ 2ï¼Œä½†è¦å¤šå†™ä¸€æ®µåç«¯é€»è¾‘ã€‚

*   * *

### æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ æ”¹åˆ°â€œè·¯çº¿ 1â€æœ€å°å¯ç”¨ç‰ˆæœ¬

ä½ æŠŠ `eva/html/document.js` é‡Œ**è¯·æ±‚ fontAPI çš„é‚£ä¸€æ®µå‡½æ•°**ï¼ˆåŒ…å« `fetch(...)` çš„å‡ è¡Œï¼Œè´´ 30 è¡Œå·¦å³ä¸Šä¸‹æ–‡ï¼‰å‘å‡ºæ¥ï¼Œæˆ‘å°±èƒ½ç²¾ç¡®å‘Šè¯‰ä½ ï¼šè¯¥åœ¨å“ªé‡ŒåŠ  `DISABLE_FONTMIN`ã€è¯¥ return ä»€ä¹ˆï¼Œæ‰èƒ½æ—¢ä¸æŠ¥é”™åˆä¸å½±å“å…¶ä»–é€»è¾‘ã€‚_

## Q: 

ç°åœ¨å…¨éƒ¨çš„ç›®å½•éƒ½æ˜¯/www/wwwroot/yys.im/eva root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# cd /www/wwwroot/yys.im/eva grep -n "fontAPI" document.js grep -n "fetch(" document.js | head 10:// let fontAPI = 'http://192.168.31.7:8003/api/fontmin'; 11://let fontAPI = `https://${location.hostname}/api/fontmin`; 12:let fontAPI = 'https://s6.magiconch.com/api/fontmin'; 13:// fontAPI = 'https://s6.magiconch.com/api/fontmin'; 14:// fontAPI = 'http://localhost:60912/api/fontmin'; 16:// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; 62: fontAPI = 'http://localhost:60912/api/fontmin'; 82: const fontURL = `${fontAPI}?name=${name}&unicode=${unicode}`; 134: console.log(`${fontAPI}?name=${fontFamilyName}&type=woff&unicode=${unicode}`);

## A: 

æ˜ç™½äº†ï¼šä½ ç°åœ¨å®é™…è·‘çš„æ˜¯ `/www/wwwroot/yys.im/eva/document.js` è¿™ä¸€ä»½ï¼Œè€Œä¸”å®ƒ**ä¸€å®šä¼šå»è¯·æ±‚ fontmin**ï¼ˆç¬¬ 82 è¡Œæ‹¼äº† `fontURL`ï¼‰ã€‚æ—¢ç„¶å¤–éƒ¨ API ç”¨ä¸äº†ï¼Œä½ å°±è¦ä¹ˆ **å½»åº•ç¦ç”¨è¿™æ®µè¯·æ±‚**ï¼Œè¦ä¹ˆ **è‡ªå·±åœ¨æœ¬æœºæä¾› `http://localhost:60912/api/fontmin`**ã€‚

æˆ‘ç»™ä½ æœ€å¿«çš„â€œç¦ç”¨ fontmin + èµ°æœ¬åœ°å­—ä½“æ ˆ fallbackâ€çš„æ”¹æ³•ï¼ˆä¸éœ€è¦åç«¯ï¼‰ã€‚

* * *

## ç›®æ ‡

*   ä¸å†è¯·æ±‚ `https://s6.magiconch.com/api/fontmin`ï¼ˆä¹Ÿä¸è¯·æ±‚ä»»ä½• `/api/fontmin`ï¼‰

*   ç¼ºå­—æ—¶äº¤ç»™ Canvas çš„å­—ä½“æ ˆå» fallbackï¼ˆä½ å·²æ”¾äº†æ€æº/Noto ç­‰ï¼‰

*   * *

## 1ï¼‰åœ¨ `document.js` é‡ŒåŠ ä¸€ä¸ªå¼€å…³ï¼šç¦ç”¨ fontmin

ç¼–è¾‘ `/www/wwwroot/yys.im/eva/document.js`

åœ¨ `fontAPI` å®šä¹‰é™„è¿‘ï¼ˆæ¯”å¦‚ç¬¬ 12 è¡Œä¸‹é¢ï¼‰åŠ ï¼š

```js
const DISABLE_FONTMIN = true;
```

ç„¶åæ‰¾åˆ°æ‹¼ `fontURL` çš„åœ°æ–¹ï¼ˆä½ è¯´ç¬¬ 82 è¡Œï¼‰é™„è¿‘ï¼Œåº”è¯¥é•¿è¿™æ ·ï¼š

```js
const fontURL = `${fontAPI}?name=${name}&unicode=${unicode}`;
```

æŠŠâ€œè¯·æ±‚ fontURLâ€çš„é‚£æ®µé€»è¾‘æ”¹æˆï¼š

```js
if (DISABLE_FONTMIN) {
  // ç›´æ¥è·³è¿‡åœ¨çº¿å­é›†å­—ä½“ç”Ÿæˆï¼šè¿”å›ç©ºï¼Œè®©åç»­èµ°æœ¬åœ°å­—ä½“/ç³»ç»Ÿå­—ä½“æ ˆ
  return null;
}
```

> ä½ å¯èƒ½ä¼šé—®â€œreturn null ä¼šä¸ä¼šæŠ¥é”™ï¼Ÿâ€  
> å¦‚æœåé¢ä»£ç æŠŠè¿”å›å€¼å½“ URL ç”¨ï¼Œæœ€ç¨³çš„æ–¹å¼æ˜¯ï¼š**åœ¨è°ƒç”¨å¤„åˆ¤æ–­ä¸ºç©ºå°±ä¸è¦èµ°ä¸‹è½½æµç¨‹**ã€‚å¦‚æœä½ æŠŠ 70~110 è¡Œè´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç²¾ç¡®ç»™ä½ æ€ä¹ˆæ”¹ä¸ç‚¸ã€‚

* * *

## 2ï¼‰è®© Canvas çœŸçš„ä½¿ç”¨â€œåå¤‡å­—ä½“æ ˆâ€

ä½ ä¹‹å‰ grep è¿‡ `ctx.font`ï¼Œåœ¨ `/www/wwwroot/yys.im/eva/document.js:28`ï¼š

```js
ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
```

æ”¹æˆï¼š

```js
ctx.font = `${weight} ${w}px "${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack","Noto Serif CJK SC",serif`;
```

è¿™æ ·å³ä½¿ `fontName`ï¼ˆæ¯”å¦‚ EVAMatisseClassicï¼‰ç¼ºå­—ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”¨åé¢çš„å­—ä½“è¡¥å­—ã€‚

* * *

## 3ï¼‰æŠŠâ€œç¼ºå­—æ£€æµ‹â€ä¹Ÿæ”¹æˆæŒ‰å­—ä½“æ ˆæ£€æµ‹ï¼ˆå¦åˆ™å®ƒä¼šç»§ç»­æç¤º/è¿‡æ»¤ï¼‰

ä½ è¿™ä¸ªé¡¹ç›®å¾ˆå¯èƒ½æœ‰ `checkFont()` / `noMatchMojis` é€»è¾‘ï¼šå®ƒå¦‚æœåªæ£€æŸ¥ä¸»å­—ä½“ï¼Œä¼šæŠŠå­—å½“â€œä¸åŒ¹é…â€ç„¶åä¸ç”»ã€‚

æœ€å°æ”¹æ³•æ˜¯ï¼šè®©æ£€æµ‹ä¹Ÿç”¨åŒä¸€æ¡å­—ä½“æ ˆã€‚æ¯”å¦‚æŠŠæ£€æµ‹ç”¨åˆ°çš„åœ°æ–¹ä»ï¼š

```js
checkFont(fontName, weight)
```

æ”¹æˆæ£€æµ‹è¿™ä¸ªæ ˆï¼ˆç¤ºä¾‹ï¼‰ï¼š

```js
checkFont(`"${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`, weight)
```

> è¿™ä¸€æ­¥è¦çœ‹ä½ æ–‡ä»¶é‡Œ `checkFont` æ€ä¹ˆå†™ã€‚ä½ æŠŠåŒ…å« `checkFont` çš„é‚£ä¸€æ®µè´´å‡ºæ¥ï¼Œæˆ‘å°±èƒ½ç»™ä½ å‡†ç¡®æ›¿æ¢ç‚¹ã€‚

* * *

## ä½ ç°åœ¨å…ˆæŠŠå…³é”®ä¸Šä¸‹æ–‡è´´ä¸€ä¸‹ï¼Œæˆ‘å°±èƒ½ç»™ä½ â€œä¸€æ¬¡æ”¹å®Œä¸æŠ¥é”™â€çš„è¡¥ä¸

è¯·æŠŠ `document.js` **ç¬¬ 70 è¡Œåˆ° 110 è¡Œ**ï¼ˆåŒ…å« `fontURL` å’Œå®ƒåç»­ fetch çš„é‚£æ®µï¼‰ç²˜å‡ºæ¥ã€‚  
æˆ‘ä¼šæ ¹æ®ä½ çš„çœŸå®ä»£ç ç»“æ„ï¼Œç»™ä½ ï¼š

*   è¯¥ return ä»€ä¹ˆï¼ˆnull/ç©ºå­—ç¬¦ä¸²/æœ¬åœ° URLï¼‰

*   è°ƒç”¨å¤„è¯¥æ€ä¹ˆåˆ¤æ–­

*   ç¡®ä¿é¡µé¢ä¸ä¼šå› ä¸º `return null` å´©æ‰

*   åŒæ—¶å®Œå…¨æ¶ˆç­ `/api/fontmin` 404

ï¼ˆä½ ä¸ç”¨æ‹…å¿ƒé•¿ï¼Œæˆ‘åªéœ€è¦é‚£ä¸€å°æ®µä¸Šä¸‹æ–‡å°±å¤Ÿã€‚ï¼‰

## Q: 

æ€ä¹ˆæµ‹è¯•ä¸Šé¢çš„apièƒ½ä¸å«©ç”¨

## A: 

ä½ è¦æµ‹è¯• â€œ`fontmin` è¿™ä¸ª API èƒ½ä¸èƒ½ç”¨â€ï¼Œæœ€ç®€å•å°±æ˜¯**ç›´æ¥ç”¨ curl è¯·æ±‚ä¸€ä¸‹**ï¼Œçœ‹å®ƒè¿”å›çš„æ˜¯ä¸æ˜¯ **200**ï¼ˆä»¥åŠå†…å®¹æ˜¯ä¸æ˜¯ä¸€ä¸ªå­—ä½“æ–‡ä»¶/äºŒè¿›åˆ¶ï¼‰ã€‚

ä¸‹é¢ç»™ä½  3 ç§æµ‹è¯•æ–¹å¼ï¼ˆä»æœ€ç®€å•åˆ°æ›´å‡†ç¡®ï¼‰ã€‚

* * *

## 1ï¼‰æœ€ç®€å•ï¼šç”¨ curl ç›´æ¥æ‰“ä¸€ä¸ªæœ€å°è¯·æ±‚

å…ˆéšä¾¿ç”¨å‡ ä¸ª unicodeï¼ˆæ¯”å¦‚æ±‰å­—â€œä¸­â€æ˜¯ `4e2d`ï¼Œä¹Ÿå¯ä»¥ç”¨ä½ é¡¹ç›®é‡ŒæŠ¥é”™çš„é‚£ä¸²ï¼‰ã€‚

### æµ‹è¯• s6 æ¥å£ï¼ˆä½ ç°åœ¨é…ç½®çš„ï¼‰

```bash
curl -I "https://s6.magiconch.com/api/fontmin?name=EVAMatisseClassic&unicode=4e2d"
```

ä½ å…³å¿ƒçš„æ˜¯ï¼š

*   çŠ¶æ€ç æ˜¯ä¸æ˜¯ `200`

*   æœ‰æ²¡æœ‰åƒ `content-type: font/woff2`ã€`font/woff`ã€`application/font-woff2` ä¹‹ç±»

å¦‚æœæ˜¯ `403/404/5xx` æˆ–è€…å¡ä½ï¼Œé‚£å°±åŸºæœ¬ä¸å¯ç”¨/è¢«æŒ¡äº†ã€‚

* * *

## 2ï¼‰ä¸‹è½½ä¸‹æ¥çœ‹çœ‹æ˜¯ä¸æ˜¯â€œçœŸå­—ä½“æ–‡ä»¶â€

```bash
curl -L -o /tmp/font.woff2 "https://s6.magiconch.com/api/fontmin?name=EVAMatisseClassic&unicode=4e2d"
file /tmp/font.woff2
ls -lh /tmp/font.woff2
```

æ­£å¸¸çš„è¯ `file` ä¼šæ˜¾ç¤ºç±»ä¼¼ï¼š

*   `WOFF2 font data` æˆ– `WOFF font data`

å¦‚æœæ˜¾ç¤ºï¼š

*   `HTML document` / `JSON` / `text/plain`  
    é‚£å°±æ˜¯æ¥å£è¿”å›äº†é”™è¯¯é¡µé¢æˆ–æŠ¥é”™ä¿¡æ¯ï¼Œä¸æ˜¯å­—ä½“æ–‡ä»¶ã€‚

*   * *

## 3ï¼‰åœ¨æµè§ˆå™¨é‡Œæµ‹ï¼ˆä½ å·²ç»åœ¨ç”¨çš„æ–¹å¼ï¼‰

F12 â†’ Network è¿‡æ»¤ `fontmin`  
ç‚¹å¼€é‚£æ¡è¯·æ±‚ï¼Œçœ‹ï¼š

*   **Status** æ˜¯å¦ 200

*   **Response** æ˜¯å¦æ˜¯äºŒè¿›åˆ¶ï¼ˆæˆ–æœ‰æ˜æ˜¾å­—ä½“æ•°æ®ï¼‰

*   **Response Headers** çš„ `content-type`

*   * *

## é¢å¤–ï¼šæµ‹è¯•ä½ è‡ªå·±åŸŸåçš„ /api/fontminï¼ˆå¦‚æœä½ æƒ³è‡ªå»ºï¼‰

```bash
curl -I "https://yys.im/api/fontmin?name=EVAMatisseClassic&unicode=4e2d"
```

å¦‚æœ 404ï¼Œè¯´æ˜ä½ æºç«™è¿˜æ²¡å®ç°è¿™ä¸ªæ¥å£ã€‚

* * *

### ä¸€ä¸ªå°æé†’ï¼ˆå¾ˆå¸¸è§ï¼‰

æœ‰äº› fontmin æœåŠ¡ä¼šï¼š

*   é™åˆ¶è·¨åŸŸ/Referer

*   é™åˆ¶é¢‘ç‡

*   åªå…è®¸ç‰¹å®š name  
    æ‰€ä»¥å³ä½¿ `curl` 200ï¼Œé¡µé¢ fetch ä¹Ÿå¯èƒ½å› ä¸º CORS æŠ¥é”™ï¼›åè¿‡æ¥ `curl` 403 ä¹Ÿå¯èƒ½åªæ˜¯ç¼ºå°‘ UA/Refererã€‚

å¦‚æœä½ æ„¿æ„ï¼ŒæŠŠä½  `curl -I ...` çš„è¾“å‡ºï¼ˆå®Œæ•´å¤´éƒ¨ï¼‰è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥å¸®ä½ åˆ¤æ–­åˆ°åº•æ˜¯ï¼š

*   æœåŠ¡æŒ‚äº†

*   è¢«é˜²ç«å¢™/é™æµ

*   CORS é—®é¢˜

*   è¿˜æ˜¯ name/unicode å‚æ•°ä¸å¯¹

## Q: 

fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; è¿˜èƒ½ç”¨

## A: 

æˆ‘è¿™è¾¹æ²¡æ³•ç›´æ¥æ›¿ä½ è®¿é—®é‚£ä¸ª Vercel æ¥å£æ¥â€œå®æµ‹å®ƒç°åœ¨æ˜¯ä¸æ˜¯æ´»çš„â€ï¼Œä½†ä½ å¯ä»¥åœ¨ä½ æœåŠ¡å™¨ä¸Š **10 ç§’é’Ÿè‡ªå·±éªŒè¯**å®ƒè¿˜èƒ½ä¸èƒ½ç”¨â€”â€”çœ‹ HTTP çŠ¶æ€ç å’Œè¿”å›çš„æ˜¯ä¸æ˜¯å­—ä½“äºŒè¿›åˆ¶å°±è¡Œã€‚

## 1ï¼‰æœ€ç›´æ¥çš„å¯ç”¨æ€§æµ‹è¯•ï¼ˆçœ‹çŠ¶æ€ç ï¼‰

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
curl -I "https://eva-title-server.vercel.app/api/fontmin?name=EVAMatisseClassic&unicode=4e2d"
```

### ç»“æœæ€ä¹ˆåˆ¤æ–­

*   **200**ï¼šåŸºæœ¬è¿˜èƒ½ç”¨

*   **404/403/5xx**ï¼šä¸å¯ç”¨æˆ–è¢«é™åˆ¶

*   **å¡ä½/è¶…æ—¶**ï¼šç½‘ç»œåˆ° Vercel ä¸é€š/è¢«å¢™/è¢«æ‹¦æˆª

*   * *

## 2ï¼‰æ›´å‡†ç¡®ï¼šæŠŠè¿”å›å†…å®¹ä¸‹è½½ä¸‹æ¥ï¼Œçœ‹æ˜¯ä¸æ˜¯â€œçœŸå­—ä½“â€

```bash
curl -L -o /tmp/font.woff2 "https://eva-title-server.vercel.app/api/fontmin?name=EVAMatisseClassic&unicode=4e2d"
ls -lh /tmp/font.woff2
file /tmp/font.woff2
```

### åˆ¤æ–­ï¼š

*   `file` æ˜¾ç¤º **WOFF2 font data** / **WOFF font data** â†’ çœŸèƒ½ç”¨

*   æ˜¾ç¤º **HTML document** / **JSON** / **text** â†’ è¿”å›çš„æ˜¯é”™è¯¯é¡µ/æŠ¥é”™ä¿¡æ¯ï¼ˆç­‰äºä¸èƒ½ç”¨ï¼‰

*   * *

## 3ï¼‰å¦‚æœ curl èƒ½ç”¨ä½†æµè§ˆå™¨è¿˜æ˜¯ä¸è¡Œï¼šå¤šåŠæ˜¯ CORS

æœ‰äº›æ¥å£ curl è®¿é—®æ²¡é—®é¢˜ï¼Œä½†æµè§ˆå™¨ä¼šå› ä¸ºè·¨åŸŸç­–ç•¥å¤±è´¥ã€‚ä½ å¯ä»¥åœ¨æµè§ˆå™¨ F12 Network ç‚¹å¼€é‚£æ¡è¯·æ±‚ï¼Œçœ‹å“åº”å¤´æœ‰æ²¡æœ‰ï¼š

*   `Access-Control-Allow-Origin: *`ï¼ˆæˆ–åŒ…å«ä½ çš„åŸŸåï¼‰

æ²¡æœ‰çš„è¯ï¼Œå‰ç«¯ fetch ä¼šæŠ¥ CORSã€‚

* * *

## ç»“è®ºå»ºè®®ï¼ˆå¾ˆç°å®ï¼‰

è¿™ç§â€œåˆ«äººéƒ¨ç½²çš„ fontminâ€æ¥å£ä¸€èˆ¬ **ä¸ç¨³å®š**ï¼ˆå¯èƒ½é™æµ/å…³åœ/è·¨åŸŸç­–ç•¥å˜åŠ¨ï¼‰ã€‚å¦‚æœä½ å¸Œæœ›é•¿æœŸç¨³å®šï¼š

*   è¦ä¹ˆ **ç¦ç”¨ fontmin**ï¼ˆä¸èµ° APIï¼Œçº¯æœ¬åœ°å­—ä½“æ ˆ fallbackï¼‰

*   è¦ä¹ˆ **è‡ªå·±åœ¨æœåŠ¡å™¨å®ç° `/api/fontmin`**ï¼ˆæœ€ç¨³ï¼‰

ä½ æŠŠä½ è·‘å‡ºæ¥çš„ `curl -I` è¾“å‡ºè´´ä¸€ä¸‹ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ å®ƒæ˜¯â€œå½»åº•æŒ‚äº†â€ã€è¿˜æ˜¯â€œé™æµ/403â€ã€è¿˜æ˜¯â€œCORS é—®é¢˜â€ã€‚

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# curl -L -o /tmp/font.woff2 "https://eva-title-server.vercel.app/api/fontmin?name=EVAMatisseClassic&unicode=4e2d" ls -lh /tmp/font.woff2 file /tmp/font.woff2 % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 2292 100 2292 0 0 4204 0 --:--:-- --:--:-- --:--:-- 4213 -rw-r--r-- 1 root root 2.3K Dec 5 17:54 /tmp/font.woff2 /tmp/font.woff2: Web Open Font Format, TrueType, length 2292, version 1.0

## A: 

èƒ½ç”¨ âœ…â€”â€”ä½ å·²ç»éªŒè¯åˆ°äº†å…³é”®ç‚¹ï¼šå®ƒè¿”å›çš„ç¡®å®æ˜¯ **WOFF å­—ä½“æ–‡ä»¶**ï¼ˆ`file` æ˜¾ç¤º _Web Open Font Format, TrueType_ï¼‰ï¼Œè€Œä¸”æˆåŠŸä¸‹è½½äº† 2.3KB çš„å­é›†å­—ä½“ã€‚

æ¥ä¸‹æ¥ä½ è¦åšçš„æ“ä½œå°±æ˜¯æŠŠé¡¹ç›®é‡Œçš„ `fontAPI` æŒ‡åˆ°è¿™ä¸ªåœ°å€ï¼Œå¹¶é¡ºæ‰‹å¤„ç†ä¸¤ä»¶å¸¸è§åç»­é—®é¢˜ï¼ˆHTTPS / CORS / ç¼“å­˜ï¼‰ã€‚

* * *

## 1ï¼‰æŠŠé¡¹ç›®çš„ fontAPI æ”¹æˆå¯ç”¨çš„æ¥å£

ç¼–è¾‘ä½ æ­£åœ¨ç”¨çš„é‚£ä»½ `document.js`ï¼ˆä½ ç°åœ¨ç›®å½•ç»Ÿä¸€åœ¨ `/www/wwwroot/yys.im/eva`ï¼‰ï¼š

æŠŠï¼š

```js
let fontAPI = 'https://s6.magiconch.com/api/fontmin';
```

æ”¹æˆï¼š

```js
let fontAPI = 'https://eva-title-server.vercel.app/api/fontmin';
```

ä½ ä¹‹å‰ grep é‡Œè¿˜æœ‰ä¸€è¡Œä¼šè¦†ç›–ï¼š

```js
fontAPI = 'http://localhost:60912/api/fontmin';
```

å¦‚æœä½ ä¸æ˜¯æœ¬æœºè·‘æœåŠ¡ç«¯ï¼Œå°±æŠŠå®ƒæ³¨é‡Šæ‰æˆ–ç¡®ä¿å®ƒä¸ä¼šæ‰§è¡Œï¼ˆå¦åˆ™ä¼šæŠŠä¸Šé¢æ”¹æ‰ï¼‰ã€‚

* * *

## 2ï¼‰ç¡®è®¤é¡µé¢å®é™…å¼•ç”¨çš„æ˜¯å“ªä»½ JSï¼ˆé¿å…æ”¹äº†ä¸ç”Ÿæ•ˆï¼‰

åœ¨ `index.html` çœ‹å¼•ç”¨è·¯å¾„ï¼ˆåœ¨ eva ç›®å½•æ‰§è¡Œï¼‰ï¼š

```bash
cd /www/wwwroot/yys.im/eva
grep -n "document.js" index.html
```

ç¡®ä¿ä½ æ”¹çš„ `document.js` å°±æ˜¯å®ƒåŠ è½½çš„é‚£ä»½ã€‚

* * *

## 3ï¼‰é‡è½½å¹¶æ¸…ç¼“å­˜ï¼ˆCloudflare ä¸€å®šè¦åšï¼‰

ä½ ç«™ç‚¹èµ° Cloudflareï¼Œå¾ˆå®¹æ˜“ç»§ç»­ç”¨æ—§ JSï¼š

*   Cloudflareï¼šPurge Cacheï¼ˆè‡³å°‘æ¸… `/eva/*`ï¼‰

*   æµè§ˆå™¨ï¼šCtrl+F5 å¼ºåˆ·ï¼ˆæˆ– DevTools å‹¾ Disable cacheï¼‰

*   * *

## 4ï¼‰éªŒè¯æˆåŠŸçš„æ ‡å¿—

æ‰“å¼€ç½‘é¡µ â†’ F12 â†’ Network è¿‡æ»¤ `fontmin`ï¼š

*   è¯·æ±‚åº”è¯¥å˜æˆï¼š  
    `https://eva-title-server.vercel.app/api/fontmin?...`

*   çŠ¶æ€ç  **200**

*   ä¸å†å‡ºç°ä½ åŸŸåä¸‹çš„ `/api/fontmin 404`

*   * *

## 5ï¼‰å¦‚æœè¿˜æœ‰â€œå­—è¡¥ä¸å‡ºæ¥â€ï¼Œæœ€å¸¸è§åŸå› æ˜¯ Canvas å­—ä½“æ ˆ/æƒé‡

å³ä½¿ fontmin èƒ½ç”¨äº†ï¼ŒCanvas ä»å¯èƒ½å› ä¸ºæƒé‡åŒ¹é…æˆ–å­—ä½“æ ˆåªå†™äº† `,sans-serif` å¯¼è‡´çœ‹èµ·æ¥æ²¡è¡¥é½ã€‚

ä½ ä¹‹å‰é‚£è¡Œï¼š

```js
ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
```

å»ºè®®è‡³å°‘æ”¹æˆï¼š

```js
ctx.font = `${weight} ${w}px "${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`;
```

è¿™æ ·ï¼šä¸»å­—ä½“ç¼ºå­—æ—¶ï¼Œæ‰ä¼šçœŸçš„èµ°ä½ è¦çš„ Heavy/NotoSerif å…œåº•ï¼ˆè€Œä¸æ˜¯æ‰åˆ° Noto Sans SCï¼‰ã€‚

* * *

å¦‚æœä½ ç°åœ¨æŠŠç½‘é¡µé‡Œé‚£æ¡ `fontmin` è¯·æ±‚çš„ Network æˆªå›¾å‘ä¸€ä¸‹ï¼ˆæˆ–ç›´æ¥è¯´çŠ¶æ€ç /æ˜¯å¦è·¨åŸŸæŠ¥é”™ï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç¡®è®¤æ˜¯å¦è¿˜éœ€è¦å¤„ç† CORS æˆ–å­—ä½“æ ˆè¿™ä¸€æ­¥ã€‚

## Q: 

è¿˜æ˜¯å‡ºç°äº†

## A: 

ä½ è¿™å¼ å›¾è¯´æ˜ï¼š**é¡µé¢ä»ç„¶åœ¨è¯·æ±‚ä½ è‡ªå·±åŸŸåçš„ `/api/fontmin`**ï¼š

`GET https://yys.im/api/fontmin ... 404`

è¿™æ„å‘³ç€åªæœ‰ä¸¤ç§å¯èƒ½ï¼ˆåŸºæœ¬100%ï¼‰ï¼š

1.  ä½ æ”¹çš„ **ä¸æ˜¯é¡µé¢å®é™…åŠ è½½çš„é‚£ä»½ JS**ï¼ˆè¿˜æœ‰å¦ä¸€ä»½ `document.js`/`make.js` åœ¨ç”¨æ—§çš„ fontAPIï¼‰

2.  ä½ çš„ä»£ç é‡Œè™½ç„¶æ”¹äº† `fontAPI`ï¼Œä½†åé¢åˆè¢«æŸæ®µé€»è¾‘æ”¹å›äº† `https://${location.hostname}/api/fontmin`ï¼ˆæˆ–æ‹¼æˆäº†åŸŸåï¼‰

å¦å¤– `favicon.ico 404` æ— ä¼¤å¤§é›…ï¼Œæ”¾ä¸ª favicon æˆ–å¿½ç•¥å°±è¡Œã€‚

* * *

## ç«‹åˆ»å®šä½ï¼šåˆ°åº•æ˜¯å“ªä¸€ä¸ªæ–‡ä»¶åœ¨å‘ `/api/fontmin`

ä½ ä¸ç”¨çŒœï¼Œç”¨ grep ä¸€æŠŠæ¢­å“ˆï¼š

```bash
cd /www/wwwroot/yys.im/eva
grep -R "location.hostname}/api/fontmin" -n .
grep -R "/api/fontmin" -n .
grep -R "fontAPI" -n . | head -n 80
```

æŠŠè¾“å‡ºè´´å‡ºæ¥ï¼Œæˆ‘å°±èƒ½æŒ‡å‡ºâ€œå“ªä¸€è¡Œã€å“ªä¸ªæ–‡ä»¶â€åœ¨æŠŠå®ƒæ”¹å›å»ã€‚

* * *

## åŒæ—¶åšä¸€ä¸ªæœ€æœ‰æ•ˆçš„æµè§ˆå™¨å®šä½ï¼ˆæ›´å¿«ï¼‰

åœ¨ä½ æˆªå›¾é‡Œï¼Œ`/api/fontmin` è¿™ä¸€æ¡å³ä¾§æœ‰æ¥æºï¼š`eva/?layout=e26:1`  
ä½ ç‚¹ä¸€ä¸‹é‚£æ¡é”™è¯¯å³ä¾§çš„é“¾æ¥ï¼ˆ`:1`ï¼‰ï¼Œå®ƒä¼šè·³åˆ° **Sources** é‡Œæ˜¾ç¤ºå…·ä½“æ˜¯å“ªæ®µ JS è§¦å‘çš„ï¼ˆé€šå¸¸ä¼šæ˜¾ç¤º `document.js` æˆ– `make.js` çš„å…·ä½“è¡Œå·ï¼‰ã€‚

ä½ çœ‹åˆ°æ–‡ä»¶å/è¡Œå·åå‘Šè¯‰æˆ‘ï¼ˆä¾‹å¦‚ `document.js:82` æˆ– `make.js:680`ï¼‰ï¼Œæˆ‘å°±èƒ½ç»™ä½ ç²¾å‡†æ”¹æ³•ã€‚

* * *

## å¸¸è§â€œæ”¹äº†è¿˜è¯·æ±‚æœ¬åŸŸåâ€çš„çœŸæ­£åŸå› 

æˆ‘ç»“åˆä½ ä¹‹å‰ grep çš„ç»“æœæé†’ä¸€ä¸‹ï¼šä½ æ–‡ä»¶é‡Œå‡ºç°è¿‡è¿™ç§è¦†ç›–é€»è¾‘ï¼š

* é¡¶éƒ¨ä½ æ”¹æˆå¤–éƒ¨æ¥å£

* ä½†åé¢åˆæœ‰ä¸€æ®µï¼š

  ```js
  fontAPI = 'http://localhost:60912/api/fontmin';
  ```

  æˆ–è€…åœ¨æŸä¸ªæ¡ä»¶ä¸‹é‡ç½®å›æœ¬åŸŸå

æ‰€ä»¥å¿…é¡»æŠŠâ€œä¼šè¦†ç›– fontAPI çš„é‚£æ®µâ€ä¹Ÿå¤„ç†æ‰ï¼ˆæ³¨é‡Š/åˆ é™¤/æ”¹æ¡ä»¶ï¼‰ã€‚

* * *

## ä¸´æ—¶æ­¢è¡€æ–¹æ¡ˆï¼ˆä¸æ”¹é€»è¾‘ä¹Ÿèƒ½ç«‹åˆ»ä¸ 404ï¼‰

å¦‚æœä½ æƒ³é©¬ä¸Šè®© 404 æ¶ˆå¤±ï¼ŒNginx åä»£æŠŠ `/api/fontmin` è½¬åˆ°å¯ç”¨çš„ Vercel æ¥å£å³å¯ï¼š

åœ¨å®å¡”ç«™ç‚¹ nginx é…ç½® `server{}` é‡ŒåŠ ï¼š

```nginx
location ^~ /api/fontmin {
  proxy_pass https://eva-title-server.vercel.app/api/fontmin;
  proxy_set_header Host eva-title-server.vercel.app;
}
```

é‡è½½ Nginx åï¼Œå³ä½¿å‰ç«¯è¿˜è¯·æ±‚ `https://yys.im/api/fontmin`ï¼Œä¹Ÿä¼šè¢«ä½ ä»£ç†åˆ° Vercel å»ï¼ˆä¸å† 404ï¼‰ã€‚

> è¿™æ‹›å¾ˆçŒ›å¾ˆçœäº‹ï¼Œé€‚åˆä½ ä¸æƒ³ç»§ç»­ç¿»å‰ç«¯ä»£ç æ‰¾æ˜¯å“ªä»½ JS çš„æƒ…å†µã€‚

* * *

ä½ é€‰ä¸€ä¸ªæ›´å¿«çš„æ–¹å¼ï¼š

*   **æƒ³å½»åº•ä»ä»£ç ä¿®**ï¼šæŠŠæˆ‘ä¸Šé¢ 3 æ¡ grep è¾“å‡ºè´´å›æ¥ï¼Œæˆ–å‘Šè¯‰æˆ‘ç‚¹å‡»æŠ¥é”™é“¾æ¥çœ‹åˆ°çš„æ–‡ä»¶å:è¡Œå·

*   **æƒ³ç«‹åˆ»æ­¢è¡€**ï¼šç›´æ¥ç”¨æˆ‘ç»™çš„ Nginx `location ^~ /api/fontmin` åä»£è§„åˆ™

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# cd /www/wwwroot/yys.im/eva grep -R "location.hostname}/api/fontmin" -n . grep -R "/api/fontmin" -n . grep -R "fontAPI" -n . | head -n 80 ./document.js:11://let fontAPI = `https://${location.hostname}/api/fontmin`; ./document.js:10:// let fontAPI = 'http://192.168.31.7:8003/api/fontmin'; ./document.js:11://let fontAPI = `https://${location.hostname}/api/fontmin`; ./document.js:12:let fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; ./document.js:13:// fontAPI = 'https://s6.magiconch.com/api/fontmin'; ./document.js:14:// fontAPI = 'http://localhost:60912/api/fontmin'; ./document.js:16:// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; ./document.js:64: fontAPI = 'http://localhost:60912/api/fontmin'; ./document.js:10:// let fontAPI = 'http://192.168.31.7:8003/api/fontmin'; ./document.js:11://let fontAPI = `https://${location.hostname}/api/fontmin`; ./document.js:12:let fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; ./document.js:13:// fontAPI = 'https://s6.magiconch.com/api/fontmin'; ./document.js:14:// fontAPI = 'http://localhost:60912/api/fontmin'; ./document.js:16:// fontAPI = 'https://eva-title-server.vercel.app/api/fontmin'; ./document.js:64: fontAPI = 'http://localhost:60912/api/fontmin'; ./document.js:84: const fontURL = `${fontAPI}?name=${name}&unicode=${unicode}`; ./document.js:136: console.log(`${fontAPI}?name=${fontFamilyName}&type=woff&unicode=${unicode}`);

## A: 

æ‰¾åˆ°äº†â€œå…ƒå‡¶â€âœ…ï¼šè™½ç„¶ä½ ç¬¬ 12 è¡Œå·²ç»æ”¹æˆäº† Vercelï¼Œä½† **ç¬¬ 64 è¡ŒåˆæŠŠ `fontAPI` è¦†ç›–æˆäº†æœ¬æœºåœ°å€**ï¼š

```js
64: fontAPI = 'http://localhost:60912/api/fontmin';
```

è€Œä½ æµè§ˆå™¨é‡Œçœ‹åˆ°çš„æ˜¯è¯·æ±‚ `https://yys.im/api/fontmin`ï¼Œè¿™é€šå¸¸å‘ç”Ÿåœ¨ï¼šå‰ç«¯æ£€æµ‹åˆ°ä¸åœ¨æœ¬æœºæ—¶ï¼Œä¼šæŠŠ localhost æ›¿æ¢/æ‹¼å›åŸŸåï¼ˆæˆ–ä½ ç»è¿‡ Cloudflare/HTTPS æ··åˆå¯¼è‡´å®ƒæ”¹ç”¨äº†åŒæº `/api/fontmin`ï¼‰ã€‚

æ€»ä¹‹ï¼š**å¿…é¡»å¤„ç†ç¬¬ 64 è¡Œè¦†ç›–**ï¼Œå¦åˆ™ä½ ä¸Šé¢æ”¹æˆ Vercel æ°¸è¿œä¼šè¢«å†²æ‰ã€‚

* * *

## ç«‹åˆ»ä¿®å¤ï¼ˆæ¨èåšæ³•ï¼‰

ç¼–è¾‘ `/www/wwwroot/yys.im/eva/document.js`ï¼ŒæŠŠç¬¬ 64 è¡Œè¿™å¥æ”¹æ‰ã€‚

### æ–¹æ¡ˆ Aï¼ˆæœ€ç®€å•ï¼‰ï¼šç›´æ¥æ³¨é‡Šæ‰ç¬¬ 64 è¡Œ

æŠŠï¼š

```js
fontAPI = 'http://localhost:60912/api/fontmin';
```

æ”¹æˆï¼š

```js
// fontAPI = 'http://localhost:60912/api/fontmin';
```

è¿™æ ·å°±ä¸ä¼šå†è¢«è¦†ç›–ï¼Œ`fontAPI` ä¼šä¸€ç›´ä¿æŒä½ ç¬¬ 12 è¡Œçš„ï¼š

```js
let fontAPI = 'https://eva-title-server.vercel.app/api/fontmin';
```

### æ–¹æ¡ˆ Bï¼ˆæ›´åˆç†ï¼‰ï¼šåªåœ¨çœŸæ­£æœ¬æœºå¼€å‘æ—¶æ‰ç”¨ localhost

æŠŠç¬¬ 64 è¡Œå¤–é¢åŒ…ä¸ªåˆ¤æ–­ï¼ˆæ¨èï¼‰ï¼š

```js
if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
  fontAPI = "http://localhost:60912/api/fontmin";
}
```

çº¿ä¸Šè®¿é—® `yys.im` å°±ä¸ä¼šåˆ‡åˆ° localhost äº†ã€‚

* * *

## æ”¹å®Œåä¸€å®šè¦åšä¸¤ä»¶äº‹ï¼ˆä¸ç„¶ä½ è¿˜ä¼šçœ‹åˆ°æ—§è¡Œä¸ºï¼‰

1.  **å¼ºåˆ·**ï¼šæµè§ˆå™¨ Ctrl+F5ï¼ˆæˆ– DevTools å‹¾ Disable cacheï¼‰

2.  **Cloudflare æ¸…ç¼“å­˜**ï¼ˆä½ ç«™ç‚¹èµ° CFï¼Œå¾ˆå®¹æ˜“è¿˜ç”¨æ—§çš„ document.jsï¼‰  
    Purge Cache â†’ è‡³å°‘æ¸… `/eva/*` æˆ–ç›´æ¥ Purge Everything

* * *

## éªŒè¯æ˜¯å¦æˆåŠŸ

åˆ·æ–°åçœ‹ Console / Networkï¼š

*   ä¸åº”å†å‡ºç° `https://yys.im/api/fontmin ... 404`

*   åº”è¯¥å˜æˆè¯·æ±‚ï¼š  
    `https://eva-title-server.vercel.app/api/fontmin?...` ä¸”çŠ¶æ€ 200

*   * *

é¡ºæ‰‹ä¸€æï¼š`favicon.ico 404` ä¸å½±å“åŠŸèƒ½ï¼Œè¦æ¶ˆæ‰çš„è¯åœ¨ç«™ç‚¹æ ¹æ”¾ä¸€ä¸ª `favicon.ico` å°±è¡Œã€‚

ä½ æŒ‰ä¸Šé¢æ³¨é‡Š/åŠ åˆ¤æ–­æ”¹å®Œåï¼Œå¦‚æœè¿˜å‡ºç° `yys.im/api/fontmin`ï¼Œé‚£å°±æ˜¯ Cloudflare è¿˜åœ¨ç¼“å­˜æ—§ JSâ€”â€”ç›´æ¥ purge ä¸€ä¸‹å°±ä¼šç«‹åˆ»æ­£å¸¸ã€‚

## Q: 

è¿˜æœ‰é—®é¢˜

## A: 

è¡Œï¼Œé‚£æˆ‘ä»¬ç›´æ¥æŠŠâ€œè¿˜æœ‰é—®é¢˜â€å¿«é€Ÿå®šä½æ‰ï¼šä½ ç°åœ¨æœ€å¯èƒ½é‡åˆ°çš„æƒ…å†µå°±ä¸‰ç±»â€”â€”æˆ‘ç»™ä½ **ä¸éœ€è¦çŒœ**çš„æ’æŸ¥é¡ºåºï¼Œä½ ç…§ç€åšï¼Œè¾“å‡ºè´´å›æ¥æˆ‘å°±èƒ½ä¸€æŠŠä¿®åˆ°ä½ã€‚

* * *

## 1ï¼‰å…ˆç¡®è®¤ï¼šç°åœ¨åˆ°åº•è¿˜åœ¨ä¸åœ¨è¯·æ±‚ `yys.im/api/fontmin`ï¼Ÿ

åœ¨æœåŠ¡å™¨ä¸Šå…ˆç¡®è®¤ä½  `document.js` ç¬¬ 64 è¡Œå·²ç»å¤„ç†äº†ï¼ˆæ³¨é‡Šæˆ–åŠ åˆ¤æ–­ï¼‰ï¼š

```bash
sed -n '55,75p' /www/wwwroot/yys.im/eva/document.js
```

ç„¶åæµè§ˆå™¨å¼ºåˆ·ï¼ˆCtrl+F5ï¼‰åï¼Œçœ‹æ§åˆ¶å°/Network é‡Œ `fontmin` çš„è¯·æ±‚åŸŸåæ˜¯ä»€ä¹ˆï¼š

*   ä»æ˜¯ `https://yys.im/api/fontmin` â†’ **ç¼“å­˜æ²¡æ¸…å¹²å‡€/æ²¡åŠ è½½åˆ°æ–° JS**

*   å˜æˆ `https://eva-title-server.vercel.app/api/fontmin` â†’ **fontAPI å·²ä¿®å¥½ï¼Œç»§ç»­çœ‹ä¸‹ä¸€é¡¹**

ï¼ˆä½ ä¹Ÿå¯ä»¥åœ¨æœåŠ¡å™¨ç›´æ¥ grep æœ€ç»ˆå€¼æ˜¯å¦è¿˜ä¼šè¢«æ”¹ï¼šï¼‰

```bash
grep -n "fontAPI =" -n /www/wwwroot/yys.im/eva/document.js
```

* * *

## 2ï¼‰å¦‚æœ fontmin åŸŸåå·²ç»å¯¹äº†ï¼Œä½†è¿˜æ˜¯â€œå­—ä¸å…¨/è¡¥ä¸ä¸Šâ€

é‚£å‡ ä¹ä¸€å®šæ˜¯ **Canvas å­—ä½“æ ˆæ²¡åŠ å¥½ æˆ– å­—ä½“æ²¡åŠ è½½å®Œæˆå°±ç»˜åˆ¶**ã€‚

### A. ç¡®è®¤ Canvas çš„ `ctx.font` ç°åœ¨æ˜¯ä»€ä¹ˆ

ä½ ä¹‹å‰é‚£è¡Œåœ¨ `document.js:28`ã€‚è¯·è´´ä¸€ä¸‹è¿™å‡ è¡Œï¼š

```bash
sed -n '20,40p' /www/wwwroot/yys.im/eva/document.js
```

æˆ‘éœ€è¦ç¡®è®¤ä½ æ˜¯å¦å·²ç»æŠŠå®ƒæ”¹æˆç±»ä¼¼ï¼š

```js
ctx.font = `${weight} ${w}px "${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack",serif`;
```

### B. ç¡®è®¤å­—ä½“æ–‡ä»¶æœ‰æ²¡æœ‰è¢«æˆåŠŸåŠ è½½ï¼ˆ200ï¼‰

æµè§ˆå™¨ F12 â†’ Network è¿‡æ»¤ `woff2` / `otf`  
æˆ–è€…æœåŠ¡å™¨ä¸Šç”¨ curl ç›´æ¥æµ‹ï¼ˆå‡è®¾ä½ å­—ä½“åœ¨ eva/fontsï¼‰ï¼š

```bash
curl -I https://yys.im/eva/fonts/SourceHanSerifCN-Heavy.woff2
curl -I https://yys.im/eva/fonts/NotoSerifSC-Black.woff2
```

* * *

## 3ï¼‰å¦‚æœæŠ¥é”™æ˜¯â€œè¿˜æ˜¯ 404 ä½†ä¸æ˜¯ fontminâ€

ä½ æŠŠæ§åˆ¶å°æœ€æ–°çº¢è‰²é”™è¯¯ï¼ˆæ–‡å­—æˆ–æˆªå›¾ï¼‰å‘å‡ºæ¥å³å¯ã€‚  
å¸¸è§çš„è¿˜æœ‰ï¼š

*   `favicon.ico 404`ï¼ˆå¯ä»¥å¿½ç•¥ï¼‰

*   æŸä¸ª `.woff2/.png/.js` è·¯å¾„ä¸å¯¹ï¼ˆæˆ‘ä¼šå‘Šè¯‰ä½ åº”è¯¥æ”¾å“ªé‡Œ/æ€ä¹ˆæ”¹ç›¸å¯¹è·¯å¾„ï¼‰

*   * *

### ä½ ç°åœ¨ç›´æ¥æŠŠè¿™ä¸‰æ¡å‘½ä»¤è¾“å‡ºè´´æˆ‘ï¼ˆæœ€çœæ—¶é—´ï¼‰

```bash
sed -n '55,75p' /www/wwwroot/yys.im/eva/document.js
sed -n '20,40p' /www/wwwroot/yys.im/eva/document.js
grep -n "fontAPI =" /www/wwwroot/yys.im/eva/document.js
```

æˆ‘çœ‹å®Œå°±èƒ½åˆ¤æ–­ä½ â€œè¿˜æœ‰é—®é¢˜â€åˆ°åº•æ˜¯ç¼“å­˜ã€fontAPI è¦†ç›–ã€Canvas å­—ä½“æ ˆã€è¿˜æ˜¯èµ„æºè·¯å¾„é—®é¢˜ï¼Œå¹¶ç»™ä½ ä¸€å¥—ç¡®å®šå¯è¡Œçš„ä¿®æ”¹ã€‚

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# ^C root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# sed -n '55,75p' /www/wwwroot/yys.im/eva/document.js let haveMatisse = checkFont('EVA_Matisse_Classic-EB,MatissePro-EB') > 120; let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150; let debug = /192\\.168/.test(location.origin); if(debug){ // fontWeight = 100; //fontAPI = 'http://localhost:60912/api/fontmin'; haveMatisse = false; // baseFontFamilyName = 'baseSplit,serif'; } const getFontFromText = (name,text,onOver=_=>{})=>{ if(!text) return requestAnimationFrame(onOver); if(haveMatisse) return requestAnimationFrame(onOver); text = text.replace(blockMojiRegex,''); text += '0';

## A: 

çœ‹åˆ°äº†ï¼šä½ å·²ç»æŠŠ **è¦†ç›– fontAPI çš„é‚£è¡Œæ³¨é‡Šæ‰äº†** âœ…ï¼ˆ`//fontAPI = 'http://localhost:60912/api/fontmin';`ï¼‰ï¼Œè€Œä¸”ç°åœ¨ `debug` åªåœ¨ `location.origin` åŒ…å« `192.168` æ—¶æ‰ä¼šè¿›ï¼Œæ‰€ä»¥çº¿ä¸Šä¸ä¼šèµ°è¿™ä¸ªåˆ†æ”¯ã€‚

ä½†ä½ è¿™é‡ŒåŒæ—¶æš´éœ²äº†â€œä¸ºä»€ä¹ˆä½ è¿˜æ˜¯æ²¡æœ‰åå¤‡æ–‡å­—æ•ˆæœâ€çš„å…³é”®åŸå› ä¹‹ä¸€ï¼š

```js
let haveMatisse = checkFont('EVA_Matisse_Classic-EB,MatissePro-EB') > 120;
let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150;

const getFontFromText = (name,text,onOver=_=>{})=>{
    if(!text) return requestAnimationFrame(onOver);
    if(haveMatisse) return requestAnimationFrame(onOver);
    ...
}
```

### è¿™æ®µé€»è¾‘çš„å«ä¹‰æ˜¯ï¼š

*   **åªè¦æ£€æµ‹åˆ°ä½ æœºå™¨â€œæœ‰ Matisseâ€**ï¼ˆ`haveMatisse=true`ï¼‰ï¼Œå®ƒå°±**ç›´æ¥è·³è¿‡** `getFontFromText` çš„å­—ä½“è·å–/å¤„ç†æµç¨‹ï¼ˆé€šå¸¸åŒ…æ‹¬ fontmin å­é›†åŒ–ã€ä»¥åŠæŸäº› fallback å¤„ç†ï¼‰

*   ç»“æœå°±æ˜¯ï¼šå“ªæ€• Matisse å¯¹æŸäº›å­—ç¼ºå­—ï¼Œå®ƒä¹Ÿå¯èƒ½ä¸ä¼šå»å¸®ä½ è¡¥ï¼ˆå› ä¸ºå®ƒåªåˆ¤æ–­â€œæœ‰æ²¡æœ‰è£…/èƒ½ä¸èƒ½ç”¨â€ï¼Œè€Œä¸æ˜¯â€œæ˜¯å¦è¦†ç›–æ‰€æœ‰å­—ç¬¦â€ï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼š**â€œæœ‰æ²¡æœ‰å­—ä½“â€å’Œâ€œæœ‰æ²¡æœ‰æŸä¸ªå­—å½¢â€æ˜¯ä¸¤å›äº‹**ï¼Œä½œè€…çš„åˆ¤æ–­è¿‡äºç²—ã€‚

* * *

# ä½ æ¥ä¸‹æ¥è¯¥æ€ä¹ˆæ”¹ï¼ˆæœ€å°æ”¹åŠ¨ï¼Œè®©ç¼ºå­—ä¹Ÿèƒ½èµ°è¡¥å­—æµç¨‹ï¼‰

## æ–¹æ¡ˆ Aï¼ˆæœ€å°ä¸”æœ‰æ•ˆï¼‰ï¼šæ”¹æˆâ€œæœ‰ Matisse ä¹Ÿè¦æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼ºå­—â€

æ€è·¯ï¼šåªæœ‰å½“ `name` å¯¹å½“å‰è¾“å…¥ `text` **å…¨éƒ¨å­—ç¬¦éƒ½èƒ½ç”»å‡ºæ¥** æ‰è·³è¿‡ï¼›å¦åˆ™ç»§ç»­èµ°åç»­å¤„ç†ï¼ˆfontmin / fallbackï¼‰ã€‚

### 1ï¼‰å…ˆæ‰¾åˆ° `blockMojiRegex`ã€`noMatchMojis` æˆ–ç¼ºå­—æ”¶é›†çš„é€»è¾‘

ä½ è¿™ä¸ªæ–‡ä»¶é‡Œè‚¯å®šæœ‰ä¸€æ®µæŠŠâ€œä¸åŒ¹é…æ–‡å­—â€ç»Ÿè®¡å‡ºæ¥ã€‚æˆ‘ä»¬è¦åˆ©ç”¨å®ƒæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¡¥å­—ã€‚

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/yys.im/eva
grep -n "noMatch" document.js
grep -n "checkFont" document.js
grep -n "blockMojiRegex" document.js
```

æŠŠè¾“å‡ºè´´æˆ‘ï¼Œæˆ‘å°±èƒ½ç²¾ç¡®å‘Šè¯‰ä½ æ”¹å“ªå‡ è¡Œã€‚

* * *

## æ–¹æ¡ˆ Bï¼ˆæ›´ç²—æš´ä½†æœ€å¿«çœ‹åˆ°æ•ˆæœï¼‰ï¼šå¼ºåˆ¶è®©å®ƒä¸è¦è®¤ä¸ºâ€œhaveMatisseâ€

ä¹Ÿå°±æ˜¯è®© `getFontFromText` æ€»æ˜¯æ‰§è¡Œï¼ˆè¿™æ ·å®ƒå°±ä¼šå»èµ° fontmin æˆ–è¡¥å­—é€»è¾‘ï¼‰ã€‚

ç›´æ¥æŠŠè¿™å¥æ”¹æˆï¼ˆä¸´æ—¶éªŒè¯ç”¨ï¼‰ï¼š

```js
let haveMatisse = false;
```

æˆ–è€…æŠŠå‡½æ•°é‡Œè¿™è¡Œæ³¨é‡Šæ‰ï¼š

```js
// if(haveMatisse) return requestAnimationFrame(onOver);
```

è¿™æ ·ä½ é©¬ä¸Šå°±èƒ½çœ‹åˆ°ï¼šç¼ºå­—æ—¶å®ƒä¼šä¸ä¼šå»è¯·æ±‚ fontminã€ä¼šä¸ä¼šè¡¥ä¸Šã€‚

> å¦‚æœè¿™æ ·æ”¹äº†â€œç¡®å®è¡¥å­—/ä¸åŒ¹é…æç¤ºå˜åŒ–äº†â€ï¼Œå°±è¯æ˜é—®é¢˜ç‚¹å®Œå…¨åœ¨è¿™ä¸ª `haveMatisse` è¿‡æ—© short-circuit ä¸Šã€‚

* * *

# å¦å¤–ä¸€ä¸ªä½ å¿…é¡»ç¡®è®¤çš„ç‚¹ï¼šCanvas å­—ä½“æ ˆæ˜¯å¦çœŸçš„åŠ äº† fallback

ä½ è¿˜æ²¡è´´ `ctx.font` çš„é‚£æ®µï¼ˆ20~40è¡Œï¼‰ï¼Œå¦‚æœå®ƒä»æ˜¯ï¼š

```js
ctx.font = `${weight} ${w}px ${fontName},sans-serif`;
```

é‚£å°±ç®—ä½ èµ°è¡¥å­—æµç¨‹ï¼Œä¹Ÿå¯èƒ½è¿˜æ˜¯è¡¥ä¸å‡ºæ¥/è¡¥å¾—ä¸æŒ‰ä½ æƒ³è¦çš„ serif heavyã€‚

ä½ æŠŠè¿™æ®µä¹Ÿè´´å‡ºæ¥ï¼ˆä½ ä¹‹å‰ä¸­æ–­äº†ç¬¬äºŒæ¡å‘½ä»¤ï¼‰ï¼Œç›´æ¥è·‘ï¼š

```bash
sed -n '20,40p' /www/wwwroot/yys.im/eva/document.js
```

* * *

## ä½ ç°åœ¨å‘æˆ‘ä¸¤æ ·ä¸œè¥¿ï¼Œæˆ‘å°±èƒ½ç»™ä½ â€œæœ€ç»ˆç‰ˆæ”¹æ³•â€

1.  `sed -n '20,40p' ...` çš„è¾“å‡ºï¼ˆçœ‹ ctx.font æœ‰æ²¡æœ‰åŠ æ ˆï¼‰

2.  `grep -n "noMatch\|blockMojiRegex\|checkFont" document.js` çš„è¾“å‡ºï¼ˆæˆ‘å®šä½ç¼ºå­—é€»è¾‘ï¼‰

æˆ‘ä¼šç»™ä½ ä¸€ä¸ªæœ€å°è¡¥ä¸ï¼Œè®©ï¼š

*   Matisse å­˜åœ¨ä¹Ÿä¸å½±å“ç¼ºå­—è¡¥å…¨

*   `/api/fontmin` ä¸å†èµ°ä½ åŸŸå

*   Canvas èƒ½æŒ‰ä½ æŒ‡å®šçš„ fallback å­—ä½“æ ˆæ¸²æŸ“å‡ºå®Œæ•´æ–‡å­—

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# cd /www/wwwroot/yys.im/eva grep -n "noMatch" document.js grep -n "checkFont" document.js grep -n "blockMojiRegex" document.js 344: noMatchMojis(){ 21:const checkFont = (fontName,weight=100)=>{ 55:let haveMatisse = checkFont('EVA_Matisse_Classic-EB,MatissePro-EB') > 120; 56:let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150; 18:const blockMojiRegex = /\\s/g; 74: text = text.replace(blockMojiRegex,'');

## A: 

å¾ˆå¥½ï¼Œå®šä½é½äº†ã€‚ç°åœ¨ä½ â€œæ²¡æœ‰åå¤‡æ–‡å­—æ•ˆæœâ€çš„å…³é”®é—®é¢˜åŸºæœ¬å°±æ˜¯ï¼š

1.  `blockMojiRegex` ç°åœ¨æ˜¯ **`/\s/g`**ï¼ˆåªä¼šå»æ‰ç©ºæ ¼ï¼‰ï¼Œæ ¹æœ¬æ²¡æœ‰çœŸçš„â€œè¿‡æ»¤ emoji/ç‰¹æ®Šå­—ç¬¦â€ã€‚è¿™ä¸æ˜¯è‡´å‘½ï¼Œä½†è¯´æ˜ä½œè€…é€»è¾‘æ¯”è¾ƒéšæ„ã€‚

2.  æ›´å…³é”®çš„æ˜¯ï¼šä½œè€…çš„â€œä¸åŒ¹é…æ–‡å­—â€åˆ¤æ–­ï¼ˆ`noMatchMojis()`ï¼‰å¾ˆå¯èƒ½**åªæŒ‰ Matisse æ˜¯å¦å­˜åœ¨**æ¥å†³å®šè¦ä¸è¦èµ°è¡¥å­—æµç¨‹ï¼Œè€Œä¸æ˜¯æŒ‰â€œè¿™ä¸ªå­—æœ‰æ²¡æœ‰å­—å½¢â€ã€‚

3.  å¦å¤–ä½ ç°åœ¨ Canvas `ctx.font` å¦‚æœè¿˜æ˜¯ `...,sans-serif`ï¼Œfallback ä¼šä¼˜å…ˆæ‰åˆ°ç³»ç»Ÿçš„ Noto Sans SCï¼Œè€Œä¸æ˜¯ä½ å‡†å¤‡çš„ serif heavyã€‚

ä¸‹é¢ç»™ä½ ä¸€ä¸ª**æœ€å°ä¸”ç¨³å®š**çš„ä¿®æ³•ï¼šè®©â€œç¼ºå­—æ—¶ä¹Ÿèƒ½èµ°åå¤‡å­—ä½“æ¸²æŸ“â€ï¼Œä¸å†è¢« `haveMatisse` ä¸€ç¥¨å¦å†³ã€‚

* * *

# âœ… ç¬¬ä¸€æ­¥ï¼šæŠŠ Canvas å­—ä½“å†™æˆçœŸæ­£çš„å­—ä½“æ ˆï¼ˆå¿…é¡»ï¼‰

ä½ æ–‡ä»¶é‡Œ `ctx.font` åœ¨ç¬¬ 28 è¡Œï¼ˆä½ ä¹‹å‰ grep å‡ºæ¥è¿‡ï¼‰ï¼ŒæŠŠå®ƒæ”¹æˆï¼š

```js
const fallbackStack = `"SourceHanSerifCN-Heavy","NotoSerifSCBlack","Noto Serif CJK SC",serif`;
ctx.font = `${weight} ${w}px "${fontName}",${fallbackStack}`;
```

> è¿™æ · Canvas æ‰ä¼šåœ¨ä¸»å­—ä½“ç¼ºå­—æ—¶è‡ªåŠ¨å»åé¢çš„å­—ä½“æ‰¾å­—å½¢ã€‚

* * *

# âœ… ç¬¬äºŒæ­¥ï¼šè®© noMatch çš„åˆ¤æ–­åŸºäºâ€œå­—å½¢æ˜¯å¦å­˜åœ¨â€ï¼Œè€Œä¸æ˜¯ haveMatisse

ä½ ç°åœ¨æœ‰ï¼š

*   `checkFont()` åœ¨ç¬¬ 21 è¡Œ

*   `noMatchMojis()` åœ¨ç¬¬ 344 è¡Œ

æ€è·¯ï¼šåœ¨ `noMatchMojis()` é‡Œï¼Œä¸è¦åªç”¨ä¸»å­—ä½“åå»æµ‹ï¼›è¦ç”¨â€œä¸»å­—ä½“ + åå¤‡å­—ä½“æ ˆâ€å»æµ‹ã€‚åªè¦æ ˆé‡Œä»»æ„å­—ä½“èƒ½æ˜¾ç¤ºï¼Œå°±ä¸ç®— noMatchã€‚

### ä½ å…ˆåšä¸€ä¸ªæœ€å°æ”¹åŠ¨ï¼ˆä¸éœ€è¦æ·±å…¥æ”¹ checkFontï¼‰

åœ¨ `noMatchMojis()` é‡Œï¼ŒæŠŠç”¨äºæ£€æµ‹çš„å­—ä½“åä»å•ä¸ª `EVAMatisseClassic` æ”¹æˆä¸€ä¸ªæ ˆï¼š

ä¾‹å¦‚æŠŠé‡Œé¢ç±»ä¼¼è¿™ç§ï¼š

```js
checkFont(fontFamilyName, 800)
```

æ›¿æ¢ä¸ºï¼š

```js
checkFont(`${fontFamilyName},SourceHanSerifCN-Heavy,NotoSerifSCBlack,serif`, 800)
```

> æ³¨æ„ï¼šè¿™é‡Œç”¨é€—å·ä¸²èµ·æ¥å°±è¡Œï¼Œå› ä¸ºä½ çš„ `checkFont` æœ¬æ¥å°±æ”¯æŒä¼  `'A,B'` è¿™ç§ï¼ˆä½ ç¬¬ 55 è¡Œä¹Ÿæ˜¯è¿™ä¹ˆä¼ çš„ï¼‰ã€‚

* * *

# âœ… ä½ ç°åœ¨åªå·®ä¸€ä¸ªä¿¡æ¯ï¼šnoMatchMojis() çš„å…·ä½“å†…å®¹

æˆ‘éœ€è¦ä½ æŠŠ `document.js` é‡Œ `noMatchMojis()` è¿™ä¸€æ®µè´´å‡ºæ¥ï¼ˆå¤§æ¦‚ 330~380 è¡Œå·¦å³ï¼‰ã€‚

ç›´æ¥åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
sed -n '330,390p' /www/wwwroot/yys.im/eva/document.js
```

æˆ‘çœ‹å®Œåä¼šå‘Šè¯‰ä½ ï¼š

*   å“ªä¸€è¡Œåœ¨ç”¨ä¸»å­—ä½“åˆ¤ç¼ºå­—

*   åº”è¯¥æ›¿æ¢æˆâ€œå­—ä½“æ ˆåˆ¤ç¼ºå­—â€çš„ç²¾ç¡®å†™æ³•

*   æ˜¯å¦è¿˜éœ€è¦æŠŠ `if (haveMatisse) return ...` é‚£ä¸ªçŸ­è·¯é€»è¾‘æ”¹æ‰ï¼ˆå¤šæ•°æƒ…å†µä¸‹è¦æ”¹ï¼‰

*   * *

# é¡ºæ‰‹ï¼šä½  CSS é‡Œä¹Ÿæœ‰ä¸€ä¸ªæ˜æ˜¾é”™è¯¯ï¼ˆä¼šå¯¼è‡´ä½ ä»¥ä¸ºå†™äº† fallbackï¼Œå…¶å®æ²¡ç”Ÿæ•ˆï¼‰

ä½ ä¹‹å‰ `html{}` é‡Œå†™äº†å¾ˆå¤šæ¡ `font-family:`ï¼Œåªæœ‰æœ€åä¸€æ¡ç”Ÿæ•ˆã€‚åŠ¡å¿…åªç•™ä¸€æ¡å­—ä½“æ ˆã€‚

* * *

## ç°åœ¨è¯·ä½ æŠŠè¿™æ®µè¾“å‡ºè´´å‡ºæ¥

```bash
sed -n '330,390p' /www/wwwroot/yys.im/eva/document.js
```

æˆ‘ä¼šåœ¨ä½ ç°æœ‰ä»£ç åŸºç¡€ä¸Šç»™ä½ ä¸€ä¸ªâ€œå¯ç›´æ¥å¤åˆ¶ç²˜è´´â€çš„æœ€ç»ˆè¡¥ä¸ï¼Œè®©ï¼š

*   ä¸»å­—ä½“ç¼ºå­—æ—¶èƒ½ç”¨ Heavy/NotoSerif è¡¥å‡ºæ¥

*   noMatch ä¸å†è¯¯æŠ¥/ä¸å†æŠŠå­—å½“ä½œâ€œæ— è§£â€è€Œä¸æ¸²æŸ“

## Q: 

root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# sed -n '55,75p' /www/wwwroot/yys.im/eva/document.js let haveMatisse = checkFont('EVA_Matisse_Classic-EB,MatissePro-EB') > 120; let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150; let debug = /192\\.168/.test(location.origin); if(debug){ // fontWeight = 100; //fontAPI = 'http://localhost:60912/api/fontmin'; haveMatisse = false; // baseFontFamilyName = 'baseSplit,serif'; } const getFontFromText = (name,text,onOver=_=>{})=>{ if(!text) return requestAnimationFrame(onOver); if(haveMatisse) return requestAnimationFrame(onOver); text = text.replace(blockMojiRegex,''); text += '0'; root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# ^C root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# cd /www/wwwroot/yys.im/eva grep -n "noMatch" document.js grep -n "checkFont" document.js grep -n "blockMojiRegex" document.js 344: noMatchMojis(){ 21:const checkFont = (fontName,weight=100)=>{ 55:let haveMatisse = checkFont('EVA_Matisse_Classic-EB,MatissePro-EB') > 120; 56:let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150; 18:const blockMojiRegex = /\\s/g; 74: text = text.replace(blockMojiRegex,''); root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# ^C root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# sed -n '20,40p' /www/wwwroot/yys.im/eva/document.js const checkFont = (fontName,weight=100)=>{ const canvas = document.createElement('canvas'); const w = 18; canvas.width = w; canvas.height = w; const ctx = canvas.getContext('2d'); document.body.appendChild(canvas); //ctx.font = `${weight} ${w}px ${fontName},sans-serif`; ctx.font = `${weight} ${w}px "${fontName}","SourceHanSerifCN-Heavy","NotoSerifSCBlack","Noto Serif CJK SC",serif`; ctx.fillStyle = '#000'; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.textAlign = 'left'; ctx.textBaseline = 'bottom'; ctx.clearRect(0,0,w,w); ctx.fillText( 'é¥‘', 0, w root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# ^C root@racknerd-d898d1b:/www/wwwroot/yys.im/eva# sed -n '330,390p' /www/wwwroot/yys.im/eva/document.js return this.layout.inputs.map((input,index)=>{ const {type} = input; if(type==='tab'){ return this.texts[index]; } return textFilter(this.texts[index] || input.placeholder) }); }, allText(){ return this._text.join(','); }, canTc(){ return this.texts.join() !== transformFunc[2](this.texts.join()) }, noMatchMojis(){ return Array.from(new Set(this.allText)).sort().filter(m=>!EVAMatisseClassicMojis.includes(m)) } }, watch:{ config:{ deep:true, handler:'make' }, output(v){ document.documentElement.setAttribute('data-output',!!v); }, // layout:'make', // texts:{ // deep:true, // handler:'make' // }, } }) const getQuerys = _=>{ const GET = {}; let queryString = location.search.slice(1); if(queryString){ let gets = queryString.split(/&/g); gets.forEach(get=>{ let [k,v] = get.split(/=/); GET[decodeURIComponent(k)] = decodeURIComponent(v); }) }; return GET }; let outputCanvas = createCanvas(); let canvas = createCanvas(); const c = async callback=>{ loadFont('notdef','NotDefault.woff2',async _=>{ loadFont('baseSplit','base-split.woff?r=220716',async _=>{ getFontFromText(fontFamilyName,getMoji(),async _=>{ layouts.slice().sort(_=>-1).forEach((layout,index)=>{ let texts = [ // 'ä½¿å¾’', // 'è¥²æ¥',

## A: 

ä½ ç°åœ¨â€œåå¤‡å­—ä½“æ˜æ˜åœ¨å­—ä½“æ ˆé‡Œï¼Œä½†è¿˜æ˜¯ä¸æ˜¾ç¤º/æç¤ºä¸åŒ¹é…â€çš„**çœŸæ­£åŸå› **ï¼Œå°±è—åœ¨ä½ è´´å‡ºæ¥çš„è¿™å¥é‡Œï¼š

```js
noMatchMojis(){
  return Array.from(new Set(this.allText)).sort().filter(m=>!EVAMatisseClassicMojis.includes(m))
}
```

å®ƒçš„é€»è¾‘æ˜¯ï¼š**åªè¦è¿™ä¸ªå­—ä¸åœ¨ `EVAMatisseClassicMojis`ï¼ˆEVA ä¸»å­—ä½“å­—åº“åˆ—è¡¨ï¼‰é‡Œï¼Œå°±ç›´æ¥åˆ¤å®šâ€œä¸åŒ¹é…â€**ã€‚  
è¿™è·Ÿä½ æœ‰æ²¡æœ‰è®¾ç½® `"SourceHanSerifCN-Heavy"` åå¤‡å­—ä½“ **å®Œå…¨æ— å…³**ã€‚

æ›´è¦å‘½çš„æ˜¯ï¼šå¾ˆå¤šé¡¹ç›®ä¼šåœ¨åç»­æµç¨‹é‡Œ**æŠŠâ€œä¸åŒ¹é…å­—â€ä»æ¸²æŸ“/å¯¼å‡ºå­—ç¬¦é›†é‡Œå‰”é™¤**ï¼ˆæ¯”å¦‚ `getMoji()` åªè¿”å›åŒ¹é…å­—ï¼‰ï¼Œè¿™æ ·ä½ å°±ç®— Canvas å­—ä½“æ ˆå†™å¾—å†å®Œç¾ï¼Œå­—ä¹Ÿæ ¹æœ¬æ²¡æœºä¼šç”»å‡ºæ¥ã€‚

ä½ å·²ç»æŠŠ `checkFont` çš„ `ctx.font` æ”¹æˆå­—ä½“æ ˆäº† âœ…ï¼ˆè¿™ä¸€æ­¥å¯¹ Canvas å¾ˆé‡è¦ï¼‰ï¼Œä½†ç°åœ¨è¿˜éœ€è¦æŠŠ `noMatchMojis()` æ”¹æˆâ€œæœ‰åå¤‡å­—ä½“æ—¶ä¸è¦æ‹¦æˆªâ€ã€‚

* * *

## âœ… æœ€å¿«ä¿®å¤ï¼ˆæ¨èï¼‰ï¼šåªè¦æ£€æµ‹åˆ°æœ‰æ€æºå®‹ä½“ Heavyï¼Œå°±ä¸è¦æŠŠå­—ç®—ä½œ noMatch

ä½ å·²ç»æœ‰è¿™è¡Œæ£€æµ‹ï¼š

```js
let haveSourceHanSerifCNHeavy = checkFont('SourceHanSerifCN-Heavy',800) > 150;
```

é‚£å°±ç›´æ¥ç”¨å®ƒæ¥æ”¾è¡Œã€‚æŠŠ `noMatchMojis()` æ”¹æˆè¿™æ ·ï¼š

```js
noMatchMojis(){
  // å¦‚æœæœ‰åå¤‡å­—ä½“ï¼ˆæ€æºå®‹ä½“ Heavyï¼‰ï¼Œå°±ä¸è¦ç”¨ EVA å­—åº“åˆ—è¡¨å»â€œå°æ€â€
  if (haveSourceHanSerifCNHeavy) return [];
  return Array.from(new Set(this.allText)).sort().filter(m=>!EVAMatisseClassicMojis.includes(m));
}
```

### ä¸€æ¡å‘½ä»¤æ”¹ï¼ˆç”¨ sed ç²¾å‡†æ›¿æ¢ï¼‰

åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼š

```bash
sed -i 's/noMatchMojis(){[[:space:]]*return Array.from(new Set(this.allText)).sort().filter(m=>!EVAMatisseClassicMojis.includes(m))[[:space:]]*}/noMatchMojis(){\n            if(haveSourceHanSerifCNHeavy) return [];\n            return Array.from(new Set(this.allText)).sort().filter(m=>!EVAMatisseClassicMojis.includes(m))\n        }/g' /www/wwwroot/yys.im/eva/document.js
```

ç„¶åæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æ›¿æ¢æˆåŠŸï¼š

```bash
grep -n "noMatchMojis" -n /www/wwwroot/yys.im/eva/document.js -A5
```

* * *

## âœ… é‡è¦ï¼šæ”¹å®Œè¦æ¸… Cloudflare/æµè§ˆå™¨ç¼“å­˜

ä½ ç«™ç‚¹èµ° Cloudflareï¼ŒJS éå¸¸å®¹æ˜“è¢«ç¼“å­˜ã€‚åšä¸¤æ­¥ï¼š

1.  Cloudflare â†’ Purge Cacheï¼ˆè‡³å°‘ `/eva/*`ï¼‰

2.  æµè§ˆå™¨ Ctrl+F5 å¼ºåˆ·ï¼ˆæˆ– DevTools å‹¾ Disable cacheï¼‰

* * *

## ä¸ºä»€ä¹ˆè¿™æ‹›æœ‰æ•ˆï¼Ÿ

*   ä»¥å‰ï¼šå­—åªè¦ä¸åœ¨ `EVAMatisseClassicMojis` å°±è¢«åˆ¤â€œnoMatchâ€ï¼Œå¾ˆå¯èƒ½è¢«å‰”é™¤ï¼Œ**åå¤‡å­—ä½“æ²¡æœ‰ä¸Šåœºæœºä¼š**ã€‚

*   ç°åœ¨ï¼šåªè¦æ£€æµ‹åˆ°ä½ è£…/å¼•å…¥äº† `"SourceHanSerifCN-Heavy"`ï¼Œå°±ä¸å†æ‹¦æˆªï¼Œå­—ä¼šè¿›å…¥æ¸²æŸ“æµç¨‹ â†’ Canvas ç”¨ä½ è®¾ç½®çš„å­—ä½“æ ˆè‡ªåŠ¨è¡¥å­—ã€‚

*   * *

## å¦‚æœä½ è¿˜æƒ³æ›´â€œä¸¥è°¨â€ï¼ˆå¯é€‰ï¼‰

ç°åœ¨è¿™ç‰ˆæ˜¯â€œåªè¦æœ‰ Heavy å°±å…¨éƒ¨æ”¾è¡Œâ€ã€‚æ›´ä¸¥æ ¼çš„åšæ³•æ˜¯ï¼šå¯¹æ¯ä¸ªå­—åˆ¤æ–­ Heavy æ˜¯å¦çœŸçš„èƒ½æ¸²æŸ“ï¼ˆé€å­—æµ‹ glyphï¼‰ï¼Œä½†é‚£éœ€è¦é¢å¤–å†™ä¸€ä¸ªâ€œé€å­—æµ‹å­—å½¢â€çš„å‡½æ•°ï¼Œæ”¹åŠ¨ä¼šå¤§ä¸€äº›ã€‚ä½ å…ˆæŠŠä¸Šé¢è¿™ä¸ªä¿®å¥½ï¼ŒåŸºæœ¬å°±èƒ½çœ‹åˆ°ä½ æƒ³è¦çš„åå¤‡æ•ˆæœäº†ã€‚

ä½ æ”¹å®Œåˆ·æ–°åï¼Œå¦‚æœâ€œä¸åŒ¹é…æ–‡å­—â€çš„æç¤ºæ¶ˆå¤±äº†ä½†æŸäº›å­—ä»ç©ºç™½ï¼ŒæŠŠé‚£ä¸ªå…·ä½“å­—å‘æˆ‘ï¼Œæˆ‘å†æ•™ä½ æ€ä¹ˆåšé€å­—æ£€æµ‹/æˆ–æ£€æŸ¥å­—ä½“æ–‡ä»¶è·¯å¾„ 200ã€‚

Network connection lost. Attempting to reconnectâ€¦

---
#ä»¥ä¸Šéƒ¨åˆ†å·²ç»åç¦»æ–¹å‘
åœ¨ç¬¬äºŒå¤©ï¼Œæˆ‘æœ‰å°è¯•é‡æ–°ä¿®æ”¹  
ç»“æœå–œäºº  

## Q: 

eva-title-main.zip

ç°åœ¨çš„é—®é¢˜æ˜¯ æœ‰ä¸€äº›å­—æ‰“ä¸å‡ºæ¥ å¯èƒ½æ˜¯ç”±äºå­—ä½“çš„é™åˆ¶ å­—åº“é‡Œæ²¡æœ‰å­— æ‰€ä»¥ç”¨äº†åå¤‡å­—ä½“ ä½†æ˜¯ä¹Ÿæ²¡æ•ˆæœ å“ªé‡Œå‡ºç°äº†é—®é¢˜

## A: 

ä½ æè¿°çš„ç°è±¡ï¼ˆæœ‰äº›å­—â€œæ‰“/æ˜¾ç¤ºä¸å‡ºæ¥â€ï¼ŒåŠ äº†åå¤‡å­—ä½“ä¹Ÿæ²¡ç”¨ï¼‰åœ¨ä½ è¿™ä¸ªé¡¹ç›®é‡Œ**æœ€å¸¸è§çš„æ ¹å› å…¶å®ä¸æ˜¯ CSS çš„ fallback é¡ºåº**ï¼Œè€Œæ˜¯ï¼š**é‚£äº›å­—æ ¹æœ¬æ²¡è¢«ä»»ä½•â€œå®é™…åŠ è½½æˆåŠŸâ€çš„å­—ä½“è¦†ç›–åˆ°**â€”â€”å°¤å…¶æ˜¯ä½ åœ¨æœ¬åœ°æ‰“å¼€æˆ–æ²¡è·‘åç«¯æ—¶ã€‚

æˆ‘çœ‹äº†ä½ å‹ç¼©åŒ…é‡Œçš„ä»£ç ï¼ˆ`document.js / make.js / document.css`ï¼‰ï¼Œè¿™é‡Œæœ‰å‡ å¤„éå¸¸å…³é”®çš„ç‚¹ï¼š

* * *

## 1) ä½ çš„â€œè¡¥å­—æœºåˆ¶â€ä¾èµ– `/api/fontmin`ï¼Œä½†å¾ˆå¤šæƒ…å†µä¸‹å®ƒå®é™…ä¸Šä¸å¯ç”¨

`document.js` é‡Œï¼š

```js
let fontAPI = `https://${location.hostname}/api/fontmin`;
```

è¿™æ„å‘³ç€å®ƒä¼šå‘â€œå½“å‰åŸŸåâ€è¯·æ±‚ä¸€ä¸ªæ¥å£æ¥æŒ‰éœ€ç”Ÿæˆå­é›†å­—ä½“ã€‚

**é—®é¢˜ï¼š**

*   å¦‚æœä½ æ˜¯ç›´æ¥åŒå‡» `index.html` ç”¨ `file://` æ‰“å¼€çš„ï¼Œ`location.hostname` ä¸ºç©ºï¼Œæœ€åä¼šå˜æˆ `https:///api/fontmin`ï¼ˆæ— æ•ˆï¼‰ï¼ŒåŠ¨æ€è¡¥å­—æ°¸è¿œåŠ è½½ä¸åˆ°ã€‚

*   å¦‚æœä½ åœ¨æœ¬åœ°èµ·äº†é™æ€æœåŠ¡å™¨ä½†æ²¡æœ‰å¯¹åº”çš„ `/api/fontmin` æœåŠ¡ç«¯æ¥å£ï¼Œä¹ŸåŒæ ·ä¼šåŠ è½½å¤±è´¥ï¼ˆä»£ç é‡Œ catch äº†é”™è¯¯ï¼Œä¸ä¸€å®šä¼šæ˜æ˜¾æŠ¥å‡ºæ¥ï¼‰ã€‚

**æ€ä¹ˆç¡®è®¤ï¼š**  
æ‰“å¼€æµè§ˆå™¨ DevTools â†’ Networkï¼Œè¿‡æ»¤ `fontmin` æˆ– `api/fontmin`ï¼Œçœ‹æ˜¯ä¸æ˜¯ 404/ERR_NAME_NOT_RESOLVED/CORS ç­‰ã€‚

**æ€ä¹ˆä¿®ï¼š**  
å¼€å‘ç¯å¢ƒç›´æ¥æŠŠ `fontAPI` æŒ‡å‘ä¸€ä¸ªç¡®å®å­˜åœ¨çš„æœåŠ¡ï¼ˆä½ ä»£ç é‡Œå·²ç»ç»™äº†ç¤ºä¾‹ï¼‰ï¼š

```js
// document.js
let fontAPI = 'http://localhost:60912/api/fontmin';
// æˆ–è€…ç”¨ä½ æ³¨é‡Šé‡Œçš„çº¿ä¸Šï¼š
let fontAPI = 'https://s6.magiconch.com/api/fontmin';
```

ä»¥åŠ**ä¸è¦ç”¨ file:// æ–¹å¼æ‰“å¼€**ï¼Œè‡³å°‘ç”¨ä¸€ä¸ªé™æ€æœåŠ¡å™¨è·‘èµ·æ¥ï¼ˆä¾‹å¦‚ `vite` / `http-server` / nginxï¼‰ã€‚

* * *

## 2) ä½ ä»¥ä¸ºåŠ äº†â€œåå¤‡å­—ä½“â€ï¼Œä½†å®é™…åå¤‡å­—ä½“å¯èƒ½æ ¹æœ¬æ²¡è¦†ç›–é‚£äº›å­—

ä½  `document.css` é‡Œå†™äº†ï¼š

```css
font-family:
  EVAMatisseClassic,
  MatisseProEB, 
  NotoSerifSCBlack,
  SourceHanSerifCN-Heavy,
  serif;
```

ä½†æ³¨æ„ä¸¤ä»¶äº‹ï¼š

### A. `SourceHanSerifCN-Heavy` æ²¡æœ‰è¢« @font-face å¼•å…¥

CSS é‡Œæ²¡æœ‰å¯¹åº”çš„ `@font-face`ï¼Œæ‰€ä»¥å®ƒåªæœ‰åœ¨**ç”¨æˆ·ç³»ç»Ÿé‡Œåˆšå¥½è£…äº†**æ‰ä¼šç”Ÿæ•ˆã€‚

### B. ä½ å¸¦çš„ `NotoSerifSC-Black.woff2` æå¯èƒ½æ˜¯â€œå­é›†/å¾ˆå°çš„ä¸€éƒ¨åˆ†â€

ä½ è¿™ä¸ª woff2 åªæœ‰å‡ å KBï¼ŒåŸºæœ¬ä¸å¯èƒ½æ˜¯å®Œæ•´ä¸­æ–‡å­—åº“ï¼Œæ‰€ä»¥å¾ˆå¤šå­—ä»ç„¶ä¼šç¼ºã€‚

\*\*ç»“è®ºï¼š\*\*fallback â€œå†™äº†â€ä¸ç­‰äº fallback â€œèƒ½æ˜¾ç¤ºâ€ã€‚åªè¦åå¤‡å­—ä½“ä¸å«è¿™ä¸ªå­—ï¼Œç…§æ ·æ˜¯ç©ºç™½/è±†è…å—ã€‚

* * *

## 3) è¿™é¡¹ç›®å®é™…ç»˜åˆ¶æ–‡å­—ä¸»è¦èµ° Canvasï¼Œç¼ºå­—æ—¶åªèƒ½é â€œå·²åŠ è½½å­—ä½“â€å…œåº•

`make.js` é‡Œ canvas ç”¨çš„å­—ä½“ä¸²æ˜¯ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`;
```

å…¶ä¸­ `baseFontFamilyName` åŒ…å«ï¼š

```js
'EVA_Matisse_Classic-EB,MatissePro-EB,baseSplit,notdef,SourceHanSerifCN-Heavy,serif'
```

å¹¶ä¸”å®ƒç¡®å®ä¼šåœ¨å¯åŠ¨æ—¶åŠ è½½ä¸¤ä¸ªå­—ä½“æ–‡ä»¶ï¼š

```js
loadFont('notdef','NotDefault.woff2', ...)
loadFont('baseSplit','base-split.woff?...', ...)
```

æ‰€ä»¥æœ€ç»ˆèƒ½å…œåº•çš„ä¸»è¦æ˜¯ï¼š

*   `EVAMatisseClassic`ï¼ˆå¦‚æœæˆåŠŸåŠ è½½/ç³»ç»Ÿå®‰è£…/æˆ–é€šè¿‡ fontmin å¾—åˆ°ï¼‰

*   `baseSplit`

*   `notdef`

*   ç³»ç»Ÿ serif /ï¼ˆä»¥åŠä½ ç³»ç»Ÿæœ‰æ²¡æœ‰è£… SourceHanSerifCN-Heavyï¼‰

**å¦‚æœä½ çš„å­—ä¸åœ¨ baseSplit å­é›†é‡Œï¼Œè€Œ `/api/fontmin` åˆæ²¡å·¥ä½œ**ï¼Œé‚£å°±ä¼šå‡ºç°ä½ è¯´çš„ï¼šæ€ä¹ˆåŠ  fallback éƒ½æ²¡æ•ˆæœã€‚

* * *

# æœ€çŸ­è§£å†³è·¯å¾„ï¼ˆæˆ‘å»ºè®®ä½ æŒ‰è¿™ä¸ªé¡ºåºåšï¼‰

## Step 1ï¼šå…ˆæŠŠé¡µé¢è·‘åœ¨æœåŠ¡å™¨ä¸Š + ä¿®æ­£ fontAPI

*   ä¸è¦ file:// æ‰“å¼€

*   `fontAPI` æŒ‡åˆ°ä¸€ä¸ªçœŸçš„èƒ½ç”¨çš„ fontmin æœåŠ¡ï¼ˆæœ¬åœ°æˆ–çº¿ä¸Šï¼‰

è¿™æ˜¯æœ€æ¥è¿‘â€œç«‹åˆ»èƒ½è¡¥å­—â€çš„ä¿®æ³•ã€‚

## Step 2ï¼šæƒ³å½»åº•ç¦»çº¿/ä¸ä¾èµ–åç«¯ï¼Œå°±æ¢ä¸€ä»½â€œçœŸçš„åŒ…å«å…¨éƒ¨æ±‰å­—â€çš„åå¤‡å­—ä½“

ä¾‹å¦‚å¼•å…¥å®Œæ•´çš„æ€æºå®‹ä½“/æ€æºå®‹ä½“ Heavyï¼ˆä½“ç§¯ä¼šå¾ˆå¤§ï¼‰ï¼Œæˆ–è€…ä½ è‡ªå·±ç”¨ fontmin/pyftsubset é¢„å…ˆè£å‰ªä¸€ä¸ªâ€œä½ ä¸šåŠ¡æ‰€éœ€å­—ç¬¦é›†â€çš„ woff2ã€‚

ï¼ˆä½ ç°åœ¨çš„ `NotoSerifSC-Black.woff2` å¤ªå°äº†ï¼ŒåŸºæœ¬è‚¯å®šä¸å¤Ÿã€‚ï¼‰

## Step 3ï¼ˆå¯é€‰ä½†å¾ˆå…³é”®ï¼‰ï¼šåˆ«ç”¨ä¸€ä¸ªâ€œå›ºå®šåå•â€å»åˆ¤æ–­è¦ä¸è¦è¡¥å­—

`getFontFromText()` é‡Œä¼šåš `diffDefaultMoji(text)`ï¼Œå¦‚æœä½ çš„ `defaultMoji` åˆ—è¡¨å‡è®¾â€œè¿™äº›å­—è‚¯å®šæœ‰â€ï¼Œä½†ç°å®é‡Œä½ çš„æœ¬åœ°å­—ä½“å¹¶æ²¡æœ‰ï¼Œé‚£å®ƒå°±ä¸ä¼šå»è¯·æ±‚è¡¥å­—ï¼Œå¯¼è‡´ç¼ºå­—æ°¸è¿œç¼ºã€‚

æœ€ç²—æš´çš„éªŒè¯åŠæ³•ï¼šä¸´æ—¶æ³¨é‡Šæ‰ `diffDefaultMoji` é‚£è¡Œï¼Œçœ‹çœ‹ç¼ºå­—æ˜¯å¦ç«‹åˆ»èƒ½é€šè¿‡ fontmin è¡¥é½ã€‚

* * *

å¦‚æœä½ æ„¿æ„æŠŠâ€œæ‰“ä¸å‡ºæ¥â€çš„å…·ä½“å­—ç¬¦å‘æˆ‘ 3~5 ä¸ªï¼Œä»¥åŠä½ æ˜¯ **file:// æ‰“å¼€**è¿˜æ˜¯ **è·‘äº†ç«™ç‚¹**ã€Network é‡Œ `/api/fontmin` çš„çŠ¶æ€ï¼ˆ200/404/å¤±è´¥åŸå› ï¼‰ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ æ˜¯å“ªä¸€æ¡å‘½ä¸­ï¼Œä»¥åŠç»™ä½ ä¸€ä»½æœ€å°æ”¹åŠ¨çš„è¡¥ä¸ä»£ç ã€‚

## Q: 

fontAPIå·²ç»ä¿®æ”¹

## A: 

å¥½ï¼Œé‚£è¯´æ˜ **fontAPI è¿™å—ä½ å·²ç»å¤„ç†äº†**ï¼Œæ¥ä¸‹æ¥å°±è¦æŸ¥å¦å¤–ä¸¤æ¡çº¿äº†ï¼š

> è¿™äº›å­—æ˜¯ï¼š  
> 1ï¼‰**å­—ä½“æ ¹æœ¬æ²¡æœ‰**ï¼Œæ‰€ä»¥è°éƒ½æ˜¾ç¤ºä¸å‡ºæ¥  
> 2ï¼‰**æ¥å£/åŠ è½½é€»è¾‘æœ‰é—®é¢˜**ï¼Œè™½ç„¶æœ‰å­—åº“ä½†æ²¡ç”¨ä¸Š

æˆ‘ç»™ä½ ä¸€ä¸ªâ€œæ’æŸ¥é¡ºåºâ€ï¼Œä½ æŒ‰æ­¥éª¤èµ°ï¼Œå¾ˆå¿«å°±èƒ½å®šä½åˆ°æ˜¯å“ªä¸€æ¡ã€‚

* * *

## Step 1ï¼šå…ˆçœ‹â€œç³»ç»Ÿèƒ½ä¸èƒ½æ˜¾ç¤ºè¿™äº›å­—â€

éšä¾¿å¼€ä¸€ä¸ªæ–°çš„ `test.html`ï¼Œå†…å®¹å†™å¾—å°½é‡ç®€å•ä¸€ç‚¹ï¼Œæ¯”å¦‚ï¼š

```html
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        font-size: 40px;
        font-family: system-ui, "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
      }
    </style>
  </head>
  <body>
    è¿™é‡Œæ‰“ä¸Šé‚£äº›ã€æ˜¾ç¤ºä¸å‡ºæ¥çš„å­—ã€‘æ¯”å¦‚ï¼šğªš¥ğ« £ğ ®·ï¼ˆåªæ˜¯ä¸¾ä¾‹ï¼‰
  </body>
</html>
```

ç”¨æµè§ˆå™¨æ‰“å¼€ï¼š

* âœ… **å¦‚æœè¿™é‡Œä¹Ÿæ˜¾ç¤ºä¸å‡ºæ¥**ï¼ˆæ˜¯æ–¹æ¡†/ç©ºç™½ï¼‰ï¼š  
  é‚£å°±æ˜¯ **ä½ ç³»ç»Ÿé‡Œæ ¹æœ¬æ²¡æœ‰åŒ…å«è¿™äº›å­—çš„å­—ä½“**ã€‚  
  ğŸ‘‰ ä¸ç®¡ä½ åœ¨é¡¹ç›®é‡Œæ€ä¹ˆå†™ `font-family` / fallback / fontAPIï¼Œéƒ½æ²¡æ•‘ã€‚

  è§£å†³åŠæ³•åªæœ‰ä¸¤æ¡ï¼š

  1.  åœ¨ç³»ç»Ÿé‡Œå®‰è£…èƒ½è¦†ç›–è¿™äº›å­—çš„å­—ä½“ï¼ˆæ¯”å¦‚å®Œæ•´ç‰ˆæ€æºå®‹ä½“/é»‘ä½“ã€éƒ¨åˆ†æ—¥æ–‡å­—ä½“ç­‰ï¼‰ï¼Œç„¶åé¡¹ç›®é‡ŒæŠŠå®ƒåŠ åˆ° `font-family` é‡Œï¼›

  2.  æˆ–è€…ç›´æ¥åœ¨é¡¹ç›®é‡Œæ”¾å…¥ä¸€ä»½â€œçœŸçš„åŒ…å«è¿™äº›å­—â€çš„ woff2ï¼Œå½“æˆåå¤‡å­—ä½“ã€‚

* âœ… **å¦‚æœè¿™é‡Œèƒ½æ­£å¸¸æ˜¾ç¤º**ï¼š  
  é‚£è¯´æ˜ç³»ç»Ÿå­—ä½“æ˜¯æœ‰è¿™äº›å­—çš„ï¼Œ**é—®é¢˜å‡ºåœ¨ä½ è¿™ä¸ª EVA é¡¹ç›®çš„å­—ä½“é€»è¾‘ä¸Š**ï¼Œç»§ç»­çœ‹ä¸‹é¢ã€‚

* * *

## Step 2ï¼šç¡®è®¤ `/api/fontmin` çœŸçš„ç»™ä½ ç”Ÿæˆäº†å«è¿™äº›å­—çš„å­—ä½“

1.  æ‰“å¼€ä½ çš„ EVA é¡µé¢ â†’ æ‰“å¼€ DevTools â†’ Network é¢æ¿

2.  åœ¨é¡µé¢é‡Œè¾“å…¥/æ˜¾ç¤ºä½ é‚£å‡ ä¸ªâ€œæœ‰é—®é¢˜çš„å­—â€ï¼Œè®©å®ƒè§¦å‘å­—ä½“ç”Ÿæˆ

3.  åœ¨ Network é‡Œæœ `fontmin` æˆ– `api/fontmin`

çœ‹ä¸¤ä»¶äº‹ï¼š

### 2.1 çœ‹è¯·æ±‚æœ‰æ²¡æœ‰å‘å‡ºå»ã€è¿”å›æ˜¯ä¸æ˜¯ 200

*   æ²¡æœ‰è¯·æ±‚ / æˆ–è€… 404 / CORS é”™è¯¯ â†’ é—®é¢˜è¿˜åœ¨â€œè°ƒç”¨é€»è¾‘å±‚â€ï¼Œæ¥å£æ ¹æœ¬æ²¡å·¥ä½œ

*   200 OK â†’ å†å¾€ä¸‹çœ‹

### 2.2 çœ‹è¿”å›çš„ CSS / å­—ä½“åæ˜¯å¦å’Œä½ ç”¨çš„ä¸€è‡´

ä¸€èˆ¬ fontmin ä¼šè¿”å›ä¸€æ®µç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿ï¼ˆå¯èƒ½æ˜¯ CSS æˆ–é“¾æ¥ï¼‰ï¼š

```css
@font-face {
  font-family: 'EVAMatisseClassic';
  src: url(https://....woff2) format('woff2');
}
```

ä½ è¦ç¡®ä¿ï¼š

* `font-family:` è¿™é‡Œçš„åå­—ï¼Œ**å’Œä½ åœ¨ CSS/Canvas é‡Œç”¨çš„æ˜¯åŒä¸€ä¸ªå­—ç¬¦ä¸²**ï¼Œæ¯”å¦‚ `EVAMatisseClassic`

* Canvas é‚£è¾¹å†™çš„æ˜¯ç±»ä¼¼ï¼š

  ```js
  ctx.font = `${fontWeight} ${fontSize}px EVAMatisseClassic, baseSplit, notdef, serif`;
  ```

å¦‚æœ fontmin è¿”å›çš„æ˜¯åˆ«çš„åå­—ï¼ˆæ¯”å¦‚ `'subsetFont_xxx'`ï¼‰ï¼Œä½ åˆåœ¨ä»£ç é‡Œå†™ `EVAMatisseClassic`ï¼Œé‚£æµè§ˆå™¨ä¼šå½“æˆä¸¤ä¸ªä¸åŒå­—ä½“ï¼š  
ğŸ”¸ å­é›†å­—ä½“åŠ è½½äº†ï¼Œä½† **æ ¹æœ¬æ²¡è¢«ç”¨åˆ°**ã€‚

* * *

## Step 3ï¼šæ£€æŸ¥â€œæ–‡å­— -> è°ƒç”¨ fontminâ€è¿™ä¸€æ­¥æ˜¯ä¸æ˜¯æ¼äº†

ä½ è¿™ä¸ªé¡¹ç›®é‡Œæœ‰ä¸€æ®µé€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼ˆåå­—å¯èƒ½ç•¥æœ‰å‡ºå…¥ï¼‰ï¼š

```js
// ä¼ªä»£ç ï¼Œåªæ˜¯è¯´æ˜é€»è¾‘
const textToRender = collectTextFromPage();   // æ”¶é›†è¦æ¸²æŸ“çš„å­—
const needFontChars = diffDefaultMoji(textToRender); // å»æ‰â€œé»˜è®¤å­—â€
if (needFontChars.length) {
  getFontFromText(needFontChars);            // è°ƒæ¥å£ fontAPI
}
```

è¿™é‡Œæœ‰ä¸ªå¸¸è§å‘ï¼š  
**`diffDefaultMoji` è®¤ä¸ºè¿™äº›å­—â€œé»˜è®¤å°±æœ‰â€ï¼Œäºæ˜¯å‹æ ¹ä¸è°ƒç”¨ fontAPIã€‚**

å¦‚æœä½ çš„æœ¬åœ°ç¯å¢ƒé‡Œå¹¶æ²¡æœ‰é¢„è£…é‚£äº›é»˜è®¤å­—ä½“ï¼Œé‚£å°±ä¼šå‡ºç°ï¼š

*   é€»è¾‘ä»¥ä¸ºï¼šè¿™äº›å­—ä¸ç”¨è¡¥ â†’ ä¸è°ƒç”¨ `/api/fontmin`

*   å®é™…ä¸Šï¼šæœ¬åœ°å­—ä½“ä¹Ÿæ²¡æœ‰ â†’ ç»“æœå°±æ˜¯ä½ çœ‹åˆ°çš„â€œæ€ä¹ˆéƒ½æ‰“ä¸å‡ºæ¥â€

ä½ å¯ä»¥ç®€å•ç²—æš´åœ°æµ‹è¯•ä¸€ä¸‹ï¼ˆä¸´æ—¶æ”¹ä¸€ä¸‹å°±è¡Œï¼‰ï¼š

```js
// æŠŠ diffDefaultMoji ç›´æ¥æ”¹æˆä¸åšåˆ¤æ–­ï¼Œå…¨éƒ¨äº¤ç»™ fontmin
function diffDefaultMoji(text) {
  return text;  // åˆ«è¿‡æ»¤ï¼Œç›´æ¥å…¨é€å»æ¥å£
}
```

æˆ–åœ¨è°ƒç”¨åœ°æ–¹å†™æ­»ä¸€ä¸²ä½ æœ‰é—®é¢˜çš„å­—ç¬¦ï¼š

```js
getFontFromText("ä½ é‚£å‡ ä¸ªæ‰“ä¸å‡ºæ¥çš„å­—");
```

åªè¦è¿™æ ·ä¸€æ”¹ï¼š

*   âœ… å¦‚æœé‚£äº›å­—çªç„¶èƒ½æ˜¾ç¤ºäº† â†’ è¯´æ˜ä¹‹å‰å°±æ˜¯è¢« `diffDefaultMoji` è¿‡æ»¤æ‰äº†

*   âŒ å¦‚æœä»ç„¶ä¸è¡Œ â†’ é—®é¢˜è¦ä¹ˆåœ¨ fontmin è¿”å›çš„å­—ä½“ä¸å«è¿™äº›å­—ï¼Œè¦ä¹ˆæ˜¯ fallback ä½¿ç”¨é¡ºåºæœ‰é—®é¢˜ï¼ˆçœ‹ Step 4ï¼‰

*   * *

## Step 4ï¼šç¡®è®¤ fallback å­—ä½“çœŸçš„â€œåŒ…å«è¿™äº›å­—â€+ é¡ºåºæ­£ç¡®

ä½ ä¹‹å‰è¯´**ç»™äº†åå¤‡å­—ä½“ä¹Ÿæ²¡æ•ˆæœ**ï¼Œæœ€å¤§å¯èƒ½æ˜¯è¿™ä¸¤ç§ï¼š

1.  åå¤‡å­—ä½“æœ¬èº«å°±æ˜¯å­é›†ï¼Œæ²¡åŒ…å«è¿™äº›å­—ï¼ˆä¾‹å¦‚ä½ å¸¦çš„ `NotoSerifSC-Black.woff2` å¾ˆå°ï¼Œå‡ ä¹è‚¯å®šä¸æ˜¯å®Œæ•´å­—åº“ï¼‰

2.  @font-face å®šä¹‰åå­—ä¸ä¸€è‡´ / ä¼˜å…ˆçº§è¢«å‰é¢ä¸€ä¸ªâ€œä¸åŒ…å«è¿™äº›å­—â€çš„å­—ä½“ç›–æ‰äº†

ä¸¾ä¸ªä½ å¯ä»¥å‚è€ƒçš„å†™æ³•ï¼š

```css
@font-face {
  font-family: 'EVA_Matisse_Classic-EB';
  src: url('./EVA_Matisse_Classic-EB.woff2') format('woff2');
  font-weight: 900;
}

@font-face {
  font-family: 'EVA_Fallback_Full';
  src: url('./YourFullCJKFont.woff2') format('woff2'); /* è¿™ä»½è¦ç¡®ä¿çœŸçš„å«è¿™äº›å­— */
}

/* ç”»å¸ƒ / æ–‡æœ¬ç”¨çš„ font-family é¡ºåº */
.title-text {
  font-family:
    EVA_Matisse_Classic-EB,   /* å…ˆç”¨ä¸»å­—ä½“ */
    EVA_Fallback_Full,        /* ä¸»å­—ä½“æ²¡æœ‰å°±ç”¨è¿™ä¸ª */
    system-ui,
    "Microsoft YaHei",
    "PingFang SC",
    sans-serif;
}
```

å…³é”®ç‚¹ï¼š

* `EVA_Fallback_Full` å¯¹åº”çš„ woff2 å¿…é¡»æ˜¯â€œå®Œæ•´æˆ–åŒ…å«é‚£å‡ ä¸ªé—®é¢˜å­—ç¬¦â€çš„ç‰ˆæœ¬

* å¹¶ä¸”åœ¨ Canvas çš„ `ctx.font` é‡Œä¹Ÿè¦å‡ºç°è¿™ä¸ªåå­—ï¼Œä¾‹å¦‚ï¼š

  ```js
  ctx.font = `900 ${fontSize}px EVA_Matisse_Classic-EB, EVA_Fallback_Full, system-ui, sans-serif`;
  ```

* * *

## æ€»ç»“ä¸€ä¸‹ä½ ç°åœ¨å¯ä»¥ç«‹åˆ»åšçš„ä¸‰ä»¶äº‹

1.  **å…ˆéªŒè¯ç³»ç»Ÿèƒ½ä¸èƒ½æ˜¾ç¤ºé‚£å‡ ä¸ªå­—**

    *   å¦‚æœç³»ç»Ÿéƒ½ä¸è¡Œ â†’ å»æ‰¾/å®‰è£…ä¸€ä¸ªæ”¯æŒè¿™äº›å­—çš„å­—ä½“ï¼ˆæˆ–æ”¾è¿›é¡¹ç›®ï¼‰

2.  **åœ¨ Network é‡Œç¡®è®¤ `/api/fontmin` è¯·æ±‚ + è¿”å›åå­—**

    *   æœ‰æ²¡æœ‰è¯·æ±‚

    *   è¿”å›é‡Œçš„ `font-family` æ˜¯å¦è·Ÿä½ ä½¿ç”¨çš„ä¸€è‡´

3.  **æš‚æ—¶å…³é—­ `diffDefaultMoji` çš„è¿‡æ»¤ï¼Œå¼ºåˆ¶è®© fontmin ä¸ºè¿™äº›å­—ç”Ÿæˆå­é›†**

    *   èƒ½æ˜¾ç¤º â†’ è°ƒç”¨é€»è¾‘çš„é—®é¢˜

    *   è¿˜æ˜¯ä¸èƒ½ â†’ å­—ä½“æ–‡ä»¶é‡Œç¡®å®æ²¡æœ‰é‚£äº›å­— or fallback é¡ºåº/å‘½åé—®é¢˜

å¦‚æœä½ æ–¹ä¾¿çš„è¯ï¼Œå¯ä»¥éšæ‰‹è´´ 2ï½3 ä¸ªâ€œæ‰“ä¸å‡ºæ¥çš„å­—â€ï¼ˆç›´æ¥å‘å­—ç¬¦å°±è¡Œï¼Œä¸éœ€è¦æˆªå›¾ï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ åˆ¤æ–­æ›´å¤§å¯èƒ½æ˜¯å“ªä¸€ç§ï¼ˆç½•è§æ±‰å­— / CJK æ‰©å±•åŒºå¯¼è‡´çš„ï¼Œè¿˜æ˜¯å…¸å‹çš„é€»è¾‘é—®é¢˜ï¼‰ï¼Œç„¶åå†™ä¸€ç‰ˆæ›´ç²¾å‡†çš„è¡¥ä¸ç»™ä½ ã€‚

## Q: 


## A: 

ä½ ç°åœ¨è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆä¸æ˜¯å­—ä½“ï¼Œè€Œæ˜¯ï¼š**Vue æ ¹æœ¬æ²¡åŠ è½½æˆåŠŸï¼Œæ‰€ä»¥æ•´å¥—åº”ç”¨é€»è¾‘éƒ½æŒ‚äº†**ã€‚

ä»ä½ æˆªå›¾é‡Œå¯ä»¥çœ‹åˆ°å‡ ä»¶äº‹ï¼š

1.  `GET https://yys.im/vue.2.6.11.min.js net::ERR_ABORTED 404 (Not Found)`

2.  `Uncaught ReferenceError: Vue is not defined`

    *   å‡ºç°åœ¨ `ui-tabs.vue.js`

    *   å‡ºç°åœ¨ `ui-switch.vue.js`

    *   å‡ºç°åœ¨ `document.js:248`ï¼ˆ`new Vue({...})` é‚£é‡Œï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼š

* `index.html` é‡Œè¿™è¡Œè„šæœ¬ï¼š

  ```html
  <script src="/vue.2.6.11.min.js"></script>
  ```

  è¯·æ±‚çš„æ˜¯ **ç«™ç‚¹æ ¹ç›®å½•** çš„ `/vue.2.6.11.min.js`ï¼Œ  
  ä½†ä½ çš„ç«™ç‚¹æ ¹ç›®å½•é‡Œå¹¶æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ â†’ 404

* å› ä¸º Vue æ²¡åŠ è½½ï¼Œå…¨å±€å˜é‡ `Vue` ä¸å­˜åœ¨ï¼Œ  
  åé¢çš„ `ui-tabs.vue.js`ã€`ui-switch.vue.js`ã€`document.js` é‡Œä¸€è°ƒç”¨ `new Vue(...)` å°±ç›´æ¥æŠ¥é”™ï¼Œ  
  åç»­æ‰€æœ‰ä¾èµ– Vue çš„é€»è¾‘ï¼ˆåŒ…æ‹¬ç”Ÿæˆç”»å¸ƒã€è°ƒç”¨ fontAPI åšè¡¥å­—ï¼‰éƒ½ä¸ä¼šæ‰§è¡Œã€‚

> æ‰€ä»¥ä½ çœ‹åˆ°çš„â€œæœ‰çš„å­—å‡ºä¸æ¥â€ï¼Œå¾ˆå¯èƒ½æœ¬è´¨æ˜¯ï¼š  
> **æ•´ä¸ªæ¸²æŸ“é€»è¾‘æŒ‚äº†ï¼ŒCanvas æ ¹æœ¬æ²¡æœ‰æ­£å¸¸é‡ç»˜ã€‚**

* * *

## æ€ä¹ˆä¿®

### æ–¹æ¡ˆ 1ï¼šç”¨å®˜æ–¹ CDN åŠ è½½ Vueï¼ˆç®€å•ç²—æš´ï¼‰

ç›´æ¥æ”¹ `index.html` é‡Œè¿™è¡Œï¼š

```html
<script src="/vue.2.6.11.min.js"></script>
```

æ”¹æˆï¼š

```html
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"></script>
```

ä¿å­˜ååˆ·æ–°é¡µé¢ï¼Œé‡æ–°æ‰“å¼€æ§åˆ¶å°çœ‹ï¼š

*   ä¸å†å‡ºç° `Vue is not defined`

*   ä¸å†æœ‰ `vue.2.6.11.min.js 404`

è¿™æ—¶å†æµ‹è¯•ä½ ä¹‹å‰é‚£äº›ã€Œæ‰“ä¸å‡ºæ¥çš„å­—ã€ï¼Œçœ‹çœ‹æ˜¯å¦æ­£å¸¸ã€‚

* * *

### æ–¹æ¡ˆ 2ï¼šæœ¬åœ°æ”¾ä¸€ä»½ vue.2.6.11.min.js

å¦‚æœä½ æƒ³**å®Œå…¨æœ¬åœ°åŒ–**è€Œä¸æ˜¯ä¾èµ– CDNï¼Œé‚£å°±ï¼š

1. å»å®˜æ–¹ CDN ä¸‹è½½ Vue 2.6.11ï¼š

   *   æ¯”å¦‚ä» jsdelivr / unpkg ä¸‹è½½ `vue.min.js`

2. é‡å‘½åä¸º `vue.2.6.11.min.js`ï¼Œå’Œ `index.html` æ”¾åœ¨**åŒä¸€ç›®å½•**

3. æŠŠ `<script>` æ”¹æˆç›¸å¯¹è·¯å¾„ï¼ˆé¿å…å†è¯·æ±‚åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼‰ï¼š

   ```html
   <script src="./vue.2.6.11.min.js"></script>
   ```

åªè¦è¿™ä¸ªæ–‡ä»¶åœ¨åŒä¸€ç›®å½•é‡Œï¼Œå°±ä¸ä¼šå† 404ï¼Œ`Vue` å°±ä¼šæ­£å¸¸å­˜åœ¨ã€‚

* * *

### å¦å¤–ä¸¤ä¸ªæŠ¥é”™è¯´æ˜

*   `https://static.cloudflareinsights.com/beacon.min.js net::ERR_BLOCKED_BY_CLIENT`  
    è¿™ä¸ªå¤§æ¦‚ç‡æ˜¯ä½ æµè§ˆå™¨/æ’ä»¶æ‹¦æˆªäº†ç»Ÿè®¡è„šæœ¬ï¼Œ**å¯ä»¥å¿½ç•¥**ã€‚

*   å…¶ä½™ `Vue is not defined`ï¼Œåªè¦ä¸Šé¢æŠŠ Vue åŠ è½½é—®é¢˜è§£å†³ï¼Œå°±ä¼šä¸€èµ·æ¶ˆå¤±ã€‚

*   * *

## æ¥ä¸‹æ¥ä½ å¯ä»¥è¿™æ ·åš

1.  **å…ˆä¿®å¥½ Vue çš„åŠ è½½**ï¼ˆç”¨ä¸Šé¢ä»»æ„ä¸€ä¸ªæ–¹æ¡ˆï¼‰ã€‚

2.  åˆ·æ–°é¡µé¢ï¼Œçœ‹æ§åˆ¶å°æ˜¯å¦åªå‰©ä¸€äº›å­—ä½“/ç½‘ç»œç›¸å…³è¯·æ±‚ï¼Œè€Œæ²¡æœ‰ `Vue is not defined`ã€‚

3.  å†çœ‹ä½ ä¹‹å‰é‚£äº›ã€Œæ‰“ä¸å‡ºæ¥çš„å­—ã€æ˜¯å¦å·²ç»æ­£å¸¸ï¼›å¦‚æœè¿˜æœ‰å•ç‹¬çš„â€œå°‘æ•°å­—ç¼ºå­—â€çš„æƒ…å†µï¼Œå†å›åˆ°æˆ‘ä»¬å‰é¢è¯´çš„ Step 1â€“4 æŸ¥å­—ä½“å’Œ fontAPIã€‚

ä½ å…ˆæŠŠ Vue è¿™å—æ”¹å¥½ï¼Œå¦‚æœæ”¹å®Œåè¿˜æœ‰æŸå‡ ä¸ªå…·ä½“å­—è¿˜æ˜¯å‡ºä¸æ¥ï¼Œå¯ä»¥ç›´æ¥æŠŠé‚£å‡ ä¸ªå­—å‘ç»™æˆ‘ï¼Œæˆ‘å†ç»“åˆç°åœ¨çš„æ—¥å¿—å¸®ä½ è¿›ä¸€æ­¥å®šä½ã€‚

## Q: 

ç°åœ¨apié—®é¢˜è§£å†³äº† vueä¹Ÿè§£å†³äº†

## A: 

çœ‹æˆªå›¾ç°åœ¨æ•´ä½“å·²ç»è·‘èµ·æ¥äº† ğŸ‰ï¼ˆVue æŠ¥é”™æ²¡äº†ã€font API ä¹Ÿåœ¨è·‘ï¼‰ï¼Œä½†ç”»é¢é‡Œåªå‡ºäº†â€œç¡…â€ï¼Œåé¢çš„â€œé”—â€æ²¡ç”»å‡ºæ¥â€”â€”è¯´æ˜ç°åœ¨çš„é—®é¢˜å·²ç»æ”¶çª„åˆ°**å­—ä½“è¦†ç›– + Canvas ç”¨çš„ font-family** è¿™å—äº†ã€‚

å…³é”®ç‚¹æœ‰ä¸¤ä¸ªï¼š

1.  ä½ åœ¨ CSS é‡ŒåŠ çš„åå¤‡å­—ä½“ï¼ˆ`NotoSerifSCBlack` ä¹‹ç±»ï¼‰**ä¸ä¼šè‡ªåŠ¨ä½œç”¨åˆ° Canvas**ã€‚  
    Canvas é‡Œæ˜¯ç”¨ JS æ‰‹åŠ¨å†™ `ctx.font = ...` çš„ï¼Œå®ƒæœ‰è‡ªå·±çš„ä¸€å¥— `font-family` å­—ç¬¦ä¸²ã€‚

2.  Canvas é‡Œç›®å‰çš„å­—ä½“é“¾é‡Œï¼Œå‰å‡ ä¸ªå­—ä½“ï¼ˆEVA/Matisse + baseSplit/notdefï¼‰**å…¶å®å¹¶ä¸åŒ…å«â€œé”—â€è¿™ä¸ªå­—**ï¼Œè€Œä¸”è¿˜ä¼šâ€œæŒ¡ä½â€åé¢çš„ç³»ç»Ÿå­—ä½“ fallbackï¼Œæ‰€ä»¥å°±ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ã€‚

* * *

## 1. çœ‹çœ‹å½“å‰ Canvas ç”¨çš„å­—ä½“é“¾

åœ¨ä½ çš„é¡¹ç›®é‡Œï¼ˆæˆ‘æ‰“å¼€äº†ä½ çš„ `make.js`ï¼‰ï¼Œæœ‰è¿™ä¸€æ®µï¼š

```js
let fontFamilyName = 'EVAMatisseClassic'
const engFontFamilyName = `"Times New Roman"`

let baseFontFamilyName = 'EVA_Matisse_Classic-EB,MatissePro-EB,baseSplit,notdef,SourceHanSerifCN-Heavy,serif';
```

åæ¥ç”»å­—çš„æ—¶å€™ä¼šç”¨åˆ°ç±»ä¼¼ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px ${fontFamilyName},${baseFontFamilyName}`;
```

æ‰€ä»¥å®é™… Canvas çš„ font-family é¡ºåºæ˜¯ï¼š

`EVAMatisseClassic, EVA_Matisse_Classic-EB, MatissePro-EB, baseSplit, notdef, SourceHanSerifCN-Heavy, serif`

é—®é¢˜åœ¨è¿™å„¿ï¼š

*   `EVAMatisseClassic / MatissePro-EB`ï¼šè¿™æ˜¯æ—¥æ–‡å­—ä½“ï¼Œå¾ˆå¤šç®€ä½“å­—ï¼ˆæ¯”å¦‚â€œé”—â€ï¼‰æœ¬æ¥å°±æ²¡æœ‰ã€‚

*   `baseSplit` / `notdef`ï¼šè¿™æ˜¯é¡¹ç›®è‡ªå¸¦çš„è¾…åŠ©å­—ä½“ï¼Œç”¨æ¥ç”»åˆ†æ‹†ç¬”ç”»æˆ–å ä½ï¼Œ**å¾ˆå¯èƒ½å¯¹å¾ˆå¤šå­—æ²¡æœ‰æ­£å¸¸å­—å½¢**ï¼Œç”šè‡³åªç»™ä¸€ä¸ªç©ºæ¡†/ç©ºç™½ã€‚

*   å› ä¸º `baseSplit` / `notdef` åœ¨ `SourceHanSerifCN-Heavy` å’Œ `serif` å‰é¢ï¼Œåªè¦å®ƒä»¬â€œå£°ç§°è‡ªå·±æœ‰è¿™ä¸ªå­—â€ï¼Œç³»ç»Ÿå°±ä¸ä¼šå†å¾€å fallback åˆ°ç³»ç»Ÿè‡ªå¸¦çš„ä¸­æ–‡å­—ä½“äº†ã€‚

ç»“æœå°±æ˜¯ï¼šâ€œé”—â€ è¿™ç§ EVA/Matisse æ²¡æœ‰ã€baseSplit/notdef ä¹Ÿæ²¡çš„å­—ï¼Œå°±ç›´æ¥ç”»ä¸å‡ºæ¥ã€‚

* * *

## 2. æŠŠçœŸæ­£çš„ä¸­æ–‡å­—ä½“æ”¾åˆ° Canvas çš„åå¤‡é‡Œï¼ˆè€Œä¸”è¦åœ¨ baseSplit/notdef ä¹‹å‰ï¼‰

ä½ æœ‰ä¸¤ç§æ€è·¯ï¼š

### æ–¹æ¡ˆ Aï¼šç”¨ç³»ç»Ÿé‡Œçš„ä¸­æ–‡å­—ä½“å…œåº•ï¼ˆæœ€ç®€å•ï¼‰

ç›´æ¥æ”¹ `make.js` é‡Œè¿™è¡Œï¼š

```js
let baseFontFamilyName = 'EVA_Matisse_Classic-EB,MatissePro-EB,baseSplit,notdef,SourceHanSerifCN-Heavy,serif';
```

æ”¹æˆç±»ä¼¼è¿™æ ·ï¼ˆç¤ºä¾‹ï¼Œå¯ä»¥æŒ‰ä½ çš„ç³»ç»Ÿå­—ä½“è°ƒæ•´ï¼‰ï¼š

```js
let baseFontFamilyName =
  'EVA_Matisse_Classic-EB,' +
  'MatissePro-EB,' +
  '"Microsoft YaHei",' +      // Windows å¸¸è§
  '"SimSun",' +               // å®‹ä½“
  '"PingFang SC",' +          // macOS å¸¸è§
  'SourceHanSerifCN-Heavy,' + // å¦‚æœä½ ç³»ç»Ÿè£…äº†æ€æºå®‹ä½“
  'serif,' +
  'baseSplit,' +
  'notdef';
```

å‡ ç‚¹è¯´æ˜ï¼š

* **æŠŠçœŸæ­£çš„ä¸­æ–‡å­—ä½“æ”¾åœ¨ `baseSplit` / `notdef` å‰é¢**ï¼Œè¿™æ ·ï¼š

  *   EVA/Matisse æ²¡è¿™ä¸ªå­— â†’ ç³»ç»Ÿä¼˜å…ˆç”¨ YaHei / å®‹ä½“ / PingFang / æ€æº

  *   åªæœ‰å½“ç³»ç»Ÿé‡ŒçœŸçš„ä»€ä¹ˆå­—ä½“éƒ½æ²¡æœ‰è¿™ä¸ªå­—æ—¶ï¼Œæ‰ä¼šè½åˆ°æœ€åçš„ `baseSplit` / `notdef`

* å­—ä½“åå­—è¦å’Œç³»ç»Ÿé‡Œå®é™…å®‰è£…çš„ä¿æŒä¸€è‡´ï¼›ä½ å¯ä»¥æ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢æµ‹ä¸€ä¸‹ï¼š

  ```css
  body {
    font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
  }
  ```

  çœ‹â€œé”—â€æ˜¯ä¸æ˜¯èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚

> è¿™æ ·åšä¹‹åï¼Œâ€œç¡…â€ ä»ç„¶ç”¨ EVA/Matisse çš„æ ·å¼ï¼Œâ€œé”—â€ ä¼šé€€åˆ°ä½ æŒ‡å®šçš„ä¸­æ–‡å­—ä½“ä¸Šï¼Œè‡³å°‘ä¸ä¼šæ¶ˆå¤±ã€‚

* * *

### æ–¹æ¡ˆ Bï¼šè‡ªå·±å‡†å¤‡ä¸€ä»½â€œå…¨å­—åº“â€çš„åå¤‡å­—ä½“æ–‡ä»¶

å¦‚æœä½ ä¸æƒ³ä¾èµ–ç³»ç»Ÿå­—ä½“ï¼Œè€Œæ˜¯å¸Œæœ›æ‰“åŒ…åœ¨é¡¹ç›®é‡Œï¼š

1. æ‰¾ä¸€ä»½è¦†ç›–å®Œæ•´ç®€ä½“å­—çš„å­—ä½“ï¼ˆæ¯”å¦‚æ€æºå®‹ä½“ Source Han Serif CNï¼‰ï¼Œç”¨å­—å‹å­é›†å·¥å…·ï¼ˆfontmin/pyftsubset æˆ–åœ¨çº¿å­—ä½“å­é›†åŒ–å·¥å…·ï¼‰è£ä¸€ä»½ woff2ã€‚

2. åœ¨ `document.css` é‡Œå¼•å…¥ï¼š

   ```css
   @font-face {
     font-family: EVAChineseFallback;
     src: url('./YourFullCJKFont.woff2') format('woff2');
   }
   ```

3. ç„¶ååœ¨ `make.js` é‡ŒæŠŠå®ƒåŠ è¿› `baseFontFamilyName`ï¼ŒåŒæ ·æ”¾åˆ° `baseSplit` / `notdef` å‰é¢ï¼š

   ```js
   let baseFontFamilyName =
     'EVA_Matisse_Classic-EB,' +
     'MatissePro-EB,' +
     'EVAChineseFallback,' +
     'serif,' +
     'baseSplit,' +
     'notdef';
   ```

* * *

## 3. è®°ä½ï¼šCanvas ç”¨çš„æ˜¯ `make.js` é‡Œçš„å­—ä½“ä¸²ï¼Œæ”¹çº¯ CSS ä¸ä¼šç”Ÿæ•ˆ

ä½ ä¹‹å‰è¯´â€œå·²ç»åŠ åå¤‡å­—ä½“ï¼Œä½†æ˜¯æ²¡æ•ˆæœâ€ï¼Œå¤§æ¦‚ç‡æ˜¯ï¼š

*   ä½ æ”¹çš„æ˜¯ `document.css` çš„ `font-family`ï¼Œè¿™åªå½±å“æ™®é€š DOM æ–‡æœ¬ï¼›

*   ä½†ç”»é¢ä¸Šçš„å¤§å­—æ˜¯ `canvas` ç”»å‡ºæ¥çš„ï¼Œå®ƒå®Œå…¨å¬ `make.js` é‡Œçš„ `ctx.font = ...`ï¼Œä¸ä¼šçœ‹ CSS çš„ `font-family`ã€‚

æ‰€ä»¥è¿™æ¬¡ä½ åªè¦ï¼š

1.  ä¿®æ”¹ `make.js` ä¸­ `baseFontFamilyName`ï¼ŒæŠŠçœŸæ­£æœ‰å­—çš„ä¸­æ–‡å­—ä½“æ”¾åœ¨ `baseSplit` / `notdef` å‰é¢ï¼›

2.  ä¿å­˜ã€åˆ·æ–°ï¼Œå†åœ¨è¾“å…¥æ¡†é‡Œå¡« `ç¡…é”—` çœ‹ä¸€ä¸‹ï¼›

åŸºæœ¬å°±èƒ½çœ‹åˆ°â€œé”—â€å‡ºç°äº†ï¼ˆæ ·å¼å¯èƒ½å’Œ EVA å­—ä½“ç•¥æœ‰å·®åˆ«ï¼Œä½†è‡³å°‘ä¸ä¼šæ¶ˆå¤±ï¼‰ã€‚

å¦‚æœä½ æ”¹å®Œä¹‹åï¼Œâ€œé”—â€ è¿˜æ˜¯ä¸æ˜¾ç¤ºï¼Œé‚£åŸºæœ¬å°±è¯´æ˜ï¼š  
å½“å‰ä½ æŒ‡å®šçš„é‚£äº›ä¸­æ–‡å­—ä½“é‡Œä¹Ÿæ²¡æœ‰â€œé”—â€è¿™ä¸ªå­—ï¼Œé‚£å°±éœ€è¦æŒ‰æ–¹æ¡ˆ B æ‰¾ä¸€ä»½\*\*ç¡®è®¤åŒ…å«â€œé”—â€\*\*çš„å­—ä½“æ–‡ä»¶ï¼ŒåŠ è¿›æ¥åšå…œåº•ã€‚

## Q: 

ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`; æ€ä¹ˆæ”¹

## A: 

å¥½ï¼Œç›´æ¥å‘Šè¯‰ä½ è¿™è¡Œæ€ä¹ˆæ”¹ ğŸ‘

ç›®æ ‡ï¼š**åœ¨ Canvas çš„å­—ä½“é“¾é‡Œï¼ŒæŠŠçœŸæ­£çš„ä¸­æ–‡å­—ä½“æ”¾åœ¨ `baseSplit` / `notdef` å‰é¢**ï¼Œè¿™æ ·åƒâ€œé”—â€è¿™ç§å­—å°±èƒ½é€€åˆ°ç³»ç»Ÿä¸­æ–‡å­—ä½“ä¸Šæ˜¾ç¤ºã€‚

### å†™æ³• 1ï¼šåªæ”¹è¿™ä¸€è¡Œï¼ˆæœ€ç›´è§‚ï¼‰

æŠŠä½ ç°åœ¨çš„ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`;
```

æ”¹æˆï¼ˆæ³¨æ„æœ‰åŒå¼•å·å’Œé¡ºåºï¼‰ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},
  "Microsoft YaHei",
  "PingFang SC",
  "SimSun",
  "Source Han Serif CN",
  serif,
  baseSplit,
  notdef`;
```

> è§£é‡Šï¼š
>
> *   å…ˆç”¨ `_fontFamilyName`ï¼ˆEVAngelion é‚£ä¸ªä¸»å­—ä½“ï¼‰
>
> *   ç„¶åç”¨ç³»ç»Ÿé‡Œçš„å‡ ä¸ªå¸¸è§ä¸­æ–‡å­—ä½“å…œåº•
>
> *   æœ€åæ‰æ˜¯ `baseSplit` / `notdef`

å­—ä½“åå¯ä»¥æ ¹æ®ä½ ç”µè„‘å®é™…æœ‰çš„æ¥æ”¹ï¼Œæ¯”å¦‚ Windows ä¸Š `"Microsoft YaHei" / "SimSun"`ï¼Œmac ä¸Š `"PingFang SC"` ç­‰ã€‚

* * *

### å†™æ³• 2ï¼šä¿æŒ `baseFontFamilyName` å˜é‡ï¼ˆä»£ç æ›´æ•´æ´ï¼‰

ä¸Šé¢é‚£è¡Œä¿æŒä¸åŠ¨ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`;
```

åªè¦æŠŠå‰é¢å®šä¹‰çš„ `baseFontFamilyName` æ”¹ä¸€ä¸‹ï¼Œæ¯”å¦‚ï¼š

```js
// åŸæ¥å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š
let baseFontFamilyName = 'EVA_Matisse_Classic-EB,MatissePro-EB,baseSplit,notdef,SourceHanSerifCN-Heavy,serif';

// æ”¹æˆï¼š
let baseFontFamilyName =
  '"Microsoft YaHei",' +
  '"PingFang SC",' +
  '"SimSun",' +
  '"Source Han Serif CN",' +  // å¦‚æœä½ æ²¡æœ‰è¿™å­—ä½“ï¼Œå¯ä»¥åˆ æ‰
  'serif,' +
  'baseSplit,' +
  'notdef';
```

> æ³¨æ„é¡ºåºï¼š  
> ä¸­æ–‡å­—ä½“ â†’ `serif` â†’ `baseSplit` â†’ `notdef`

* * *

æ”¹å®Œä¿å­˜ï¼Œåˆ·æ–°é¡µé¢ï¼Œå†åœ¨è¾“å…¥æ¡†é‡Œè¾“å…¥ `ç¡…é”—` æµ‹ä¸€ä¸‹ã€‚  
å¦‚æœâ€œé”—â€è¿˜æ˜¯ä¸å‡ºæ¥ï¼Œå¾ˆå¤§æ¦‚ç‡æ˜¯ï¼šä½ æœºå™¨ä¸Šå½“å‰è¿™äº›å­—ä½“ä¹Ÿæ²¡æœ‰â€œé”—â€ï¼Œé‚£å°±éœ€è¦é¢å¤–åŠ ä¸€ä»½\*\*ç¡®è®¤åŒ…å«â€œé”—â€\*\*çš„ WOFF å­—ä½“åšå…œåº•ï¼Œæˆ‘å†å¸®ä½ å†™ @font-face çš„ç‰ˆæœ¬ã€‚

## Q: 

SourceHanSerifCN-Heavy.ttf

è¿™ä»½åŒ…å« é’™ è¿™ä¸ªå­—å— è¿™ä»½æ±‰å­—å…¨å—

## A: 

æˆ‘åˆšåˆšæŠŠä½ ä¼ ä¸Šæ¥çš„ **`SourceHanSerifCN-Heavy.ttf`** çœŸæœºæ£€äº†ä¸€ä¸‹ï¼š

*   âœ… **â€œé’™â€ è¿™ä¸ªå­—æ˜¯æœ‰çš„**  
    Unicode ç¼–ç æ˜¯ U+9499ï¼Œåœ¨è¿™ä»½å­—ä½“çš„ cmap é‡Œç¡®å®å­˜åœ¨ï¼Œæ‰€ä»¥ç”¨è¿™ä»½å­—ä½“æ¸²æŸ“â€œé’™â€æ²¡æœ‰é—®é¢˜ã€‚

*   âœ… **å¸¸ç”¨ç®€ä½“æ±‰å­—åŸºæœ¬æ˜¯å…¨çš„**  
    è¿™ä»½æ˜¯æ€æºå®‹ä½“çš„ç®€ä½“ä¸­æ–‡å­é›†ï¼ˆSource Han Serif CN Heavyï¼‰ï¼Œè¦†ç›–äº†æ•´å— CJK ç»Ÿä¸€è¡¨æ„æ–‡å­—åŒºï¼ˆU+4E00â€“9FFFï¼‰é‡Œçš„ç»å¤§å¤šæ•°æ±‰å­—â€”â€”ä¹Ÿå°±æ˜¯å¸¸è§ç®€ä½“ã€ç¹ä½“å¸¸ç”¨å­—åŸºæœ¬éƒ½åœ¨ã€‚

*   ä½†è¦æ³¨æ„ï¼š

    *   è¿™ä¸ç­‰äºâ€œæ•´ä¸ª Unicode æ‰€æœ‰æ±‰å­—éƒ½å…¨äº†â€ã€‚ä¸€äº›éå¸¸å†·é—¨çš„æ‰©å±•åŒºï¼ˆå¦‚ CJK Ext. Bã€Cã€Dâ€¦ åœ¨ U+20000 ä»¥åçš„é‚£äº›ç”Ÿåƒ»å­—ï¼‰ï¼Œä»»ä½•å¸¸è§„æ¡Œé¢å­—ä½“éƒ½ä¸ä¸€å®šå…¨ã€‚

    *   å¯¹ä½ ç°åœ¨è¿™ç§æ ‡é¢˜ç”Ÿæˆç”¨é€”æ¥è¯´ï¼Œ**æ—¥å¸¸ä¼šç”¨åˆ°çš„å­—å‡ ä¹è‚¯å®šéƒ½è¦†ç›–äº†**ï¼ŒåŒ…æ‹¬å„ç§å…ƒç´ åï¼šâ€œç¡…ã€é”—ã€é’™ã€é•ã€é“ã€é’ ã€é’¾â€¦â€¦â€è¿™ç§æ²¡é—®é¢˜ã€‚

å¦‚æœä½ æƒ³æŠŠå®ƒå½“ä½œ Canvas çš„å…œåº•å­—ä½“ï¼Œå¯ä»¥è¿™æ ·å†™ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```css
@font-face {
  font-family: "SourceHanSerifCN-Heavy";
  src: url("./SourceHanSerifCN-Heavy.ttf") format("truetype");
  font-weight: 900;
  font-style: normal;
}
```

ç„¶ååœ¨ `make.js` é‡ŒæŠŠå®ƒåŠ åˆ°å­—ä½“é“¾é‡Œï¼ˆåœ¨ `baseSplit` / `notdef` å‰é¢ï¼‰ï¼š

```js
let baseFontFamilyName =
  '"SourceHanSerifCN-Heavy",' +
  '"Microsoft YaHei",' +
  '"PingFang SC",' +
  'serif,' +
  'baseSplit,' +
  'notdef';
```

è¿™æ ·åƒâ€œé’™â€è¿™ç§å­—å°±ä¼šä¼˜å…ˆç”¨æ€æºå®‹ä½“æ¥å…œåº•æ˜¾ç¤ºäº†ã€‚

## Q: 

ä¸ºä»€ä¹ˆè¿˜æ˜¯æ˜¾ç¤ºä¸äº† é’™

## A: 

å…ˆè¯´ç»“è®ºï¼š  
**ä½ çš„ `SourceHanSerifCN-Heavyall` è¿™ä»½å­—ä½“é‡Œæ˜¯æœ‰ã€Œé’™ã€çš„ï¼Œä½† Canvas ç°åœ¨å…¶å®æ²¡ç”¨ä¸Šå®ƒï¼Œæ‰€ä»¥ã€Œé’™ã€è¿˜æ˜¯ç”»ä¸å‡ºæ¥ã€‚**  
ä½ å·²ç»æŠŠ @font-face å’Œ `baseFontFamilyName` éƒ½å†™è¿›å»äº†ï¼Œä½†é¡ºåºå’Œåå­—è¿˜æœ‰ç‚¹å°å‘ã€‚

æˆ‘ä¸€æ­¥ä¸€æ­¥ç»™ä½ ä¸€ä¸ª**å‡ ä¹å¿…å®šèƒ½è·‘é€šçš„æ”¹æ³•**ï¼Œä½ ç…§ç€æ”¹å°±è¡Œã€‚

* * *

## 1. ç¡®ä¿ @font-face å†™æ³•æ²¡é—®é¢˜

`document.css` é‡Œè¿™æ ·å†™å°±å¯ä»¥ï¼ˆä½ å·²ç»å·®ä¸å¤šäº†ï¼Œåªæ˜¯æˆ‘è¡¥ä¸Š formatï¼‰ï¼š

```css
@font-face {
  font-family: SourceHanSerifCN-Heavy;
  src: url('./SourceHanSerifCN-Heavy.woff2') format('woff2');
}

@font-face {
  font-family: SourceHanSerifCN-Heavyall;
  src: url('./SourceHanSerifCN-Heavyall.ttf') format('truetype');
}
```

> ç¡®è®¤ï¼š`document.css`ã€`SourceHanSerifCN-Heavyall.ttf` åœ¨**åŒä¸€ä¸ªç›®å½•**ï¼Œä»ä½ æˆªå›¾çœ‹æ˜¯å¯¹çš„ã€‚

ä½ ä¹Ÿå¯ä»¥åœ¨ CSS é‡Œç”¨å®ƒåšä¸ªç®€å•æµ‹è¯•ï¼ˆåªæ˜¯è¾…åŠ©åˆ¤æ–­ï¼‰ï¼š

```css
.test-font {
  font-family: SourceHanSerifCN-Heavyall;
  font-size: 60px;
}
```

HTML é‡ŒåŠ ä¸€è¡Œï¼š

```html
<div class="test-font">é’™</div>
```

å¦‚æœè¿™é‡Œâ€œé’™â€æ˜¯èƒ½æ­£å¸¸æ˜¾ç¤ºçš„ï¼Œè¯´æ˜ **å­—ä½“æ–‡ä»¶æ²¡é—®é¢˜ï¼Œé—®é¢˜åªåœ¨ Canvas é‚£è¾¹**ã€‚

* * *

## 2. æŠŠ Canvas çš„å­—ä½“é“¾æ”¹å¹²å‡€

ç°åœ¨ä½  `make.js` é‡Œæ˜¯è¿™æ ·ï¼ˆæˆªå›¾é‡Œï¼‰ï¼š

```js
let fontFamilyName = 'EVAMatisseClassic'
const engFontFamilyName = `"Times New Roman"`

let baseFontFamilyName =
  'EVA_Matisse_Classic-EB,MatissePro-EB,SourceHanSerifCN-Heavy,NotoSerifSC-Black,serif,SourceHanSerifCN-Heavyall,baseSplit,notdef';
```

è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

1.  `EVA_Matisse_Classic-EB` å’Œ `MatissePro-EB` æ²¡å¿…è¦åœ¨ `baseFontFamilyName` å†å†™ä¸€æ¬¡ï¼ˆå®ƒä»¬å·²ç»åœ¨ `_fontFamilyName` é‡Œäº†ï¼‰ï¼Œå¤šå†™åªä¼šè®© fallback æ›´ä¹±ã€‚

2.  æˆ‘ä»¬å¸Œæœ›ã€Œé’™ã€**ä¼˜å…ˆä½¿ç”¨ `SourceHanSerifCN-Heavyall`**ï¼Œå†é€€åˆ° `SourceHanSerifCN-Heavy`ï¼Œæœ€åæ‰æ˜¯ `serif` â†’ ç„¶åæ‰è½®åˆ° `baseSplit` / `notdef`ã€‚

ç›´æ¥æŠŠ `baseFontFamilyName` æ”¹æˆè¿™æ ·ï¼š

```js
let baseFontFamilyName =
  'SourceHanSerifCN-Heavyall,' +
  'SourceHanSerifCN-Heavy,' +
  'serif,' +
  'baseSplit,' +
  'notdef';
```

ä¿æŒè¿™è¡Œä¸åŠ¨ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`;
```

> è¿™æ ·æœ€ç»ˆçš„å­—ä½“ä¸²ä¼šæ˜¯ï¼š  
> `EVAMatisseClassic, SourceHanSerifCN-Heavyall, SourceHanSerifCN-Heavy, serif, baseSplit, notdef`

é€»è¾‘å°±å˜æˆï¼š

1.  èƒ½ç”¨ `EVAMatisseClassic` çš„å­— â†’ ç”¨ EVA å­—ä½“ï¼ˆä½ æƒ³è¦çš„æ ‡é¢˜æ•ˆæœï¼‰ã€‚

2.  EVA æ²¡æœ‰çš„å­—ï¼ˆæ¯”å¦‚ã€Œé’™ã€ï¼‰ â†’ å» `SourceHanSerifCN-Heavyall` é‡Œæ‰¾ï¼Œé‚£é‡Œæˆ‘ä»¬å·²ç»ç¡®è®¤æœ‰ã€Œé’™ã€ã€‚

3.  å†ä¸è¡Œæ‰ä¼šå» `serif` / `baseSplit` / `notdef`ã€‚

* * *

## 3. å¦‚æœè¿˜ä¸è¡Œï¼Œç”¨â€œå¼ºåˆ¶åªç”¨æ€æºå®‹ä½“â€åšä¸€æ¬¡æµ‹è¯•

ä¸ºäº†å¿«é€Ÿç¡®è®¤æ˜¯ä¸æ˜¯ Canvas æ²¡ç”¨ä¸Šå­—ä½“ï¼Œä½ å¯ä»¥ä¸´æ—¶æŠŠé‚£è¡Œæ”¹å¾—æ›´æç«¯ä¸€ç‚¹ï¼š

```js
ctx.font = `${fontWeight} ${fontSize}px SourceHanSerifCN-Heavyall`;
```

ä¿å­˜ â†’ åˆ·æ–° â†’ æ–‡æœ¬æ¡†é‡Œåªè¾“å…¥ä¸€ä¸ªã€Œé’™ã€çœ‹çœ‹ï¼š

*   âœ… å¦‚æœè¿™æ ·èƒ½æ˜¾ç¤ºã€Œé’™ã€ï¼Œå°±è¯´æ˜å­—ä½“æœ¬èº«æ²¡é—®é¢˜ï¼Œé—®é¢˜å°±æ˜¯åœ¨ä¹‹å‰é‚£ä¸ªå­—ä½“é“¾ / fallback é¡ºåºä¸Šï¼›æŒ‰ä¸Šé¢çš„ `baseFontFamilyName` å†™æ³•å›å»å°±è¡Œã€‚

*   âŒ å¦‚æœè¿™æ ·éƒ½æ˜¾ç¤ºä¸å‡ºæ¥ï¼ŒåŸºæœ¬å°±æ˜¯ï¼š

    *   å­—ä½“æ²¡åŠ è½½æˆåŠŸï¼ˆNetwork é‡Œ `SourceHanSerifCN-Heavyall.ttf` 404 / æŠ¥é”™ï¼‰ï¼Œæˆ–è€…

    *   é¡µé¢é‡Œå…¶å®æ²¡èµ°åˆ°ä½ ä¿®æ”¹åçš„è¿™æ®µ JSï¼ˆä¾‹å¦‚æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ `make.js`ï¼‰

è¿™ä¸¤ç§æƒ…å†µä½ å¯ä»¥å†æ£€æŸ¥ä¸‹ï¼š

*   DevTools â†’ Network â†’ Filter é‡Œè¾“å…¥ `SourceHanSerifCN-Heavyall` çœ‹è¯·æ±‚æ˜¯å¦ 200ï¼›

*   DevTools â†’ Sources é‡Œæ‰“å¼€å½“å‰åŠ è½½çš„ `make.js`ï¼Œç¡®è®¤é¡¶éƒ¨ `baseFontFamilyName` çš„å†…å®¹å°±æ˜¯ä½ åˆšæ”¹çš„é‚£ä¸€ç‰ˆã€‚

*   * *

## å°ç»“

1. ä½ çš„å­—ä½“æ–‡ä»¶æœ¬èº«æ˜¯æœ‰ã€Œé’™ã€çš„ï¼Œè¿™ç‚¹æ²¡é—®é¢˜ã€‚

2. å…³é”®æ˜¯ Canvas çš„ `ctx.font` é‚£ä¸€ä¸²è¦å˜æˆç±»ä¼¼ï¼š

   ```js
   let baseFontFamilyName =
     'SourceHanSerifCN-Heavyall,SourceHanSerifCN-Heavy,serif,baseSplit,notdef';
   
   ctx.font = `${fontWeight} ${fontSize}px ${_fontFamilyName},${baseFontFamilyName}`;
   ```

3. å¦‚æœæ”¹å®Œè¿˜æ˜¯ä¸æ˜¾ç¤ºï¼Œå°±å…ˆç”¨ï¼š

   ```js
   ctx.font = `${fontWeight} ${fontSize}px SourceHanSerifCN-Heavyall`;
   ```

   åšä¸€æ¬¡â€œåªç”¨æ€æºå®‹ä½“â€çš„æµ‹è¯•ï¼Œç¡®è®¤åˆ°åº•æ˜¯å­—ä½“æ²¡åŠ è½½ï¼Œè¿˜æ˜¯ fallback é“¾çš„é—®é¢˜ã€‚

ä½ å…ˆæŒ‰ä¸Šé¢çš„æ–¹æ¡ˆ A/æµ‹è¯•ç‰ˆæ”¹ä¸€ä¸‹ï¼Œä¸€èˆ¬ã€Œé’™ã€å°±èƒ½å‡ºæ¥äº†ã€‚
  
The End.
