name: Stamp publishDate once

on:
  workflow_dispatch:
  push:
    paths:
      - "src/content/blog/**/*.md"
      - "src/content/blog/**/*.mdx"

permissions:
  contents: write

jobs:
  stamp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Stamp publishDate into frontmatter (once)
        shell: bash
        run: |
          set -euo pipefail

          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- \
            "src/content/blog/**/*.md" "src/content/blog/**/*.mdx" || true)

          if [ -z "$CHANGED" ]; then
            echo "No changed blog posts."
            exit 0
          fi

          for FILE in $CHANGED; do
            echo "Processing $FILE"

            # 没有 frontmatter 就加一个
            if ! head -n 1 "$FILE" | grep -q '^---$'; then
              tmp=$(mktemp)
              {
                echo "---"
                echo "publishDate: $NOW"
                echo "---"
                cat "$FILE"
              } > "$tmp"
              mv "$tmp" "$FILE"
              continue
            fi

            # frontmatter 内已存在 publishDate 就跳过（只写一次）
            if awk '
              NR==1 {in=($0=="---"); next}
              in==1 && $0=="---" {exit 0}
              in==1 && $0 ~ /^publishDate:/ {found=1}
              END {exit(found?0:1)}
            ' "$FILE"; then
              echo "publishDate exists, skip."
              continue
            fi

            # 在 frontmatter 结束 --- 之前插入 publishDate
            tmp=$(mktemp)
            awk -v now="$NOW" '
              NR==1 {print; in=1; next}
              in==1 && $0=="---" {print "publishDate: " now; print; in=0; next}
              {print}
            ' "$FILE" > "$tmp"
            mv "$tmp" "$FILE"
          done

      - name: Commit changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "chore: stamp publishDate"
          git push
          
