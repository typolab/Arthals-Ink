name: Stamp blog publish/updated dates (changed only, BJ)

on:
  push:
    paths:
      - "src/content/blog/**/*.md"
      - "src/content/blog/**/*.mdx"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  stamp:
    # 防止 bot 写回再次触发造成循环
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      # 只需要 gray-matter（纯 JS）来改 frontmatter，不需要任何 postinstall
      - name: Install deps (ignore postinstall scripts)
        env:
          CI: true
          SKIP_SIMPLE_GIT_HOOKS: "1"
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Collect changed blog files (with status)
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # 手动运行：处理所有 blog 文件（统一标记为 M）
            git ls-files 'src/content/blog/**/*.md' 'src/content/blog/**/*.mdx' \
              | awk '{print "M\t"$0}' > changed_files_status.txt || true
          else
            if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              RANGE="$AFTER"
            else
              RANGE="$BEFORE..$AFTER"
            fi

            # 输出形如：A<TAB>path 或 M<TAB>path
            git diff --name-status "$RANGE" \
              | grep -E '^([AM])\s+src/content/blog/.*\.(md|mdx)$' \
              > changed_files_status.txt || true
          fi

          echo "Changed files (status + path):"
          cat changed_files_status.txt || true

          # 转成 JSON 数组：[{status:"A"|"M", path:"..."}]
          files_json=$(
            node - <<'NODE'
            const fs = require('fs');
            const p = 'changed_files_status.txt';
            const lines = fs.existsSync(p) ? fs.readFileSync(p,'utf8').split(/\r?\n/).filter(Boolean) : [];
            const out = lines.map(l => {
              const m = l.match(/^([AM])\s+(.*)$/);
              return m ? { status: m[1], path: m[2] } : null;
            }).filter(Boolean);
            process.stdout.write(JSON.stringify(out));
NODE
          )

          echo "files=$files_json" >> "$GITHUB_OUTPUT"

      - name: Stamp dates (inline, BJ)
        if: ${{ steps.changed.outputs.files != '[]' }}
        shell: bash
        env:
          CHANGED_FILES_JSON: ${{ steps.changed.outputs.files }}
        run: |
          set -euo pipefail

          node <<'NODE'
          import fs from "node:fs/promises";
          import { execFileSync } from "node:child_process";
          import matter from "gray-matter";

          const items = JSON.parse(process.env.CHANGED_FILES_JSON || "[]");

          const BOT_NAME = "github-actions[bot]";
          const BOT_EMAIL_RE = /github-actions\[bot\]@users\.noreply\.github\.com/i;

          function sh(cmd, args) {
            return execFileSync(cmd, args, { encoding: "utf8", stdio: ["ignore", "pipe", "pipe"] }).trim();
          }

          // 将 git 的 ISO 时间转为北京时间(+08:00)
          function toBJ(iso) {
            const out = execFileSync(
              "bash",
              ["-lc", `TZ=Asia/Shanghai date -d "${iso}" +"%Y-%m-%dT%H:%M:%S%:z"`],
              { encoding: "utf8" }
            );
            return out.trim();
          }

          function stripBOM(s) { return s.replace(/^\uFEFF/, ""); }
          function ltrimBlankLines(s) { return s.replace(/^(?:[ \t]*\r?\n)+/, ""); }
          function normalizeTopDelims(s) {
            const lines = s.split(/\r?\n/);
            const limit = Math.min(lines.length, 300);
            for (let i = 0; i < limit; i++) {
              if (/^[ \t]*---[ \t]*$/.test(lines[i])) lines[i] = "---";
            }
            return lines.join("\n");
          }

          // 允许处理“顶部空行 / --- 有空格 / 双 frontmatter”等坏格式，把它们归一成单 frontmatter
          function parseRobust(raw) {
            let s = stripBOM(raw);
            s = ltrimBlankLines(s);
            s = normalizeTopDelims(s);

            // 没有 frontmatter
            if (!(/^---\n/.test(s) || s.startsWith("---\r\n"))) {
              return { data: {}, content: s };
            }

            const p1 = matter(s, { language: "yaml", delimiters: ["---", "---"] });
            let data = { ...(p1.data || {}) };
            let content = p1.content ?? "";

            // 如果 content 又以 --- 开头，说明是“双 frontmatter 坏格式”
            if (/^---\n/.test(content) || content.startsWith("---\r\n")) {
              const p2 = matter(content, { language: "yaml", delimiters: ["---", "---"] });
              // 合并策略：第二段（title/tags等）为主，第一段（日期）覆盖同名键
              data = { ...(p2.data || {}), ...(p1.data || {}) };
              content = p2.content ?? "";
            }

            return { data, content };
          }

          function hasNonEmpty(v) {
            if (v == null) return false;
            if (typeof v === "string") return v.trim().length > 0;
            return true;
          }

          // ✅ publishDate 取“当前路径第一次出现”的创建时间：不要用 --follow（避免 rename/复制串历史）
          function gitFirstCommitISO_NoFollow(file) {
            const out = sh("git", ["log", "--diff-filter=A", "--format=%cI|%an|%ae", "--", file]);
            if (!out) return "";
            const lines = out.split("\n").filter(Boolean);
            return (lines[lines.length - 1]?.split("|")[0]) || "";
          }

          // updatedDate 仍然 follow：追踪改名历史是合理的（表示内容最后更新）
          function gitLastHumanCommitISO_Follow(file) {
            const out = sh("git", ["log", "--follow", "--format=%cI|%an|%ae", "--", file]);
            if (!out) return "";
            const lines = out.split("\n").filter(Boolean);

            for (const line of lines) {
              const [iso, name, email] = line.split("|");
              if (!iso) continue;
              if (name === BOT_NAME) continue;
              if (email && BOT_EMAIL_RE.test(email)) continue;
              return iso;
            }
            return lines[0]?.split("|")[0] || "";
          }

          let changed = 0;

          for (const item of items) {
            const file = item.path;
            const status = item.status; // "A" | "M"

            const raw = await fs.readFile(file, "utf8");
            const rawNorm = normalizeTopDelims(ltrimBlankLines(stripBOM(raw))).replace(/\r\n/g, "\n");

            const { data, content } = parseRobust(raw);

            const firstISO = gitFirstCommitISO_NoFollow(file);
            const lastISO  = gitLastHumanCommitISO_Follow(file);

            if (!firstISO || !lastISO) {
              console.log(`[SKIP] no git history: ${file}`);
              continue;
            }

            const firstBJ = toBJ(firstISO);
            const lastBJ  = toBJ(lastISO);

            // ✅ 新增文件：无条件固定 publishDate（防止沿用旧文章/复制的 publishDate）
            if (status === "A") {
              data.publishDate = firstBJ;
            } else {
              // 修改文件：publishDate 只在缺失/空时写入（固定）
              if (!hasNonEmpty(data.publishDate)) data.publishDate = firstBJ;
            }

            // updatedDate：每次同步为最后一次 human commit 时间
            data.updatedDate = lastBJ;

            const out = matter.stringify(content, data, { language: "yaml" });
            const finalText = normalizeTopDelims(ltrimBlankLines(stripBOM(out))).replace(/\r\n/g, "\n");

            if (finalText !== rawNorm) {
              await fs.writeFile(file, finalText, "utf8");
              changed++;
              console.log(`[OK]   ${file}`);
              console.log(`       status=${status}`);
              console.log(`       publishDate=${data.publishDate}`);
              console.log(`       updatedDate=${data.updatedDate}`);
            } else {
              console.log(`[NOOP] ${file}`);
            }
          }

          console.log(`Done. Changed files: ${changed}`);
          NODE

      - name: Commit & push (if any)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: sync blog publishDate/updatedDate (BJ)"
          git push
